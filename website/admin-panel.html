<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Markeb Media</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      color: #1e293b;
    }

    /* Sidebar Navigation */
    .admin-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: #fff;
      border-right: 2px solid #e2e8f0;
      padding: 24px;
      overflow-y: auto;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .admin-logo {
      font-size: 24px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 32px;
      text-align: center;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      padding-left: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      color: #64748b;
      text-decoration: none;
      font-weight: 500;
      transition: all .2s ease;
      cursor: pointer;
      margin-bottom: 4px;
    }

    .nav-item:hover {
      background: #f1f5f9;
      color: #0f172a;
    }

    .nav-item.active {
      background: #3b82f6;
      color: #fff;
    }

    .nav-icon {
      font-size: 18px;
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .admin-main {
      margin-left: 260px;
      min-height: 100vh;
      padding: 24px;
      transition: margin-left 0.3s ease;
    }

    .admin-header {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-title {
      font-size: 28px;
      font-weight: 700;
      color: #0f172a;
    }

    .admin-subtitle {
      color: #64748b;
      font-size: 14px;
      margin-top: 4px;
    }

    .admin-badge {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    /* Sections */
    .admin-section {
      display: none;
    }

    .admin-section.active {
      display: block;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 8px;
    }

    .stat-label {
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
    }

    /* Tables */
    .data-table {
      width: 100%;
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
    }

    .data-table thead {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
    }

    .data-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
    }

    .data-table td {
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }

    .data-table tbody tr:hover {
      background: #f8fafc;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all .2s ease;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: #3b82f6;
      color: #fff;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: #fff;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: #fff;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: #64748b;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .btn-warning {
      background: #f59e0b;
      color: #fff;
    }

    .btn-warning:hover {
      background: #d97706;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Calendar */
    .calendar-container {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .calendar-nav {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .calendar-current {
      font-size: 20px;
      font-weight: 700;
      color: #0f172a;
      min-width: 200px;
      text-align: center;
    }

    .calendar-view-selector {
      display: flex;
      gap: 4px;
      background: #f1f5f9;
      padding: 4px;
      border-radius: 8px;
    }

    .calendar-view-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      color: #64748b;
      transition: all .2s ease;
    }

    .calendar-view-btn.active {
      background: #fff;
      color: #3b82f6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .calendar-grid {
      display: grid;
      gap: 1px;
      background: #e2e8f0;
      border: 1px solid #e2e8f0;
    }

    /* Month View */
    .calendar-grid.month {
      grid-template-columns: repeat(7, 1fr);
    }

    .calendar-day-header {
      background: #f8fafc;
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      color: #64748b;
    }

    .calendar-day {
      background: #fff;
      min-height: 120px;
      padding: 8px;
      position: relative;
    }

    .calendar-day-number {
      font-weight: 600;
      font-size: 14px;
      color: #0f172a;
      margin-bottom: 4px;
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .calendar-day.today {
      background: #eff6ff;
      border: 2px solid #3b82f6;
    }

    .calendar-booking {
      background: #3b82f6;
      color: #fff;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 11px;
      margin-bottom: 2px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .calendar-booking:hover {
      background: #2563eb;
    }

    .calendar-booking.pending {
      background: #f59e0b;
    }

    .calendar-booking.cancelled {
      background: #ef4444;
    }

    /* Week View */
    .calendar-grid.week {
      grid-template-columns: 80px repeat(7, 1fr);
    }

    .calendar-time-slot {
      background: #f8fafc;
      padding: 8px;
      font-size: 12px;
      color: #64748b;
      text-align: right;
      border-right: 2px solid #e2e8f0;
    }

    .calendar-week-slot {
      background: #fff;
      padding: 4px;
      min-height: 60px;
      position: relative;
    }

    /* Day View */
    .calendar-grid.day {
      grid-template-columns: 80px 1fr;
    }

    /* Drive Time Badge */
    .drive-time-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: #dbeafe;
      color: #1e40af;
    }

    .drive-time-badge.warning {
      background: #fef3c7;
      color: #92400e;
    }

    .drive-time-badge.error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: .3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Filters */
    .filters-bar {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-input {
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      flex: 1;
      min-width: 200px;
    }

    .filter-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .filter-select {
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
    }

    /* Loading */
    .spinner {
      margin: 30px auto;
      width: 50px;
      height: 50px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-dialog {
      background: #fff;
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      border-radius: 16px 16px 0 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s ease;
      line-height: 1;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 24px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: #64748b;
      font-size: 14px;
    }

    .detail-value {
      color: #0f172a;
      font-weight: 500;
      text-align: right;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-paid {
      background: #d1fae5;
      color: #065f46;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-cancelled {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Region Dropdown */
    .region-select {
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      background: #fff;
      color: #0f172a;
      cursor: pointer;
      transition: all .2s ease;
      min-width: 140px;
      max-width: 180px;
    }

    .region-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .region-select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8f9fa;
    }

    .region-select:hover:not(:disabled) {
      border-color: #cbd5e1;
    }

    /* Region badge */
    .region-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #eff6ff;
      color: #1e40af;
      border: 2px solid #bfdbfe;
    }

    .region-badge.empty {
      background: #f1f5f9;
      color: #64748b;
      border-color: #e2e8f0;
      font-style: italic;
    }

    /* Info/Warning boxes */
    .info-box {
      background: #eff6ff;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      color: #1e40af;
      font-size: 14px;
    }

    .warning-box {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      color: #92400e;
      font-size: 14px;
    }

    .success-box {
      background: #d1fae5;
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      color: #065f46;
      font-size: 14px;
    }

    /* Action buttons grid */
    .action-buttons-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 24px;
    }

    /* Rewards section */
    .rewards-section {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
    }

    .rewards-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .rewards-title {
      font-size: 18px;
      font-weight: 700;
      color: #92400e;
    }

    .rewards-progress {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .progress-bar-container {
      background: #e5e7eb;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
      transition: width 0.3s ease;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .mobile-menu-btn {
        display: block !important;
      }

      .admin-sidebar {
        transform: translateX(-100%);
      }

      .admin-sidebar.open {
        transform: translateX(0);
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
      }

      .admin-main {
        margin-left: 0;
      }

      .calendar-grid.month .calendar-day {
        min-height: 80px;
      }

      .calendar-booking {
        font-size: 10px;
      }

      .calendar-header {
        flex-direction: column;
      }

      .action-buttons-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .admin-title {
        font-size: 24px;
      }

      .filters-bar {
        flex-direction: column;
      }

      .filter-input {
        width: 100%;
        min-width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .calendar-grid.month .calendar-day {
        min-height: 60px;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table thead {
        display: none;
      }

      .data-table, 
      .data-table tbody, 
      .data-table tr, 
      .data-table td {
        display: block;
        width: 100%;
      }

      .data-table tr {
        margin-bottom: 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
      }

      .data-table td {
        padding: 8px 0;
        border: none;
        position: relative;
        padding-left: 50%;
      }

      .data-table td:before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 45%;
        padding-right: 10px;
        font-weight: 600;
        color: #64748b;
        font-size: 11px;
        text-transform: uppercase;
      }

      .detail-item {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }

      .detail-value {
        text-align: left;
        width: 100%;
      }

      .modal-dialog {
        max-width: 100%;
        margin: 0;
        max-height: 100vh;
        border-radius: 0;
      }

      .modal-header {
        border-radius: 0;
      }
    }

    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      cursor: pointer;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* ===== MOBILE-FRIENDLY CALENDAR STYLES ===== */

/* Optimize calendar for small screens */
@media (max-width: 768px) {
  .calendar-container {
    padding: 16px;
    margin-bottom: 16px;
  }

  .calendar-header {
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 12px;
  }

  .calendar-nav {
    width: 100%;
    justify-content: space-between;
  }

  .calendar-current {
    font-size: 16px;
    min-width: 150px;
  }

  .calendar-view-selector {
    width: 100%;
    justify-content: center;
  }

  .calendar-view-btn {
    flex: 1;
    padding: 6px 8px;
    font-size: 11px;
  }

  .calendar-grid.month .calendar-day {
    min-height: 70px;
    padding: 4px;
  }

  .calendar-day-number {
    font-size: 12px;
  }

  .calendar-booking {
    font-size: 9px;
    padding: 2px 4px;
  }

  .modal-dialog {
    max-width: 95%;
    margin: 10px auto;
  }

  .modal-header {
    padding: 16px;
  }

  .modal-header h3 {
    font-size: 18px;
  }

  .modal-body {
    padding: 16px;
  }

  .detail-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    padding: 12px;
  }

  .detail-value {
    text-align: left;
    width: 100%;
  }

  .action-buttons-grid {
    grid-template-columns: 1fr;
  }

  .filters-bar {
    flex-direction: column;
    gap: 8px;
  }

  .filter-input,
  .filter-select {
    width: 100%;
    min-width: 100%;
  }

  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .stat-card {
    padding: 16px;
  }

  .stat-value {
    font-size: 24px;
  }

  .stat-label {
    font-size: 12px;
  }

  .data-table {
    font-size: 13px;
  }
}

/* Extra small screens (phones) */
@media (max-width: 480px) {
  .calendar-container {
    padding: 8px;
    border-radius: 8px;
  }

  .calendar-header {
    gap: 8px;
    margin-bottom: 12px;
  }

  .calendar-nav {
    gap: 6px;
  }

  .btn.btn-small {
    padding: 4px 8px;
    font-size: 10px;
  }

  .calendar-current {
    font-size: 13px;
    min-width: 100px;
  }

  .calendar-view-selector {
    padding: 2px;
    gap: 2px;
  }

  .calendar-view-btn {
    padding: 5px 6px;
    font-size: 10px;
  }

  /* Compact calendar grid */
  .calendar-grid {
    gap: 0.5px;
  }

  .calendar-day-header {
    padding: 6px 2px;
    font-size: 10px;
  }

  .calendar-grid.month .calendar-day {
    min-height: 50px;
    max-height: 50px;
    padding: 2px;
    border-radius: 4px;
  }

  .calendar-day-number {
    font-size: 11px;
    margin-bottom: 2px;
  }

  /* Show only dots for bookings on tiny screens */
  .calendar-booking {
    height: 6px;
    padding: 0;
    margin-bottom: 1px;
    border-radius: 3px;
    text-indent: -9999px; /* Hide text */
    overflow: hidden;
  }

  /* Add +more indicator */
  .calendar-day.has-more::after {
    content: '+';
    position: absolute;
    bottom: 2px;
    right: 2px;
    font-size: 8px;
    font-weight: 700;
    color: #64748b;
    background: #fff;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal {
    padding: 0;
    align-items: flex-start;
  }

  .modal-dialog {
    max-width: 100%;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
  }

  .modal-header {
    border-radius: 0;
    padding: 12px;
  }

  .modal-header h3 {
    font-size: 16px;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    font-size: 20px;
  }

  .modal-body {
    padding: 12px;
  }

  .detail-item {
    padding: 10px 0;
  }

  .detail-label,
  .detail-value {
    font-size: 13px;
  }

  .btn {
    padding: 10px 16px;
    font-size: 13px;
  }

  .action-buttons-grid {
    gap: 8px;
  }

  .stats-grid {
    grid-template-columns: 1fr;
    gap: 8px;
  }

  .stat-card {
    padding: 12px;
  }

  .stat-value {
    font-size: 20px;
  }

  .data-table {
    font-size: 12px;
  }

  .data-table td {
    padding: 6px 0;
  }

  .data-table td:before {
    font-size: 10px;
  }

  .data-table .btn-small {
    padding: 6px 10px;
    font-size: 11px;
    white-space: nowrap;
  }

  .data-table td[data-label="Actions"] {
    padding-left: 0 !important;
  }

  .data-table td[data-label="Actions"] > div {
    flex-direction: column;
    width: 100%;
  }

  .data-table td[data-label="Actions"] .btn {
    width: 100%;
  }

  .spinner {
    width: 35px;
    height: 35px;
    border-width: 3px;
  }
}

/* Touch-friendly tap targets */
@media (pointer: coarse) {
  .calendar-booking,
  .calendar-day,
  .btn,
  .nav-item {
    min-height: 44px;
  }

  .calendar-view-btn {
    min-height: 40px;
  }
}

/* ===== PASSWORD PROTECTION STYLES ===== */
.password-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  padding: 20px;
}

.password-modal.unlocked {
  display: none;
}

.password-dialog {
  background: #fff;
  border-radius: 24px;
  max-width: 480px;
  width: 100%;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
  overflow: hidden;
  animation: passwordSlideIn 0.4s ease-out;
}

@keyframes passwordSlideIn {
  from {
    opacity: 0;
    transform: translateY(-30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.password-header {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  padding: 48px 32px;
  text-align: center;
  color: #fff;
}

.password-logo {
  font-size: 64px;
  margin-bottom: 16px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.password-header h2 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.password-header p {
  font-size: 16px;
  opacity: 0.9;
}

.password-body {
  padding: 40px 32px;
}

.password-input-group {
  margin-bottom: 24px;
}

.password-input {
  width: 100%;
  padding: 16px 20px;
  border: 3px solid #e2e8f0;
  border-radius: 12px;
  font-size: 18px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  letter-spacing: 2px;
  text-align: center;
  transition: all 0.3s ease;
  background: #f8fafc;
}

.password-input:focus {
  outline: none;
  border-color: #3b82f6;
  background: #fff;
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.password-error {
  display: none;
  margin-top: 12px;
  padding: 12px 16px;
  background: #fee2e2;
  border: 2px solid #ef4444;
  border-radius: 8px;
  color: #991b1b;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
}

.password-error.show {
  display: block;
  animation: shake 0.5s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.password-submit {
  width: 100%;
  padding: 16px 24px;
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.password-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.password-submit:active {
  transform: translateY(0);
}

.password-icon {
  font-size: 20px;
}

.password-footer {
  margin-top: 24px;
  padding-top: 24px;
  border-top: 2px solid #e2e8f0;
  text-align: center;
}

.password-footer p {
  font-size: 14px;
  color: #64748b;
  font-weight: 600;
}

/* Mobile optimizations */
@media (max-width: 480px) {
  .password-dialog {
    border-radius: 16px;
  }

  .password-header {
    padding: 32px 24px;
  }

  .password-logo {
    font-size: 48px;
  }

  .password-header h2 {
    font-size: 24px;
  }

  .password-body {
    padding: 28px 24px;
  }

  .password-input {
    font-size: 16px;
    padding: 14px 16px;
  }
}
  </style>
</head>
<body>

  <body>
  <!-- Password Protection Modal -->
<div class="password-modal" id="passwordModal">
  <div class="password-dialog">
    <div class="password-header">
      <div class="password-logo">
        <img src="Markeb Media Logo (2).PNG" alt="Markeb Media" style="width: 80px; height: auto;">
      </div>
      <h2>Admin Access Required</h2>
      <p>Enter the admin code to continue</p>
    </div>
      
      <div class="password-body">
        <form id="passwordForm" onsubmit="checkPassword(event)">
          <div class="password-input-group">
            <input 
              type="password" 
              id="adminPassword" 
              class="password-input"
              placeholder="Enter admin code"
              autocomplete="off"
              autofocus
            />
            <div class="password-error" id="passwordError">
              ‚ùå Incorrect code. Please try again.
            </div>
          </div>
          
          <button type="submit" class="password-submit">
            <span>Unlock Admin Panel</span>
            <span class="password-icon">üîì</span>
          </button>
        </form>
        
        <div class="password-footer">
          <p>‚ö†Ô∏è Authorized personnel only</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>

 <!-- Sidebar Navigation -->
<div class="admin-sidebar" id="adminSidebar">
  <div class="admin-logo">
    <img src="/public/images/Markeb Media Logo (2).png" alt="Markeb Media" style="height: 80px; width: auto;">
  </div>

    <div class="nav-section">
      <div class="nav-section-title">Overview</div>
      <div class="nav-item active" onclick="showSection('dashboard')">
        <span class="nav-icon">üìä</span>
        Dashboard
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Bookings</div>
      <div class="nav-item" onclick="showSection('calendar')">
        <span class="nav-icon">üìÖ</span>
        Calendar
      </div>
      <div class="nav-item" onclick="showSection('bookings')">
        <span class="nav-icon">üìã</span>
        All Bookings
      </div>
      <div class="nav-item" onclick="showSection('pending')">
        <span class="nav-icon">üí≥</span>
        Pending (Need Payment)
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Customers</div>
      <div class="nav-item" onclick="showSection('customers')">
        <span class="nav-icon">üë•</span>
        All Customers
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Tools</div>
      <div class="nav-item" onclick="window.open('uk-client-map.html', '_blank')">
        <span class="nav-icon">üó∫Ô∏è</span>
        UK Map
      </div>
    </div>

<div class="nav-section" style="margin-top: auto; padding-top: 24px; border-top: 2px solid #e2e8f0;">
  <div class="nav-item" onclick="adminLogout()" style="color: #ef4444;">
    <span class="nav-icon">üö™</span>
    Logout
  </div>
</div>
  </div>

  <!-- Main Content -->
  <div class="admin-main">
    <!-- Header -->
    <div class="admin-header">
      <div>
        <div class="admin-title">Admin Panel</div>
        <div class="admin-subtitle">Manage bookings, customers, and payments</div>
      </div>
      <div class="admin-badge">‚ö†Ô∏è ADMIN ACCESS</div>
    </div>

    <!-- Dashboard Section -->
    <div class="admin-section active" id="dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalBookings">-</div>
          <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="upcomingBookings">-</div>
          <div class="stat-label">Upcoming</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pendingBookings">-</div>
          <div class="stat-label">Need Payment</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalCustomers">-</div>
          <div class="stat-label">Total Customers</div>
        </div>
      </div>

      <div class="calendar-container">
        <div style="text-align: center; padding: 40px;">
          <h3 style="color: #64748b;">Welcome to the Admin Panel</h3>
          <p style="color: #94a3b8; margin-top: 8px;">Select a section from the sidebar to get started</p>
        </div>
      </div>
    </div>

    <!-- Calendar Section -->
    <div class="admin-section" id="calendar">
      <div class="calendar-container">
        <div class="calendar-header">
          <div class="calendar-nav">
            <button class="btn btn-primary btn-small" onclick="previousPeriod()">‚óÄ Previous</button>
            <div class="calendar-current" id="calendarCurrent">Loading...</div>
            <button class="btn btn-primary btn-small" onclick="nextPeriod()">Next ‚ñ∂</button>
          </div>
          <div class="calendar-view-selector">
            <button class="calendar-view-btn active" data-view="month" onclick="setCalendarView('month')">Month</button>
            <button class="calendar-view-btn" data-view="week" onclick="setCalendarView('week')">Week</button>
            <button class="calendar-view-btn" data-view="day" onclick="setCalendarView('day')">Day</button>
          </div>
        </div>

        <div class="filters-bar">
          <select class="filter-select" id="calendarRegion" onchange="loadCalendar()">
            <option value="">All Regions</option>
            <option value="North">North</option>
            <option value="South">South</option>
          </select>
          <button class="btn btn-primary" onclick="loadCalendar()">üîÑ Refresh</button>
        </div>

        <div id="calendarGrid">
          <div style="text-align: center; padding: 40px;">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- All Bookings Section -->
    <div class="admin-section" id="bookings">
      <div class="filters-bar">
        <input type="text" class="filter-input" id="bookingSearch" placeholder="Search by name, email, address, reference...">
        <select class="filter-select" id="bookingRegion">
          <option value="">All Regions</option>
          <option value="North">North</option>
          <option value="South">South</option>
        </select>
        <select class="filter-select" id="bookingStatus">
          <option value="">All Status</option>
          <option value="Booked">Booked</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <button class="btn btn-primary" onclick="loadBookings()">üîç Search</button>
      </div>

      <div class="calendar-container" id="bookingsContainer">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

   <!-- Pending Bookings Section -->
<div class="admin-section" id="pending">
  <div class="info-box" style="margin-bottom: 24px;">
    <strong>üí≥ Reserved Bookings</strong><br>
    These bookings have been reserved but require payment. You can either charge the customer's saved card or send them a payment link via email.
  </div>

  <div class="calendar-container" id="pendingContainer">
    <div style="text-align: center; padding: 40px;">
      <div class="spinner"></div>
    </div>
  </div>
</div>

    <!-- Customers Section -->
    <div class="admin-section" id="customers">
      <div class="filters-bar">
        <input type="text" class="filter-input" id="customerSearch" placeholder="Search by name, email, company...">
        <button class="btn btn-primary" onclick="loadCustomers()">üîç Search</button>
      </div>

      <div class="calendar-container" id="customersContainer">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Detail Modal -->
  <div class="modal" id="bookingModal" onclick="closeModal('bookingModal')">
    <div class="modal-dialog" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="bookingModalTitle">Booking Details</h3>
        <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
      </div>
      <div class="modal-body" id="bookingModalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Customer Detail Modal -->
  <div class="modal" id="customerModal" onclick="closeModal('customerModal')">
    <div class="modal-dialog" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="customerModalTitle">Customer Details</h3>
        <button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
      </div>
      <div class="modal-body" id="customerModalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Reschedule Modal -->
<div class="modal" id="rescheduleModal" onclick="closeModal('rescheduleModal')">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Reschedule Booking</h3>
      <button class="modal-close" onclick="closeModal('rescheduleModal')">&times;</button>
    </div>
    <div class="modal-body" id="rescheduleModalBody">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Cancel Modal -->
<div class="modal" id="cancelModal" onclick="closeModal('cancelModal')">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Cancel Booking</h3>
      <button class="modal-close" onclick="closeModal('cancelModal')">&times;</button>
    </div>
    <div class="modal-body" id="cancelModalBody">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Modify Service Modal -->
<div class="modal" id="modifyServiceModal" onclick="closeModal('modifyServiceModal')">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Modify Service</h3>
      <button class="modal-close" onclick="closeModal('modifyServiceModal')">&times;</button>
    </div>
    <div class="modal-body" id="modifyServiceModalBody">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

  <script>
    // ===== PASSWORD PROTECTION =====
    const ADMIN_CODE = 'MARKEB2546';
    const SESSION_KEY = 'admin_authenticated';
    const SESSION_DURATION = 8 * 60 * 60 * 1000; // 8 hours

    // Check if already authenticated
    function isAuthenticated() {
      const authData = localStorage.getItem(SESSION_KEY);
      if (!authData) return false;
      
      try {
        const { timestamp } = JSON.parse(authData);
        const now = Date.now();
        
        // Check if session is still valid
        if (now - timestamp < SESSION_DURATION) {
          return true;
        } else {
          // Session expired
          localStorage.removeItem(SESSION_KEY);
          return false;
        }
      } catch (e) {
        return false;
      }
    }

    // Check password
    function checkPassword(event) {
      event.preventDefault();
      
      const input = document.getElementById('adminPassword');
      const error = document.getElementById('passwordError');
      const modal = document.getElementById('passwordModal');
      
      if (input.value === ADMIN_CODE) {
        // Correct password
        localStorage.setItem(SESSION_KEY, JSON.stringify({
          timestamp: Date.now()
        }));
        
        // Success animation
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.95)';
        modal.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
          modal.classList.add('unlocked');
        }, 300);
        
      } else {
        // Incorrect password
        error.classList.add('show');
        input.value = '';
        input.classList.add('error');
        
        setTimeout(() => {
          error.classList.remove('show');
          input.classList.remove('error');
        }, 3000);
      }
    }

    // Logout function
    function adminLogout() {
      if (confirm('Are you sure you want to logout from the admin panel?')) {
        localStorage.removeItem(SESSION_KEY);
        location.reload();
      }
    }

    // Check authentication on page load
    window.addEventListener('DOMContentLoaded', function() {
      if (isAuthenticated()) {
        document.getElementById('passwordModal').classList.add('unlocked');
      }
    });


   // ===== SERVICE & ADDON CATALOGS =====
    const SERVICES_CATALOG = {
      north: [
        {
          id: 'complete-branding',
          name: 'Complete Branding Package - Photo & Video',
          price: 894.00,
          duration: 300,
          isPropertyService: false,
          availableAddons: ['elevate-edit', 'add-branded-outro']
        },
        {
          id: 'branding-video',
          name: 'Branding Videography Session',
          price: 534.00,
          duration: 180,
          isPropertyService: false,
          availableAddons: ['elevate-edit', 'add-branded-outro']
        },
        {
          id: 'branding-photo',
          name: 'Branding Photography Session - 10 Signature Shots',
          price: 414.00,
          duration: 120,
          isPropertyService: false,
          availableAddons: []
        },
        {
          id: 'gold-package',
          name: 'Gold Package',
          price: 600.00,
          duration: 150,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'silver-package',
          name: 'Silver Package',
          price: 262.80,
          duration: 90,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'all-in-one-drone',
          name: 'All In One Drone',
          price: 214.80,
          duration: 45,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'property-video',
          name: 'Property Videography',
          price: 154.80,
          duration: 60,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-drone-photo', 'property-drone-video', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'property-photo',
          name: 'Property Photography',
          price: 118.80,
          duration: 45,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-photo', 'property-drone-video', 'property-speed-tours']
        },
        {
          id: 'drone-video',
          name: 'Property Drone Videography',
          price: 130.80,
          duration: 20,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-drone-photo', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'drone-photo',
          name: 'Property Drone Photography',
          price: 130.80,
          duration: 20,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-video', 'property-speed-tours']
        }
      ],
      south: [
        {
          id: 'gold-package',
          name: 'Gold Package',
          price: 600.00,
          duration: 150,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'silver-package',
          name: 'Silver Package',
          price: 262.80,
          duration: 90,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'all-in-one-drone',
          name: 'All In One Drone',
          price: 214.80,
          duration: 45,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'property-video',
          name: 'Property Videography',
          price: 154.80,
          duration: 60,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-drone-photo', 'property-drone-video', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'property-photo',
          name: 'Property Photography',
          price: 118.80,
          duration: 45,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-photo', 'property-drone-video', 'property-speed-tours']
        },
        {
          id: 'drone-video',
          name: 'Property Drone Videography',
          price: 130.80,
          duration: 20,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-drone-photo', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'drone-photo',
          name: 'Property Drone Photography',
          price: 130.80,
          duration: 20,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-video', 'property-speed-tours']
        }
      ]
    };

    const ADDONS_CATALOG = {
      'standard-floor-plan': {
        id: 'standard-floor-plan',
        name: 'Standard Floor Plan',
        price: 24.00,
        description: '2D floor plan to help buyers visualize the property layout'
      },
      'plus-floor-plan': {
        id: 'plus-floor-plan',
        name: 'Plus Floor Plan',
        price: 36.00,
        description: 'Enhanced 2D floor plan with measurements and room labels'
      },
      'elevate-edit': {
        id: 'elevate-edit',
        name: 'Elevate Your Edit',
        price: 75.00,
        description: 'Transform your video with premium editing including dynamic transitions, bold captions, spotlight features'
      },
      'property-drone-photo': {
        id: 'property-drone-photo',
        name: 'Property Drone Photography',
        price: 130.80,
        description: 'Up to 10 stunning aerial photographs'
      },
      'property-drone-video': {
        id: 'property-drone-video',
        name: 'Property Drone Videography',
        price: 130.80,
        description: 'Up to 30-second cinematic aerial showcase'
      },
      'property-video': {
        id: 'property-video',
        name: 'Property Videography',
        price: 154.80,
        description: 'Shot in 4K to captivate viewers and drive enquiries'
      },
      'property-speed-tours': {
        id: 'property-speed-tours',
        name: 'Property Speed Tours',
        price: 60.00,
        description: 'Quick walkthrough video tour of the property'
      },
      'add-branded-outro': {
        id: 'add-branded-outro',
        name: 'Add Branded Outro To Video',
        price: 0.00,
        description: 'Add your branded outro to any video content'
      }
    };

    // Global state
    let currentView = 'month';
    let currentDate = new Date();
    let allBookings = [];
    let allCustomers = [];
    let currentBooking = null;

    // UK REGIONS - All UK counties and regions
    const UK_REGIONS = [
      // England - North West
      'Cheshire', 'Cumbria', 'Greater Manchester', 'Lancashire', 'Merseyside',
      // England - North East
      'County Durham', 'Northumberland', 'Tyne and Wear',
      // England - Yorkshire and the Humber
      'East Riding of Yorkshire', 'North Yorkshire', 'South Yorkshire', 'West Yorkshire',
      // England - East Midlands
      'Derbyshire', 'Leicestershire', 'Lincolnshire', 'Northamptonshire', 'Nottinghamshire', 'Rutland',
      // England - West Midlands
      'Herefordshire', 'Shropshire', 'Staffordshire', 'Warwickshire', 'West Midlands', 'Worcestershire',
      // England - East of England
      'Bedfordshire', 'Cambridgeshire', 'Essex', 'Hertfordshire', 'Norfolk', 'Suffolk',
      // England - South East
      'Berkshire', 'Buckinghamshire', 'East Sussex', 'Hampshire', 'Isle of Wight', 'Kent', 'Oxfordshire', 'Surrey', 'West Sussex',
      // England - South West
      'Bristol', 'Cornwall', 'Devon', 'Dorset', 'Gloucestershire', 'Somerset', 'Wiltshire',
      // England - London
      'Greater London',
      // Scotland
      'Aberdeenshire', 'Angus', 'Argyll and Bute', 'City of Edinburgh', 'Clackmannanshire', 
      'Dumfries and Galloway', 'Dundee City', 'East Ayrshire', 'East Dunbartonshire', 'East Lothian',
      'East Renfrewshire', 'Falkirk', 'Fife', 'Glasgow City', 'Highland', 'Inverclyde',
      'Midlothian', 'Moray', 'North Ayrshire', 'North Lanarkshire', 'Orkney Islands',
      'Perth and Kinross', 'Renfrewshire', 'Scottish Borders', 'Shetland Islands', 'South Ayrshire',
      'South Lanarkshire', 'Stirling', 'West Dunbartonshire', 'West Lothian', 'Western Isles',
      // Wales
      'Anglesey', 'Blaenau Gwent', 'Bridgend', 'Caerphilly', 'Cardiff', 'Carmarthenshire',
      'Ceredigion', 'Conwy', 'Denbighshire', 'Flintshire', 'Gwynedd', 'Merthyr Tydfil',
      'Monmouthshire', 'Neath Port Talbot', 'Newport', 'Pembrokeshire', 'Powys', 'Rhondda Cynon Taf',
      'Swansea', 'Torfaen', 'Vale of Glamorgan', 'Wrexham',
      // Northern Ireland
      'Antrim', 'Armagh', 'Down', 'Fermanagh', 'Londonderry', 'Tyrone'
    ].sort();

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardStats();
      loadCalendar();
      loadBookings();
      loadPendingBookings();
      loadCustomers();
    });

    // Navigation
    function showSection(sectionId) {
      document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(sectionId).classList.add('active');
      
      const navItem = [...document.querySelectorAll('.nav-item')].find(n => 
        n.getAttribute('onclick')?.includes(`showSection('${sectionId}')`)
      );
      if (navItem) navItem.classList.add('active');

      if (window.innerWidth <= 1024) {
        document.getElementById('adminSidebar').classList.remove('open');
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('adminSidebar');
      sidebar.classList.toggle('open');
      
      if (sidebar.classList.contains('open')) {
        document.addEventListener('click', closeSidebarOutside);
      } else {
        document.removeEventListener('click', closeSidebarOutside);
      }
    }

    function closeSidebarOutside(event) {
      const sidebar = document.getElementById('adminSidebar');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      
      if (!sidebar.contains(event.target) && !menuBtn.contains(event.target)) {
        sidebar.classList.remove('open');
        document.removeEventListener('click', closeSidebarOutside);
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Dashboard Stats
    async function loadDashboardStats() {
      try {
        const response = await fetch('/.netlify/functions/admin-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();
        
        if (data.success) {
          document.getElementById('totalBookings').textContent = data.stats.total;
          document.getElementById('upcomingBookings').textContent = data.stats.upcoming;
          document.getElementById('pendingBookings').textContent = data.stats.pending;
        }

        // Load customer count
        const customersResponse = await fetch('/.netlify/functions/admin-users');
        const customersData = await customersResponse.json();
        
        if (customersData.success) {
          document.getElementById('totalCustomers').textContent = customersData.total;
        }

      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }

    // Calendar Functions
    function setCalendarView(view) {
      currentView = view;
      document.querySelectorAll('.calendar-view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      loadCalendar();
    }

    function previousPeriod() {
      if (currentView === 'month') {
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
      } else if (currentView === 'week') {
        currentDate = new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000);
      } else {
        currentDate = new Date(currentDate.getTime() - 24 * 60 * 60 * 1000);
      }
      loadCalendar();
    }

    function nextPeriod() {
      if (currentView === 'month') {
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
      } else if (currentView === 'week') {
        currentDate = new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000);
      } else {
        currentDate = new Date(currentDate.getTime() + 24 * 60 * 60 * 1000);
      }
      loadCalendar();
    }

    async function loadCalendar() {
      const grid = document.getElementById('calendarGrid');
      const currentEl = document.getElementById('calendarCurrent');
      const region = document.getElementById('calendarRegion')?.value || '';

      grid.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        let startDate, endDate;

        if (currentView === 'month') {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          startDate = new Date(year, month, 1).toISOString().split('T')[0];
          endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
          
          currentEl.textContent = currentDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
        } else if (currentView === 'week') {
          const tempDate = new Date(currentDate);
          const day = tempDate.getDay();
          const diff = tempDate.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(tempDate.setDate(diff));
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          
          startDate = monday.toISOString().split('T')[0];
          endDate = sunday.toISOString().split('T')[0];
          
          currentEl.textContent = `Week of ${monday.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' })} - ${sunday.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' })}`;
        } else {
          startDate = currentDate.toISOString().split('T')[0];
          endDate = startDate;
          
          currentEl.textContent = currentDate.toLocaleDateString('en-GB', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        }

        const response = await fetch('/.netlify/functions/admin-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ startDate, endDate, region })
        });

        const data = await response.json();

        if (data.success) {
          allBookings = data.bookings; // ‚úÖ critical so View works from calendar
          if (currentView === 'month') {
            renderMonthView(data.bookings);
          } else if (currentView === 'week') {
            renderWeekView(data.bookings);
          } else {
            renderDayView(data.bookings);
          }
        }

      } catch (error) {
        console.error('Error loading calendar:', error);
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading calendar</div>';
      }
    }

    function renderMonthView(bookings) {
      const grid = document.getElementById('calendarGrid');
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay() || 7; // 1=Monday, 7=Sunday

      let html = '<div class="calendar-grid month">';
      
      // Day headers
      ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });

      // Empty cells before first day
      for (let i = 1; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day other-month"></div>';
      }

      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayBookings = bookings.filter(b => b.fields['Date'] === dateStr);
        
        const today = new Date();
        const isToday = dateStr === today.toISOString().split('T')[0];
        
        html += `<div class="calendar-day ${isToday ? 'today' : ''}">`;
        html += `<div class="calendar-day-number">${day}</div>`;
        
        dayBookings.forEach(booking => {
       const paymentStatus = booking.fields['Payment Status'] || 'Pending';

const statusClass =
  booking.fields['Booking Status'] === 'Cancelled'
    ? 'cancelled'
    : paymentStatus === 'Pending'
    ? 'pending'
    : '';

          html += `<div class="calendar-booking ${statusClass}" onclick="viewBookingById('${booking.id}')">${booking.fields['Time']} ${booking.fields['Client Name']}</div>`;
        });
        
        html += '</div>';
      }

      html += '</div>';
      grid.innerHTML = html;
    }

    function renderWeekView(bookings) {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '<div style="padding: 40px; text-align: center;">Week view coming soon...</div>';
    }

    function renderDayView(bookings) {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '<div style="padding: 40px; text-align: center;">Day view coming soon...</div>';
    }

    // Bookings Functions
    async function loadBookings() {
      const container = document.getElementById('bookingsContainer');
      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        const search = document.getElementById('bookingSearch')?.value || '';
        const region = document.getElementById('bookingRegion')?.value || '';
        const status = document.getElementById('bookingStatus')?.value || '';

        const response = await fetch('/.netlify/functions/admin-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ region, status })
        });

        const data = await response.json();

        if (data.success) {
          allBookings = data.bookings;
          renderBookingsTable(allBookings, search);
        }

      } catch (error) {
        console.error('Error loading bookings:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading bookings</div>';
      }
    }

   async function loadPendingBookings() {
  const container = document.getElementById('pendingContainer');
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

  try {
    const response = await fetch('/.netlify/functions/admin-bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentStatus: 'Pending' })
    });

    const data = await response.json();

    if (data.success) {
      // Filter out cancelled bookings
      const activeBookings = data.bookings.filter(booking => 
        booking.fields['Booking Status'] !== 'Cancelled'
      );

      if (activeBookings.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
            <h3 style="color: #64748b; margin-bottom: 8px;">All Caught Up!</h3>
            <p style="color: #94a3b8;">No reserved bookings require payment</p>
          </div>
        `;
      } else {
        renderPendingBookingsTable(activeBookings);
      }
    }

  } catch (error) {
    console.error('Error loading reserved bookings:', error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading reserved bookings</div>';
  }
}

// NEW FUNCTION: Render pending bookings with payment actions
function renderPendingBookingsTable(bookings) {
  const container = document.getElementById('pendingContainer');
  
  // Sort by date (earliest first)
  const sorted = bookings.sort((a, b) => {
    const dateA = new Date(a.fields['Date']);
    const dateB = new Date(b.fields['Date']);
    return dateA - dateB;
  });

  let html = `
    <div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; color: #92400e;">
      <strong>‚ö†Ô∏è ${bookings.length} booking${bookings.length === 1 ? '' : 's'} awaiting payment</strong>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th>Reference</th>
          <th>Date & Time</th>
          <th>Client</th>
          <th>Service</th>
          <th>Amount</th>
<th>Reserved Date</th>
<th>Booking Status</th>
<th>Payment Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  sorted.forEach(booking => {
    const totalPrice = (booking.fields['Total Price'] || 0).toFixed(2);
    const pendingDate = booking.fields['Created Date'] || '-';
    const hasPaymentMethod = booking.fields['Stripe Payment Method ID'] ? true : false;
    
    html += `
      <tr>
        <td data-label="Reference">
          <strong>${booking.fields['Booking Reference']}</strong>
        </td>
        <td data-label="Date & Time">
          ${booking.fields['Date']}<br>
          <span style="color: #3b82f6; font-weight: 600;">${booking.fields['Time']}</span>
        </td>
        <td data-label="Client">
          ${booking.fields['Client Name']}<br>
          <small style="color: #64748b;">${booking.fields['Client Email']}</small>
        </td>
        <td data-label="Service">
          ${booking.fields['Service'] || '-'}
        </td>
        <td data-label="Amount">
          <span style="font-size: 18px; font-weight: 700; color: #f59e0b;">¬£${totalPrice}</span>
        </td>
        <td data-label="Pending">
          ${new Date(pendingDate).toLocaleDateString('en-GB')}
        </td>
        <td data-label="Booking Status">
  <span class="status-badge status-${(booking.fields['Booking Status'] || 'booked').toLowerCase()}">
    ${booking.fields['Booking Status'] || 'Booked'}
  </span>
</td>
        <td data-label="Actions">
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            ${hasPaymentMethod ? `
              <button class="btn btn-success btn-small" onclick="chargePendingBooking('${booking.id}')" title="Charge the customer's saved card">
                üí≥ Charge Card
              </button>
            ` : `
              <span style="font-size: 11px; color: #94a3b8; font-style: italic;">No saved card</span>
            `}
            <button class="btn btn-primary btn-small" onclick='processPayment("${booking.id}", "${booking.fields['Booking Reference']}", this)' title="Email payment link to customer">
  üìß Send Link
</button>
            <button class="btn btn-secondary btn-small" onclick="viewBookingById('${booking.id}')" title="View full booking details">
              üëÅÔ∏è View
            </button>
          </div>
        </td>
      </tr>
    `;
  });

  html += `
      </tbody>
    </table>
    
    <div style="margin-top: 24px; padding: 16px; background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px;">
      <h4 style="margin: 0 0 12px 0; color: #1e40af;">üí° Payment Options</h4>
      <ul style="margin: 0; padding-left: 20px; color: #1e40af; line-height: 1.8;">
        <li><strong>Charge Card:</strong> Instantly charge the customer's saved payment method (if available)</li>
        <li><strong>Send Link:</strong> Email a secure payment link to the customer</li>
        <li><strong>View:</strong> See full booking details and additional options</li>
      </ul>
    </div>
  `;

  container.innerHTML = html;
}

    function renderBookingsTable(bookings, search = '', containerId = 'bookingsContainer') {
      const container = document.getElementById(containerId);
      
      let filtered = bookings;
      if (search) {
        const term = search.toLowerCase();
        filtered = bookings.filter(b => 
          (b.fields['Client Name'] || '').toLowerCase().includes(term) ||
          (b.fields['Client Email'] || '').toLowerCase().includes(term) ||
          (b.fields['Property Address'] || '').toLowerCase().includes(term) ||
          (b.fields['Booking Reference'] || '').toLowerCase().includes(term)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px;">No bookings found</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Reference</th>
              <th>Date & Time</th>
              <th>Client</th>
              <th>Address</th>
              <th>Service</th>
              <th>Status</th>
              <th>Drive Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(booking => {
        const driveTimeInfo = booking.driveTimeInfo;
        const driveTimeBadge = driveTimeInfo ? `
          <span class="drive-time-badge ${driveTimeInfo.hasConflict ? 'error' : driveTimeInfo.bufferTime.surplus < 15 ? 'warning' : ''}">
            üöó ${driveTimeInfo.driveTimeFormatted} ${driveTimeInfo.hasConflict ? '‚ö†Ô∏è' : ''}
          </span>
        ` : '-';

        html += `
          <tr>
            <td data-label="Reference"><strong>${booking.fields['Booking Reference']}</strong></td>
            <td data-label="Date & Time">${booking.fields['Date']}<br>${booking.fields['Time']}</td>
            <td data-label="Client">
              ${booking.fields['Client Name']}<br>
              <small style="color: #64748b;">${booking.fields['Client Email']}</small>
            </td>
            <td data-label="Address">${booking.fields['Property Address'] || '-'}</td>
            <td data-label="Service">${booking.fields['Service'] || '-'}</td>
            <td data-label="Status">
  <span class="status-badge status-${(booking.fields['Booking Status'] || 'booked').toLowerCase()}">
    ${booking.fields['Booking Status'] || 'Booked'}
  </span>
  <br>
  <span class="status-badge status-${(booking.fields['Payment Status'] || 'pending').toLowerCase()}" style="font-size: 11px;">
    üí≥ ${booking.fields['Payment Status'] || 'Pending'}
  </span>
</td>
            <td data-label="Drive Time">${driveTimeBadge}</td>
            <td data-label="Actions">
              <button class="btn btn-primary btn-small" onclick="viewBookingById('${booking.id}')">
                View
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function viewBookingById(bookingId) {
      const booking = allBookings.find(b => b.id === bookingId);
      if (!booking) {
        alert('Booking not found');
        return;
      }
      viewBooking(booking);
    }

    function viewBooking(booking) {
      currentBooking = booking;
      const modal = document.getElementById('bookingModal');
      const title = document.getElementById('bookingModalTitle');
      const body = document.getElementById('bookingModalBody');

      title.textContent = `Booking ${booking.fields['Booking Reference']}`;

      const driveTimeSection = booking.driveTimeInfo ? `
        <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 16px; margin: 16px 0;">
          <h4 style="margin: 0 0 12px 0; color: #1e40af;">üöó Drive Time Information</h4>
          <div class="detail-item">
            <span class="detail-label">From Previous Booking</span>
            <span class="detail-value">${booking.driveTimeInfo.fromBooking}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Drive Time</span>
            <span class="detail-value">${booking.driveTimeInfo.driveTimeFormatted}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Previous End Time</span>
            <span class="detail-value">${booking.driveTimeInfo.previousBookingEndTime}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Current Start Time</span>
            <span class="detail-value">${booking.driveTimeInfo.currentBookingStartTime}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Buffer Time</span>
            <span class="detail-value">
              ${booking.driveTimeInfo.bufferTime.available} min 
              (${booking.driveTimeInfo.bufferTime.sufficient ? '‚úì Sufficient' : '‚ö†Ô∏è Tight Schedule'})
            </span>
          </div>
          ${booking.driveTimeInfo.hasConflict ? `
            <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 12px; margin-top: 12px; color: #991b1b;">
              <strong>‚ö†Ô∏è Schedule Conflict:</strong> Insufficient time between bookings
            </div>
          ` : ''}
        </div>
      ` : '';

      const isPending = booking.fields['Payment Status'] === 'Pending';
      const isCancelled = booking.fields['Booking Status'] === 'Cancelled';

      body.innerHTML = `
        <div class="detail-item">
          <span class="detail-label">Reference</span>
          <span class="detail-value">${booking.fields['Booking Reference']}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Date & Time</span>
          <span class="detail-value">${booking.fields['Date']} at ${booking.fields['Time']}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Client Name</span>
          <span class="detail-value">${booking.fields['Client Name']}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Client Email</span>
          <span class="detail-value">${booking.fields['Client Email']}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Property Address</span>
          <span class="detail-value">${booking.fields['Property Address'] || '-'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Service</span>
          <span class="detail-value">${booking.fields['Service'] || '-'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Total Price</span>
          <span class="detail-value">¬£${(booking.fields['Total Price'] || 0).toFixed(2)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Payment Status</span>
          <span class="detail-value">
            <span class="status-badge status-${(booking.fields['Payment Status'] || '').toLowerCase()}">
              ${booking.fields['Payment Status'] || '-'}
            </span>
          </span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Booking Status</span>
          <span class="detail-value">
            <span class="status-badge status-${isCancelled ? 'cancelled' : 'active'}">
              ${booking.fields['Booking Status'] || 'Booked'}
            </span>
          </span>
        </div>
        ${driveTimeSection}
        
        ${!isCancelled ? `
          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
            <div class="action-buttons-grid">
              
              ${isPending ? `
                <button class="btn btn-success" onclick="chargePendingBooking('${booking.id}')" style="width: 100%; justify-content: center;">
                  üí≥ Charge Card
                </button>
                <button class="btn btn-primary" onclick='processPayment("${booking.id}", "${booking.fields['Booking Reference']}")' style="width: 100%; justify-content: center;">
                  üìß Send Payment Link
                </button>
              ` : ''}
              
              <button class="btn btn-primary" onclick="showAdminReschedule('${booking.id}')" style="width: 100%; justify-content: center;">
                üìÖ Reschedule
              </button>
              
              <button class="btn btn-secondary" onclick="showModifyService('${booking.id}')" style="width: 100%; justify-content: center;">
                ‚úèÔ∏è Modify Service
              </button>
              
              <button class="btn btn-danger" onclick="showAdminCancel('${booking.id}')" style="width: 100%; justify-content: center;">
                ‚ùå Cancel
              </button>
            </div>

            <div class="info-box" style="margin-top: 16px;">
              <strong>‚ÑπÔ∏è Admin Actions:</strong> These actions will automatically send email notifications to customers.
            </div>
          </div>
        ` : `
          <div style="margin-top: 24px; padding: 16px; background: #fee2e2; border: 2px solid #ef4444; border-radius: 12px; text-align: center; color: #991b1b;">
            <strong>‚ùå This booking has been cancelled</strong>
          </div>
        `}
      `;

      modal.classList.add('active');
    }

   async function processPayment(bookingId, bookingRef) {
  if (!confirm(`Send payment link for booking ${bookingRef}?\n\nThe customer will receive an email with a secure payment link.`)) return;

  // Show loading state
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '‚è≥ Sending...';
  btn.disabled = true;

  try {
    const response = await fetch('/.netlify/functions/process-reserved-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId, bookingRef })
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úÖ Payment link sent successfully!\n\nEmail sent to customer\n\nPayment URL:\n${data.paymentLink}`);
      closeModal('bookingModal');
      loadBookings();
      loadPendingBookings();
      loadDashboardStats();
    } else {
      alert(`‚ùå Error: ${data.error}`);
      btn.innerHTML = originalText;
      btn.disabled = false;
    }

  } catch (error) {
    console.error('Error processing payment:', error);
    alert('‚ùå Error sending payment link');
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

    // ===== ADMIN BOOKING ACTIONS =====
    async function chargePendingBooking(bookingId) {
      const booking = allBookings.find(b => b.id === bookingId) || currentBooking;
      if (!booking) return alert('Booking data not found');

      if (booking.fields['Payment Status'] !== 'Pending') {
        alert(`‚ùå Cannot charge card\n\nThis booking is not in "Pending" status.\nCurrent status: ${booking.fields['Payment Status'] || 'Unknown'}\n\nOnly bookings with "Pending" payment status can be charged.`);
        return;
      }

      if (!booking.fields['Stripe Payment Method ID']) {
        alert(`‚ùå No payment method on file\n\nThis booking does not have a saved card.\n\nPlease use "Send Payment Link" instead.`);
        return;
      }

      const clientName = booking.fields['Client Name'];
      const amount = (booking.fields['Total Price'] || 0).toFixed(2);
      
      if (!confirm(`Charge ${clientName}'s saved card?\n\nAmount: ¬£${amount}\n\nThis will immediately charge their payment method and send a confirmation email.`)) return;
      
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Processing...';
      btn.disabled = true;

      try {
        const response = await fetch('/.netlify/functions/charge-card', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bookingId })
        });

        const data = await response.json();

        if (data.success) {
          alert(`‚úÖ Payment Successful!\n\nCharged: ¬£${data.amount.toFixed(2)}\nClient: ${clientName}\n\nConfirmation email sent automatically.`);
          closeModal('bookingModal');
          loadBookings();
          loadPendingBookings();
          loadDashboardStats();
          loadCalendar();
        } else {
          alert(`‚ùå Payment Failed\n\n${data.error || 'Unknown error'}\n\n${data.userMessage || 'Please try sending a payment link instead.'}`);
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      } catch (error) {
        console.error('Error charging card:', error);
        alert('‚ùå System Error\n\nFailed to process payment. Please try again or contact support.');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Show Reschedule Modal
function showAdminReschedule(bookingId) {
  const booking = allBookings.find(b => b.id === bookingId) || currentBooking;
  if (!booking) return;
  
  const modal = document.getElementById('rescheduleModal');
  const modalBody = document.getElementById('rescheduleModalBody');
  
  modalBody.innerHTML = `
    <div class="form-group">
      <label class="form-label">Current Date & Time</label>
      <div style="padding: 12px; background: #f8fafc; border-radius: 8px; font-weight: 600;">
        ${booking.fields['Date']} at ${booking.fields['Time']}
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="rescheduleDate">New Date *</label>
      <input 
        type="date" 
        id="rescheduleDate" 
        class="form-input" 
        value="${booking.fields['Date']}"
        min="${new Date().toISOString().split('T')[0]}"
      />
    </div>

    <div class="form-group">
      <label class="form-label" for="rescheduleTime">New Time *</label>
      <select id="rescheduleTime" class="form-input">
        ${generateTimeOptions(booking.fields['Time'])}
      </select>
    </div>

    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <input type="checkbox" id="rescheduleSendEmail" checked style="width: 20px; height: 20px;">
        <span style="font-size: 14px; font-weight: 600;">Send email notification to customer</span>
      </label>
    </div>

    <div class="button-group" style="margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeModal('rescheduleModal')" style="flex: 1;">
        Cancel
      </button>
      <button class="btn btn-primary" onclick="confirmReschedule('${bookingId}')" style="flex: 2;">
        Confirm Reschedule
      </button>
    </div>
  `;
  
  modal.classList.add('active');
}

function generateTimeOptions(currentTime) {
  const times = [];
  for (let hour = 9; hour <= 17; hour++) {
    for (let minute of [0, 30]) {
      if (hour === 17 && minute === 30) break;
      const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
      const selected = timeStr === currentTime ? 'selected' : '';
      times.push(`<option value="${timeStr}" ${selected}>${timeStr}</option>`);
    }
  }
  return times.join('');
}

async function confirmReschedule(bookingId) {
  const newDate = document.getElementById('rescheduleDate').value;
  const newTime = document.getElementById('rescheduleTime').value;
  const sendEmail = document.getElementById('rescheduleSendEmail').checked;

  if (!newDate || !newTime) {
    alert('Please select both date and time');
    return;
  }

  try {
    const response = await fetch('/.netlify/functions/admin-reschedule-booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId, newDate, newTime, sendEmail })
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úÖ Rescheduled!\n\n${newDate} at ${newTime}\n\n${data.emailSent ? '‚úâÔ∏è Email sent' : 'üîï Silent'}`);
      closeModal('rescheduleModal');
      closeModal('bookingModal');
      loadBookings();
      loadCalendar();
      loadDashboardStats();
    } else {
      alert(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Reschedule error:', error);
    alert('‚ùå Failed to reschedule.');
  }
}

    // Show Cancel Modal
function showAdminCancel(bookingId) {
  const booking = allBookings.find(b => b.id === bookingId) || currentBooking;
  if (!booking) return;
  
  const modal = document.getElementById('cancelModal');
  const modalBody = document.getElementById('cancelModalBody');
  
  modalBody.innerHTML = `
    <div class="warning-box">
      ‚ö†Ô∏è <strong>Warning:</strong> This action cannot be undone. Cancellation fees may apply based on the timing.
    </div>

    <div class="form-group">
      <label class="form-label">Booking Details</label>
      <div style="padding: 12px; background: #f8fafc; border-radius: 8px;">
        <div style="margin-bottom: 8px;"><strong>Client:</strong> ${booking.fields['Client Name']}</div>
        <div style="margin-bottom: 8px;"><strong>Date:</strong> ${booking.fields['Date']} at ${booking.fields['Time']}</div>
        <div><strong>Service:</strong> ${booking.fields['Service']}</div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="cancelReason">Cancellation Reason *</label>
      <select id="cancelReason" class="form-input">
        <option value="">-- Select a reason --</option>
        <option value="Customer request">Customer request</option>
        <option value="Property not ready">Property not ready</option>
        <option value="Weather conditions">Weather conditions</option>
        <option value="Media specialist unavailable">Media specialist unavailable</option>
        <option value="Scheduling conflict">Scheduling conflict</option>
        <option value="Other">Other (specify below)</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label" for="cancelNotes">Additional Notes (Optional)</label>
      <textarea 
        id="cancelNotes" 
        class="form-input" 
        rows="3"
        placeholder="Any additional details about the cancellation..."
      ></textarea>
    </div>

    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <input type="checkbox" id="cancelSendEmail" checked style="width: 20px; height: 20px;">
        <span style="font-size: 14px; font-weight: 600;">Send cancellation email to customer</span>
      </label>
    </div>

    <div class="button-group" style="margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeModal('cancelModal')" style="flex: 1;">
        Keep Booking
      </button>
      <button class="btn btn-danger" onclick="confirmCancel('${bookingId}')" style="flex: 2;">
        Confirm Cancellation
      </button>
    </div>
  `;
  
  modal.classList.add('active');
}

async function confirmCancel(bookingId) {
  const reason = document.getElementById('cancelReason').value;
  const notes = document.getElementById('cancelNotes').value.trim();
  const sendEmail = document.getElementById('cancelSendEmail').checked;

  if (!reason) {
    alert('Please select a cancellation reason');
    document.getElementById('cancelReason').focus();
    return;
  }

  const finalReason = notes ? `${reason}: ${notes}` : reason;

  try {
    const response = await fetch('/.netlify/functions/admin-cancel-booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId, reason: finalReason, sendEmail })
    });

    const data = await response.json();

    if (data.success) {
      let msg = `‚úÖ Cancelled!\n\n`;
      if (data.cancellationCharge > 0) msg += `Fee: ¬£${data.cancellationCharge.toFixed(2)}\n`;
      if (data.refundProcessed) msg += `Refund: ¬£${data.refundAmount.toFixed(2)}\n`;
      msg += `\n${data.emailSent ? '‚úâÔ∏è Email sent' : 'üîï Silent'}`;
      alert(msg);
      closeModal('cancelModal');
      closeModal('bookingModal');
      loadBookings();
      loadCalendar();
      loadDashboardStats();
    } else {
      alert(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Cancel error:', error);
    alert('‚ùå Failed to cancel.');
  }
}

    // Show Modify Service Modal
function showModifyService(bookingId) {
  const booking = allBookings.find(b => b.id === bookingId) || currentBooking;
  if (!booking) return;
  
  const modal = document.getElementById('modifyServiceModal');
  const modalBody = document.getElementById('modifyServiceModalBody');
  
  const region = booking.fields['Region'] === 'North' ? 'north' : 'south';
  const services = SERVICES_CATALOG[region] || SERVICES_CATALOG.south;
  
  modalBody.innerHTML = `
    <div class="form-group">
      <label class="form-label">Current Service</label>
      <div style="padding: 12px; background: #f8fafc; border-radius: 8px; font-weight: 600;">
        ${booking.fields['Service']} - ¬£${(booking.fields['Total Price'] || 0).toFixed(2)}
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="newService">New Service *</label>
      <select id="newService" class="form-input" onchange="updateServicePrice()">
        <option value="">-- Select new service --</option>
        ${services.map(service => `
          <option 
            value="${service.id}" 
            data-price="${service.price}"
            data-duration="${service.duration}"
            data-name="${service.name}"
          >
            ${service.name} - ¬£${service.price.toFixed(2)}
          </option>
        `).join('')}
      </select>
    </div>

    <div id="addonSection" style="display: none; margin-top: 24px;">
      <label class="form-label">Add-Ons (Optional)</label>
      <div id="addonCheckboxes" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Add-ons will be populated dynamically -->
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Bedrooms (if applicable)</label>
      <div style="display: flex; align-items: center; gap: 16px;">
        <button type="button" class="bedroom-btn" onclick="adjustModifyBedrooms(-1)">-</button>
        <div style="flex: 1; text-align: center;">
          <div id="modifyBedroomCount" style="font-size: 32px; font-weight: 700; color: #3b82f6;">4</div>
        </div>
        <button type="button" class="bedroom-btn" onclick="adjustModifyBedrooms(1)">+</button>
      </div>
    </div>

    <div id="modifyPriceBreakdown" style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 24px 0;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
        <span style="color: #64748b;">Service</span>
        <span id="modifyServicePrice" style="font-weight: 600;">¬£0.00</span>
      </div>
      <div id="modifyBedroomRow" style="display: none; justify-content: space-between; margin-bottom: 12px;">
        <span style="color: #64748b;">Extra bedrooms</span>
        <span id="modifyBedroomFee" style="font-weight: 600;">¬£0.00</span>
      </div>
      <div id="modifyAddonsRow" style="display: none; justify-content: space-between; margin-bottom: 12px;">
        <span style="color: #64748b;">Add-ons</span>
        <span id="modifyAddonsFee" style="font-weight: 600;">¬£0.00</span>
      </div>
      <div style="border-top: 2px solid #e2e8f0; margin: 16px 0;"></div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 18px; font-weight: 700;">New Total</span>
        <span id="modifyTotalPrice" style="font-size: 24px; font-weight: 700; color: #3b82f6;">¬£0.00</span>
      </div>
    </div>

    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <input type="checkbox" id="modifySendEmail" checked style="width: 20px; height: 20px;">
        <span style="font-size: 14px; font-weight: 600;">Send update email to customer</span>
      </label>
    </div>

    <div class="button-group" style="margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeModal('modifyServiceModal')" style="flex: 1;">
        Cancel
      </button>
      <button class="btn btn-primary" onclick="confirmModifyService('${bookingId}')" style="flex: 2;">
        Update Service
      </button>
    </div>
  `;
  
  modal.classList.add('active');
}

let modifyServiceData = {
  bedrooms: 4,
  selectedAddons: []
};

function updateServicePrice() {
  const select = document.getElementById('newService');
  const selectedOption = select.options[select.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) {
    document.getElementById('addonSection').style.display = 'none';
    return;
  }

  const serviceId = selectedOption.value;
  const booking = currentBooking || allBookings.find(b => b.id);
  const region = booking?.fields['Region'] === 'North' ? 'north' : 'south';
  const services = SERVICES_CATALOG[region] || SERVICES_CATALOG.south;
  const service = services.find(s => s.id === serviceId);

  // Show add-ons if available
  if (service && service.availableAddons && service.availableAddons.length > 0) {
    const addonContainer = document.getElementById('addonCheckboxes');
    addonContainer.innerHTML = service.availableAddons.map(addonId => {
      const addon = ADDONS_CATALOG[addonId];
      if (!addon) return '';
      
      return `
        <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
          <input 
            type="checkbox" 
            value="${addon.id}" 
            onchange="toggleModifyAddon('${addon.id}')"
            style="width: 20px; height: 20px;"
          >
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${addon.name}</div>
            <div style="font-size: 13px; color: #64748b;">${addon.description}</div>
          </div>
          <div style="font-weight: 700; color: #3b82f6;">
            ${addon.price === 0 ? 'FREE' : `+¬£${addon.price.toFixed(2)}`}
          </div>
        </label>
      `;
    }).join('');
    
    document.getElementById('addonSection').style.display = 'block';
  } else {
    document.getElementById('addonSection').style.display = 'none';
  }

  modifyServiceData.selectedAddons = [];
  calculateModifyPrice();
}

function toggleModifyAddon(addonId) {
  const index = modifyServiceData.selectedAddons.indexOf(addonId);
  if (index > -1) {
    modifyServiceData.selectedAddons.splice(index, 1);
  } else {
    modifyServiceData.selectedAddons.push(addonId);
  }
  calculateModifyPrice();
}

function adjustModifyBedrooms(change) {
  modifyServiceData.bedrooms = Math.max(1, Math.min(15, modifyServiceData.bedrooms + change));
  document.getElementById('modifyBedroomCount').textContent = modifyServiceData.bedrooms;
  calculateModifyPrice();
}

function calculateModifyPrice() {
  const select = document.getElementById('newService');
  const selectedOption = select.options[select.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) return;

  const servicePrice = parseFloat(selectedOption.dataset.price);
  const extraBedrooms = Math.max(0, modifyServiceData.bedrooms - 4);
  const bedroomFee = extraBedrooms * 30;

  let addonsFee = 0;
  modifyServiceData.selectedAddons.forEach(addonId => {
    const addon = ADDONS_CATALOG[addonId];
    if (addon) addonsFee += addon.price;
  });

  const totalPrice = servicePrice + bedroomFee + addonsFee;

  document.getElementById('modifyServicePrice').textContent = `¬£${servicePrice.toFixed(2)}`;
  document.getElementById('modifyTotalPrice').textContent = `¬£${totalPrice.toFixed(2)}`;

  const bedroomRow = document.getElementById('modifyBedroomRow');
  if (bedroomFee > 0) {
    bedroomRow.style.display = 'flex';
    document.getElementById('modifyBedroomFee').textContent = `¬£${bedroomFee.toFixed(2)}`;
  } else {
    bedroomRow.style.display = 'none';
  }

  const addonsRow = document.getElementById('modifyAddonsRow');
  if (addonsFee > 0) {
    addonsRow.style.display = 'flex';
    document.getElementById('modifyAddonsFee').textContent = `¬£${addonsFee.toFixed(2)}`;
  } else {
    addonsRow.style.display = 'none';
  }
}

async function confirmModifyService(bookingId) {
  const select = document.getElementById('newService');
  const selectedOption = select.options[select.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) {
    alert('Please select a new service');
    return;
  }

  const serviceId = selectedOption.value;
  const serviceName = selectedOption.dataset.name;
  const servicePrice = parseFloat(selectedOption.dataset.price);
  const serviceDuration = parseInt(selectedOption.dataset.duration);
  const sendEmail = document.getElementById('modifySendEmail').checked;

  const extraBedrooms = Math.max(0, modifyServiceData.bedrooms - 4);
  const bedroomFee = extraBedrooms * 30;

  let addonsFee = 0;
  const addonsArray = modifyServiceData.selectedAddons.map(addonId => {
    const addon = ADDONS_CATALOG[addonId];
    if (addon) addonsFee += addon.price;
    return {
      id: addonId,
      name: addon?.name || '',
      price: addon?.price || 0
    };
  });

  const totalPrice = servicePrice + bedroomFee + addonsFee;

  try {
    const response = await fetch('/.netlify/functions/admin-modify-service', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        bookingId,
        newServiceId: serviceId,
        newServiceName: serviceName,
        newServicePrice: servicePrice,
        newServiceDuration: serviceDuration,
        bedrooms: modifyServiceData.bedrooms,
        extraBedroomFee: bedroomFee,
        addons: addonsArray,
        addonsPrice: addonsFee,
        totalPrice: totalPrice,
        sendEmail
      })
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úÖ Service Updated!\n\nNew: ${serviceName} (¬£${totalPrice.toFixed(2)})\n\n${data.emailSent ? '‚úâÔ∏è Email sent' : 'üîï Silent'}`);
      closeModal('modifyServiceModal');
      closeModal('bookingModal');
      loadBookings();
      loadCalendar();
      loadDashboardStats();
    } else {
      alert(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Modify service error:', error);
    alert('‚ùå Failed to modify service.');
  }
}

    // Customers Functions
    async function loadCustomers() {
      const container = document.getElementById('customersContainer');
      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        const response = await fetch('/.netlify/functions/admin-users');
        const data = await response.json();

        if (data.success) {
          allCustomers = data.users;
          renderCustomersTable(allCustomers);
        }

      } catch (error) {
        console.error('Error loading customers:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading customers</div>';
      }
    }

    function renderCustomersTable(customers) {
      const container = document.getElementById('customersContainer');
      const search = document.getElementById('customerSearch')?.value || '';

      let filtered = customers;
      if (search) {
        const term = search.toLowerCase();
        filtered = customers.filter(c => 
          (c.fields['Name'] || '').toLowerCase().includes(term) ||
          (c.fields['Email'] || '').toLowerCase().includes(term) ||
          (c.fields['Company'] || '').toLowerCase().includes(term)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px;">No customers found</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Company</th>
              <th>Region</th>
              <th>Status</th>
              <th>Email Alerts</th>
              <th>Reserve Privilege</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(customer => {
        const allowReserve = customer.fields['Allow Reserve Without Payment'] === true;
        const emailNotifications = customer.fields['Email Notifications Enabled'] === true;

        html += `
          <tr>
            <td data-label="Name"><strong>${customer.fields['Name']}</strong></td>
            <td data-label="Email">${customer.fields['Email']}</td>
            <td data-label="Company">${customer.fields['Company'] || '-'}</td>
            <td data-label="Region">
              <select 
                class="region-select" 
                data-user-email="${customer.fields['Email']}" 
                data-record-id="${customer.id}"
                data-original-value="${customer.fields['Region'] || ''}"
                onchange="updateUserRegion(this)"
              >
                <option value="">Select Region...</option>
                ${UK_REGIONS.map(region => `
                  <option value="${region}" ${customer.fields['Region'] === region ? 'selected' : ''}>
                    ${region}
                  </option>
                `).join('')}
              </select>
            </td>
            <td data-label="Status">
              <span class="status-badge status-${(customer.fields['Account Status'] || '').toLowerCase()}">
                ${customer.fields['Account Status'] || '-'}
              </span>
            </td>
            <td data-label="Email Alerts">
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  ${emailNotifications ? 'checked' : ''} 
                  onchange='toggleEmailNotifications("${customer.fields['Email']}", this.checked, "${customer.id}")'
                >
                <span class="toggle-slider"></span>
              </label>
            </td>
            <td data-label="Reserve Privilege">
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  ${allowReserve ? 'checked' : ''} 
                  onchange='toggleReservePrivilege("${customer.id}", "${customer.fields['Email']}", this.checked)'
                >
                <span class="toggle-slider"></span>
              </label>
            </td>
            <td data-label="Actions">
              <button class="btn btn-primary btn-small" onclick='viewCustomer(${JSON.stringify(customer).replace(/'/g, "&#39;")})'>
                View
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function viewCustomer(customer) {
      const modal = document.getElementById('customerModal');
      const title = document.getElementById('customerModalTitle');
      const body = document.getElementById('customerModalBody');

      title.textContent = customer.fields['Name'];

      const allowReserve = customer.fields['Allow Reserve Without Payment'] === true;
      const emailNotificationsEnabled = customer.fields['Email Notifications Enabled'] === true;
      const emailNotificationsStatus = emailNotificationsEnabled ? 'Enabled' : 'Disabled';
      const emailNotificationsColor = emailNotificationsEnabled ? '#10b981' : '#ef4444';

      body.innerHTML = `
        <div class="warning-box">
          ‚ö†Ô∏è <strong>Security Note:</strong> Passwords are hashed and cannot be viewed for security reasons.
        </div>

        <div class="detail-item">
          <span class="detail-label">üë§ Full Name</span>
          <span class="detail-value">${customer.fields['Name']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìß Email Address</span>
          <span class="detail-value">${customer.fields['Email']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üè¢ Company</span>
          <span class="detail-value">${customer.fields['Company'] || 'N/A'}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìç Region</span>
          <span class="detail-value">
            ${customer.fields['Region'] ? 
              `<span class="region-badge">${customer.fields['Region']}</span>` : 
              '<span class="region-badge empty">Not set</span>'
            }
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìÖ Account Created</span>
          <span class="detail-value">${customer.fields['Created Date']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">‚úÖ Account Status</span>
          <span class="detail-value">
            <span class="status-badge status-${(customer.fields['Account Status'] || '').toLowerCase()}">
              ${customer.fields['Account Status'] || 'Unknown'}
            </span>
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üì¨ Milestone Emails</span>
          <span class="detail-value">
            <span style="color: ${emailNotificationsColor}; font-weight: 600;">
              ${emailNotificationsStatus}
            </span>
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üí≥ Allow Reserve Without Payment</span>
          <span class="detail-value">
            <label class="toggle-switch">
              <input 
                type="checkbox" 
                ${allowReserve ? 'checked' : ''} 
                onchange='toggleReservePrivilege("${customer.id}", "${customer.fields['Email']}", this.checked)'
              >
              <span class="toggle-slider"></span>
            </label>
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üîê Password</span>
          <span class="detail-value" style="color: #64748b; font-style: italic;">Encrypted (not visible)</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üÜî Record ID</span>
          <span class="detail-value" style="font-family: monospace; font-size: 12px;">${customer.id}</span>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
          <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
            <button class="btn btn-danger" style="flex: 1;" onclick='redeemPoints("${customer.fields['Email']}", "${customer.fields['Name']}")'>
              ‚≠ê Redeem Points
            </button>
            <button class="btn btn-primary" style="flex: 1;" onclick='impersonateUser("${customer.fields['Email']}")'>
              üîë Login as ${customer.fields['Name']}
            </button>
            <button class="btn btn-secondary" style="flex: 1;" onclick='checkMilestone("${customer.fields['Email']}", "${customer.fields['Name']}")'>
              üìß Check Milestone
            </button>
          </div>
          
          <div style="padding: 16px; background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px;">
            <div style="font-weight: 600; color: #065f46; margin-bottom: 12px; font-size: 14px;">‚ûï Manually Add Points</div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input 
                type="number" 
                id="manualPoints-${customer.id}" 
                placeholder="Enter points amount" 
                min="1"
                style="flex: 1; padding: 10px 14px; border: 2px solid #10b981; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;"
              >
              <button class="btn btn-primary" style="white-space: nowrap;" onclick='addManualPoints("${customer.fields['Email']}", "${customer.fields['Name']}", "${customer.id}")'>
                ‚ûï Add Points
              </button>
            </div>
            <div style="font-size: 12px; color: #047857; margin-top: 8px;">Use this to add bonus/promotional points to the account</div>
          </div>
        </div>
      `;

      modal.classList.add('active');
    }

    async function toggleReservePrivilege(recordId, email, enabled) {
      try {
        const response = await fetch('/.netlify/functions/update-reserve-privilege', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recordId, email, enabled })
        });

        const data = await response.json();

        if (data.success) {
          console.log(`‚úì Reserve privilege ${enabled ? 'enabled' : 'disabled'} for ${email}`);
          // Update local cache
          const customer = allCustomers.find(c => c.id === recordId);
          if (customer) {
            customer.fields['Allow Reserve Without Payment'] = enabled;
          }
        } else {
          alert(`Error: ${data.message}`);
          // Revert toggle
          event.target.checked = !enabled;
        }

      } catch (error) {
        console.error('Error toggling reserve privilege:', error);
        alert('Error updating privilege');
        event.target.checked = !enabled;
      }
    }

    async function updateUserRegion(selectElement) {
      const email = selectElement.dataset.userEmail;
      const recordId = selectElement.dataset.recordId;
      const region = selectElement.value;
      
      const originalValue = selectElement.dataset.originalValue || '';
      selectElement.disabled = true;
      
      try {
        const response = await fetch('/.netlify/functions/update-user-region', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userEmail: email,
            recordId: recordId,
            region: region
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update region');
        }

        const result = await response.json();

        // Update the user in allCustomers array
        const userIndex = allCustomers.findIndex(u => u.fields['Email'] === email);
        if (userIndex !== -1) {
          allCustomers[userIndex].fields['Region'] = region;
        }

        // Store new value
        selectElement.dataset.originalValue = region;
        selectElement.disabled = false;
        
        console.log(`‚úÖ Region updated to "${region}" for ${email}`);

      } catch (error) {
        console.error('Error updating region:', error);
        alert(`‚ùå Failed to update region: ${error.message}`);
        
        // Revert selection
        selectElement.value = originalValue;
        selectElement.disabled = false;
      }
    }

    async function toggleEmailNotifications(email, enabled, recordId) {
      try {
        // Show loading state
        const toggleInput = event.target;
        toggleInput.disabled = true;

        const response = await fetch('/.netlify/functions/toggle-email-notifications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userEmail: email,
            enabled: enabled,
            recordId: recordId
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update email notification settings');
        }

        const result = await response.json();
        
        // Update the user in allCustomers array
        const userIndex = allCustomers.findIndex(u => u.fields['Email'] === email);
        if (userIndex !== -1) {
          allCustomers[userIndex].fields['Email Notifications Enabled'] = enabled;
        }

        // Show success message briefly
        const statusText = enabled ? 'enabled' : 'disabled';
        console.log(`‚úÖ Email notifications ${statusText} for ${email}`);
        
        toggleInput.disabled = false;

      } catch (error) {
        console.error('Error toggling email notifications:', error);
        alert(`‚ùå Failed to update email notifications: ${error.message}`);
        
        // Revert the toggle
        event.target.checked = !enabled;
        event.target.disabled = false;
      }
    }

    function impersonateUser(email) {
      const user = allCustomers.find(c => c.fields['Email'] === email);
      if (!user) {
        alert('User data not found');
        return;
      }

      if (confirm(`Login as ${user.fields['Name']}?\n\nThis will open their dashboard in a new tab.`)) {
        const sessionData = {
          email: email,
          name: user.fields['Name'] || 'Client',
          company: user.fields['Company'] || '',
          timestamp: Date.now(),
          expires: Date.now() + (24 * 60 * 60 * 1000),
          adminImpersonation: true
        };

        const token = btoa(JSON.stringify(sessionData));
        
        const baseUrl = window.location.origin;
        const dashboardUrl = baseUrl + '/website/dashboard.html?admin_session=' + encodeURIComponent(token) + 
                            '&admin_email=' + encodeURIComponent(email) +
                            '&admin_name=' + encodeURIComponent(user.fields['Name'] || 'Client') +
                            '&admin_company=' + encodeURIComponent(user.fields['Company'] || '');
        
        window.open(dashboardUrl, '_blank');
        alert(`‚úì Logged in as ${user.fields['Name']}`);
      }
    }

    // Real-time search
    document.getElementById('bookingSearch')?.addEventListener('input', (e) => {
      renderBookingsTable(allBookings, e.target.value);
    });

    document.getElementById('customerSearch')?.addEventListener('input', (e) => {
      renderCustomersTable(allCustomers);
    });

    // Rewards and Points Management
    async function redeemPoints(email, name) {
      if (!email) {
        alert('Email address is required');
        return;
      }
      
      const user = allCustomers.find(u => u.fields['Email'] === email);
      if (!user) {
        alert('User data not found');
        return;
      }
      
      try {
        // Get booking points from Acuity
        const acuityResponse = await fetch('/.netlify/functions/acuity-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userEmail: email })
        });
        
        if (!acuityResponse.ok) {
          throw new Error('Failed to fetch Acuity data');
        }

        const acuityData = await acuityResponse.json();
        const bookingPoints = Math.floor(acuityData.totalInvestment ?? 0);
        
        // Get manual points AND baseline from Airtable
        const manualPointsResponse = await fetch('/.netlify/functions/get-manual-points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userEmail: email })
        });
        
        const manualPointsData = await manualPointsResponse.json();
        const manualPoints = manualPointsData?.manualPoints || 0;
        const lastRedemptionBaseline = manualPointsData?.lastRedemptionBaseline || 0;
        
        // Calculate NET booking points (subtract baseline) and total points
        const netBookingPoints = Math.max(0, bookingPoints - lastRedemptionBaseline);
        const currentPoints = netBookingPoints + manualPoints;
        const pointsValue = (currentPoints / 100).toFixed(2);

        if (currentPoints === 0) {
          alert(`${name} has no points to redeem.`);
          return;
        }

        // Ask how many points to redeem
        const pointsToRedeem = prompt(`How many points would you like to redeem for ${name}?\n\nAvailable: ${currentPoints} pts (¬£${pointsValue})\n  ‚Ä¢ Net Booking Points: ${netBookingPoints}\n  ‚Ä¢ Manual Points: ${manualPoints}\n\nEnter amount (or leave blank to redeem all):`);
        
        if (pointsToRedeem === null) {
          return; // User cancelled
        }

        let finalPointsToRedeem = currentPoints; // Default: redeem all
        
        if (pointsToRedeem.trim() !== '') {
          finalPointsToRedeem = parseInt(pointsToRedeem);
          
          if (isNaN(finalPointsToRedeem) || finalPointsToRedeem <= 0) {
            alert('Please enter a valid number greater than 0.');
            return;
          }
          
          if (finalPointsToRedeem > currentPoints) {
            alert(`Cannot redeem ${finalPointsToRedeem} points. Only ${currentPoints} points available.`);
            return;
          }
        }

        const finalValue = (finalPointsToRedeem / 100).toFixed(2);

        if (!confirm(`Confirm redemption for ${name}?\n\nRedeeming: ${finalPointsToRedeem} pts (¬£${finalValue})\nRemaining: ${currentPoints - finalPointsToRedeem} pts\n\nContinue?`)) {
          return;
        }

        // Call the redemption endpoint
        const response = await fetch('/.netlify/functions/redeem-points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userEmail: email,
            redeemedPoints: finalPointsToRedeem,
            redeemedValue: finalValue,
            acuityTotalInvestment: acuityData.totalInvestment,
            currentTotalPoints: currentPoints
          })
        });

        if (!response.ok) {
          throw new Error('Failed to redeem points');
        }

        const result = await response.json();
        
        alert(`‚úÖ Points redeemed successfully!\n\n${name} redeemed ${finalPointsToRedeem} points (¬£${finalValue})\n\nRemaining: ${currentPoints - finalPointsToRedeem} points`);
        
        // Refresh the user list and close modal
        loadCustomers();
        closeModal('customerModal');

      } catch (error) {
        console.error('Error redeeming points:', error);
        alert(`‚ùå Failed to redeem points: ${error.message}\n\nPlease try again.`);
      }
    }

    async function addManualPoints(email, name, userId) {
      const input = document.getElementById(`manualPoints-${userId}`);
      const pointsToAdd = parseInt(input.value);
      
      if (!pointsToAdd || pointsToAdd <= 0) {
        alert('Please enter a valid points amount (greater than 0)');
        return;
      }
      
      if (!confirm(`Add ${pointsToAdd} bonus points to ${name}?\n\nThis will be recorded as a manual adjustment and will increase their total points balance.`)) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/add-manual-points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userEmail: email,
            pointsToAdd: pointsToAdd,
            addedBy: 'Admin',
            reason: 'Manual adjustment'
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to add points');
        }
        
        const result = await response.json();
        alert(`‚úÖ Successfully added ${pointsToAdd} points to ${name}!\n\nNew total: ${result.newTotal} points`);
        
        // Clear input and refresh
        input.value = '';
        loadCustomers();
        closeModal('customerModal');
        
      } catch (error) {
        console.error('Error adding points:', error);
        alert(`‚ùå Failed to add points: ${error.message}\n\nPlease try again.`);
      }
    }

    async function checkMilestone(email, name) {
      if (!email) {
        alert('Email address is required');
        return;
      }
      
      if (!confirm(`Check milestone for ${name}?\n\nThis will check if they've reached a new milestone and send an email if applicable.`)) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/check-milestone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userEmail: email })
        });
        
        if (!response.ok) {
          throw new Error('Failed to check milestone');
        }
        
        const result = await response.json();
        
        if (result.skipped) {
          alert(`‚ÑπÔ∏è Email notifications are disabled for ${name}`);
        } else if (result.emailSent) {
          alert(`‚úÖ Milestone email sent to ${name}!\n\nMilestone: ${result.milestone.tier} (${result.milestone.points} points)\nCurrent Balance: ${result.currentBalance} points`);
        } else {
          alert(`‚ÑπÔ∏è No new milestone reached for ${name}\n\nCurrent Balance: ${result.currentBalance} points\nLast Milestone: ${result.lastMilestoneReached} points`);
        }
        
        // Refresh user list
        loadCustomers();
        
      } catch (error) {
        console.error('Error checking milestone:', error);
        alert(`‚ùå Failed to check milestone: ${error.message}\n\nPlease try again.`);
      }
    }

    // Scroll input into view when keyboard appears on mobile/tablet
    if (window.innerWidth <= 1024) {
      document.addEventListener('focusin', function(e) {
        if (e.target.matches('input[type="number"]')) {
          setTimeout(() => {
            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      });
    }
  </script>
</body>
</html>