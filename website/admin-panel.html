<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Markeb Media</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      color: #1e293b;
    }

    /* Sidebar Navigation */
    .admin-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: #fff;
      border-right: 2px solid #e2e8f0;
      padding: 24px;
      overflow-y: auto;
      z-index: 1000;
    }

    .admin-logo {
      font-size: 24px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 32px;
      text-align: center;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      padding-left: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      color: #64748b;
      text-decoration: none;
      font-weight: 500;
      transition: all .2s ease;
      cursor: pointer;
      margin-bottom: 4px;
    }

    .nav-item:hover {
      background: #f1f5f9;
      color: #0f172a;
    }

    .nav-item.active {
      background: #3b82f6;
      color: #fff;
    }

    .nav-icon {
      font-size: 18px;
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .admin-main {
      margin-left: 260px;
      min-height: 100vh;
      padding: 24px;
    }

    .admin-header {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-title {
      font-size: 28px;
      font-weight: 700;
      color: #0f172a;
    }

    .admin-subtitle {
      color: #64748b;
      font-size: 14px;
      margin-top: 4px;
    }

    .admin-badge {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    /* Sections */
    .admin-section {
      display: none;
    }

    .admin-section.active {
      display: block;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 8px;
    }

    .stat-label {
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
    }

    /* Tables */
    .data-table {
      width: 100%;
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
    }

    .data-table thead {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
    }

    .data-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
    }

    .data-table td {
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }

    .data-table tbody tr:hover {
      background: #f8fafc;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all .2s ease;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3b82f6;
      color: #fff;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: #fff;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: #fff;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Calendar */
    .calendar-container {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .calendar-nav {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .calendar-current {
      font-size: 20px;
      font-weight: 700;
      color: #0f172a;
      min-width: 200px;
      text-align: center;
    }

    .calendar-view-selector {
      display: flex;
      gap: 4px;
      background: #f1f5f9;
      padding: 4px;
      border-radius: 8px;
    }

    .calendar-view-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      color: #64748b;
      transition: all .2s ease;
    }

    .calendar-view-btn.active {
      background: #fff;
      color: #3b82f6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .calendar-grid {
      display: grid;
      gap: 1px;
      background: #e2e8f0;
      border: 1px solid #e2e8f0;
    }

    /* Month View */
    .calendar-grid.month {
      grid-template-columns: repeat(7, 1fr);
    }

    .calendar-day-header {
      background: #f8fafc;
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      color: #64748b;
    }

    .calendar-day {
      background: #fff;
      min-height: 120px;
      padding: 8px;
      position: relative;
    }

    .calendar-day-number {
      font-weight: 600;
      font-size: 14px;
      color: #0f172a;
      margin-bottom: 4px;
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .calendar-day.today {
      background: #eff6ff;
      border: 2px solid #3b82f6;
    }

    .calendar-booking {
      background: #3b82f6;
      color: #fff;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 11px;
      margin-bottom: 2px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .calendar-booking:hover {
      background: #2563eb;
    }

    .calendar-booking.reserved {
      background: #f59e0b;
    }

    .calendar-booking.cancelled {
      background: #ef4444;
    }

    /* Week View */
    .calendar-grid.week {
      grid-template-columns: 80px repeat(7, 1fr);
    }

    .calendar-time-slot {
      background: #f8fafc;
      padding: 8px;
      font-size: 12px;
      color: #64748b;
      text-align: right;
      border-right: 2px solid #e2e8f0;
    }

    .calendar-week-slot {
      background: #fff;
      padding: 4px;
      min-height: 60px;
      position: relative;
    }

    /* Day View */
    .calendar-grid.day {
      grid-template-columns: 80px 1fr;
    }

    /* Drive Time Badge */
    .drive-time-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: #dbeafe;
      color: #1e40af;
    }

    .drive-time-badge.warning {
      background: #fef3c7;
      color: #92400e;
    }

    .drive-time-badge.error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: .3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Filters */
    .filters-bar {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-input {
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      flex: 1;
      min-width: 200px;
    }

    .filter-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .filter-select {
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
    }

    /* Loading */
    .spinner {
      margin: 30px auto;
      width: 50px;
      height: 50px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-dialog {
      background: #fff;
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      border-radius: 16px 16px 0 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s ease;
      line-height: 1;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 24px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: #64748b;
      font-size: 14px;
    }

    .detail-value {
      color: #0f172a;
      font-weight: 500;
      text-align: right;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-paid {
      background: #d1fae5;
      color: #065f46;
    }

    .status-reserved {
      background: #fef3c7;
      color: #92400e;
    }

    .status-cancelled {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Region Dropdown */
    .region-select {
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      background: #fff;
      color: #0f172a;
      cursor: pointer;
      transition: all .2s ease;
      min-width: 140px;
      max-width: 180px;
    }

    .region-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .region-select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8f9fa;
    }

    .region-select:hover:not(:disabled) {
      border-color: #cbd5e1;
    }

    /* Region badge */
    .region-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #eff6ff;
      color: #1e40af;
      border: 2px solid #bfdbfe;
    }

    .region-badge.empty {
      background: #f1f5f9;
      color: #64748b;
      border-color: #e2e8f0;
      font-style: italic;
    }

    /* Warning/Info boxes */
    .warning-box {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      color: #92400e;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .admin-sidebar {
        transform: translateX(-100%);
        transition: transform .3s ease;
      }

      .admin-sidebar.open {
        transform: translateX(0);
      }

      .admin-main {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: block;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 999;
        background: #3b82f6;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
      }

      .calendar-grid.month .calendar-day {
        min-height: 80px;
      }

      .calendar-booking {
        font-size: 10px;
      }
    }

    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .filters-bar {
        flex-direction: column;
      }

      .filter-input {
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .calendar-grid.month .calendar-day {
        min-height: 60px;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table thead {
        display: none;
      }

      .data-table, 
      .data-table tbody, 
      .data-table tr, 
      .data-table td {
        display: block;
        width: 100%;
      }

      .data-table tr {
        margin-bottom: 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
      }

      .data-table td {
        padding: 8px 0;
        border: none;
        position: relative;
        padding-left: 50%;
      }

      .data-table td:before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 45%;
        padding-right: 10px;
        font-weight: 600;
        color: #64748b;
        font-size: 11px;
        text-transform: uppercase;
      }
    }

    .mobile-menu-btn {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

  <!-- Sidebar Navigation -->
  <div class="admin-sidebar" id="adminSidebar">
    <div class="admin-logo">üõ°Ô∏è MARKEB ADMIN</div>

    <div class="nav-section">
      <div class="nav-section-title">Overview</div>
      <div class="nav-item active" onclick="showSection('dashboard')">
        <span class="nav-icon">üìä</span>
        Dashboard
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Bookings</div>
      <div class="nav-item" onclick="showSection('calendar')">
        <span class="nav-icon">üìÖ</span>
        Calendar
      </div>
      <div class="nav-item" onclick="showSection('bookings')">
        <span class="nav-icon">üìã</span>
        All Bookings
      </div>
      <div class="nav-item" onclick="showSection('reserved')">
        <span class="nav-icon">üí≥</span>
        Reserved (Need Payment)
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Customers</div>
      <div class="nav-item" onclick="showSection('customers')">
        <span class="nav-icon">üë•</span>
        All Customers
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Tools</div>
      <div class="nav-item" onclick="window.open('uk-client-map.html', '_blank')">
        <span class="nav-icon">üó∫Ô∏è</span>
        UK Map
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-main">
    <!-- Header -->
    <div class="admin-header">
      <div>
        <div class="admin-title">Admin Panel</div>
        <div class="admin-subtitle">Manage bookings, customers, and payments</div>
      </div>
      <div class="admin-badge">‚ö†Ô∏è ADMIN ACCESS</div>
    </div>

    <!-- Dashboard Section -->
    <div class="admin-section active" id="dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalBookings">-</div>
          <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="upcomingBookings">-</div>
          <div class="stat-label">Upcoming</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="reservedBookings">-</div>
          <div class="stat-label">Need Payment</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalCustomers">-</div>
          <div class="stat-label">Total Customers</div>
        </div>
      </div>

      <div class="calendar-container">
        <div style="text-align: center; padding: 40px;">
          <h3 style="color: #64748b;">Welcome to the Admin Panel</h3>
          <p style="color: #94a3b8; margin-top: 8px;">Select a section from the sidebar to get started</p>
        </div>
      </div>
    </div>

    <!-- Calendar Section -->
    <div class="admin-section" id="calendar">
      <div class="calendar-container">
        <div class="calendar-header">
          <div class="calendar-nav">
            <button class="btn btn-primary btn-small" onclick="previousPeriod()">‚óÄ Previous</button>
            <div class="calendar-current" id="calendarCurrent">Loading...</div>
            <button class="btn btn-primary btn-small" onclick="nextPeriod()">Next ‚ñ∂</button>
          </div>
          <div class="calendar-view-selector">
            <button class="calendar-view-btn active" data-view="month" onclick="setCalendarView('month')">Month</button>
            <button class="calendar-view-btn" data-view="week" onclick="setCalendarView('week')">Week</button>
            <button class="calendar-view-btn" data-view="day" onclick="setCalendarView('day')">Day</button>
          </div>
        </div>

        <div class="filters-bar">
          <select class="filter-select" id="calendarRegion" onchange="loadCalendar()">
            <option value="">All Regions</option>
            <option value="North">North</option>
            <option value="South">South</option>
          </select>
          <button class="btn btn-primary" onclick="loadCalendar()">üîÑ Refresh</button>
        </div>

        <div id="calendarGrid">
          <div style="text-align: center; padding: 40px;">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- All Bookings Section -->
    <div class="admin-section" id="bookings">
      <div class="filters-bar">
        <input type="text" class="filter-input" id="bookingSearch" placeholder="Search by name, email, address, reference...">
        <select class="filter-select" id="bookingRegion">
          <option value="">All Regions</option>
          <option value="North">North</option>
          <option value="South">South</option>
        </select>
        <select class="filter-select" id="bookingStatus">
          <option value="">All Status</option>
          <option value="Booked">Booked</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <button class="btn btn-primary" onclick="loadBookings()">üîç Search</button>
      </div>

      <div class="calendar-container" id="bookingsContainer">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- Reserved Bookings Section -->
    <div class="admin-section" id="reserved">
      <div class="calendar-container" id="reservedContainer">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- Customers Section -->
    <div class="admin-section" id="customers">
      <div class="filters-bar">
        <input type="text" class="filter-input" id="customerSearch" placeholder="Search by name, email, company...">
        <button class="btn btn-primary" onclick="loadCustomers()">üîç Search</button>
      </div>

      <div class="calendar-container" id="customersContainer">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Detail Modal -->
  <div class="modal" id="bookingModal" onclick="closeModal('bookingModal')">
    <div class="modal-dialog" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="bookingModalTitle">Booking Details</h3>
        <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
      </div>
      <div class="modal-body" id="bookingModalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Customer Detail Modal -->
  <div class="modal" id="customerModal" onclick="closeModal('customerModal')">
    <div class="modal-dialog" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="customerModalTitle">Customer Details</h3>
        <button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
      </div>
      <div class="modal-body" id="customerModalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentView = 'month';
    let currentDate = new Date();
    let allBookings = [];
    let allCustomers = [];

    // UK REGIONS - All UK counties and regions
    const UK_REGIONS = [
      // England - North West
      'Cheshire', 'Cumbria', 'Greater Manchester', 'Lancashire', 'Merseyside',
      // England - North East
      'County Durham', 'Northumberland', 'Tyne and Wear',
      // England - Yorkshire and the Humber
      'East Riding of Yorkshire', 'North Yorkshire', 'South Yorkshire', 'West Yorkshire',
      // England - East Midlands
      'Derbyshire', 'Leicestershire', 'Lincolnshire', 'Northamptonshire', 'Nottinghamshire', 'Rutland',
      // England - West Midlands
      'Herefordshire', 'Shropshire', 'Staffordshire', 'Warwickshire', 'West Midlands', 'Worcestershire',
      // England - East of England
      'Bedfordshire', 'Cambridgeshire', 'Essex', 'Hertfordshire', 'Norfolk', 'Suffolk',
      // England - South East
      'Berkshire', 'Buckinghamshire', 'East Sussex', 'Hampshire', 'Isle of Wight', 'Kent', 'Oxfordshire', 'Surrey', 'West Sussex',
      // England - South West
      'Bristol', 'Cornwall', 'Devon', 'Dorset', 'Gloucestershire', 'Somerset', 'Wiltshire',
      // England - London
      'Greater London',
      // Scotland
      'Aberdeenshire', 'Angus', 'Argyll and Bute', 'City of Edinburgh', 'Clackmannanshire', 
      'Dumfries and Galloway', 'Dundee City', 'East Ayrshire', 'East Dunbartonshire', 'East Lothian',
      'East Renfrewshire', 'Falkirk', 'Fife', 'Glasgow City', 'Highland', 'Inverclyde',
      'Midlothian', 'Moray', 'North Ayrshire', 'North Lanarkshire', 'Orkney Islands',
      'Perth and Kinross', 'Renfrewshire', 'Scottish Borders', 'Shetland Islands', 'South Ayrshire',
      'South Lanarkshire', 'Stirling', 'West Dunbartonshire', 'West Lothian', 'Western Isles',
      // Wales
      'Anglesey', 'Blaenau Gwent', 'Bridgend', 'Caerphilly', 'Cardiff', 'Carmarthenshire',
      'Ceredigion', 'Conwy', 'Denbighshire', 'Flintshire', 'Gwynedd', 'Merthyr Tydfil',
      'Monmouthshire', 'Neath Port Talbot', 'Newport', 'Pembrokeshire', 'Powys', 'Rhondda Cynon Taf',
      'Swansea', 'Torfaen', 'Vale of Glamorgan', 'Wrexham',
      // Northern Ireland
      'Antrim', 'Armagh', 'Down', 'Fermanagh', 'Londonderry', 'Tyrone'
    ].sort();

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardStats();
      loadCalendar();
      loadBookings();
      loadCustomers();
    });

    // Navigation
    function showSection(sectionId) {
      document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(sectionId).classList.add('active');
      
      const navItem = [...document.querySelectorAll('.nav-item')].find(n => 
        n.getAttribute('onclick')?.includes(`showSection('${sectionId}')`)
      );
      if (navItem) navItem.classList.add('active');

      // Close sidebar on mobile
      if (window.innerWidth <= 1024) {
        document.getElementById('adminSidebar').classList.remove('open');
      }
    }

    function toggleSidebar() {
      document.getElementById('adminSidebar').classList.toggle('open');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Dashboard Stats
    async function loadDashboardStats() {
      try {
        const response = await fetch('/.netlify/functions/admin-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();
        
        if (data.success) {
          document.getElementById('totalBookings').textContent = data.stats.total;
          document.getElementById('upcomingBookings').textContent = data.stats.upcoming;
          document.getElementById('reservedBookings').textContent = data.stats.reserved;
        }

        // Load customer count
        const customersResponse = await fetch('/.netlify/functions/admin-users');
        const customersData = await customersResponse.json();
        
        if (customersData.success) {
          document.getElementById('totalCustomers').textContent = customersData.total;
        }

      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }

    // Calendar Functions
    function setCalendarView(view) {
      currentView = view;
      document.querySelectorAll('.calendar-view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      loadCalendar();
    }

    function previousPeriod() {
      if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() - 7);
      } else {
        currentDate.setDate(currentDate.getDate() - 1);
      }
      loadCalendar();
    }

    function nextPeriod() {
      if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + 7);
      } else {
        currentDate.setDate(currentDate.getDate() + 1);
      }
      loadCalendar();
    }

    async function loadCalendar() {
      const grid = document.getElementById('calendarGrid');
      const currentEl = document.getElementById('calendarCurrent');
      const region = document.getElementById('calendarRegion')?.value || '';

      grid.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        let startDate, endDate;

        if (currentView === 'month') {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          startDate = new Date(year, month, 1).toISOString().split('T')[0];
          endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
          
          currentEl.textContent = currentDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
        } else if (currentView === 'week') {
          const day = currentDate.getDay();
          const diff = currentDate.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(currentDate.setDate(diff));
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          
          startDate = monday.toISOString().split('T')[0];
          endDate = sunday.toISOString().split('T')[0];
          
          currentEl.textContent = `Week of ${monday.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' })} - ${sunday.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' })}`;
        } else {
          startDate = currentDate.toISOString().split('T')[0];
          endDate = startDate;
          
          currentEl.textContent = currentDate.toLocaleDateString('en-GB', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        }

        const response = await fetch('/.netlify/functions/admin-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ startDate, endDate, region })
        });

        const data = await response.json();

        if (data.success) {
          if (currentView === 'month') {
            renderMonthView(data.bookings);
          } else if (currentView === 'week') {
            renderWeekView(data.bookings);
          } else {
            renderDayView(data.bookings);
          }
        }

      } catch (error) {
        console.error('Error loading calendar:', error);
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading calendar</div>';
      }
    }

    function renderMonthView(bookings) {
      const grid = document.getElementById('calendarGrid');
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay() || 7; // 1=Monday, 7=Sunday

      let html = '<div class="calendar-grid month">';
      
      // Day headers
      ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });

      // Empty cells before first day
      for (let i = 1; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day other-month"></div>';
      }

      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayBookings = bookings.filter(b => b.fields['Date'] === dateStr);
        
        const today = new Date();
        const isToday = dateStr === today.toISOString().split('T')[0];
        
        html += `<div class="calendar-day ${isToday ? 'today' : ''}">`;
        html += `<div class="calendar-day-number">${day}</div>`;
        
        dayBookings.forEach(booking => {
          const statusClass = booking.fields['Payment Status'] === 'Reserved' ? 'reserved' : 
                              booking.fields['Booking Status'] === 'Cancelled' ? 'cancelled' : '';
          html += `<div class="calendar-booking ${statusClass}" onclick='viewBooking(${JSON.stringify(booking).replace(/'/g, "&#39;")})'>${booking.fields['Time']} ${booking.fields['Client Name']}</div>`;
        });
        
        html += '</div>';
      }

      html += '</div>';
      grid.innerHTML = html;
    }

    function renderWeekView(bookings) {
      const grid = document.getElementById('calendarGrid');
      // Implementation for week view
      grid.innerHTML = '<div style="padding: 40px; text-align: center;">Week view coming soon...</div>';
    }

    function renderDayView(bookings) {
      const grid = document.getElementById('calendarGrid');
      // Implementation for day view
      grid.innerHTML = '<div style="padding: 40px; text-align: center;">Day view coming soon...</div>';
    }

    // Bookings Functions
    async function loadBookings() {
      const container = document.getElementById('bookingsContainer');
      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        const search = document.getElementById('bookingSearch')?.value || '';
        const region = document.getElementById('bookingRegion')?.value || '';
        const status = document.getElementById('bookingStatus')?.value || '';

        const response = await fetch('/.netlify/functions/admin-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ region, status })
        });

        const data = await response.json();

        if (data.success) {
          allBookings = data.bookings;
          renderBookingsTable(allBookings, search);
        }

      } catch (error) {
        console.error('Error loading bookings:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading bookings</div>';
      }
    }

    function renderBookingsTable(bookings, search = '') {
      const container = document.getElementById('bookingsContainer');
      
      let filtered = bookings;
      if (search) {
        const term = search.toLowerCase();
        filtered = bookings.filter(b => 
          (b.fields['Client Name'] || '').toLowerCase().includes(term) ||
          (b.fields['Client Email'] || '').toLowerCase().includes(term) ||
          (b.fields['Property Address'] || '').toLowerCase().includes(term) ||
          (b.fields['Booking Reference'] || '').toLowerCase().includes(term)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px;">No bookings found</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Reference</th>
              <th>Date & Time</th>
              <th>Client</th>
              <th>Address</th>
              <th>Service</th>
              <th>Status</th>
              <th>Drive Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(booking => {
        const driveTimeInfo = booking.driveTimeInfo;
        const driveTimeBadge = driveTimeInfo ? `
          <span class="drive-time-badge ${driveTimeInfo.hasConflict ? 'error' : driveTimeInfo.bufferTime.surplus < 15 ? 'warning' : ''}">
            üöó ${driveTimeInfo.driveTimeFormatted} ${driveTimeInfo.hasConflict ? '‚ö†Ô∏è' : ''}
          </span>
        ` : '-';

        html += `
          <tr>
            <td data-label="Reference"><strong>${booking.fields['Booking Reference']}</strong></td>
            <td data-label="Date & Time">${booking.fields['Date']}<br>${booking.fields['Time']}</td>
            <td data-label="Client">
              ${booking.fields['Client Name']}<br>
              <small style="color: #64748b;">${booking.fields['Client Email']}</small>
            </td>
            <td data-label="Address">${booking.fields['Property Address'] || '-'}</td>
            <td data-label="Service">${booking.fields['Service Name'] || '-'}</td>
            <td data-label="Status">
              <span class="status-badge status-${(booking.fields['Payment Status'] || '').toLowerCase()}">
                ${booking.fields['Payment Status'] || '-'}
              </span>
            </td>
            <td data-label="Drive Time">${driveTimeBadge}</td>
            <td data-label="Actions">
              <button class="btn btn-primary btn-small" onclick='viewBooking(${JSON.stringify(booking).replace(/'/g, "&#39;")})'>
                View
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function viewBooking(booking) {
      const modal = document.getElementById('bookingModal');
      const title = document.getElementById('bookingModalTitle');
      const body = document.getElementById('bookingModalBody');

      title.textContent = `Booking ${booking.fields['Booking Reference']}`;

      const driveTimeSection = booking.driveTimeInfo ? `
        <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 16px; margin: 16px 0;">
          <h4 style="margin: 0 0 12px 0; color: #1e40af;">üöó Drive Time Information</h4>
          <div class="detail-item">
            <span class="detail-label">From Previous Booking</span>
            <span class="detail-value">${booking.driveTimeInfo.fromBooking}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Drive Time</span>
            <span class="detail-value">${booking.driveTimeInfo.driveTimeFormatted}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Previous End Time</span>
            <span class="detail-value">${booking.driveTimeInfo.previousBookingEndTime}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Current Start Time</span>
            <span class="detail-value">${booking.driveTimeInfo.currentBookingStartTime}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Buffer Time</span>
            <span class="detail-value">
              ${booking.driveTimeInfo.bufferTime.available} min 
              (${booking.driveTimeInfo.bufferTime.sufficient ? '‚úì Sufficient' : '‚ö†Ô∏è Tight Schedule'})
            </span>
          </div>
          ${booking.driveTimeInfo.hasConflict ? `
            <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 12px; margin-top: 12px; color: #991b1b;">
              <strong>‚ö†Ô∏è Schedule Conflict:</strong> Insufficient time between bookings
            </div>
          ` : ''}
        </div>
      ` : '';

      body.innerHTML = `
        <div class="detail-item">
          <span class="detail-label">Reference</span>
          <span class="detail-value">${booking.fields['Booking Reference']}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Date & Time</span>
          <span class="detail-value">${booking.fields['Date']} at ${booking.fields['Time']}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Client Name</span>
          <span class="detail-value">${booking.fields['Client Name']}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Client Email</span>
          <span class="detail-value">${booking.fields['Client Email']}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Property Address</span>
          <span class="detail-value">${booking.fields['Property Address'] || '-'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Service</span>
          <span class="detail-value">${booking.fields['Service Name'] || '-'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Payment Status</span>
          <span class="detail-value">
            <span class="status-badge status-${(booking.fields['Payment Status'] || '').toLowerCase()}">
              ${booking.fields['Payment Status'] || '-'}
            </span>
          </span>
        </div>
        ${driveTimeSection}
        ${booking.fields['Payment Status'] === 'Reserved' ? `
          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
            <button class="btn btn-success" onclick='processPayment("${booking.id}", "${booking.fields['Booking Reference']}")' style="width: 100%;">
              üí≥ Send Payment Link
            </button>
          </div>
        ` : ''}
      `;

      modal.classList.add('active');
    }

    async function processPayment(bookingId, bookingRef) {
      if (!confirm(`Send payment link for booking ${bookingRef}?`)) return;

      try {
        const response = await fetch('/.netlify/functions/process-reserved-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bookingId, bookingRef })
        });

        const data = await response.json();

        if (data.success) {
          alert(`‚úì Payment link sent successfully!\n\nLink: ${data.paymentLink}`);
          closeModal('bookingModal');
          loadBookings();
          loadDashboardStats();
        } else {
          alert(`Error: ${data.error}`);
        }

      } catch (error) {
        console.error('Error processing payment:', error);
        alert('Error sending payment link');
      }
    }

    // Customers Functions
    async function loadCustomers() {
      const container = document.getElementById('customersContainer');
      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        const response = await fetch('/.netlify/functions/admin-users');
        const data = await response.json();

        if (data.success) {
          allCustomers = data.users;
          renderCustomersTable(allCustomers);
        }

      } catch (error) {
        console.error('Error loading customers:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading customers</div>';
      }
    }

    function renderCustomersTable(customers) {
      const container = document.getElementById('customersContainer');
      const search = document.getElementById('customerSearch')?.value || '';

      let filtered = customers;
      if (search) {
        const term = search.toLowerCase();
        filtered = customers.filter(c => 
          (c.fields['Name'] || '').toLowerCase().includes(term) ||
          (c.fields['Email'] || '').toLowerCase().includes(term) ||
          (c.fields['Company'] || '').toLowerCase().includes(term)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px;">No customers found</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Company</th>
              <th>Region</th>
              <th>Status</th>
              <th>Email Alerts</th>
              <th>Reserve Privilege</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(customer => {
        const allowReserve = customer.fields['Allow Reserve Without Payment'] === true;
        const emailNotifications = customer.fields['Email Notifications Enabled'] !== false;

        html += `
          <tr>
            <td data-label="Name"><strong>${customer.fields['Name']}</strong></td>
            <td data-label="Email">${customer.fields['Email']}</td>
            <td data-label="Company">${customer.fields['Company'] || '-'}</td>
            <td data-label="Region">
              <select 
                class="region-select" 
                data-user-email="${customer.fields['Email']}" 
                data-record-id="${customer.id}"
                data-original-value="${customer.fields['Region'] || ''}"
                onchange="updateUserRegion(this)"
              >
                <option value="">Select Region...</option>
                ${UK_REGIONS.map(region => `
                  <option value="${region}" ${customer.fields['Region'] === region ? 'selected' : ''}>
                    ${region}
                  </option>
                `).join('')}
              </select>
            </td>
            <td data-label="Status">
              <span class="status-badge status-${(customer.fields['Account Status'] || '').toLowerCase()}">
                ${customer.fields['Account Status'] || '-'}
              </span>
            </td>
            <td data-label="Email Alerts">
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  ${emailNotifications ? 'checked' : ''} 
                  onchange='toggleEmailNotifications("${customer.fields['Email']}", this.checked, "${customer.id}")'
                >
                <span class="toggle-slider"></span>
              </label>
            </td>
            <td data-label="Reserve Privilege">
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  ${allowReserve ? 'checked' : ''} 
                  onchange='toggleReservePrivilege("${customer.id}", "${customer.fields['Email']}", this.checked)'
                >
                <span class="toggle-slider"></span>
              </label>
            </td>
            <td data-label="Actions">
              <button class="btn btn-primary btn-small" onclick='viewCustomer(${JSON.stringify(customer).replace(/'/g, "&#39;")})'>
                View
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function viewCustomer(customer) {
      const modal = document.getElementById('customerModal');
      const title = document.getElementById('customerModalTitle');
      const body = document.getElementById('customerModalBody');

      title.textContent = customer.fields['Name'];

      const allowReserve = customer.fields['Allow Reserve Without Payment'] === true;
      const emailNotificationsStatus = customer.fields['Email Notifications Enabled'] !== false ? 'Enabled' : 'Disabled';
      const emailNotificationsColor = customer.fields['Email Notifications Enabled'] !== false ? '#10b981' : '#ef4444';

      body.innerHTML = `
        <div class="warning-box">
          ‚ö†Ô∏è <strong>Security Note:</strong> Passwords are hashed and cannot be viewed for security reasons.
        </div>

        <div class="detail-item">
          <span class="detail-label">üë§ Full Name</span>
          <span class="detail-value">${customer.fields['Name']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìß Email Address</span>
          <span class="detail-value">${customer.fields['Email']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üè¢ Company</span>
          <span class="detail-value">${customer.fields['Company'] || 'N/A'}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìç Region</span>
          <span class="detail-value">
            ${customer.fields['Region'] ? 
              `<span class="region-badge">${customer.fields['Region']}</span>` : 
              '<span class="region-badge empty">Not set</span>'
            }
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìÖ Account Created</span>
          <span class="detail-value">${customer.fields['Created Date']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">‚úÖ Account Status</span>
          <span class="detail-value">
            <span class="status-badge status-${(customer.fields['Account Status'] || '').toLowerCase()}">
              ${customer.fields['Account Status'] || 'Unknown'}
            </span>
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üì¨ Milestone Emails</span>
          <span class="detail-value">
            <span style="color: ${emailNotificationsColor}; font-weight: 600;">
              ${emailNotificationsStatus}
            </span>
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üí≥ Allow Reserve Without Payment</span>
          <span class="detail-value">
            <label class="toggle-switch">
              <input 
                type="checkbox" 
                ${allowReserve ? 'checked' : ''} 
                onchange='toggleReservePrivilege("${customer.id}", "${customer.fields['Email']}", this.checked)'
              >
              <span class="toggle-slider"></span>
            </label>
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üîê Password</span>
          <span class="detail-value" style="color: #64748b; font-style: italic;">Encrypted (not visible)</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üÜî Record ID</span>
          <span class="detail-value" style="font-family: monospace; font-size: 12px;">${customer.id}</span>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
          <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
            <button class="btn btn-danger" style="flex: 1;" onclick='redeemPoints("${customer.fields['Email']}", "${customer.fields['Name']}")'>
              ‚≠ê Redeem Points
            </button>
            <button class="btn btn-primary" style="flex: 1;" onclick='impersonateUser("${customer.fields['Email']}")'>
              üîë Login as ${customer.fields['Name']}
            </button>
            <button class="btn btn-secondary" style="flex: 1;" onclick='checkMilestone("${customer.fields['Email']}", "${customer.fields['Name']}")'>
              üìß Check Milestone
            </button>
          </div>
          
          <div style="padding: 16px; background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px;">
            <div style="font-weight: 600; color: #065f46; margin-bottom: 12px; font-size: 14px;">‚ûï Manually Add Points</div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input 
                type="number" 
                id="manualPoints-${customer.id}" 
                placeholder="Enter points amount" 
                min="1"
                style="flex: 1; padding: 10px 14px; border: 2px solid #10b981; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;"
              >
              <button class="btn btn-primary" style="white-space: nowrap;" onclick='addManualPoints("${customer.fields['Email']}", "${customer.fields['Name']}", "${customer.id}")'>
                ‚ûï Add Points
              </button>
            </div>
            <div style="font-size: 12px; color: #047857; margin-top: 8px;">Use this to add bonus/promotional points to the account</div>
          </div>
        </div>
      `;

      modal.classList.add('active');
    }

    async function toggleReservePrivilege(recordId, email, enabled) {
      try {
        const response = await fetch('/.netlify/functions/update-reserve-privilege', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recordId, email, enabled })
        });

        const data = await response.json();

        if (data.success) {
          console.log(`‚úì Reserve privilege ${enabled ? 'enabled' : 'disabled'} for ${email}`);
          // Update local cache
          const customer = allCustomers.find(c => c.id === recordId);
          if (customer) {
            customer.fields['Allow Reserve Without Payment'] = enabled;
          }
        } else {
          alert(`Error: ${data.message}`);
          // Revert toggle
          event.target.checked = !enabled;
        }

      } catch (error) {
        console.error('Error toggling reserve privilege:', error);
        alert('Error updating privilege');
        event.target.checked = !enabled;
      }
    }

    async function updateUserRegion(selectElement) {
      const email = selectElement.dataset.userEmail;
      const recordId = selectElement.dataset.recordId;
      const region = selectElement.value;
      
      const originalValue = selectElement.dataset.originalValue || '';
      selectElement.disabled = true;
      
      try {
        const response = await fetch('/.netlify/functions/update-user-region', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userEmail: email,
            recordId: recordId,
            region: region
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update region');
        }

        const result = await response.json();

        // Update the user in allCustomers array
        const userIndex = allCustomers.findIndex(u => u.fields['Email'] === email);
        if (userIndex !== -1) {
          allCustomers[userIndex].fields['Region'] = region;
        }

        // Store new value
        selectElement.dataset.originalValue = region;
        selectElement.disabled = false;
        
        console.log(`‚úÖ Region updated to "${region}" for ${email}`);

      } catch (error) {
        console.error('Error updating region:', error);
        alert(`‚ùå Failed to update region: ${error.message}`);
        
        // Revert selection
        selectElement.value = originalValue;
        selectElement.disabled = false;
      }
    }

    async function toggleEmailNotifications(email, enabled, recordId) {
      try {
        // Show loading state
        const toggleInput = event.target;
        toggleInput.disabled = true;

        const response = await fetch('/.netlify/functions/toggle-email-notifications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userEmail: email,
            enabled: enabled,
            recordId: recordId
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update email notification settings');
        }

        const result = await response.json();
        
        // Update the user in allCustomers array
        const userIndex = allCustomers.findIndex(u => u.fields['Email'] === email);
        if (userIndex !== -1) {
          allCustomers[userIndex].fields['Email Notifications Enabled'] = enabled;
        }

        // Show success message briefly
        const statusText = enabled ? 'enabled' : 'disabled';
        console.log(`‚úÖ Email notifications ${statusText} for ${email}`);
        
        toggleInput.disabled = false;

      } catch (error) {
        console.error('Error toggling email notifications:', error);
        alert(`‚ùå Failed to update email notifications: ${error.message}`);
        
        // Revert the toggle
        event.target.checked = !enabled;
        event.target.disabled = false;
      }
    }

    function impersonateUser(email) {
      const user = allCustomers.find(c => c.fields['Email'] === email);
      if (!user) {
        alert('User data not found');
        return;
      }

      if (confirm(`Login as ${user.fields['Name']}?\n\nThis will open their dashboard in a new tab.`)) {
        const sessionData = {
          email: email,
          name: user.fields['Name'] || 'Client',
          company: user.fields['Company'] || '',
          timestamp: Date.now(),
          expires: Date.now() + (24 * 60 * 60 * 1000),
          adminImpersonation: true
        };

        const token = btoa(JSON.stringify(sessionData));
        
        const baseUrl = window.location.origin;
        const dashboardUrl = baseUrl + '/website/dashboard.html?admin_session=' + encodeURIComponent(token) + 
                            '&admin_email=' + encodeURIComponent(email) +
                            '&admin_name=' + encodeURIComponent(user.fields['Name'] || 'Client') +
                            '&admin_company=' + encodeURIComponent(user.fields['Company'] || '');
        
        window.open(dashboardUrl, '_blank');
        alert(`‚úì Logged in as ${user.fields['Name']}`);
      }
    }

    // Real-time search
    document.getElementById('bookingSearch')?.addEventListener('input', (e) => {
      renderBookingsTable(allBookings, e.target.value);
    });

    document.getElementById('customerSearch')?.addEventListener('input', (e) => {
      renderCustomersTable(allCustomers);
    });

    // Rewards and Points Management
    async function redeemPoints(email, name) {
      if (!email) {
        alert('Email address is required');
        return;
      }
      
      const user = allCustomers.find(u => u.fields['Email'] === email);
      if (!user) {
        alert('User data not found');
        return;
      }
      
      try {
        // Get booking points from Acuity
        const acuityResponse = await fetch('/.netlify/functions/acuity-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userEmail: email })
        });
        
        if (!acuityResponse.ok) {
          throw new Error('Failed to fetch Acuity data');
        }

        const acuityData = await acuityResponse.json();
        const bookingPoints = Math.floor(acuityData.totalInvestment ?? 0);
        
        // Get manual points AND baseline from Airtable
        const manualPointsResponse = await fetch('/.netlify/functions/get-manual-points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userEmail: email })
        });
        
        const manualPointsData = await manualPointsResponse.json();
        const manualPoints = manualPointsData?.manualPoints || 0;
        const lastRedemptionBaseline = manualPointsData?.lastRedemptionBaseline || 0;
        
        // Calculate NET booking points (subtract baseline) and total points
        const netBookingPoints = Math.max(0, bookingPoints - lastRedemptionBaseline);
        const currentPoints = netBookingPoints + manualPoints;
        const pointsValue = (currentPoints / 100).toFixed(2);

        if (currentPoints === 0) {
          alert(`${name} has no points to redeem.`);
          return;
        }

        // Ask how many points to redeem
        const pointsToRedeem = prompt(`How many points would you like to redeem for ${name}?\n\nAvailable: ${currentPoints} pts (¬£${pointsValue})\n  ‚Ä¢ Net Booking Points: ${netBookingPoints}\n  ‚Ä¢ Manual Points: ${manualPoints}\n\nEnter amount (or leave blank to redeem all):`);
        
        if (pointsToRedeem === null) {
          return; // User cancelled
        }

        let finalPointsToRedeem = currentPoints; // Default: redeem all
        
        if (pointsToRedeem.trim() !== '') {
          finalPointsToRedeem = parseInt(pointsToRedeem);
          
          if (isNaN(finalPointsToRedeem) || finalPointsToRedeem <= 0) {
            alert('Please enter a valid number greater than 0.');
            return;
          }
          
          if (finalPointsToRedeem > currentPoints) {
            alert(`Cannot redeem ${finalPointsToRedeem} points. Only ${currentPoints} points available.`);
            return;
          }
        }

        const finalValue = (finalPointsToRedeem / 100).toFixed(2);

        if (!confirm(`Confirm redemption for ${name}?\n\nRedeeming: ${finalPointsToRedeem} pts (¬£${finalValue})\nRemaining: ${currentPoints - finalPointsToRedeem} pts\n\nContinue?`)) {
          return;
        }

        // Call the redemption endpoint
        const response = await fetch('/.netlify/functions/redeem-points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userEmail: email,
            redeemedPoints: finalPointsToRedeem,
            redeemedValue: finalValue,
            acuityTotalInvestment: acuityData.totalInvestment,
            currentTotalPoints: currentPoints
          })
        });

        if (!response.ok) {
          throw new Error('Failed to redeem points');
        }

        const result = await response.json();
        
        alert(`‚úÖ Points redeemed successfully!\n\n${name} redeemed ${finalPointsToRedeem} points (¬£${finalValue})\n\nRemaining: ${currentPoints - finalPointsToRedeem} points`);
        
        // Refresh the user list and close modal
        loadCustomers();
        closeModal('customerModal');

      } catch (error) {
        console.error('Error redeeming points:', error);
        alert(`‚ùå Failed to redeem points: ${error.message}\n\nPlease try again.`);
      }
    }

    async function addManualPoints(email, name, userId) {
      const input = document.getElementById(`manualPoints-${userId}`);
      const pointsToAdd = parseInt(input.value);
      
      if (!pointsToAdd || pointsToAdd <= 0) {
        alert('Please enter a valid points amount (greater than 0)');
        return;
      }
      
      if (!confirm(`Add ${pointsToAdd} bonus points to ${name}?\n\nThis will be recorded as a manual adjustment and will increase their total points balance.`)) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/add-manual-points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userEmail: email,
            pointsToAdd: pointsToAdd,
            addedBy: 'Admin',
            reason: 'Manual adjustment'
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to add points');
        }
        
        const result = await response.json();
        alert(`‚úÖ Successfully added ${pointsToAdd} points to ${name}!\n\nNew total: ${result.newTotal} points`);
        
        // Clear input and refresh
        input.value = '';
        loadCustomers();
        closeModal('customerModal');
        
      } catch (error) {
        console.error('Error adding points:', error);
        alert(`‚ùå Failed to add points: ${error.message}\n\nPlease try again.`);
      }
    }

    async function checkMilestone(email, name) {
      if (!email) {
        alert('Email address is required');
        return;
      }
      
      if (!confirm(`Check milestone for ${name}?\n\nThis will check if they've reached a new milestone and send an email if applicable.`)) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/check-milestone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userEmail: email })
        });
        
        if (!response.ok) {
          throw new Error('Failed to check milestone');
        }
        
        const result = await response.json();
        
        if (result.skipped) {
          alert(`‚ÑπÔ∏è Email notifications are disabled for ${name}`);
        } else if (result.emailSent) {
          alert(`‚úÖ Milestone email sent to ${name}!\n\nMilestone: ${result.milestone.tier} (${result.milestone.points} points)\nCurrent Balance: ${result.currentBalance} points`);
        } else {
          alert(`‚ÑπÔ∏è No new milestone reached for ${name}\n\nCurrent Balance: ${result.currentBalance} points\nLast Milestone: ${result.lastMilestoneReached} points`);
        }
        
        // Refresh user list
        loadCustomers();
        
      } catch (error) {
        console.error('Error checking milestone:', error);
        alert(`‚ùå Failed to check milestone: ${error.message}\n\nPlease try again.`);
      }
    }

    // Scroll input into view when keyboard appears on mobile/tablet
    if (window.innerWidth <= 1024) {
      document.addEventListener('focusin', function(e) {
        if (e.target.matches('input[type="number"]')) {
          setTimeout(() => {
            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      });
    }
  </script>
</body>
</html>