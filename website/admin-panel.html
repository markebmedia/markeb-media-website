<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Markeb Media</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

  <style>
  /* ===== ADMIN PANEL STYLES - UPDATED WITH MOBILE FIXES ===== */

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
  font-family: 'Inter', sans-serif;
  background: #f8fafc;
  color: #1e293b;
}

/* Sidebar Navigation */
.admin-sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 260px;
  height: 100vh;
  background: #fff;
  border-right: 2px solid #e2e8f0;
  padding: 24px;
  overflow-y: auto;
  z-index: 1000;
  transition: transform 0.3s ease;
}

.admin-logo {
  font-size: 24px;
  font-weight: 700;
  color: #3b82f6;
  margin-bottom: 32px;
  text-align: center;
}

.nav-section {
  margin-bottom: 24px;
}

.nav-section-title {
  font-size: 11px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  padding-left: 12px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  color: #64748b;
  text-decoration: none;
  font-weight: 500;
  transition: all .2s ease;
  cursor: pointer;
  margin-bottom: 4px;
}

.nav-item:hover {
  background: #f1f5f9;
  color: #0f172a;
}

.nav-item.active {
  background: #3b82f6;
  color: #fff;
}

.nav-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

/* Main Content */
.admin-main {
  margin-left: 260px;
  min-height: 100vh;
  padding: 24px;
  transition: margin-left 0.3s ease;
}

.admin-header {
  background: #fff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.admin-title {
  font-size: 28px;
  font-weight: 700;
  color: #0f172a;
}

.admin-subtitle {
  color: #64748b;
  font-size: 14px;
  margin-top: 4px;
}

.admin-badge {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: #fff;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 14px;
}

/* Sections */
.admin-section {
  display: none;
}

.admin-section.active {
  display: block;
}

/* Stats Cards */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: #fff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: #3b82f6;
  margin-bottom: 8px;
}

.stat-label {
  color: #64748b;
  font-size: 13px;
  font-weight: 500;
}

/* Tables */
.data-table {
  width: 100%;
  background: #fff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  overflow: hidden;
}

.data-table thead {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #fff;
}

.data-table th {
  padding: 16px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  text-transform: uppercase;
}

.data-table td {
  padding: 16px;
  border-bottom: 1px solid #e2e8f0;
  font-size: 14px;
}

.data-table tbody tr:hover {
  background: #f8fafc;
}

/* Buttons */
.btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all .2s ease;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-family: 'Inter', sans-serif;
}

.btn-primary {
  background: #3b82f6;
  color: #fff;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-success {
  background: #10b981;
  color: #fff;
}

.btn-success:hover {
  background: #059669;
}

.btn-danger {
  background: #ef4444;
  color: #fff;
}

.btn-danger:hover {
  background: #dc2626;
}

.btn-secondary {
  background: #64748b;
  color: #fff;
}

.btn-secondary:hover {
  background: #475569;
}

.btn-warning {
  background: #f59e0b;
  color: #fff;
}

.btn-warning:hover {
  background: #d97706;
}

.btn-small {
  padding: 6px 12px;
  font-size: 12px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Calendar */
.calendar-container {
  background: #fff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.calendar-nav {
  display: flex;
  gap: 12px;
  align-items: center;
}

.calendar-current {
  font-size: 20px;
  font-weight: 700;
  color: #0f172a;
  min-width: 200px;
  text-align: center;
}

.calendar-view-selector {
  display: flex;
  gap: 4px;
  background: #f1f5f9;
  padding: 4px;
  border-radius: 8px;
}

.calendar-view-btn {
  padding: 8px 16px;
  border: none;
  background: transparent;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  color: #64748b;
  transition: all .2s ease;
}

.calendar-view-btn.active {
  background: #fff;
  color: #3b82f6;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.calendar-grid {
  display: grid;
  gap: 1px;
  background: #e2e8f0;
  border: 1px solid #e2e8f0;
}

.calendar-grid.month {
  grid-template-columns: repeat(7, 1fr);
}

.calendar-day-header {
  background: #f8fafc;
  padding: 12px;
  text-align: center;
  font-weight: 600;
  font-size: 12px;
  color: #64748b;
}

.calendar-day {
  background: #fff;
  min-height: 120px;
  padding: 8px;
  position: relative;
}

.calendar-day-number {
  font-weight: 600;
  font-size: 14px;
  color: #0f172a;
  margin-bottom: 4px;
}

.calendar-day.other-month {
  opacity: 0.3;
}

.calendar-day.today {
  background: #eff6ff;
  border: 2px solid #3b82f6;
}

.calendar-booking {
  background: #3b82f6;
  color: #fff;
  padding: 4px 6px;
  border-radius: 4px;
  font-size: 11px;
  margin-bottom: 2px;
  cursor: pointer;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.calendar-booking:hover {
  background: #2563eb;
}

.calendar-booking.pending {
  background: #f59e0b;
}

.calendar-booking.cancelled {
  background: #ef4444;
}

.calendar-grid.week {
  grid-template-columns: 80px repeat(7, 1fr);
}

.calendar-time-slot {
  background: #f8fafc;
  padding: 8px;
  font-size: 12px;
  color: #64748b;
  text-align: right;
  border-right: 2px solid #e2e8f0;
}

.calendar-week-slot {
  background: #fff;
  padding: 4px;
  min-height: 60px;
  position: relative;
}

.calendar-grid.day {
  grid-template-columns: 80px 1fr;
}

.calendar-booking-counter {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border: 2px solid #3b82f6;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  text-align: center;
}

.calendar-booking-counter-value {
  font-size: 28px;
  font-weight: 700;
  color: #3b82f6;
}

.calendar-booking-counter-label {
  font-size: 14px;
  color: #64748b;
  font-weight: 600;
  margin-left: 8px;
}

/* Drive Time Badge */
.drive-time-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  background: #dbeafe;
  color: #1e40af;
}

.drive-time-badge.warning {
  background: #fef3c7;
  color: #92400e;
}

.drive-time-badge.error {
  background: #fee2e2;
  color: #991b1b;
}

/* Toggle Switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 52px;
  height: 28px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #cbd5e1;
  transition: .3s;
  border-radius: 28px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .3s;
  border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

/* Filters */
.filters-bar {
  background: #fff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 24px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.filter-input {
  padding: 10px 14px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  flex: 1;
  min-width: 200px;
}

.filter-input:focus {
  outline: none;
  border-color: #3b82f6;
}

.filter-select {
  padding: 10px 14px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  background: #fff;
  cursor: pointer;
}

/* Loading */
.spinner {
  margin: 30px auto;
  width: 50px;
  height: 50px;
  border: 4px solid #e2e8f0;
  border-top: 4px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-dialog {
  background: #fff;
  border-radius: 16px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
  padding: 24px;
  border-bottom: 2px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #fff;
  border-radius: 16px 16px 0 0;
}

.modal-header h3 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.modal-close {
  background: rgba(255, 255, 255, 0.2);
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: #fff;
  font-size: 28px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .2s ease;
  line-height: 1;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.modal-body {
  padding: 24px;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.detail-item:last-child {
  border-bottom: none;
}

.detail-label {
  font-weight: 600;
  color: #64748b;
  font-size: 14px;
}

.detail-value {
  color: #0f172a;
  font-weight: 500;
  text-align: right;
}

/* Status Badges */
.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-paid {
  background: #d1fae5;
  color: #065f46;
}

.status-pending {
  background: #fef3c7;
  color: #92400e;
}

.status-cancelled {
  background: #fee2e2;
  color: #991b1b;
}

.status-active {
  background: #d1fae5;
  color: #065f46;
}

.status-inactive {
  background: #fee2e2;
  color: #991b1b;
}

/* Region Dropdown */
.region-select {
  padding: 8px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  font-size: 13px;
  font-family: 'Inter', sans-serif;
  background: #fff;
  color: #0f172a;
  cursor: pointer;
  transition: all .2s ease;
  min-width: 140px;
  max-width: 180px;
}

.region-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.region-select:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #f8f9fa;
}

.region-select:hover:not(:disabled) {
  border-color: #cbd5e1;
}

/* Region badge */
.region-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  background: #eff6ff;
  color: #1e40af;
  border: 2px solid #bfdbfe;
}

.region-badge.north {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #fff;
  border-color: #3b82f6;
}

.region-badge.south {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: #fff;
  border-color: #f59e0b;
}

.region-badge.empty {
  background: #f1f5f9;
  color: #64748b;
  border-color: #e2e8f0;
  font-style: italic;
}

/* Info/Warning boxes */
.info-box {
  background: #eff6ff;
  border: 2px solid #3b82f6;
  border-radius: 12px;
  padding: 16px;
  margin: 16px 0;
  color: #1e40af;
  font-size: 14px;
}

.warning-box {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin: 16px 0;
  color: #92400e;
  font-size: 14px;
}

.success-box {
  background: #d1fae5;
  border: 2px solid #10b981;
  border-radius: 12px;
  padding: 16px;
  margin: 16px 0;
  color: #065f46;
  font-size: 14px;
}

/* Action buttons grid */
.action-buttons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-top: 24px;
}

/* Rewards section */
.rewards-section {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 20px;
  margin: 16px 0;
}

.rewards-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.rewards-title {
  font-size: 18px;
  font-weight: 700;
  color: #92400e;
}

.rewards-progress {
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.progress-bar-container {
  background: #e5e7eb;
  height: 12px;
  border-radius: 6px;
  overflow: hidden;
  margin-top: 8px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
  transition: width 0.3s ease;
}

/* Form Styles */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #0f172a;
  font-size: 14px;
}

.form-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s ease;
}

.form-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input:read-only {
  background: #f8fafc;
  cursor: not-allowed;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}

.bedroom-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid #3b82f6;
  background: #fff;
  color: #3b82f6;
  font-size: 24px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}

.bedroom-btn:hover {
  background: #3b82f6;
  color: #fff;
}

.bedroom-btn:active {
  transform: scale(0.95);
}

.button-group {
  display: flex;
  gap: 12px;
}

.mobile-menu-btn {
  display: none;
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 999;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 16px;
  cursor: pointer;
  font-size: 20px;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Password Protection Styles */
.password-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  padding: 20px;
}

.password-modal.unlocked {
  display: none;
}

.password-dialog {
  background: #fff;
  border-radius: 24px;
  max-width: 480px;
  width: 100%;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
  overflow: hidden;
  animation: passwordSlideIn 0.4s ease-out;
}

@keyframes passwordSlideIn {
  from {
    opacity: 0;
    transform: translateY(-30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.password-header {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  padding: 48px 32px;
  text-align: center;
  color: #fff;
}

.password-logo {
  font-size: 64px;
  margin-bottom: 16px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.password-header h2 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.password-header p {
  font-size: 16px;
  opacity: 0.9;
}

.password-body {
  padding: 40px 32px;
}

.password-input-group {
  margin-bottom: 24px;
}

.password-input {
  width: 100%;
  padding: 16px 20px;
  border: 3px solid #e2e8f0;
  border-radius: 12px;
  font-size: 18px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  letter-spacing: 2px;
  text-align: center;
  transition: all 0.3s ease;
  background: #f8fafc;
}

.password-input:focus {
  outline: none;
  border-color: #3b82f6;
  background: #fff;
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.password-error {
  display: none;
  margin-top: 12px;
  padding: 12px 16px;
  background: #fee2e2;
  border: 2px solid #ef4444;
  border-radius: 8px;
  color: #991b1b;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
}

.password-error.show {
  display: block;
  animation: shake 0.5s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.password-submit {
  width: 100%;
  padding: 16px 24px;
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.password-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.password-submit:active {
  transform: translateY(0);
}

.password-icon {
  font-size: 20px;
}

.password-footer {
  margin-top: 24px;
  padding-top: 24px;
  border-top: 2px solid #e2e8f0;
  text-align: center;
}

.password-footer p {
  font-size: 14px;
  color: #64748b;
  font-weight: 600;
}

/* ===== MOBILE RESPONSIVE STYLES ===== */

/* Tablet and below */
@media (max-width: 1024px) {
  .mobile-menu-btn {
    display: block !important;
  }

  .admin-sidebar {
    transform: translateX(-100%);
    width: 280px;
  }

  .admin-sidebar.open {
    transform: translateX(0);
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
  }

  .admin-main {
    margin-left: 0;
  }

  .nav-item {
    padding: 14px 12px;
    font-size: 15px;
    gap: 14px;
  }

  .calendar-grid.month .calendar-day {
    min-height: 80px;
  }

  .calendar-booking {
    font-size: 10px;
  }

  .calendar-header {
    flex-direction: column;
  }

  .action-buttons-grid {
    grid-template-columns: 1fr;
  }
}

/* Mobile devices */
@media (max-width: 768px) {
  
  /* Prevent zoom on input focus (iOS) */
  input, select, textarea, button {
    font-size: 16px !important;
  }

  /* Header */
  .admin-header {
    flex-direction: column;
    align-items: center;
    gap: 12px;
    text-align: center;
    padding: 16px 20px;
  }

  .admin-title {
    font-size: clamp(20px, 5.5vw, 24px);
  }

  .admin-subtitle {
    font-size: 14px;
  }

  .admin-badge {
    padding: 6px 12px;
    font-size: 12px;
  }

  /* Filters */
  .filters-bar {
    flex-direction: column;
    gap: 8px;
  }

  .filter-input,
  .filter-select {
    width: 100%;
    min-width: 100%;
    font-size: 16px;
    padding: 14px 16px;
  }

  /* Stats */
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .stat-card {
    padding: 16px;
  }

  .stat-value {
    font-size: 24px;
  }

  .stat-label {
    font-size: 12px;
  }

  /* Calendar */
  .calendar-container {
    padding: 16px;
    margin-bottom: 16px;
  }

  .calendar-header {
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 12px;
  }

  .calendar-nav {
    width: 100%;
    justify-content: space-between;
  }

  .calendar-current {
    font-size: 16px;
    min-width: 150px;
  }

  .calendar-view-selector {
    width: 100%;
    justify-content: center;
  }

  .calendar-view-btn {
    flex: 1;
    padding: 6px 8px;
    font-size: 11px;
  }

  .calendar-grid.month .calendar-day {
    min-height: 70px;
    padding: 4px;
  }

  .calendar-day-number {
    font-size: 12px;
  }

  .calendar-booking {
    font-size: 9px;
    padding: 2px 4px;
  }

  .calendar-booking-counter {
    padding: 12px;
  }
  
  .calendar-booking-counter-value {
    font-size: 24px;
  }
  
  .calendar-booking-counter-label {
    font-size: 13px;
  }

  /* Forms */
  .form-input,
  .region-select {
    width: 100%;
    min-width: 100%;
    font-size: 16px;
    padding: 14px 16px;
  }

  .form-row {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .button-group {
    flex-direction: column;
    gap: 8px;
  }
  
  .button-group .btn {
    width: 100%;
  }

  /* ===== FIXED: DATA TABLE MOBILE VIEW ===== */
  .data-table {
    font-size: 13px;
  }

  .data-table thead {
    display: none;
  }

  .data-table, 
  .data-table tbody, 
  .data-table tr, 
  .data-table td {
    display: block;
    width: 100%;
  }

  .data-table tr {
    margin-bottom: 20px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    background: #fff;
  }

  /* ‚úÖ FIXED: Remove padding-left that caused overlap */
  .data-table td {
    padding: 12px 0;
    border: none;
    position: relative;
    padding-left: 0 !important;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  /* ‚úÖ FIXED: Change from absolute to static positioning */
  .data-table td:before {
    content: attr(data-label);
    position: static;
    width: 100%;
    padding-right: 0;
    font-weight: 700;
    color: #64748b;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  /* ‚úÖ Make sure values wrap properly */
  .data-table td .detail-value,
  .data-table td > span,
  .data-table td > strong,
  .data-table td > div {
    width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* ‚úÖ Fix action buttons in mobile view */
  .data-table td[data-label="Actions"] {
    padding-top: 16px;
    border-top: 1px solid #e2e8f0;
    margin-top: 8px;
  }

  .data-table td[data-label="Actions"]:before {
    margin-bottom: 8px;
  }

  .data-table td[data-label="Actions"] > div {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }

  .data-table td[data-label="Actions"] .btn {
    width: 100%;
    justify-content: center;
  }

  /* ‚úÖ Fix status badges */
  .data-table .status-badge {
    display: inline-block;
    width: auto;
  }

  /* ‚úÖ Fix region badges */
  .data-table .region-badge {
    display: inline-block;
    width: auto;
  }

  /* Modal */
  .modal {
    padding: 0;
    align-items: flex-start;
  }

  .modal-dialog {
    max-width: 95%;
    margin: 10px auto;
  }

  .modal-header {
    padding: 16px;
  }

  .modal-header h3 {
    font-size: 18px;
  }

  .modal-body {
    padding: 16px;
  }

  .detail-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    padding: 12px;
  }

  .detail-value {
    text-align: left;
    width: 100%;
  }

  /* Password modal */
  .password-dialog {
    border-radius: 16px;
  }

  .password-header {
    padding: 32px 24px;
  }

  .password-logo {
    font-size: 48px;
  }

  .password-header h2 {
    font-size: 24px;
  }

  .password-body {
    padding: 28px 24px;
  }

  .password-input {
    font-size: 16px;
    padding: 14px 16px;
  }
}

/* Extra small screens (phones) */
@media (max-width: 480px) {
  
  body {
    font-size: 14px;
  }

  /* Calendar ultra compact */
  .calendar-container {
    padding: 8px;
    border-radius: 8px;
  }

  .calendar-header {
    gap: 8px;
    margin-bottom: 12px;
  }

  .calendar-nav {
    gap: 6px;
  }

  .btn.btn-small {
    padding: 8px 12px;
    font-size: 12px;
    white-space: nowrap;
  }

  .calendar-current {
    font-size: 13px;
    min-width: 100px;
  }

  .calendar-view-selector {
    padding: 2px;
    gap: 2px;
  }

  .calendar-view-btn {
    padding: 5px 6px;
    font-size: 10px;
  }

  .calendar-grid {
    gap: 0.5px;
  }

  .calendar-day-header {
    padding: 6px 2px;
    font-size: 10px;
  }

  .calendar-grid.month .calendar-day {
    min-height: 50px;
    max-height: 50px;
    padding: 2px;
    border-radius: 4px;
  }

  .calendar-day-number {
    font-size: 11px;
    margin-bottom: 2px;
  }

  /* Show only dots for bookings */
  .calendar-booking {
    height: 6px;
    padding: 0;
    margin-bottom: 1px;
    border-radius: 3px;
    text-indent: -9999px;
    overflow: hidden;
  }

  /* Stats grid single column */
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 8px;
  }

  .stat-card {
    padding: 12px;
  }

  .stat-value {
    font-size: 20px;
  }

  /* Forms */
  .form-label {
    font-size: 13px;
  }

  .btn {
    padding: 10px 16px;
    font-size: 13px;
  }

  .action-buttons-grid {
    gap: 8px;
  }

  /* Data table */
  .data-table {
    font-size: 12px;
  }

  .data-table td {
    padding: 6px 0;
  }

  .data-table td:before {
    font-size: 10px;
  }

  .data-table .btn-small {
    padding: 6px 10px;
    font-size: 11px;
    white-space: nowrap;
  }

  /* Modal full screen */
  .modal-dialog {
    max-width: 100%;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
  }

  .modal-header {
    border-radius: 0;
    padding: 12px;
  }

  .modal-header h3 {
    font-size: 16px;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    font-size: 20px;
  }

  .modal-body {
    padding: 12px;
  }

  .detail-item {
    padding: 10px 0;
  }

  .detail-label,
  .detail-value {
    font-size: 13px;
  }

  /* Spinner */
  .spinner {
    width: 35px;
    height: 35px;
    border-width: 3px;
  }

  /* Safe area insets for iOS */
  .admin-sidebar {
    padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
  }

  .admin-main {
    padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
  }
}

/* Touch-friendly tap targets */
@media (pointer: coarse) {
  .calendar-booking,
  .calendar-day,
  .btn,
  .nav-item {
    min-height: 44px;
  }

  .calendar-view-btn {
    min-height: 40px;
  }

  .nav-item, .btn, .filter-select, .filter-input {
    min-height: 44px;
    padding: 14px 20px;
  }
  
  .btn-small {
    min-height: 40px;
    padding: 8px 14px;
  }
}

/* ===== ADD THIS TO YOUR ADMIN PANEL CSS ===== */

/* Blocked time styling */
.calendar-booking.blocked {
  background: #ef4444 !important;
  color: #fff;
  font-weight: 600;
  border: 2px solid #dc2626;
}

.calendar-booking.blocked:hover {
  background: #dc2626 !important;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* Calendar day hover state */
.calendar-day:hover {
  background: #f8fafc;
}

.calendar-day.today:hover {
  background: #dbeafe;
}

/* Quick block modal styling */
#quickBlockModal .modal-dialog {
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ===== CALENDAR MOBILE FIXES - ADD TO YOUR <style> SECTION ===== */

/* Fix calendar booking boxes overlapping on mobile */
@media (max-width: 768px) {
  
  /* Make calendar day cells taller to fit content */
  .calendar-grid.month .calendar-day {
    min-height: 100px; /* Increased from 70px */
    padding: 6px;
    overflow: hidden;
  }

  /* Stack booking boxes properly */
  .calendar-booking {
    display: block;
    width: 100%;
    margin-bottom: 3px;
    padding: 4px 6px;
    font-size: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-radius: 4px;
  }

  /* Show only first 3 bookings, hide rest */
  .calendar-day .calendar-booking:nth-child(n+5) {
    display: none;
  }

  /* Add "more" indicator if there are hidden bookings */
  .calendar-day:has(.calendar-booking:nth-child(5))::after {
    content: '+more';
    display: block;
    font-size: 9px;
    color: #64748b;
    font-weight: 600;
    text-align: center;
    margin-top: 2px;
    padding: 2px;
    background: #f1f5f9;
    border-radius: 3px;
  }

  /* Calendar day number smaller */
  .calendar-day-number {
    font-size: 11px;
    margin-bottom: 4px;
    font-weight: 700;
  }

  /* Booking counter responsive */
  .calendar-booking-counter {
    padding: 10px;
    margin-bottom: 12px;
  }

  .calendar-booking-counter-value {
    font-size: 20px;
  }

  .calendar-booking-counter-label {
    font-size: 12px;
  }
}

/* Extra small phones - even more compact */
@media (max-width: 480px) {
  
  .calendar-grid.month .calendar-day {
    min-height: 60px;
    padding: 3px;
  }

  /* Show dots instead of text for bookings on tiny screens */
  .calendar-booking {
    height: 8px;
    padding: 0;
    margin-bottom: 2px;
    border-radius: 4px;
    text-indent: -9999px; /* Hide text */
    overflow: hidden;
    cursor: pointer;
  }

  /* Different colors for status */
  .calendar-booking:not(.pending):not(.cancelled):not(.blocked) {
    background: #3b82f6; /* Regular booking - blue */
  }

  .calendar-booking.pending {
    background: #f59e0b; /* Pending - orange */
  }

  .calendar-booking.cancelled {
    background: #94a3b8; /* Cancelled - gray */
  }

  .calendar-booking.blocked {
    background: #ef4444; /* Blocked - red */
  }

  /* Show max 4 dots */
  .calendar-day .calendar-booking:nth-child(n+6) {
    display: none;
  }

  /* More indicator */
  .calendar-day:has(.calendar-booking:nth-child(6))::after {
    content: '+';
    font-size: 10px;
    font-weight: 900;
    color: #fff;
    background: #64748b;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 2px;
  }

  .calendar-day-number {
    font-size: 10px;
    margin-bottom: 3px;
  }

  /* Ultra compact booking counter */
  .calendar-booking-counter {
    padding: 8px;
    margin-bottom: 8px;
  }

  .calendar-booking-counter-value {
    font-size: 18px;
  }

  .calendar-booking-counter-label {
    font-size: 11px;
  }
}

/* Optional: Add legend for mobile users */
@media (max-width: 480px) {
  .calendar-legend {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .calendar-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: #64748b;
  }

  .calendar-legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 3px;
  }
}

/* Template Card Styles */
.template-card {
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: 'Inter', sans-serif;
}

.template-card:hover {
  border-color: #3b82f6;
  background: #eff6ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.template-card:active {
  transform: translateY(0);
}

.recipient-checkbox-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-bottom: 1px solid #e2e8f0;
  cursor: pointer;
  transition: background 0.2s ease;
}

.recipient-checkbox-item:hover {
  background: #f8fafc;
}

.recipient-checkbox-item:last-child {
  border-bottom: none;
}

.recipient-checkbox-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.recipient-info {
  flex: 1;
}

.recipient-name {
  font-weight: 600;
  color: #1e293b;
  font-size: 14px;
}

.recipient-details {
  font-size: 12px;
  color: #64748b;
  margin-top: 2px;
}

.recipient-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
}

.badge-active {
  background: rgba(16, 185, 129, 0.1);
  color: #10b981;
}

.badge-inactive {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

  </style>
</head>
<body>

  <body>
  <!-- Password Protection Modal -->
<div class="password-modal" id="passwordModal">
  <div class="password-dialog">
    <div class="password-header">
      <div class="password-logo">
        <img src="/public/images/Markeb Media Logo (2).png" alt="Markeb Media" style="width: 80px; height: auto;">
      </div>
      <h2>Admin Access Required</h2>
      <p>Enter the admin code to continue</p>
    </div>
      
      <div class="password-body">
        <form id="passwordForm" onsubmit="checkPassword(event)">
          <div class="password-input-group">
            <input 
              type="password" 
              id="adminPassword" 
              class="password-input"
              placeholder="Enter admin code"
              autocomplete="off"
              autofocus
            />
            <div class="password-error" id="passwordError">
              ‚ùå Incorrect code. Please try again.
            </div>
          </div>
          
          <button type="submit" class="password-submit">
            <span>Unlock Admin Panel</span>
          </button>
        </form>
        
        <div class="password-footer">
          <p>‚ö†Ô∏è Authorized personnel only</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>

 <!-- Sidebar Navigation -->
<div class="admin-sidebar" id="adminSidebar">
  <div class="admin-logo">
    <img src="/public/images/Markeb Media Logo (2).png" alt="Markeb Media" style="height: 80px; width: auto;">
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Overview</div>
    <div class="nav-item active" onclick="showSection('dashboard')">
      <i data-lucide="layout-dashboard" class="nav-icon" style="width: 20px; height: 20px;"></i>
      Dashboard
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Bookings</div>
    <div class="nav-item" onclick="showSection('create-booking')">
      <i data-lucide="plus-circle" class="nav-icon" style="width: 20px; height: 20px;"></i>
      Create Booking
    </div>
    <div class="nav-item" onclick="showSection('calendar')">
      <i data-lucide="calendar" class="nav-icon" style="width: 20px; height: 20px;"></i>
      Calendar
    </div>
    <div class="nav-item" onclick="showSection('bookings')">
      <i data-lucide="clipboard-list" class="nav-icon" style="width: 20px; height: 20px;"></i>
      All Bookings
    </div>
    <div class="nav-item" onclick="showSection('pending')">
      <i data-lucide="credit-card" class="nav-icon" style="width: 20px; height: 20px;"></i>
      Pending (Need Payment)
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Marketing</div>
    <div class="nav-item" onclick="showSection('discount-codes')">
      <i data-lucide="gift" class="nav-icon" style="width: 20px; height: 20px;"></i>
      Discount Codes
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Customers</div>
    <div class="nav-item" onclick="showSection('customers')">
      <i data-lucide="users" class="nav-icon" style="width: 20px; height: 20px;"></i>
      All Customers
    </div>
  </div>

  <div class="nav-section">
  <div class="nav-section-title">COMMUNICATIONS</div>
  <div class="nav-item" onclick="showSection('market-updates')">
    <i data-lucide="trending-up" class="nav-icon"></i>
    Market Updates
  </div>
  <div class="nav-item" onclick="showSection('email-broadcast')">
    <i data-lucide="send" class="nav-icon"></i>
    Email Broadcast
  </div>
</div>

  <div class="nav-section">
    <div class="nav-section-title">Schedule</div>
    <div class="nav-item" onclick="showSection('blocked-times')">
      <i data-lucide="ban" class="nav-icon" style="width: 20px; height: 20px;"></i>
      Block Times
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Tools</div>
    <div class="nav-item" onclick="window.open('uk-client-map.html', '_blank')">
      <i data-lucide="map" class="nav-icon" style="width: 20px; height: 20px;"></i>
      UK Map
    </div>
  </div>

  <div class="nav-section" style="margin-top: auto; padding-top: 24px; border-top: 2px solid #e2e8f0;">
    <div class="nav-item" onclick="adminLogout()" style="color: #ef4444;">
      <i data-lucide="log-out" class="nav-icon" style="width: 20px; height: 20px;"></i>
      Logout
    </div>
  </div>
</div>

  <!-- Main Content -->
  <div class="admin-main">
    <!-- Header -->
    <div class="admin-header">
      <div>
        <div class="admin-title">Admin Panel</div>
        <div class="admin-subtitle">Manage bookings, customers, and payments</div>
      </div>
      <div class="admin-badge">‚ö†Ô∏è ADMIN ACCESS</div>
    </div>

    <!-- Dashboard Section -->
    <div class="admin-section active" id="dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalBookings">-</div>
          <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="upcomingBookings">-</div>
          <div class="stat-label">Upcoming</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pendingBookings">-</div>
          <div class="stat-label">Need Payment</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalCustomers">-</div>
          <div class="stat-label">Total Customers</div>
        </div>
      </div>

      <div class="calendar-container">
        <div style="text-align: center; padding: 40px;">
          <h3 style="color: #64748b;">Welcome to the Admin Panel</h3>
          <p style="color: #94a3b8; margin-top: 8px;">Select a section from the sidebar to get started</p>
        </div>
      </div>
    </div>

    <!-- Create Booking Section -->
<div class="admin-section" id="create-booking">
  <div class="calendar-container">
    <h2 style="margin-bottom: 24px;">Create New Booking</h2>
    
    <form id="adminBookingForm">
      <!-- Customer Selection -->
      <div class="form-group">
  <label class="form-label">Customer</label>
  <input 
    type="text" 
    id="bookingCustomer" 
    class="form-input" 
    list="customersList" 
    placeholder="Type name or select from list..."
    onchange="populateCustomerDetails()"
  >
  <datalist id="customersList">
    <!-- Populated from allCustomers -->
  </datalist>
  <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
    üí° Select existing customer or type manually for new customers
  </small>
</div>

<div class="form-row">
  <div class="form-group">
    <label class="form-label">Customer Name *</label>
    <input type="text" id="bookingClientName" class="form-input" required>
  </div>
  <div class="form-group">
    <label class="form-label">Customer Email *</label>
    <input type="email" id="bookingClientEmail" class="form-input" required>
  </div>
</div>

      <!-- Region Selection -->
      <div class="form-group">
        <label class="form-label">Region *</label>
        <select id="bookingRegion" class="form-input" required onchange="loadServicesForRegion()">
          <option value="">-- Select Region --</option>
          <option value="North">North</option>
          <option value="South">South</option>
        </select>
      </div>

      <!-- Service Selection -->
      <div class="form-group">
        <label class="form-label">Service *</label>
        <select id="bookingService" class="form-input" required onchange="updateBookingPrice()">
          <option value="">-- Select Service --</option>
        </select>
      </div>

      <!-- Bedrooms (conditional) -->
      <div class="form-group" id="bookingBedroomsSection" style="display: none;">
        <label class="form-label">Bedrooms</label>
        <div style="display: flex; align-items: center; gap: 16px;">
          <button type="button" class="bedroom-btn" onclick="adjustBookingBedrooms(-1)">-</button>
          <div style="flex: 1; text-align: center;">
            <div id="bookingBedroomCount" style="font-size: 32px; font-weight: 700; color: #3b82f6;">4</div>
          </div>
          <button type="button" class="bedroom-btn" onclick="adjustBookingBedrooms(1)">+</button>
        </div>
      </div>

      <!-- Add-ons -->
      <div id="bookingAddonsSection" style="display: none; margin-top: 24px;">
        <label class="form-label">Add-Ons (Optional)</label>
        <div id="bookingAddonCheckboxes" style="display: flex; flex-direction: column; gap: 12px;">
          <!-- Populated dynamically -->
        </div>
      </div>

      <!-- Property Details -->
      <div class="form-group">
        <label class="form-label">Property Address *</label>
        <input type="text" id="bookingAddress" class="form-input" required placeholder="Full property address">
      </div>

      <div class="form-row">
        <div class="form-group">
  <label class="form-label">Postcode *</label>
  <input type="text" id="bookingPostcode" class="form-input" required placeholder="e.g. M1 1AA" onchange="checkAdminAvailability()">
</div>
        <div class="form-group">
          <label class="form-label">Access Instructions</label>
          <input type="text" id="bookingAccess" class="form-input" placeholder="Key location, gate code, etc.">
        </div>
      </div>

      <!-- Date & Time -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date *</label>
          <input type="date" id="bookingDate" class="form-input" required 
                 min="${new Date().toISOString().split('T')[0]}"
                 onchange="checkAdminAvailability()">
        </div>
        <div class="form-group">
          <label class="form-label">Time *</label>
          <select id="bookingTime" class="form-input" required onchange="checkAdminAvailability()">
            <option value="">-- Select Time --</option>
            ${generateTimeOptions()}
          </select>
        </div>
      </div>

      <!-- Availability Check Results -->
      <div id="availabilityResults" style="display: none; margin: 16px 0;"></div>

      <!-- Price Breakdown -->
      <div id="bookingPriceBreakdown" style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 24px 0; display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
          <span style="color: #64748b;">Service</span>
          <span id="bookingServicePrice" style="font-weight: 600;">¬£0.00</span>
        </div>
        <div id="bookingBedroomRow" style="display: none; justify-content: space-between; margin-bottom: 12px;">
          <span style="color: #64748b;">Extra bedrooms</span>
          <span id="bookingBedroomFee" style="font-weight: 600;">¬£0.00</span>
        </div>
        <div id="bookingAddonsRow" style="display: none; justify-content: space-between; margin-bottom: 12px;">
          <span style="color: #64748b;">Add-ons</span>
          <span id="bookingAddonsFee" style="font-weight: 600;">¬£0.00</span>
        </div>
        <div style="border-top: 2px solid #e2e8f0; margin: 16px 0;"></div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 18px; font-weight: 700;">Total Price</span>
          <span id="bookingTotalPrice" style="font-size: 24px; font-weight: 700; color: #3b82f6;">¬£0.00</span>
        </div>
      </div>

      <!-- Discount Code -->
      <div class="form-group">
        <label class="form-label">Discount Code (Optional)</label>
        <div style="display: flex; gap: 12px;">
          <input 
            type="text" 
            id="bookingDiscountCode" 
            class="form-input" 
            placeholder="Enter discount code"
            style="flex: 1; text-transform: uppercase;"
          >
          <button 
            type="button" 
            class="btn btn-primary" 
            onclick="applyAdminDiscount()"
            style="white-space: nowrap;"
          >
            Apply Code
          </button>
        </div>
        <div id="discountMessage" style="margin-top: 8px; font-size: 13px;"></div>
      </div>

      <!-- Payment Options -->
      <div class="form-group">
        <label class="form-label">Payment Status *</label>
        <select id="bookingPaymentStatus" class="form-input" required>
          <option value="Pending">Pending (Reserve without payment)</option>
          <option value="Paid">Paid (Mark as paid manually)</option>
        </select>
      </div>

      <!-- Submit Buttons -->
      <div class="button-group" style="margin-top: 24px;">
        <button type="button" class="btn btn-secondary" onclick="resetBookingForm()" style="flex: 1;">
          Reset Form
        </button>
        <button type="submit" class="btn btn-success" style="flex: 2;">
          Create Booking
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Discount Codes Section -->
<div class="admin-section" id="discount-codes">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div>
      <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Discount Codes</h2>
      <p style="color: #64748b; font-size: 14px;">Create and manage promotional discount codes</p>
    </div>
    <button class="btn btn-primary" onclick="showCreateDiscountModal()">
      ‚ûï Create Discount Code
    </button>
  </div>

  <div class="filters-bar">
    <select class="filter-select" id="discountStatusFilter" onchange="loadDiscountCodes()">
      <option value="">All Status</option>
      <option value="Active">Active</option>
      <option value="Inactive">Inactive</option>
    </select>
    <button class="btn btn-primary" onclick="loadDiscountCodes()">üîÑ Refresh</button>
  </div>

  <div class="calendar-container" id="discountCodesContainer">
    <div style="text-align: center; padding: 40px;">
      <div class="spinner"></div>
    </div>
  </div>
</div>

    <!-- Calendar Section -->
    <div class="admin-section" id="calendar">
      <div class="calendar-container">
        <div class="calendar-header">
          <div class="calendar-nav">
            <button class="btn btn-primary btn-small" onclick="previousPeriod()">‚óÄ Previous</button>
            <div class="calendar-current" id="calendarCurrent">Loading...</div>
            <button class="btn btn-primary btn-small" onclick="nextPeriod()">Next ‚ñ∂</button>
          </div>
          <div class="calendar-view-selector">
            <button class="calendar-view-btn active" data-view="month" onclick="setCalendarView('month')">Month</button>
            <button class="calendar-view-btn" data-view="week" onclick="setCalendarView('week')">Week</button>
            <button class="calendar-view-btn" data-view="day" onclick="setCalendarView('day')">Day</button>
          </div>
        </div>

        <div class="filters-bar">
          <select class="filter-select" id="calendarRegion" onchange="loadCalendar()">
            <option value="">All Regions</option>
            <option value="North">North</option>
            <option value="South">South</option>
          </select>
          <button class="btn btn-primary" onclick="loadCalendar()">üîÑ Refresh</button>
        </div>

        <div id="calendarGrid">
          <div style="text-align: center; padding: 40px;">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- All Bookings Section -->
    <div class="admin-section" id="bookings">
      <div class="filters-bar">
        <input type="text" class="filter-input" id="bookingSearch" placeholder="Search by name, email, address, reference...">
        <select class="filter-select" id="bookingRegion">
          <option value="">All Regions</option>
          <option value="North">North</option>
          <option value="South">South</option>
        </select>
        <select class="filter-select" id="bookingStatus">
          <option value="">All Status</option>
          <option value="Booked">Booked</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <button class="btn btn-primary" onclick="loadBookings()">üîç Search</button>
      </div>

      <div class="calendar-container" id="bookingsContainer">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

   <!-- Pending Bookings Section -->
<div class="admin-section" id="pending">
  <div class="info-box" style="margin-bottom: 24px;">
    <strong>üí≥ Reserved Bookings</strong><br>
    These bookings have been reserved but require payment. You can either charge the customer's saved card or send them a payment link via email.
  </div>

  <div class="calendar-container" id="pendingContainer">
    <div style="text-align: center; padding: 40px;">
      <div class="spinner"></div>
    </div>
  </div>
</div>

    <!-- Customers Section -->
    <div class="admin-section" id="customers">
      <div class="filters-bar">
        <input type="text" class="filter-input" id="customerSearch" placeholder="Search by name, email, company...">
        <button class="btn btn-primary" onclick="loadCustomers()">üîç Search</button>
      </div>

      <div class="calendar-container" id="customersContainer">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  

  <!-- Blocked Times Section -->
<div class="admin-section" id="blocked-times">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div>
      <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Blocked Times</h2>
      <p style="color: #64748b; font-size: 14px;">Block out dates and times when bookings cannot be made</p>
    </div>
    <button class="btn btn-primary" onclick="showCreateBlockModal()">
      ‚ûï Block Time
    </button>
  </div>

  <div class="filters-bar">
    <select class="filter-select" id="blockRegionFilter" onchange="loadBlockedTimes()">
      <option value="">All Regions</option>
      <option value="North">North</option>
      <option value="South">South</option>
    </select>
    <button class="btn btn-primary" onclick="loadBlockedTimes()">üîÑ Refresh</button>
  </div>

  <div class="calendar-container" id="blockedTimesContainer">
    <div style="text-align: center; padding: 40px;">
      <div class="spinner"></div>
    </div>
  </div>
</div>

<!-- Market Updates Section -->
<div class="admin-section" id="market-updates">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div>
      <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Market Updates</h2>
      <p style="color: #64748b; font-size: 14px;">Send property market insights to opted-in estate agents by region</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid" style="margin-bottom: 24px;">
    <div class="stat-card">
      <div class="stat-value" id="totalOptedIn">-</div>
      <div class="stat-label">Total Opted In</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="northOptedIn">-</div>
      <div class="stat-label">North Region</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="southOptedIn">-</div>
      <div class="stat-label">South Region</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="lastSentDate">-</div>
      <div class="stat-label">Last Sent</div>
    </div>
  </div>

  <!-- Send Controls -->
  <div class="calendar-container">
    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">üìß Send Market Update</h3>
    
    <div class="info-box" style="margin-bottom: 24px;">
      üí° <strong>How it works:</strong> Select a region and compose your market update. Only customers who have opted in for market updates in that region will receive the email.
    </div>

    <div class="form-group">
  <label class="form-label" for="marketUpdateRegion">Select Region(s) *</label>
  <select 
    id="marketUpdateRegion" 
    class="form-input" 
    required 
    multiple 
    size="8" 
    onchange="updateMarketRecipientCount()" 
    style="height: auto; min-height: 200px;"
  >
    <optgroup label="üéØ Your Service Regions">
      <option value="Cheshire East">Cheshire East</option>
      <option value="Cheshire West and Chester">Cheshire West and Chester</option>
      <option value="Greater London">Greater London</option>
      <option value="Greater Manchester">Greater Manchester</option>
      <option value="Essex">Essex</option>
      <option value="West Midlands">West Midlands</option>
      <option value="Leicestershire">Leicestershire</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England - Yorkshire & Humber">
      <option value="South Yorkshire">South Yorkshire</option>
      <option value="West Yorkshire">West Yorkshire</option>
      <option value="North Yorkshire">North Yorkshire</option>
      <option value="East Riding of Yorkshire">East Riding of Yorkshire</option>
      <option value="York">York</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England - North West">
      <option value="Cumbria">Cumbria</option>
      <option value="Lancashire">Lancashire</option>
      <option value="Merseyside">Merseyside</option>
      <option value="Blackburn with Darwen">Blackburn with Darwen</option>
      <option value="Blackpool">Blackpool</option>
      <option value="Halton">Halton</option>
      <option value="Warrington">Warrington</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England - North East">
      <option value="County Durham">County Durham</option>
      <option value="Northumberland">Northumberland</option>
      <option value="Tyne and Wear">Tyne and Wear</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England - Midlands">
      <option value="Derbyshire">Derbyshire</option>
      <option value="Derby">Derby</option>
      <option value="Herefordshire">Herefordshire</option>
      <option value="Lincolnshire">Lincolnshire</option>
      <option value="Northamptonshire">Northamptonshire</option>
      <option value="Nottinghamshire">Nottinghamshire</option>
      <option value="Nottingham">Nottingham</option>
      <option value="Rutland">Rutland</option>
      <option value="Shropshire">Shropshire</option>
      <option value="Telford and Wrekin">Telford and Wrekin</option>
      <option value="Staffordshire">Staffordshire</option>
      <option value="Stoke-on-Trent">Stoke-on-Trent</option>
      <option value="Warwickshire">Warwickshire</option>
      <option value="Worcestershire">Worcestershire</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England - East">
      <option value="Bedford">Bedford</option>
      <option value="Central Bedfordshire">Central Bedfordshire</option>
      <option value="Cambridgeshire">Cambridgeshire</option>
      <option value="Peterborough">Peterborough</option>
      <option value="Hertfordshire">Hertfordshire</option>
      <option value="Norfolk">Norfolk</option>
      <option value="Suffolk">Suffolk</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England - South East">
      <option value="Berkshire">Berkshire</option>
      <option value="Buckinghamshire">Buckinghamshire</option>
      <option value="East Sussex">East Sussex</option>
      <option value="Brighton and Hove">Brighton and Hove</option>
      <option value="Hampshire">Hampshire</option>
      <option value="Portsmouth">Portsmouth</option>
      <option value="Southampton">Southampton</option>
      <option value="Isle of Wight">Isle of Wight</option>
      <option value="Kent">Kent</option>
      <option value="Medway">Medway</option>
      <option value="Oxfordshire">Oxfordshire</option>
      <option value="Surrey">Surrey</option>
      <option value="West Sussex">West Sussex</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England - South West">
      <option value="Bristol">Bristol</option>
      <option value="Cornwall">Cornwall</option>
      <option value="Devon">Devon</option>
      <option value="Plymouth">Plymouth</option>
      <option value="Torbay">Torbay</option>
      <option value="Dorset">Dorset</option>
      <option value="Bournemouth, Christchurch and Poole">Bournemouth, Christchurch and Poole</option>
      <option value="Gloucestershire">Gloucestershire</option>
      <option value="Somerset">Somerset</option>
      <option value="Bath and North East Somerset">Bath and North East Somerset</option>
      <option value="North Somerset">North Somerset</option>
      <option value="South Gloucestershire">South Gloucestershire</option>
      <option value="Wiltshire">Wiltshire</option>
      <option value="Swindon">Swindon</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø Scotland">
      <option value="Aberdeen City">Aberdeen City</option>
      <option value="Aberdeenshire">Aberdeenshire</option>
      <option value="Angus">Angus</option>
      <option value="Argyll and Bute">Argyll and Bute</option>
      <option value="City of Edinburgh">City of Edinburgh</option>
      <option value="Clackmannanshire">Clackmannanshire</option>
      <option value="Dumfries and Galloway">Dumfries and Galloway</option>
      <option value="Dundee City">Dundee City</option>
      <option value="East Ayrshire">East Ayrshire</option>
      <option value="East Dunbartonshire">East Dunbartonshire</option>
      <option value="East Lothian">East Lothian</option>
      <option value="East Renfrewshire">East Renfrewshire</option>
      <option value="Falkirk">Falkirk</option>
      <option value="Fife">Fife</option>
      <option value="Glasgow City">Glasgow City</option>
      <option value="Highland">Highland</option>
      <option value="Inverclyde">Inverclyde</option>
      <option value="Midlothian">Midlothian</option>
      <option value="Moray">Moray</option>
      <option value="North Ayrshire">North Ayrshire</option>
      <option value="North Lanarkshire">North Lanarkshire</option>
      <option value="Orkney Islands">Orkney Islands</option>
      <option value="Perth and Kinross">Perth and Kinross</option>
      <option value="Renfrewshire">Renfrewshire</option>
      <option value="Scottish Borders">Scottish Borders</option>
      <option value="Shetland Islands">Shetland Islands</option>
      <option value="South Ayrshire">South Ayrshire</option>
      <option value="South Lanarkshire">South Lanarkshire</option>
      <option value="Stirling">Stirling</option>
      <option value="West Dunbartonshire">West Dunbartonshire</option>
      <option value="West Lothian">West Lothian</option>
      <option value="Na h-Eileanan Siar">Na h-Eileanan Siar</option>
    </optgroup>
    
    <optgroup label="üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Wales">
      <option value="Isle of Anglesey">Isle of Anglesey</option>
      <option value="Blaenau Gwent">Blaenau Gwent</option>
      <option value="Bridgend">Bridgend</option>
      <option value="Caerphilly">Caerphilly</option>
      <option value="Cardiff">Cardiff</option>
      <option value="Carmarthenshire">Carmarthenshire</option>
      <option value="Ceredigion">Ceredigion</option>
      <option value="Conwy">Conwy</option>
      <option value="Denbighshire">Denbighshire</option>
      <option value="Flintshire">Flintshire</option>
      <option value="Gwynedd">Gwynedd</option>
      <option value="Merthyr Tydfil">Merthyr Tydfil</option>
      <option value="Monmouthshire">Monmouthshire</option>
      <option value="Neath Port Talbot">Neath Port Talbot</option>
      <option value="Newport">Newport</option>
      <option value="Pembrokeshire">Pembrokeshire</option>
      <option value="Powys">Powys</option>
      <option value="Rhondda Cynon Taf">Rhondda Cynon Taf</option>
      <option value="Swansea">Swansea</option>
      <option value="Torfaen">Torfaen</option>
      <option value="Vale of Glamorgan">Vale of Glamorgan</option>
      <option value="Wrexham">Wrexham</option>
    </optgroup>
    
    <optgroup label="Northern Ireland">
      <option value="Antrim and Newtownabbey">Antrim and Newtownabbey</option>
      <option value="Ards and North Down">Ards and North Down</option>
      <option value="Armagh City, Banbridge and Craigavon">Armagh City, Banbridge and Craigavon</option>
      <option value="Belfast">Belfast</option>
      <option value="Causeway Coast and Glens">Causeway Coast and Glens</option>
      <option value="Derry City and Strabane">Derry City and Strabane</option>
      <option value="Fermanagh and Omagh">Fermanagh and Omagh</option>
      <option value="Lisburn and Castlereagh">Lisburn and Castlereagh</option>
      <option value="Mid and East Antrim">Mid and East Antrim</option>
      <option value="Mid Ulster">Mid Ulster</option>
      <option value="Newry, Mourne and Down">Newry, Mourne and Down</option>
    </optgroup>
  </select>
  <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
    üí° Hold Ctrl (Windows) or Cmd (Mac) to select multiple regions
  </div>
  <div id="recipientCount" style="font-size: 13px; margin-top: 8px;">
    Select region(s) to see recipient count
  </div>
</div>

<!-- Add this ABOVE the subject field -->
<div style="margin-bottom: 24px;">
  <button type="button" class="btn btn-primary" onclick="autoFetchMarketData()" id="fetchDataBtn">
    üìä Auto-Fetch Market Data & Generate Content
  </button>
  <div id="dataPreview" style="margin-top: 16px;"></div>
</div>

      <div class="form-group">
        <label class="form-label" for="marketUpdateSubject">Email Subject *</label>
        <input 
          type="text" 
          id="marketUpdateSubject" 
          class="form-input" 
          placeholder="e.g., Property Market Update - [Region] - [Month Year]"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="marketUpdateContent">Email Content *</label>
        <textarea 
          id="marketUpdateContent" 
          class="form-input" 
          rows="12"
          placeholder="Compose your market update here...

Example:
Hey [Name],

Here's what's happening in the [Region] property market:

üìä KEY STATS
- Average sale price: ¬£XXX,XXX (‚ÜëX% vs last month)
- Median time to sell: XX days
- Transaction volume: XXX properties

üéØ WHAT THIS MEANS FOR YOU
[Your insights and interpretation]

üí° VALUATION INSIGHT
[Specific actionable advice for estate agents]

Best regards,
Markeb Media Team"
          required
        ></textarea>
        <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
          üí° Use [Name] to personalize with customer name
        </div>
      </div>

      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
          <input type="checkbox" id="marketUpdatePreview" style="width: 20px; height: 20px;">
          <span style="font-size: 14px; font-weight: 600;">Send test email to myself first</span>
        </label>
      </div>

      <div class="button-group" style="margin-top: 24px;">
        <button type="button" class="btn btn-secondary" onclick="resetMarketUpdateForm()" style="flex: 1;">
          Reset
        </button>
        <button type="submit" class="btn btn-primary" style="flex: 2;">
          üìß Send Market Update
        </button>
      </div>
    </form>
  </div>

  <!-- Send History -->
  <div class="calendar-container" style="margin-top: 24px;">
    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">üìú Send History</h3>
    <div id="marketUpdateHistory">
      <div style="text-align: center; padding: 40px;">
        <div class="spinner"></div>
      </div>
    </div>
  </div>
</div>

<!-- EMAIL BROADCAST SECTION -->
<div id="email-broadcast" class="admin-section">
  
  <!-- Stats Cards -->
  <div class="stats-grid" style="margin-bottom: 32px;">
    <div class="stat-card">
      <div class="stat-value" id="broadcastTotalUsers">-</div>
      <div class="stat-label">Dashboard Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="broadcastSelected">0</div>
      <div class="stat-label">Selected Recipients</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="broadcastLastSent">Never</div>
      <div class="stat-label">Last Broadcast</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="broadcastTotalSent">0</div>
      <div class="stat-label">Total Sent</div>
    </div>
  </div>

  <!-- Select Recipients -->
  <div class="calendar-container" style="margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="font-size: 18px; font-weight: 700;">
        <i data-lucide="users" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i>
        Select Recipients
      </h3>
      <div style="display: flex; gap: 8px;">
        <button class="btn btn-secondary btn-small" onclick="selectAllBroadcastRecipients()">
          Select All
        </button>
        <button class="btn btn-secondary btn-small" onclick="deselectAllBroadcastRecipients()">
          Deselect All
        </button>
      </div>
    </div>
    
    <!-- Search & Filter -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 20px;">
      <input type="text" id="broadcastRecipientSearch" class="form-input" placeholder="Search by name, company, or email..." oninput="filterBroadcastRecipients()">
      <select id="broadcastRecipientFilter" class="form-input" onchange="filterBroadcastRecipients()">
        <option value="all">All Users</option>
        <option value="active">Active Only</option>
        <option value="email-enabled">Email Notifications On</option>
      </select>
    </div>

    <!-- Recipient List -->
    <div id="broadcastRecipientList" style="max-height: 400px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; background: #fff;">
      <div style="text-align: center; padding: 40px; color: #94a3b8;">
        <div class="spinner"></div>
        <p style="margin-top: 12px;">Loading users...</p>
      </div>
    </div>
  </div>

  <!-- Template Selection -->
  <div class="calendar-container" style="margin-bottom: 24px;">
    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">
      <i data-lucide="layout-template" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i>
      Choose Template
    </h3>
    
    <div class="info-box" style="margin-bottom: 24px;">
      <strong>Merge tags available:</strong> <code>[Name]</code>, <code>[Company]</code>, <code>[Email]</code><br>
      Each recipient receives an individual email (not CC'd or BCC'd together).
    </div>

    <!-- Template Buttons -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 24px;">
      
      <div class="template-card" onclick="loadBroadcastTemplate('availability')">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <i data-lucide="calendar-check" style="width: 24px; height: 24px; color: #3b82f6;"></i>
          <strong style="font-size: 15px;">Availability Reminder</strong>
        </div>
        <p style="font-size: 13px; color: #64748b; margin: 0;">
          Auto-generates available dates from booking calendar
        </p>
      </div>

      <div class="template-card" onclick="loadBroadcastTemplate('feature-announcement')">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <i data-lucide="sparkles" style="width: 24px; height: 24px; color: #10b981;"></i>
          <strong style="font-size: 15px;">New Feature</strong>
        </div>
        <p style="font-size: 13px; color: #64748b; margin: 0;">
          Announce new dashboard features
        </p>
      </div>

      <div class="template-card" onclick="loadBroadcastTemplate('seasonal-offer')">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <i data-lucide="gift" style="width: 24px; height: 24px; color: #f59e0b;"></i>
          <strong style="font-size: 15px;">Seasonal Offer</strong>
        </div>
        <p style="font-size: 13px; color: #64748b; margin: 0;">
          Holiday discounts and promotions
        </p>
      </div>

      <div class="template-card" onclick="loadBroadcastTemplate('tips-advice')">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <i data-lucide="lightbulb" style="width: 24px; height: 24px; color: #8b5cf6;"></i>
          <strong style="font-size: 15px;">Tips & Advice</strong>
        </div>
        <p style="font-size: 13px; color: #64748b; margin: 0;">
          Property marketing tips
        </p>
      </div>

      <div class="template-card" onclick="loadBroadcastTemplate('company-news')">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <i data-lucide="newspaper" style="width: 24px; height: 24px; color: #ef4444;"></i>
          <strong style="font-size: 15px;">Company News</strong>
        </div>
        <p style="font-size: 13px; color: #64748b; margin: 0;">
          Team updates and achievements
        </p>
      </div>

      <div class="template-card" onclick="loadBroadcastTemplate('custom')">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <i data-lucide="pencil" style="width: 24px; height: 24px; color: #64748b;"></i>
          <strong style="font-size: 15px;">Custom Email</strong>
        </div>
        <p style="font-size: 13px; color: #64748b; margin: 0;">
          Write your own message
        </p>
      </div>

    </div>

    <!-- Email Composer (shown after template selection) -->
    <div id="broadcastComposer" style="display: none;">
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label class="form-label">
          Email Subject <span style="color: #ef4444;">*</span>
        </label>
        <input type="text" id="broadcastSubject" class="form-input" placeholder="e.g., Book Your Spring Property Shoot Today!" required>
      </div>

      <div class="form-group" style="margin-bottom: 20px;">
        <label class="form-label">
          Email Content <span style="color: #ef4444;">*</span>
        </label>
        <textarea id="broadcastContent" class="form-input" rows="14" placeholder="Hi [Name],

We wanted to reach out..." required></textarea>
        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
          HTML allowed: <code>&lt;strong&gt;</code>, <code>&lt;br&gt;</code>, <code>&lt;a href=""&gt;</code>, <code>&lt;ul&gt;</code>, <code>&lt;li&gt;</code>
        </div>
      </div>

      <!-- Preview -->
      <div class="form-group" style="margin-bottom: 20px;">
        <label class="form-label">
          Preview (with first recipient's data)
        </label>
        <button class="btn btn-secondary btn-small" onclick="updateBroadcastPreview()" style="margin-bottom: 12px;">
          Refresh Preview
        </button>
        <div id="broadcastPreview" style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 24px; min-height: 200px;">
          <div style="text-align: center; color: #94a3b8;">
            Select a template or enter content to preview
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="sendBroadcastEmail()" id="sendBroadcastBtn">
          <i data-lucide="send" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></i>
          Send to <span id="sendBroadcastCount">0</span> Recipients
        </button>
        
        <button class="btn btn-secondary" onclick="sendTestBroadcast()">
          <i data-lucide="flask-conical" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></i>
          Send Test to Yourself
        </button>
        
        <button class="btn btn-secondary" onclick="clearBroadcastForm()">
          <i data-lucide="x" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></i>
          Clear
        </button>
      </div>

    </div>

  </div>

  <!-- Broadcast History -->
  <div class="calendar-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="font-size: 18px; font-weight: 700;">
        <i data-lucide="history" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;"></i>
        Broadcast History
      </h3>
      <button class="btn btn-secondary btn-small" onclick="clearBroadcastHistory()">
        Clear History
      </button>
    </div>
    <div id="broadcastHistoryContainer">
      <div style="text-align: center; padding: 40px; color: #94a3b8;">
        <i data-lucide="clock" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
        <p>No broadcasts sent yet</p>
      </div>
    </div>
  </div>

</div>
<!-- END EMAIL BROADCAST SECTION -->

  <!-- Booking Detail Modal -->
  <div class="modal" id="bookingModal" onclick="closeModal('bookingModal')">
    <div class="modal-dialog" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="bookingModalTitle">Booking Details</h3>
        <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
      </div>
      <div class="modal-body" id="bookingModalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Customer Detail Modal -->
  <div class="modal" id="customerModal" onclick="closeModal('customerModal')">
    <div class="modal-dialog" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="customerModalTitle">Customer Details</h3>
        <button class="modal-close" onclick="closeModal('customerModal')">&times;</button>
      </div>
      <div class="modal-body" id="customerModalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Reschedule Modal -->
<div class="modal" id="rescheduleModal" onclick="closeModal('rescheduleModal')">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Reschedule Booking</h3>
      <button class="modal-close" onclick="closeModal('rescheduleModal')">&times;</button>
    </div>
    <div class="modal-body" id="rescheduleModalBody">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Cancel Modal -->
<div class="modal" id="cancelModal" onclick="closeModal('cancelModal')">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Cancel Booking</h3>
      <button class="modal-close" onclick="closeModal('cancelModal')">&times;</button>
    </div>
    <div class="modal-body" id="cancelModalBody">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Modify Service Modal -->
<div class="modal" id="modifyServiceModal" onclick="closeModal('modifyServiceModal')">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Modify Service</h3>
      <button class="modal-close" onclick="closeModal('modifyServiceModal')">&times;</button>
    </div>
    <div class="modal-body" id="modifyServiceModalBody">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Create/Edit Discount Code Modal -->
<div class="modal" id="discountModal" onclick="closeModal('discountModal')">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="discountModalTitle">Create Discount Code</h3>
      <button class="modal-close" onclick="closeModal('discountModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="discountForm" onsubmit="saveDiscountCode(event)">
        
        <!-- Code -->
        <div class="form-group">
          <label class="form-label" for="discountCode">Discount Code *</label>
          <input 
            type="text" 
            id="discountCode" 
            class="form-input" 
            placeholder="e.g. SUMMER25"
            style="text-transform: uppercase;"
            maxlength="20"
            required
          />
          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
            Use uppercase letters and numbers only. No spaces.
          </div>
        </div>

        <!-- Discount Type & Value -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="discountType">Discount Type *</label>
            <select id="discountType" class="form-input" required onchange="updateDiscountValueLabel()">
              <option value="">-- Select Type --</option>
              <option value="Percentage">Percentage Off</option>
              <option value="Fixed Amount">Fixed Amount Off</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="discountValue">
              <span id="discountValueLabel">Discount Value *</span>
            </label>
            <input 
              type="number" 
              id="discountValue" 
              class="form-input" 
              placeholder="e.g. 25"
              min="0"
              step="0.01"
              required
            />
          </div>
        </div>

        <!-- Status -->
        <div class="form-group">
          <label class="form-label" for="discountStatus">Status *</label>
          <select id="discountStatus" class="form-input" required>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>

        <!-- Valid From & Until -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="validFrom">Valid From</label>
            <input 
              type="date" 
              id="validFrom" 
              class="form-input"
            />
          </div>
          
          <div class="form-group">
            <label class="form-label" for="validUntil">Valid Until</label>
            <input 
              type="date" 
              id="validUntil" 
              class="form-input"
            />
          </div>
        </div>

        <!-- Max Uses -->
        <div class="form-group">
          <label class="form-label" for="maxUses">Max Total Uses</label>
          <input 
            type="number" 
            id="maxUses" 
            class="form-input" 
            placeholder="Leave blank for unlimited"
            min="1"
          />
          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
            Total number of times this code can be used across all customers
          </div>
        </div>

        <!-- Min Purchase -->
        <div class="form-group">
          <label class="form-label" for="minPurchase">Minimum Purchase (¬£)</label>
          <input 
            type="number" 
            id="minPurchase" 
            class="form-input" 
            placeholder="e.g. 100.00"
            min="0"
            step="0.01"
          />
          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
            Minimum booking value required to use this code
          </div>
        </div>

        <!-- Applicable Regions -->
        <div class="form-group">
          <label class="form-label">Applicable Regions</label>
          <div style="display: flex; gap: 16px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="North" class="region-checkbox" style="width: 18px; height: 18px;">
              <span>North</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" value="South" class="region-checkbox" style="width: 18px; height: 18px;">
              <span>South</span>
            </label>
          </div>
          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
            Leave unchecked for all regions
          </div>
        </div>

        <!-- Applicable Services -->
        <div class="form-group">
          <label class="form-label">Applicable Services</label>
          <div id="serviceCheckboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <!-- Populated dynamically -->
          </div>
          <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
            Leave unchecked for all services
          </div>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label class="form-label" for="discountNotes">Internal Notes</label>
          <textarea 
            id="discountNotes" 
            class="form-input" 
            rows="3"
            placeholder="e.g. Summer promotion 2025"
          ></textarea>
        </div>

        <!-- Submit Buttons -->
        <div class="button-group" style="margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('discountModal')" style="flex: 1;">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="saveDiscountBtn" style="flex: 2;">
            <div class="loading-spinner"></div>
            <span>Create Discount Code</span>
          </button>
        </div>

         </form> <!-- ‚úÖ Close discountForm -->
    </div> <!-- ‚úÖ Close discount modal-body -->
  </div> <!-- ‚úÖ Close discount modal-dialog -->
</div> <!-- ‚úÖ Close discountModal -->

       <!-- Block Time Modal -->
<div class="modal" id="blockTimeModal" onclick="closeModal('blockTimeModal')">
  <div class="modal-dialog" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Block Time Slot</h3>
      <button class="modal-close" onclick="closeModal('blockTimeModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="blockTimeForm" onsubmit="saveBlockedTime(event)">
        
        <div class="form-group">
          <label class="form-label" for="blockRegion">Region *</label>
          <select id="blockRegion" class="form-input" required>
            <option value="">-- Select Region --</option>
            <option value="North">North (Jodie)</option>
            <option value="South">South (Maeve)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="blockDate">Date *</label>
          <input 
            type="date" 
            id="blockDate" 
            class="form-input" 
            required
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="blockStartTime">Start Time *</label>
            <select id="blockStartTime" class="form-input" required>
              <option value="">-- Select --</option>
              <option value="09:00">09:00</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">13:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
              <option value="17:30">17:30</option>
              <option value="18:00">18:00</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="blockEndTime">End Time *</label>
            <select id="blockEndTime" class="form-input" required>
              <option value="">-- Select --</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">13:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
              <option value="17:30">17:30</option>
              <option value="18:00">18:00</option>
              <option value="18:30">18:30</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="blockReason">Reason (Optional)</label>
          <textarea 
            id="blockReason" 
            class="form-input" 
            rows="3"
            placeholder="e.g. Team meeting, Equipment maintenance, Personal time off"
          ></textarea>
        </div>

        <div class="button-group" style="margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('blockTimeModal')" style="flex: 1;">
            Cancel
          </button>
          <button type="submit" class="btn btn-danger" style="flex: 2;">
            Block Time
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

  
  <script>
    // ===== STRIPE INITIALIZATION =====
const STRIPE_PUBLIC_KEY = 'pk_live_51QycLvQAVOs8qTDFVfXTNzuuhBnPjgZQSS3AH30NGMuSf3SxAWF9pLzYwL0ulj1wMMCC2jnhDyeqeop7BkWDfeZ400wT3Ko8aK';
const stripe = Stripe(STRIPE_PUBLIC_KEY);

    // ===== PASSWORD PROTECTION =====
    const ADMIN_CODE = 'MARKEB2546';
    const SESSION_KEY = 'admin_authenticated';
    const SESSION_DURATION = 8 * 60 * 60 * 1000; // 8 hours

    // ===== GLOBAL VARIABLES ===== 
    let currentMarketData = null;  // ‚úÖ ADD THIS LINE HERE

    // Check if already authenticated
    function isAuthenticated() {
      const authData = localStorage.getItem(SESSION_KEY);
      if (!authData) return false;
      
      try {
        const { timestamp } = JSON.parse(authData);
        const now = Date.now();
        
        // Check if session is still valid
        if (now - timestamp < SESSION_DURATION) {
          return true;
        } else {
          // Session expired
          localStorage.removeItem(SESSION_KEY);
          return false;
        }
      } catch (e) {
        return false;
      }
    }

    // Check password
    function checkPassword(event) {
      event.preventDefault();
      
      const input = document.getElementById('adminPassword');
      const error = document.getElementById('passwordError');
      const modal = document.getElementById('passwordModal');
      
      if (input.value === ADMIN_CODE) {
        // Correct password
        localStorage.setItem(SESSION_KEY, JSON.stringify({
          timestamp: Date.now()
        }));
        
        // Success animation
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.95)';
        modal.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
          modal.classList.add('unlocked');
        }, 300);
        
      } else {
        // Incorrect password
        error.classList.add('show');
        input.value = '';
        input.classList.add('error');
        
        setTimeout(() => {
          error.classList.remove('show');
          input.classList.remove('error');
        }, 3000);
      }
    }

    // Logout function
    function adminLogout() {
      if (confirm('Are you sure you want to logout from the admin panel?')) {
        localStorage.removeItem(SESSION_KEY);
        location.reload();
      }
    }

    // Check authentication on page load
    window.addEventListener('DOMContentLoaded', function() {
      if (isAuthenticated()) {
        document.getElementById('passwordModal').classList.add('unlocked');
      }
    });


   // ===== SERVICE & ADDON CATALOGS =====
    const SERVICES_CATALOG = {
  north: [
    {
      id: 'complete-branding',
      name: 'Complete Branding Package - Photo & Video',
      price: 894.00,
      duration: 300,
      isPropertyService: false,
      availableAddons: ['elevate-edit', 'add-branded-outro']
    },
    {
      id: 'branding-video',
      name: 'Branding Videography Session',
      price: 534.00,
      duration: 180,
      isPropertyService: false,
      availableAddons: ['elevate-edit', 'add-branded-outro']
    },
    {
      id: 'branding-photo',
      name: 'Branding Photography Session - 10 Signature Shots',
      price: 414.00,
      duration: 120,
      isPropertyService: false,
      availableAddons: []
    },
    {
      id: 'gold-package',
      name: 'Gold Package',
      price: 600.00,
      duration: 150,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'silver-package',
      name: 'Silver Package',
      price: 262.80,
      duration: 90,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'bronze-package',
      name: 'Bronze Package',
      price: 202.80,
      duration: 90,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-speed-tours']
    },
    {
      id: 'all-in-one-drone',
      name: 'All In One Drone',
      price: 214.80,
      duration: 45,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'property-video',
      name: 'Property Videography',
      price: 154.80,
      duration: 60,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-drone-photo', 'property-drone-video', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'property-photo',
      name: 'Property Photography',
      price: 118.80,
      duration: 45,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-photo', 'property-drone-video', 'property-speed-tours']
    },
    {
      id: 'drone-video',
      name: 'Property Drone Videography',
      price: 130.80,
      duration: 20,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-drone-photo', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'drone-photo',
      name: 'Property Drone Photography',
      price: 130.80,
      duration: 20,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-video', 'property-speed-tours']
    }
  ],
  south: [
    {
      id: 'gold-package',
      name: 'Gold Package',
      price: 600.00,
      duration: 150,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'silver-package',
      name: 'Silver Package',
      price: 262.80,
      duration: 90,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'bronze-package',
      name: 'Bronze Package',
      price: 202.80,
      duration: 90,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-speed-tours']
    },
    {
      id: 'all-in-one-drone',
      name: 'All In One Drone',
      price: 214.80,
      duration: 45,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'property-video',
      name: 'Property Videography',
      price: 154.80,
      duration: 60,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-drone-photo', 'property-drone-video', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'property-photo',
      name: 'Property Photography',
      price: 118.80,
      duration: 45,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-photo', 'property-drone-video', 'property-speed-tours']
    },
    {
      id: 'drone-video',
      name: 'Property Drone Videography',
      price: 130.80,
      duration: 20,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-drone-photo', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'drone-photo',
      name: 'Property Drone Photography',
      price: 130.80,
      duration: 20,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-video', 'property-speed-tours']
    }
  ]
};

    const ADDONS_CATALOG = {
      'standard-floor-plan': {
        id: 'standard-floor-plan',
        name: 'Standard Floor Plan',
        price: 24.00,
        description: '2D floor plan to help buyers visualize the property layout'
      },
      'plus-floor-plan': {
        id: 'plus-floor-plan',
        name: 'Plus Floor Plan',
        price: 36.00,
        description: 'Enhanced 2D floor plan with measurements and room labels'
      },
      'elevate-edit': {
        id: 'elevate-edit',
        name: 'Elevate Your Edit',
        price: 75.00,
        description: 'Transform your video with premium editing including dynamic transitions, bold captions, spotlight features'
      },
      'property-drone-photo': {
        id: 'property-drone-photo',
        name: 'Property Drone Photography',
        price: 130.80,
        description: 'Up to 10 stunning aerial photographs'
      },
      'property-drone-video': {
        id: 'property-drone-video',
        name: 'Property Drone Videography',
        price: 130.80,
        description: 'Up to 30-second cinematic aerial showcase'
      },
      'property-video': {
        id: 'property-video',
        name: 'Property Videography',
        price: 154.80,
        description: 'Shot in 4K to captivate viewers and drive enquiries'
      },
      'property-speed-tours': {
        id: 'property-speed-tours',
        name: 'Property Speed Tours',
        price: 60.00,
        description: 'Quick walkthrough video tour of the property'
      },
      'add-branded-outro': {
        id: 'add-branded-outro',
        name: 'Add Branded Outro To Video',
        price: 0.00,
        description: 'Add your branded outro to any video content'
      }
    };

    // Global state
    let currentView = 'month';
    let currentDate = new Date();
    let allBookings = [];
    let allCustomers = [];
    let currentBooking = null;

   // UK REGIONS - All UK counties and regions (matching HPI API codes)
const UK_REGIONS = [
  // ===== ENGLAND - NORTH WEST =====
  'Cheshire East',
  'Cheshire West and Chester',
  'Cumbria',
  'Greater Manchester',
  'Lancashire',
  'Merseyside',
  'Blackburn with Darwen',
  'Blackpool',
  'Halton',
  'Warrington',
  
  // ===== ENGLAND - NORTH EAST =====
  'County Durham',
  'Northumberland',
  'Tyne and Wear',
  
  // ===== ENGLAND - YORKSHIRE & HUMBER =====
  'East Riding of Yorkshire',
  'North Yorkshire',
  'South Yorkshire',
  'West Yorkshire',
  'York',
  
  // ===== ENGLAND - EAST MIDLANDS =====
  'Derby',
  'Derbyshire',
  'Leicestershire',
  'Lincolnshire',
  'Northamptonshire',
  'Nottingham',
  'Nottinghamshire',
  'Rutland',
  
  // ===== ENGLAND - WEST MIDLANDS =====
  'Herefordshire',
  'Shropshire',
  'Staffordshire',
  'Stoke-on-Trent',
  'Telford and Wrekin',
  'Warwickshire',
  'West Midlands',
  'Worcestershire',
  
  // ===== ENGLAND - EAST OF ENGLAND =====
  'Bedford',
  'Cambridgeshire',
  'Central Bedfordshire',
  'Essex',
  'Hertfordshire',
  'Norfolk',
  'Peterborough',
  'Suffolk',
  
  // ===== ENGLAND - SOUTH EAST =====
  'Berkshire',
  'Brighton and Hove',
  'Buckinghamshire',
  'East Sussex',
  'Hampshire',
  'Isle of Wight',
  'Kent',
  'Medway',
  'Oxfordshire',
  'Portsmouth',
  'Southampton',
  'Surrey',
  'West Sussex',
  
  // ===== ENGLAND - SOUTH WEST =====
  'Bath and North East Somerset',
  'Bournemouth, Christchurch and Poole',
  'Bristol',
  'Cornwall',
  'Devon',
  'Dorset',
  'Gloucestershire',
  'North Somerset',
  'Plymouth',
  'Somerset',
  'South Gloucestershire',
  'Swindon',
  'Torbay',
  'Wiltshire',
  
  // ===== ENGLAND - LONDON =====
  'Greater London',
  
  // ===== SCOTLAND =====
  'Aberdeen City',
  'Aberdeenshire',
  'Angus',
  'Argyll and Bute',
  'City of Edinburgh',
  'Clackmannanshire',
  'Dumfries and Galloway',
  'Dundee City',
  'East Ayrshire',
  'East Dunbartonshire',
  'East Lothian',
  'East Renfrewshire',
  'Falkirk',
  'Fife',
  'Glasgow City',
  'Highland',
  'Inverclyde',
  'Midlothian',
  'Moray',
  'Na h-Eileanan Siar',
  'North Ayrshire',
  'North Lanarkshire',
  'Orkney Islands',
  'Perth and Kinross',
  'Renfrewshire',
  'Scottish Borders',
  'Shetland Islands',
  'South Ayrshire',
  'South Lanarkshire',
  'Stirling',
  'West Dunbartonshire',
  'West Lothian',
  
  // ===== WALES =====
  'Blaenau Gwent',
  'Bridgend',
  'Caerphilly',
  'Cardiff',
  'Carmarthenshire',
  'Ceredigion',
  'Conwy',
  'Denbighshire',
  'Flintshire',
  'Gwynedd',
  'Isle of Anglesey',
  'Merthyr Tydfil',
  'Monmouthshire',
  'Neath Port Talbot',
  'Newport',
  'Pembrokeshire',
  'Powys',
  'Rhondda Cynon Taf',
  'Swansea',
  'Torfaen',
  'Vale of Glamorgan',
  'Wrexham',
  
  // ===== NORTHERN IRELAND =====
  'Antrim and Newtownabbey',
  'Ards and North Down',
  'Armagh City, Banbridge and Craigavon',
  'Belfast',
  'Causeway Coast and Glens',
  'Derry City and Strabane',
  'Fermanagh and Omagh',
  'Lisburn and Castlereagh',
  'Mid and East Antrim',
  'Mid Ulster',
  'Newry, Mourne and Down'
].sort();

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardStats();
      loadCalendar();
      loadBookings();
      loadPendingBookings();
      loadCustomers();
      loadDiscountCodes();
      loadBlockedTimes();

      // Populate time options
      const timeSelect = document.getElementById('bookingTime');
      if (timeSelect) {
        for (let hour = 9; hour <= 17; hour++) {
          for (let minute of [0, 30]) {
            if (hour === 17 && minute === 30) break;
            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            timeSelect.innerHTML += `<option value="${timeStr}">${timeStr}</option>`;
          }
        }
      }
    });

    // ===== ADMIN BOOKING CREATION =====
    
    let bookingFormData = {
  bedrooms: 4,
  selectedAddons: [],
  discountCode: '',
  discountAmount: 0,
  priceBeforeDiscount: 0,
  totalPrice: 0
};

    // Populate customer dropdown
    function populateCustomerDropdown() {
      const select = document.getElementById('bookingCustomer');
      if (!select) return;
      
      select.innerHTML = '<option value="">-- Select Customer --</option>';
      allCustomers.forEach(customer => {
        select.innerHTML += `<option value="${customer.fields['Email']}" data-name="${customer.fields['Name']}" data-company="${customer.fields['Company'] || ''}">${customer.fields['Name']} (${customer.fields['Email']})</option>`;
      });
    }

    // Auto-populate customer details
    function populateCustomerDropdown() {
  const datalist = document.getElementById('customersList');
  if (!datalist) return;
  
  datalist.innerHTML = '';
  allCustomers.forEach(customer => {
    const option = document.createElement('option');
    option.value = `${customer.fields['Name']} (${customer.fields['Email']})`;
    option.setAttribute('data-email', customer.fields['Email']);
    option.setAttribute('data-name', customer.fields['Name']);
    datalist.appendChild(option);
  });
}

function populateCustomerDetails() {
  const input = document.getElementById('bookingCustomer');
  const value = input.value;
  
  if (!value) {
    document.getElementById('bookingClientName').value = '';
    document.getElementById('bookingClientEmail').value = '';
    return;
  }
  
  // Try to find matching customer
  const customer = allCustomers.find(c => 
    value.includes(c.fields['Email']) || value === c.fields['Name']
  );
  
  if (customer) {
    // Existing customer selected
    document.getElementById('bookingClientName').value = customer.fields['Name'];
    document.getElementById('bookingClientEmail').value = customer.fields['Email'];
  } else {
    // Manual entry - clear fields so admin can type
    document.getElementById('bookingClientName').value = '';
    document.getElementById('bookingClientEmail').value = '';
  }
}

    // Load services based on region
    function loadServicesForRegion() {
      const region = document.getElementById('bookingRegion').value;
      const serviceSelect = document.getElementById('bookingService');
      
      if (!region) {
        serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';
        return;
      }
      
      const regionKey = region.toLowerCase();
      const services = SERVICES_CATALOG[regionKey] || [];
      
      serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';
      services.forEach(service => {
        serviceSelect.innerHTML += `
          <option 
            value="${service.id}" 
            data-price="${service.price}"
            data-duration="${service.duration}"
            data-name="${service.name}"
            data-property="${service.isPropertyService}"
            data-addons='${JSON.stringify(service.availableAddons)}'
          >
            ${service.name} - ¬£${service.price.toFixed(2)}
          </option>
        `;
      });
    }

    // Update price and show/hide sections
    function updateBookingPrice() {
      const select = document.getElementById('bookingService');
      const selectedOption = select.options[select.selectedIndex];
      
      if (!selectedOption || !selectedOption.value) {
        document.getElementById('bookingPriceBreakdown').style.display = 'none';
        document.getElementById('bookingBedroomsSection').style.display = 'none';
        document.getElementById('bookingAddonsSection').style.display = 'none';
        return;
      }

      const servicePrice = parseFloat(selectedOption.dataset.price);
      const isPropertyService = selectedOption.dataset.property === 'true';
      const availableAddons = JSON.parse(selectedOption.dataset.addons || '[]');

      // Show/hide bedrooms section
      document.getElementById('bookingBedroomsSection').style.display = isPropertyService ? 'block' : 'none';

      // Show/hide addons section
      if (availableAddons.length > 0) {
        const addonContainer = document.getElementById('bookingAddonCheckboxes');
        addonContainer.innerHTML = availableAddons.map(addonId => {
          const addon = ADDONS_CATALOG[addonId];
          if (!addon) return '';
          
          return `
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
              <input 
                type="checkbox" 
                value="${addon.id}" 
                onchange="toggleBookingAddon('${addon.id}')"
                style="width: 20px; height: 20px;"
              >
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">${addon.name}</div>
                <div style="font-size: 13px; color: #64748b;">${addon.description}</div>
              </div>
              <div style="font-weight: 700; color: #3b82f6;">
                ${addon.price === 0 ? 'FREE' : `+¬£${addon.price.toFixed(2)}`}
              </div>
            </label>
          `;
        }).join('');
        
        document.getElementById('bookingAddonsSection').style.display = 'block';
      } else {
        document.getElementById('bookingAddonsSection').style.display = 'none';
      }

      bookingFormData.selectedAddons = [];
      calculateBookingPrice();
      document.getElementById('bookingPriceBreakdown').style.display = 'block';
    }

    function toggleBookingAddon(addonId) {
      const index = bookingFormData.selectedAddons.indexOf(addonId);
      if (index > -1) {
        bookingFormData.selectedAddons.splice(index, 1);
      } else {
        bookingFormData.selectedAddons.push(addonId);
      }
      calculateBookingPrice();
    }

    function adjustBookingBedrooms(change) {
      bookingFormData.bedrooms = Math.max(1, Math.min(15, bookingFormData.bedrooms + change));
      document.getElementById('bookingBedroomCount').textContent = bookingFormData.bedrooms;
      calculateBookingPrice();
    }

    function calculateBookingPrice() {
  const select = document.getElementById('bookingService');
  const selectedOption = select.options[select.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) return;

  const servicePrice = parseFloat(selectedOption.dataset.price);
  const isPropertyService = selectedOption.dataset.property === 'true';
  
  const extraBedrooms = isPropertyService ? Math.max(0, bookingFormData.bedrooms - 4) : 0;
  const bedroomFee = extraBedrooms * 30;

  let addonsFee = 0;
  bookingFormData.selectedAddons.forEach(addonId => {
    const addon = ADDONS_CATALOG[addonId];
    if (addon) addonsFee += addon.price;
  });

  const subtotal = servicePrice + bedroomFee + addonsFee;
  
  // Reset discount when price changes
  bookingFormData.discountCode = '';
  bookingFormData.discountAmount = 0;
  bookingFormData.priceBeforeDiscount = 0;
  bookingFormData.totalPrice = subtotal;
  
  // Clear discount UI
  const codeInput = document.getElementById('bookingDiscountCode');
  const messageDiv = document.getElementById('discountMessage');
  if (codeInput) codeInput.value = '';
  if (messageDiv) messageDiv.innerHTML = '';
  
  const discountRow = document.getElementById('bookingDiscountRow');
  if (discountRow) discountRow.style.display = 'none';

  // Update price display
  document.getElementById('bookingServicePrice').textContent = `¬£${servicePrice.toFixed(2)}`;
  document.getElementById('bookingTotalPrice').textContent = `¬£${subtotal.toFixed(2)}`;

  const bedroomRow = document.getElementById('bookingBedroomRow');
  if (bedroomFee > 0) {
    bedroomRow.style.display = 'flex';
    document.getElementById('bookingBedroomFee').textContent = `¬£${bedroomFee.toFixed(2)}`;
  } else {
    bedroomRow.style.display = 'none';
  }

  const addonsRow = document.getElementById('bookingAddonsRow');
  if (addonsFee > 0) {
    addonsRow.style.display = 'flex';
    document.getElementById('bookingAddonsFee').textContent = `¬£${addonsFee.toFixed(2)}`;
  } else {
    addonsRow.style.display = 'none';
  }
}

async function applyAdminDiscount() {
  const codeInput = document.getElementById('bookingDiscountCode');
  const code = codeInput.value.trim().toUpperCase();
  const messageDiv = document.getElementById('discountMessage');
  
  if (!code) {
    messageDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Please enter a discount code</span>';
    return;
  }

  const serviceSelect = document.getElementById('bookingService');
  const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) {
    messageDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Please select a service first</span>';
    return;
  }

  const serviceId = selectedOption.value;
  const region = document.getElementById('bookingRegion').value;

  // Calculate current price BEFORE discount
  const servicePrice = parseFloat(selectedOption.dataset.price);
  const isPropertyService = selectedOption.dataset.property === 'true';
  const extraBedrooms = isPropertyService ? Math.max(0, bookingFormData.bedrooms - 4) : 0;
  const bedroomFee = extraBedrooms * 30;
  let addonsFee = 0;
  bookingFormData.selectedAddons.forEach(addonId => {
    const addon = ADDONS_CATALOG[addonId];
    if (addon) addonsFee += addon.price;
  });
  const priceBeforeDiscount = servicePrice + bedroomFee + addonsFee;

  messageDiv.innerHTML = '<span style="color: #3b82f6;">‚è≥ Validating code...</span>';

  try {
    const response = await fetch('/.netlify/functions/validate-discount-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code,
        serviceId,
        region,
        totalPrice: priceBeforeDiscount
      })
    });

    const data = await response.json();

    if (data.success) {
      // Store discount info
      bookingFormData.discountCode = code;
      bookingFormData.discountAmount = data.discountAmount;
      bookingFormData.priceBeforeDiscount = priceBeforeDiscount;
      bookingFormData.totalPrice = data.finalPrice;

      messageDiv.innerHTML = `
        <span style="color: #10b981;">
          ‚úÖ Code "${code}" applied! Saving ¬£${data.discountAmount.toFixed(2)}
        </span>
      `;

      // Update price display
      updateDiscountedPrice();
    } else {
      bookingFormData.discountCode = '';
      bookingFormData.discountAmount = 0;
      bookingFormData.priceBeforeDiscount = 0;
      bookingFormData.totalPrice = priceBeforeDiscount;

      messageDiv.innerHTML = `<span style="color: #ef4444;">‚ùå ${data.error}</span>`;
      
      const discountRow = document.getElementById('bookingDiscountRow');
      if (discountRow) discountRow.style.display = 'none';
    }
  } catch (error) {
    console.error('Discount validation error:', error);
    messageDiv.innerHTML = '<span style="color: #ef4444;">‚ùå Error validating code</span>';
  }
}

function updateDiscountedPrice() {
  if (bookingFormData.discountAmount > 0) {
    let discountRow = document.getElementById('bookingDiscountRow');
    
    if (!discountRow) {
      // Create discount row if it doesn't exist
      const breakdown = document.getElementById('bookingPriceBreakdown');
      const totalRow = breakdown.querySelector('[style*="border-top"]');
      
      discountRow = document.createElement('div');
      discountRow.id = 'bookingDiscountRow';
      discountRow.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 12px;';
      discountRow.innerHTML = `
        <span style="color: #10b981; font-weight: 600;">Discount (${bookingFormData.discountCode})</span>
        <span id="bookingDiscountAmount" style="font-weight: 600; color: #10b981;">-¬£0.00</span>
      `;
      
      breakdown.insertBefore(discountRow, totalRow);
    }
    
    discountRow.style.display = 'flex';
    document.getElementById('bookingDiscountAmount').textContent = `-¬£${bookingFormData.discountAmount.toFixed(2)}`;
    document.getElementById('bookingTotalPrice').textContent = `¬£${bookingFormData.totalPrice.toFixed(2)}`;
  }
}

function createDiscountRow() {
  const breakdown = document.getElementById('bookingPriceBreakdown');
  const totalRow = breakdown.querySelector('[style*="border-top"]');
  
  const discountRow = document.createElement('div');
  discountRow.id = 'bookingDiscountRow';
  discountRow.style.cssText = 'display: none; justify-content: space-between; margin-bottom: 12px;';
  discountRow.innerHTML = `
    <span style="color: #10b981; font-weight: 600;">Discount (${bookingFormData.discountCode})</span>
    <span id="bookingDiscountAmount" style="font-weight: 600; color: #10b981;">-¬£0.00</span>
  `;
  
  breakdown.insertBefore(discountRow, totalRow);
  return discountRow;
}

function resetBookingForm() {
  document.getElementById('adminBookingForm').reset();
  bookingFormData = {
    bedrooms: 4,
    selectedAddons: [],
    discountCode: '',
    discountAmount: 0,
    priceBeforeDiscount: 0,
    totalPrice: 0
  };
  document.getElementById('bookingBedroomCount').textContent = '4';
  document.getElementById('bookingPriceBreakdown').style.display = 'none';
  document.getElementById('bookingBedroomsSection').style.display = 'none';
  document.getElementById('bookingAddonsSection').style.display = 'none';
  document.getElementById('availabilityResults').style.display = 'none';
  const discountMsg = document.getElementById('discountMessage');
  if (discountMsg) discountMsg.innerHTML = '';
  const discountRow = document.getElementById('bookingDiscountRow');
  if (discountRow) discountRow.style.display = 'none';
}

    // Check availability
 async function checkAdminAvailability() {
  const date = document.getElementById('bookingDate').value;
  const time = document.getElementById('bookingTime').value;
  const region = document.getElementById('bookingRegion').value;
  const postcode = document.getElementById('bookingPostcode').value;
  const serviceSelect = document.getElementById('bookingService');
  const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
  
  if (!date || !time || !region || !selectedOption?.value || !postcode) return;
  
  const duration = parseInt(selectedOption.dataset.duration);
  const resultsDiv = document.getElementById('availabilityResults');
  resultsDiv.innerHTML = '<div style="text-align: center; padding: 16px;"><div class="spinner" style="width: 30px; height: 30px;"></div></div>';
  resultsDiv.style.display = 'block';
  
  try {
    const response = await fetch('/.netlify/functions/check-availability', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        postcode: postcode,
        region: region, 
        selectedDate: date,
        duration: duration  // ‚úÖ ADD THIS LINE
      })
    });
    
    const data = await response.json();
    
    if (data.availableSlots) {
      const selectedSlot = data.availableSlots.find(slot => slot.time === time);
      
      if (selectedSlot && selectedSlot.available) {
        resultsDiv.innerHTML = `
          <div class="success-box">
            ‚úÖ <strong>Available!</strong> This time slot is free.
          </div>
        `;
      } else {
        resultsDiv.innerHTML = `
          <div class="warning-box">
            ‚ö†Ô∏è <strong>Conflict detected!</strong> ${selectedSlot?.reason || 'Time slot may be busy'}
          </div>
        `;
      }
    }
  } catch (error) {
    console.error('Availability check error:', error);
    resultsDiv.innerHTML = `
      <div class="warning-box">
        ‚ö†Ô∏è Could not check availability. Please verify manually.
      </div>
    `;
  }
}

    // Form submission
document.getElementById('adminBookingForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const serviceSelect = document.getElementById('bookingService');
  const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) {
    alert('Please select a service');
    return;
  }

  const region = document.getElementById('bookingRegion').value;
  const mediaSpecialist = region === 'North' ? 'Jodie' : 'Maeve';
  const paymentStatus = document.getElementById('bookingPaymentStatus').value;

  // Calculate pricing (use discounted total if discount applied)
  const servicePrice = parseFloat(selectedOption.dataset.price);
  const extraBedrooms = Math.max(0, bookingFormData.bedrooms - 4);
  const extraBedroomFee = extraBedrooms * 30;
  
  let addonsPrice = 0;
  bookingFormData.selectedAddons.forEach(addonId => {
    const addon = ADDONS_CATALOG[addonId];
    if (addon) addonsPrice += addon.price;
  });

  const subtotal = servicePrice + extraBedroomFee + addonsPrice;
  const totalPrice = bookingFormData.totalPrice || subtotal;

  const formData = {
    clientName: document.getElementById('bookingClientName').value,
    clientEmail: document.getElementById('bookingClientEmail').value,
    clientPhone: '',
    clientNotes: '',
    region: region,
    mediaSpecialist: mediaSpecialist,
    
    service: selectedOption.dataset.name,
    serviceId: selectedOption.value,
    basePrice: servicePrice,
    duration: parseInt(selectedOption.dataset.duration),
    
    bedrooms: bookingFormData.bedrooms,
    extraBedroomFee: extraBedroomFee,
    
    addons: bookingFormData.selectedAddons.map(id => ({
      id,
      name: ADDONS_CATALOG[id]?.name,
      price: ADDONS_CATALOG[id]?.price
    })),
    addonsPrice: addonsPrice,
    
    propertyAddress: document.getElementById('bookingAddress').value,
    postcode: document.getElementById('bookingPostcode').value,
    accessInstructions: document.getElementById('bookingAccess').value || '',
    
    date: document.getElementById('bookingDate').value,
    time: document.getElementById('bookingTime').value,
    
    // Discount fields
  discountCode: bookingFormData.discountCode || '',
  discountAmount: bookingFormData.discountAmount || 0,
  priceBeforeDiscount: bookingFormData.priceBeforeDiscount || totalPrice,
  totalPrice: bookingFormData.totalPrice || totalPrice,  // ‚úÖ FIXED LINE
    
    paymentOption: 'reserve', // Admin always uses reserve, never Stripe
    paymentStatus: paymentStatus, // Can be "Pending" or "Paid"
    status: 'Booked',
    createdBy: 'Admin'
  };

  const statusText = paymentStatus === 'Paid' ? '‚úÖ Already paid' : '‚è≥ Payment pending';
  const confirmMsg = `Create booking for ${formData.clientName}?\n\nService: ${formData.service}\nDate: ${formData.date} at ${formData.time}\nMedia Specialist: ${formData.mediaSpecialist}\nTotal: ¬£${totalPrice.toFixed(2)}${bookingFormData.discountCode ? `\nDiscount: ${bookingFormData.discountCode} (-¬£${bookingFormData.discountAmount.toFixed(2)})` : ''}\n\n${statusText}`;
  
  if (!confirm(confirmMsg)) {
    return;
  }

  const btn = e.target.querySelector('button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.innerHTML = '‚è≥ Creating...';
  btn.disabled = true;

  try {
    // Admin bookings ALWAYS create directly, NEVER go to Stripe
    const response = await fetch('/.netlify/functions/create-booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úÖ Booking created successfully!\n\nReference: ${data.bookingRef}\nMedia Specialist: ${formData.mediaSpecialist}\nTotal: ¬£${totalPrice.toFixed(2)}\nPayment Status: ${paymentStatus}`);
      resetBookingForm();
      loadBookings();
      loadCalendar();
      loadDashboardStats();
    } else {
      alert(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Booking creation error:', error);
    alert('‚ùå Failed to create booking: ' + error.message);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
});

    // ===== END ADMIN BOOKING CREATION =====

    // Navigation
  function showSection(sectionId) {
  document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  document.getElementById(sectionId).classList.add('active');
  
  const navItem = [...document.querySelectorAll('.nav-item')].find(n => 
    n.getAttribute('onclick')?.includes(`showSection('${sectionId}')`)
  );
  if (navItem) navItem.classList.add('active');

  // Load data when switching to specific sections
  if (sectionId === 'blocked-times') {
    loadBlockedTimes();
  }
  
  if (sectionId === 'discount-codes') {
    loadDiscountCodes();
  }

  if (window.innerWidth <= 1024) {
    document.getElementById('adminSidebar').classList.remove('open');
  }
  
  // Reinitialize Lucide icons after DOM changes
  lucide.createIcons();
}

    function toggleSidebar() {
      const sidebar = document.getElementById('adminSidebar');
      sidebar.classList.toggle('open');
      
      if (sidebar.classList.contains('open')) {
        document.addEventListener('click', closeSidebarOutside);
      } else {
        document.removeEventListener('click', closeSidebarOutside);
      }
    }

    function closeSidebarOutside(event) {
      const sidebar = document.getElementById('adminSidebar');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      
      if (!sidebar.contains(event.target) && !menuBtn.contains(event.target)) {
        sidebar.classList.remove('open');
        document.removeEventListener('click', closeSidebarOutside);
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Dashboard Stats
    async function loadDashboardStats() {
      try {
        const response = await fetch('/.netlify/functions/admin-bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();
        
        if (data.success) {
          document.getElementById('totalBookings').textContent = data.stats.total;
          document.getElementById('upcomingBookings').textContent = data.stats.upcoming;
          document.getElementById('pendingBookings').textContent = data.stats.pending;
        }

        // Load customer count
        const customersResponse = await fetch('/.netlify/functions/admin-users');
        const customersData = await customersResponse.json();
        
        if (customersData.success) {
          document.getElementById('totalCustomers').textContent = customersData.total;
        }

      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }

    // Calendar Functions
    function setCalendarView(view) {
      currentView = view;
      document.querySelectorAll('.calendar-view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      loadCalendar();
    }

    function previousPeriod() {
      if (currentView === 'month') {
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
      } else if (currentView === 'week') {
        currentDate = new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000);
      } else {
        currentDate = new Date(currentDate.getTime() - 24 * 60 * 60 * 1000);
      }
      loadCalendar();
    }

    function nextPeriod() {
      if (currentView === 'month') {
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
      } else if (currentView === 'week') {
        currentDate = new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000);
      } else {
        currentDate = new Date(currentDate.getTime() + 24 * 60 * 60 * 1000);
      }
      loadCalendar();
    }

    // ===== UPDATED CALENDAR FUNCTIONS WITH BLOCKED TIMES =====

async function loadCalendar() {
  const grid = document.getElementById('calendarGrid');
  const currentEl = document.getElementById('calendarCurrent');
  const region = document.getElementById('calendarRegion')?.value || '';

  grid.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

  try {
    let startDate, endDate;

    if (currentView === 'month') {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      startDate = new Date(year, month, 1).toISOString().split('T')[0];
      endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
      
      currentEl.textContent = currentDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    } else if (currentView === 'week') {
      const tempDate = new Date(currentDate);
      const day = tempDate.getDay();
      const diff = tempDate.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(tempDate.setDate(diff));
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      
      startDate = monday.toISOString().split('T')[0];
      endDate = sunday.toISOString().split('T')[0];
      
      currentEl.textContent = `Week of ${monday.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' })} - ${sunday.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' })}`;
    } else {
      startDate = currentDate.toISOString().split('T')[0];
      endDate = startDate;
      
      currentEl.textContent = currentDate.toLocaleDateString('en-GB', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    }

    // ‚úÖ Fetch BOTH bookings AND blocked times
    const [bookingsResponse, blockedTimesResponse] = await Promise.all([
      fetch('/.netlify/functions/admin-bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ startDate, endDate, region })
      }),
      fetch('/.netlify/functions/airtable-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          method: 'GET',
          table: 'Blocked Times',
          filterFormula: region ? `AND({Date} >= "${startDate}", {Date} <= "${endDate}", {Region} = "${region}")` : `AND({Date} >= "${startDate}", {Date} <= "${endDate}")`
        })
      })
    ]);

    const bookingsData = await bookingsResponse.json();
    const blockedTimesData = await blockedTimesResponse.json();

    if (bookingsData.success) {
      allBookings = bookingsData.bookings;
      const blockedTimes = blockedTimesData.records || [];
      
      if (currentView === 'month') {
        renderMonthView(bookingsData.bookings, blockedTimes);
      } else if (currentView === 'week') {
        renderWeekView(bookingsData.bookings, blockedTimes);
      } else {
        renderDayView(bookingsData.bookings, blockedTimes);
      }
    }

  } catch (error) {
    console.error('Error loading calendar:', error);
    grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading calendar</div>';
  }
}

function renderMonthView(bookings, blockedTimes) {
  const grid = document.getElementById('calendarGrid');
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay() || 7;

  const totalBookings = bookings.length;
  const totalBlocks = blockedTimes.length;

  let html = `
    <div class="calendar-booking-counter">
      <span class="calendar-booking-counter-value">${totalBookings}</span>
      <span class="calendar-booking-counter-label">booking${totalBookings !== 1 ? 's' : ''}</span>
      ${totalBlocks > 0 ? `
        <span style="margin-left: 16px; color: #ef4444; font-size: 14px;">
          | üö´ ${totalBlocks} blocked time${totalBlocks !== 1 ? 's' : ''}
        </span>
      ` : ''}
    </div>
    
    <div class="calendar-grid month">
  `;
  
  ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
    html += `<div class="calendar-day-header">${day}</div>`;
  });

  for (let i = 1; i < startingDayOfWeek; i++) {
    html += '<div class="calendar-day other-month"></div>';
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayBookings = bookings.filter(b => b.fields['Date'] === dateStr);
    const dayBlocks = blockedTimes.filter(b => b.fields['Date'] === dateStr);
    
    const today = new Date();
    const isToday = dateStr === today.toISOString().split('T')[0];
    
    // ‚úÖ Add click handler to create block
    html += `<div class="calendar-day ${isToday ? 'today' : ''}" onclick="showQuickBlockModal('${dateStr}')" style="cursor: pointer;">`;
    html += `<div class="calendar-day-number">${day}</div>`;
    
    // ‚úÖ Show blocked times FIRST (red)
    dayBlocks.forEach(block => {
      const fields = block.fields;
      html += `
        <div class="calendar-booking blocked" 
             onclick="event.stopPropagation(); viewBlockedTime('${block.id}')"
             title="${fields['Reason'] || 'Blocked'}"
             style="background: #ef4444; cursor: pointer;">
          üö´ ${fields['Start Time']}-${fields['End Time']} ${fields['Region']}
        </div>
      `;
    });
    
    // Show bookings
    dayBookings.forEach(booking => {
      const paymentStatus = booking.fields['Payment Status'] || 'Pending';
      const statusClass =
        booking.fields['Booking Status'] === 'Cancelled'
          ? 'cancelled'
          : paymentStatus === 'Pending'
          ? 'pending'
          : '';

      html += `<div class="calendar-booking ${statusClass}" onclick="event.stopPropagation(); viewBookingById('${booking.id}')">${booking.fields['Time']} ${booking.fields['Client Name']}</div>`;
    });
    
    html += '</div>';
  }

  html += '</div>';
  grid.innerHTML = html;
}

function renderWeekView(bookings, blockedTimes) {
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '<div style="padding: 40px; text-align: center;">Week view coming soon...</div>';
}

function renderDayView(bookings, blockedTimes) {
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '<div style="padding: 40px; text-align: center;">Day view coming soon...</div>';
}

// ===== BOOKINGS FUNCTIONS =====

async function loadBookings() {
  const container = document.getElementById('bookingsContainer');
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

  try {
    const search = document.getElementById('bookingSearch')?.value || '';
    const region = document.getElementById('bookingRegion')?.value || '';
    const status = document.getElementById('bookingStatus')?.value || '';

    const response = await fetch('/.netlify/functions/admin-bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        search, 
        region, 
        status 
      })
    });

    const data = await response.json();

    if (data.success) {
      allBookings = data.bookings;
      renderBookingsTable(allBookings);
    }

  } catch (error) {
    console.error('Error loading bookings:', error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading bookings</div>';
  }
}

function renderBookingsTable(bookings, searchTerm = '') {
  const container = document.getElementById('bookingsContainer');
  
  let filtered = bookings;
  
  // Apply search filter
  if (searchTerm) {
    const term = searchTerm.toLowerCase();
    filtered = bookings.filter(b => {
      const fields = b.fields;
      return (
        (fields['Client Name'] || '').toLowerCase().includes(term) ||
        (fields['Client Email'] || '').toLowerCase().includes(term) ||
        (fields['Property Address'] || '').toLowerCase().includes(term) ||
        (fields['Booking Reference'] || '').toLowerCase().includes(term)
      );
    });
  }

  if (filtered.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 40px;">No bookings found</div>';
    return;
  }

  let html = `
    <table class="data-table">
      <thead>
        <tr>
          <th>Reference</th>
          <th>Client</th>
          <th>Service</th>
          <th>Date & Time</th>
          <th>Region</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  filtered.forEach(booking => {
    const fields = booking.fields;
    const paymentStatus = fields['Payment Status'] || 'Pending';
    const bookingStatus = fields['Booking Status'] || 'Booked';
    const finalPrice = fields['Final Price'] || 0;
    const discountCode = fields['Discount Code'] || '';
    const discountAmount = fields['Discount Amount'] || 0;
    
    html += `
      <tr>
        <td data-label="Reference">
          <strong>${fields['Booking Reference']}</strong>
          ${discountCode ? `<br><small style="color: #10b981;">üéÅ ${discountCode}</small>` : ''}
        </td>
        <td data-label="Client">
          ${fields['Client Name']}<br>
          <small style="color: #64748b;">${fields['Client Email']}</small>
        </td>
        <td data-label="Service">${fields['Service']}</td>
        <td data-label="Date & Time">
          ${fields['Date']}<br>
          <strong>${fields['Time']}</strong>
        </td>
        <td data-label="Region">
          <span class="region-badge ${(fields['Region'] || '').toLowerCase()}">${fields['Region']}</span>
        </td>
        <td data-label="Total">
          <strong>¬£${finalPrice.toFixed(2)}</strong>
          ${discountAmount > 0 ? `<br><small style="color: #10b981;">-¬£${discountAmount.toFixed(2)} off</small>` : ''}
        </td>
        <td data-label="Payment">
          <span class="status-badge status-${paymentStatus.toLowerCase()}">
            ${paymentStatus}
          </span>
        </td>
        <td data-label="Status">
          <span class="status-badge status-${bookingStatus.toLowerCase()}">
            ${bookingStatus}
          </span>
        </td>
        <td data-label="Actions">
          <button class="btn btn-primary btn-small" onclick="viewBookingById('${booking.id}')">
            View
          </button>
        </td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// View Booking by ID
function viewBookingById(bookingId) {
  const booking = allBookings.find(b => b.id === bookingId);
  if (!booking) {
    alert('Booking not found');
    return;
  }
  
  currentBooking = booking;
  const fields = booking.fields;
  
  const modal = document.getElementById('bookingModal');
  const title = document.getElementById('bookingModalTitle');
  const body = document.getElementById('bookingModalBody');
  
  title.textContent = `Booking ${fields['Booking Reference']}`;
  
  const date = new Date(fields['Date']);
  const formattedDate = date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  
  // ‚úÖ Extract discount information
  const totalPrice = fields['Final Price'] || 0;
  const discountCode = fields['Discount Code'] || '';
  const discountAmount = fields['Discount Amount'] || 0;
  const priceBeforeDiscount = fields['Price Before Discount'] || totalPrice;
  const hasDiscount = discountAmount > 0 && discountCode;
  
  body.innerHTML = `
    <div class="detail-item">
      <span class="detail-label">üìã Reference</span>
      <span class="detail-value"><strong>${fields['Booking Reference']}</strong></span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üë§ Client Name</span>
      <span class="detail-value">${fields['Client Name']}</span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üìß Client Email</span>
      <span class="detail-value">${fields['Client Email']}</span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üìç Region</span>
      <span class="detail-value">
        <span class="region-badge ${(fields['Region'] || '').toLowerCase()}">${fields['Region']}</span>
      </span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üé¨ Service</span>
      <span class="detail-value">${fields['Service']}</span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üìÖ Date</span>
      <span class="detail-value">${formattedDate}</span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üïê Time</span>
      <span class="detail-value"><strong>${fields['Time']}</strong></span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üè† Property Address</span>
      <span class="detail-value">${fields['Property Address']}</span>
    </div>

    ${hasDiscount ? `
      <div class="detail-item">
        <span class="detail-label">üéÅ Discount Code</span>
        <span class="detail-value">
          <strong style="color: #10b981;">${discountCode}</strong>
        </span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">üí∞ Original Price</span>
        <span class="detail-value" style="text-decoration: line-through; color: #94a3b8;">
          ¬£${priceBeforeDiscount.toFixed(2)}
        </span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">üíö Discount Applied</span>
        <span class="detail-value" style="color: #10b981; font-weight: 700;">
          -¬£${discountAmount.toFixed(2)}
        </span>
      </div>
    ` : ''}

    <div class="detail-item">
      <span class="detail-label">üí∑ ${hasDiscount ? 'Final Price' : 'Total Price'}</span>
      <span class="detail-value"><strong style="font-size: 18px; color: #3b82f6;">¬£${totalPrice.toFixed(2)}</strong></span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üí≥ Payment Status</span>
      <span class="detail-value">
        <span class="status-badge status-${(fields['Payment Status'] || '').toLowerCase()}">
          ${fields['Payment Status'] || 'Pending'}
        </span>
      </span>
    </div>
    
    <div class="detail-item">
      <span class="detail-label">üìä Booking Status</span>
      <span class="detail-value">
        <span class="status-badge status-${(fields['Booking Status'] || '').toLowerCase()}">
          ${fields['Booking Status'] || 'Booked'}
        </span>
      </span>
    </div>
    
    <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
      <div class="action-buttons-grid">
        <button class="btn btn-primary" onclick="showAdminReschedule('${booking.id}')">
          üìÖ Reschedule
        </button>
        <button class="btn btn-warning" onclick="showModifyService('${booking.id}')">
          ‚úèÔ∏è Modify Service
        </button>
        <button class="btn btn-danger" onclick="showAdminCancel('${booking.id}')">
          ‚ùå Cancel
        </button>
      </div>
    </div>
  `;
  
  modal.classList.add('active');
}

// Show Admin Reschedule Modal
function showAdminReschedule(bookingId) {
  const booking = allBookings.find(b => b.id === bookingId) || currentBooking;
  if (!booking) return;
  
  const modal = document.getElementById('rescheduleModal');
  const modalBody = document.getElementById('rescheduleModalBody');
  
  modalBody.innerHTML = `
    <div class="form-group">
      <label class="form-label">Current Booking</label>
      <div style="padding: 12px; background: #f8fafc; border-radius: 8px;">
        <div style="margin-bottom: 8px;"><strong>Date:</strong> ${booking.fields['Date']}</div>
        <div><strong>Time:</strong> ${booking.fields['Time']}</div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="rescheduleDate">New Date *</label>
      <input 
        type="date" 
        id="rescheduleDate" 
        class="form-input" 
        required
        min="${new Date().toISOString().split('T')[0]}"
      />
    </div>

    <div class="form-group">
      <label class="form-label" for="rescheduleTime">New Time *</label>
      <select id="rescheduleTime" class="form-input" required>
        <option value="">-- Select Time --</option>
        ${generateTimeOptions()}
      </select>
    </div>

    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <input type="checkbox" id="rescheduleSendEmail" checked style="width: 20px; height: 20px;">
        <span style="font-size: 14px; font-weight: 600;">Send confirmation email to customer</span>
      </label>
    </div>

    <div class="button-group" style="margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeModal('rescheduleModal')" style="flex: 1;">
        Cancel
      </button>
      <button class="btn btn-primary" onclick="confirmReschedule('${bookingId}')" style="flex: 2;">
        Confirm Reschedule
      </button>
    </div>
  `;
  
  modal.classList.add('active');
}

// ===== PENDING BOOKINGS FUNCTIONS =====

async function loadPendingBookings() {
  const container = document.getElementById('pendingContainer');
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

  try {
    // ‚úÖ Fetch ALL bookings first (no filters)
    const response = await fetch('/.netlify/functions/admin-bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})  // Empty = get all bookings
    });

    const data = await response.json();
    console.log('üìä All bookings fetched:', data.bookings?.length);

    if (data.success) {
      // ‚úÖ Filter client-side for pending payments
      const pendingBookings = data.bookings.filter(booking => {
        const paymentStatus = booking.fields['Payment Status'];
        const bookingStatus = booking.fields['Booking Status'];
        
        // Debug each booking
        if (paymentStatus === 'Pending') {
          console.log('Found pending:', {
            ref: booking.fields['Booking Reference'],
            paymentStatus,
            bookingStatus
          });
        }
        
        // Include if:
        // 1. Payment Status = "Pending"
        // 2. Booking Status is active (not cancelled)
        return paymentStatus === 'Pending' && 
               bookingStatus !== 'Cancelled';
      });
      
      console.log('üí≥ Pending bookings to display:', pendingBookings.length);
      renderPendingBookingsTable(pendingBookings);
    } else {
      console.error('‚ùå API returned error:', data);
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load bookings</div>';
    }

  } catch (error) {
    console.error('‚ùå Error loading pending bookings:', error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading pending bookings</div>';
  }
}

function renderPendingBookingsTable(bookings) {
  const container = document.getElementById('pendingContainer');
  
  if (bookings.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px;">
        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
        <h3 style="color: #64748b; margin-bottom: 8px;">All Caught Up!</h3>
        <p style="color: #94a3b8;">No bookings waiting for payment</p>
      </div>
    `;
    return;
  }

  let html = `
    <table class="data-table">
      <thead>
        <tr>
          <th>Reference</th>
          <th>Client</th>
          <th>Service</th>
          <th>Date & Time</th>
          <th>Total</th>
          <th>Payment Method</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  bookings.forEach(booking => {
    const fields = booking.fields;
    const hasPaymentMethod = !!fields['Stripe Payment Method ID'];
    const finalPrice = fields['Final Price'] || 0;
    const discountCode = fields['Discount Code'] || '';
    const discountAmount = fields['Discount Amount'] || 0;
    
    html += `
      <tr>
        <td data-label="Reference">
          <strong>${fields['Booking Reference']}</strong>
          ${discountCode ? `<br><small style="color: #10b981;">üéÅ ${discountCode}</small>` : ''}
        </td>
        <td data-label="Client">
          ${fields['Client Name']}<br>
          <small style="color: #64748b;">${fields['Client Email']}</small>
        </td>
        <td data-label="Service">${fields['Service']}</td>
        <td data-label="Date & Time">
          ${fields['Date']}<br>
          <strong>${fields['Time']}</strong>
        </td>
        <td data-label="Total">
          <strong>¬£${finalPrice.toFixed(2)}</strong>
          ${discountAmount > 0 ? `<br><small style="color: #10b981;">-¬£${discountAmount.toFixed(2)} off</small>` : ''}
        </td>
        <td data-label="Payment Method">
          ${hasPaymentMethod 
            ? '<span class="status-badge status-active">üí≥ Card on File</span>' 
            : '<span class="status-badge" style="background: #fee2e2; color: #991b1b;">‚ùå No Card</span>'}
        </td>
        <td data-label="Actions">
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            ${hasPaymentMethod ? `
              <button class="btn btn-success btn-small" onclick="chargeCard('${booking.id}', '${fields['Booking Reference']}', ${finalPrice})">
                üí≥ Charge Card
              </button>
            ` : ''}
            <button class="btn btn-warning btn-small" onclick="markAsPaid('${booking.id}')">
              ‚úÖ Mark Paid
            </button>
            <button class="btn btn-primary btn-small" onclick="viewBookingById('${booking.id}')">
              üëÅÔ∏è View
            </button>
          </div>
        </td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// ===== MARK AS PAID FUNCTION - CORRECTED =====
async function markAsPaid(bookingId) {
  const booking = allBookings.find(b => b.id === bookingId);
  if (!booking) return;
  
  const finalPrice = booking.fields['Final Price'] || 0;
  
  if (!confirm(`Mark this booking as paid?\n\nClient: ${booking.fields['Client Name']}\nAmount: ¬£${finalPrice.toFixed(2)}`)) {
    return;
  }
  
  try {
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: 'PATCH',
        table: 'Bookings',
        recordId: bookingId,  // ‚úÖ Using recordId
        body: {
          fields: {
            'Payment Status': 'Paid'
          }
        }
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      console.error('Airtable error:', data);
      throw new Error(data.error?.message || 'Failed to update payment status');
    }
    
    alert('‚úÖ Booking marked as paid!');
    loadPendingBookings();
    loadBookings();
    loadCalendar();
    loadDashboardStats();
    
  } catch (error) {
    console.error('Error marking as paid:', error);
    alert('‚ùå Failed to update payment status: ' + error.message);
  }
}

async function chargeCard(bookingId, bookingRef, amount) {
  if (!confirm(`Charge card for booking ${bookingRef}?\n\nAmount: ¬£${amount.toFixed(2)}\n\nThis will charge the customer's saved card immediately.`)) {
    return;
  }
  
  try {
    const response = await fetch('/.netlify/functions/charge-card', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert(`‚úÖ Card charged successfully!\n\nBooking: ${data.bookingRef}\nAmount: ¬£${data.amount.toFixed(2)}\n\nConfirmation email sent to customer.`);
      loadPendingBookings();
      loadBookings();
      loadCalendar();
      loadDashboardStats();
    } else {
      alert(`‚ùå Payment Failed\n\n${data.userMessage || data.error}\n\nBooking: ${bookingRef}`);
    }
    
  } catch (error) {
    console.error('Error charging card:', error);
    alert(`‚ùå Failed to charge card: ${error.message}`);
  }
}

// ===== QUICK BLOCK MODAL =====

function showQuickBlockModal(dateStr) {
  const date = new Date(dateStr);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  if (date < today) {
    alert('‚ùå Cannot block times in the past');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'quickBlockModal';
  modal.style.zIndex = '10000';
  
  modal.innerHTML = `
    <div class="modal-dialog" style="max-width: 500px;">
      <div class="modal-header">
        <h3>üö´ Block Time</h3>
        <button class="modal-close" onclick="closeQuickBlockModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="quickBlockForm" onsubmit="saveQuickBlock(event, '${dateStr}')">
          
          <div class="form-group">
            <label class="form-label">Date</label>
            <div style="padding: 12px; background: #f8fafc; border-radius: 8px; font-weight: 600;">
              ${date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="quickBlockRegion">Region *</label>
            <select id="quickBlockRegion" class="form-input" required>
              <option value="">-- Select Region --</option>
              <option value="North">North</option>
              <option value="South">South</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="quickBlockStartTime">Start Time *</label>
              <select id="quickBlockStartTime" class="form-input" required>
                <option value="">-- Select --</option>
                ${generateTimeOptions('09:00')}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="quickBlockEndTime">End Time *</label>
              <select id="quickBlockEndTime" class="form-input" required>
                <option value="">-- Select --</option>
                ${generateTimeOptions('18:00')}
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="quickBlockReason">Reason (Optional)</label>
            <input 
              type="text" 
              id="quickBlockReason" 
              class="form-input" 
              placeholder="e.g., Team meeting, Weather, Equipment maintenance"
            />
          </div>

          <div class="button-group" style="margin-top: 24px;">
            <button type="button" class="btn btn-secondary" onclick="closeQuickBlockModal()" style="flex: 1;">
              Cancel
            </button>
            <button type="submit" class="btn btn-danger" style="flex: 2;">
              üö´ Block Time
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function closeQuickBlockModal() {
  const modal = document.getElementById('quickBlockModal');
  if (modal) modal.remove();
}

async function saveQuickBlock(event, dateStr) {
  event.preventDefault();
  
  const region = document.getElementById('quickBlockRegion').value;
  const startTime = document.getElementById('quickBlockStartTime').value;
  const endTime = document.getElementById('quickBlockEndTime').value;
  const reason = document.getElementById('quickBlockReason').value.trim();
  
  if (startTime >= endTime) {
    alert('‚ùå End time must be after start time');
    return;
  }
  
  try {
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: 'POST',
        table: 'Blocked Times',
        body: {
          fields: {
            'Region': region,
            'Date': dateStr,
            'Start Time': startTime,
            'End Time': endTime,
            'Reason': reason || 'Admin block',
            'Created By': 'Admin Calendar'
          }
        }
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to create blocked time');
    }
    
    alert(`‚úÖ Time blocked!\n\n${region} - ${dateStr}\n${startTime} to ${endTime}`);
    closeQuickBlockModal();
    loadCalendar(); // Refresh calendar
    
  } catch (error) {
    console.error('Error creating blocked time:', error);
    alert('‚ùå Failed to block time');
  }
}

// ===== VIEW BLOCKED TIME DETAILS =====

function viewBlockedTime(blockId) {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'viewBlockModal';
  modal.style.zIndex = '10000';
  
  fetch('/.netlify/functions/airtable-proxy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      method: 'GET',
      table: 'Blocked Times',
      recordId: blockId
    })
  })
  .then(res => res.json())
  .then(data => {
    const fields = data.fields;
    const date = new Date(fields['Date']);
    
    modal.innerHTML = `
      <div class="modal-dialog" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
          <h3>üö´ Blocked Time</h3>
          <button class="modal-close" onclick="closeViewBlockModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="detail-item">
            <span class="detail-label">Region</span>
            <span class="detail-value">
              <span class="region-badge ${fields['Region'].toLowerCase()}">${fields['Region']}</span>
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Date</span>
            <span class="detail-value">${date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Time Blocked</span>
            <span class="detail-value"><strong>${fields['Start Time']} - ${fields['End Time']}</strong></span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Reason</span>
            <span class="detail-value">${fields['Reason'] || 'Not specified'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Created By</span>
            <span class="detail-value">${fields['Created By'] || 'Admin'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Created Date</span>
            <span class="detail-value">${new Date(fields['Created Date']).toLocaleDateString('en-GB')}</span>
          </div>
          
          <div style="margin-top: 24px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="deleteBlockFromCalendar('${blockId}', '${fields['Date']}')">
              üóëÔ∏è Remove Block
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  })
  .catch(error => {
    console.error('Error loading blocked time:', error);
    alert('‚ùå Failed to load blocked time details');
  });
}

function closeViewBlockModal() {
  const modal = document.getElementById('viewBlockModal');
  if (modal) modal.remove();
}

async function deleteBlockFromCalendar(recordId, date) {
  if (!confirm(`Remove this time block for ${date}?`)) {
    return;
  }
  
  try {
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: 'DELETE',
        table: 'Blocked Times',
        recordId: recordId
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error?.message || 'Failed to delete blocked time');
    }
    
    alert('‚úÖ Time block removed!');
    closeViewBlockModal();
    loadCalendar();
    
  } catch (error) {
    console.error('Error deleting blocked time:', error);
    alert('‚ùå Failed to remove time block: ' + error.message);
  }
}

// Helper function (if not already present)
function generateTimeOptions(selectedTime = '') {
  const times = [];
  for (let hour = 9; hour <= 18; hour++) {
    for (let minute of [0, 30]) {
      if (hour === 18 && minute === 30) break;
      const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
      const selected = timeStr === selectedTime ? 'selected' : '';
      times.push(`<option value="${timeStr}" ${selected}>${timeStr}</option>`);
    }
  }
  return times.join('');
}

async function confirmReschedule(bookingId) {
  const newDate = document.getElementById('rescheduleDate').value;
  const newTime = document.getElementById('rescheduleTime').value;
  const sendEmail = document.getElementById('rescheduleSendEmail').checked;

  if (!newDate || !newTime) {
    alert('Please select both date and time');
    return;
  }

  try {
    const response = await fetch('/.netlify/functions/admin-reschedule-booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId, newDate, newTime, sendEmail })
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úÖ Rescheduled!\n\n${newDate} at ${newTime}\n\n${data.emailSent ? '‚úâÔ∏è Email sent' : 'üîï Silent'}`);
      closeModal('rescheduleModal');
      closeModal('bookingModal');
      loadBookings();
      loadCalendar();
      loadDashboardStats();
    } else {
      alert(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Reschedule error:', error);
    alert('‚ùå Failed to reschedule.');
  }
}

    // Show Cancel Modal
function showAdminCancel(bookingId) {
  const booking = allBookings.find(b => b.id === bookingId) || currentBooking;
  if (!booking) return;
  
  const modal = document.getElementById('cancelModal');
  const modalBody = document.getElementById('cancelModalBody');
  
  modalBody.innerHTML = `
    <div class="warning-box">
      ‚ö†Ô∏è <strong>Warning:</strong> This action cannot be undone. Cancellation fees may apply based on the timing.
    </div>

    <div class="form-group">
      <label class="form-label">Booking Details</label>
      <div style="padding: 12px; background: #f8fafc; border-radius: 8px;">
        <div style="margin-bottom: 8px;"><strong>Client:</strong> ${booking.fields['Client Name']}</div>
        <div style="margin-bottom: 8px;"><strong>Date:</strong> ${booking.fields['Date']} at ${booking.fields['Time']}</div>
        <div><strong>Service:</strong> ${booking.fields['Service']}</div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="cancelReason">Cancellation Reason *</label>
      <select id="cancelReason" class="form-input">
        <option value="">-- Select a reason --</option>
        <option value="Customer request">Customer request</option>
        <option value="Property not ready">Property not ready</option>
        <option value="Weather conditions">Weather conditions</option>
        <option value="Media specialist unavailable">Media specialist unavailable</option>
        <option value="Scheduling conflict">Scheduling conflict</option>
        <option value="Other">Other (specify below)</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label" for="cancelNotes">Additional Notes (Optional)</label>
      <textarea 
        id="cancelNotes" 
        class="form-input" 
        rows="3"
        placeholder="Any additional details about the cancellation..."
      ></textarea>
    </div>

    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <input type="checkbox" id="cancelSendEmail" checked style="width: 20px; height: 20px;">
        <span style="font-size: 14px; font-weight: 600;">Send cancellation email to customer</span>
      </label>
    </div>

    <div class="button-group" style="margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeModal('cancelModal')" style="flex: 1;">
        Keep Booking
      </button>
      <button class="btn btn-danger" onclick="confirmCancel('${bookingId}')" style="flex: 2;">
        Confirm Cancellation
      </button>
    </div>
  `;
  
  modal.classList.add('active');
}

async function confirmCancel(bookingId) {
  const reason = document.getElementById('cancelReason').value;
  const notes = document.getElementById('cancelNotes').value.trim();
  const sendEmail = document.getElementById('cancelSendEmail').checked;

  if (!reason) {
    alert('Please select a cancellation reason');
    document.getElementById('cancelReason').focus();
    return;
  }

  const finalReason = notes ? `${reason}: ${notes}` : reason;

  try {
    const response = await fetch('/.netlify/functions/admin-cancel-booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId, reason: finalReason, sendEmail })
    });

    const data = await response.json();

    if (data.success) {
      let msg = `‚úÖ Cancelled!\n\n`;
      if (data.cancellationCharge > 0) msg += `Fee: ¬£${data.cancellationCharge.toFixed(2)}\n`;
      if (data.refundProcessed) msg += `Refund: ¬£${data.refundAmount.toFixed(2)}\n`;
      msg += `\n${data.emailSent ? '‚úâÔ∏è Email sent' : 'üîï Silent'}`;
      alert(msg);
      closeModal('cancelModal');
      closeModal('bookingModal');
      loadBookings();
      loadCalendar();
      loadDashboardStats();
    } else {
      alert(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Cancel error:', error);
    alert('‚ùå Failed to cancel.');
  }
}

    // Show Modify Service Modal
function showModifyService(bookingId) {
  const booking = allBookings.find(b => b.id === bookingId) || currentBooking;
  if (!booking) return;
  
  const modal = document.getElementById('modifyServiceModal');
  const modalBody = document.getElementById('modifyServiceModalBody');
  
  const region = booking.fields['Region'] === 'North' ? 'north' : 'south';
  const services = SERVICES_CATALOG[region] || SERVICES_CATALOG.south;
  
  const currentPrice = booking.fields['Final Price'] || 0;
  
  modalBody.innerHTML = `
    <div class="form-group">
      <label class="form-label">Current Service</label>
      <div style="padding: 12px; background: #f8fafc; border-radius: 8px; font-weight: 600;">
        ${booking.fields['Service']} - ¬£${currentPrice.toFixed(2)}
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="newService">New Service *</label>
      <select id="newService" class="form-input" onchange="updateServicePrice()">
        <option value="">-- Select new service --</option>
        ${services.map(service => `
          <option 
            value="${service.id}" 
            data-price="${service.price}"
            data-duration="${service.duration}"
            data-name="${service.name}"
          >
            ${service.name} - ¬£${service.price.toFixed(2)}
          </option>
        `).join('')}
      </select>
    </div>

    <div id="addonSection" style="display: none; margin-top: 24px;">
      <label class="form-label">Add-Ons (Optional)</label>
      <div id="addonCheckboxes" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Add-ons will be populated dynamically -->
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Bedrooms (if applicable)</label>
      <div style="display: flex; align-items: center; gap: 16px;">
        <button type="button" class="bedroom-btn" onclick="adjustModifyBedrooms(-1)">-</button>
        <div style="flex: 1; text-align: center;">
          <div id="modifyBedroomCount" style="font-size: 32px; font-weight: 700; color: #3b82f6;">4</div>
        </div>
        <button type="button" class="bedroom-btn" onclick="adjustModifyBedrooms(1)">+</button>
      </div>
    </div>

    <div id="modifyPriceBreakdown" style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 24px 0;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
        <span style="color: #64748b;">Service</span>
        <span id="modifyServicePrice" style="font-weight: 600;">¬£0.00</span>
      </div>
      <div id="modifyBedroomRow" style="display: none; justify-content: space-between; margin-bottom: 12px;">
        <span style="color: #64748b;">Extra bedrooms</span>
        <span id="modifyBedroomFee" style="font-weight: 600;">¬£0.00</span>
      </div>
      <div id="modifyAddonsRow" style="display: none; justify-content: space-between; margin-bottom: 12px;">
        <span style="color: #64748b;">Add-ons</span>
        <span id="modifyAddonsFee" style="font-weight: 600;">¬£0.00</span>
      </div>
      <div style="border-top: 2px solid #e2e8f0; margin: 16px 0;"></div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 18px; font-weight: 700;">New Total</span>
        <span id="modifyTotalPrice" style="font-size: 24px; font-weight: 700; color: #3b82f6;">¬£0.00</span>
      </div>
    </div>

    <div class="form-group">
      <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <input type="checkbox" id="modifySendEmail" checked style="width: 20px; height: 20px;">
        <span style="font-size: 14px; font-weight: 600;">Send update email to customer</span>
      </label>
    </div>

    <div class="button-group" style="margin-top: 24px;">
      <button class="btn btn-secondary" onclick="closeModal('modifyServiceModal')" style="flex: 1;">
        Cancel
      </button>
      <button class="btn btn-primary" onclick="confirmModifyService('${bookingId}')" style="flex: 2;">
        Update Service
      </button>
    </div>
  `;
  
  modal.classList.add('active');
}

let modifyServiceData = {
  bedrooms: 4,
  selectedAddons: []
};

function updateServicePrice() {
  const select = document.getElementById('newService');
  const selectedOption = select.options[select.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) {
    document.getElementById('addonSection').style.display = 'none';
    return;
  }

  const serviceId = selectedOption.value;
  const booking = currentBooking || allBookings.find(b => b.id);
  const region = booking?.fields['Region'] === 'North' ? 'north' : 'south';
  const services = SERVICES_CATALOG[region] || SERVICES_CATALOG.south;
  const service = services.find(s => s.id === serviceId);

  // Show add-ons if available
  if (service && service.availableAddons && service.availableAddons.length > 0) {
    const addonContainer = document.getElementById('addonCheckboxes');
    addonContainer.innerHTML = service.availableAddons.map(addonId => {
      const addon = ADDONS_CATALOG[addonId];
      if (!addon) return '';
      
      return `
        <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
          <input 
            type="checkbox" 
            value="${addon.id}" 
            onchange="toggleModifyAddon('${addon.id}')"
            style="width: 20px; height: 20px;"
          >
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${addon.name}</div>
            <div style="font-size: 13px; color: #64748b;">${addon.description}</div>
          </div>
          <div style="font-weight: 700; color: #3b82f6;">
            ${addon.price === 0 ? 'FREE' : `+¬£${addon.price.toFixed(2)}`}
          </div>
        </label>
      `;
    }).join('');
    
    document.getElementById('addonSection').style.display = 'block';
  } else {
    document.getElementById('addonSection').style.display = 'none';
  }

  modifyServiceData.selectedAddons = [];
  calculateModifyPrice();
}

function toggleModifyAddon(addonId) {
  const index = modifyServiceData.selectedAddons.indexOf(addonId);
  if (index > -1) {
    modifyServiceData.selectedAddons.splice(index, 1);
  } else {
    modifyServiceData.selectedAddons.push(addonId);
  }
  calculateModifyPrice();
}

function adjustModifyBedrooms(change) {
  modifyServiceData.bedrooms = Math.max(1, Math.min(15, modifyServiceData.bedrooms + change));
  document.getElementById('modifyBedroomCount').textContent = modifyServiceData.bedrooms;
  calculateModifyPrice();
}

function calculateModifyPrice() {
  const select = document.getElementById('newService');
  const selectedOption = select.options[select.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) return;

  const servicePrice = parseFloat(selectedOption.dataset.price);
  const extraBedrooms = Math.max(0, modifyServiceData.bedrooms - 4);
  const bedroomFee = extraBedrooms * 30;

  let addonsFee = 0;
  modifyServiceData.selectedAddons.forEach(addonId => {
    const addon = ADDONS_CATALOG[addonId];
    if (addon) addonsFee += addon.price;
  });

  const totalPrice = servicePrice + bedroomFee + addonsFee;

  document.getElementById('modifyServicePrice').textContent = `¬£${servicePrice.toFixed(2)}`;
  document.getElementById('modifyTotalPrice').textContent = `¬£${totalPrice.toFixed(2)}`;

  const bedroomRow = document.getElementById('modifyBedroomRow');
  if (bedroomFee > 0) {
    bedroomRow.style.display = 'flex';
    document.getElementById('modifyBedroomFee').textContent = `¬£${bedroomFee.toFixed(2)}`;
  } else {
    bedroomRow.style.display = 'none';
  }

  const addonsRow = document.getElementById('modifyAddonsRow');
  if (addonsFee > 0) {
    addonsRow.style.display = 'flex';
    document.getElementById('modifyAddonsFee').textContent = `¬£${addonsFee.toFixed(2)}`;
  } else {
    addonsRow.style.display = 'none';
  }
}

async function confirmModifyService(bookingId) {
  const select = document.getElementById('newService');
  const selectedOption = select.options[select.selectedIndex];
  
  if (!selectedOption || !selectedOption.value) {
    alert('Please select a new service');
    return;
  }

  const serviceId = selectedOption.value;
  const serviceName = selectedOption.dataset.name;
  const servicePrice = parseFloat(selectedOption.dataset.price);
  const serviceDuration = parseInt(selectedOption.dataset.duration);
  const sendEmail = document.getElementById('modifySendEmail').checked;

  const extraBedrooms = Math.max(0, modifyServiceData.bedrooms - 4);
  const bedroomFee = extraBedrooms * 30;

  let addonsFee = 0;
  const addonsArray = modifyServiceData.selectedAddons.map(addonId => {
    const addon = ADDONS_CATALOG[addonId];
    if (addon) addonsFee += addon.price;
    return {
      id: addonId,
      name: addon?.name || '',
      price: addon?.price || 0
    };
  });

  const totalPrice = servicePrice + bedroomFee + addonsFee;

  try {
    const response = await fetch('/.netlify/functions/admin-modify-service', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        bookingId,
        newServiceId: serviceId,
        newServiceName: serviceName,
        newServicePrice: servicePrice,
        newServiceDuration: serviceDuration,
        bedrooms: modifyServiceData.bedrooms,
        extraBedroomFee: bedroomFee,
        addons: addonsArray,
        addonsPrice: addonsFee,
        totalPrice: totalPrice,
        sendEmail
      })
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úÖ Service Updated!\n\nNew: ${serviceName} (¬£${totalPrice.toFixed(2)})\n\n${data.emailSent ? '‚úâÔ∏è Email sent' : 'üîï Silent'}`);
      closeModal('modifyServiceModal');
      closeModal('bookingModal');
      loadBookings();
      loadCalendar();
      loadDashboardStats();
    } else {
      alert(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Modify service error:', error);
    alert('‚ùå Failed to modify service.');
  }
}

    // Customers Functions
    async function loadCustomers() {
      const container = document.getElementById('customersContainer');
      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        const response = await fetch('/.netlify/functions/admin-users');
        const data = await response.json();

        if (data.success) {
          allCustomers = data.users;
          renderCustomersTable(allCustomers);
          populateCustomerDropdown(); // ADD THIS LINE
        }

      } catch (error) {
        console.error('Error loading customers:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading customers</div>';
      }
    }

    function renderCustomersTable(customers) {
      const container = document.getElementById('customersContainer');
      const search = document.getElementById('customerSearch')?.value || '';

      let filtered = customers;
      if (search) {
        const term = search.toLowerCase();
        filtered = customers.filter(c => 
          (c.fields['Name'] || '').toLowerCase().includes(term) ||
          (c.fields['Email'] || '').toLowerCase().includes(term) ||
          (c.fields['Company'] || '').toLowerCase().includes(term)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px;">No customers found</div>';
        return;
      }

      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Company</th>
              <th>Region</th>
              <th>Status</th>
              <th>Email Alerts</th>
              <th>Skip Payment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(customer => {
        const allowReserve = customer.fields['Allow Reserve Without Payment'] === true;
        const emailNotifications = customer.fields['Email Notifications Enabled'] === true;

        html += `
          <tr>
            <td data-label="Name"><strong>${customer.fields['Name']}</strong></td>
            <td data-label="Email">${customer.fields['Email']}</td>
            <td data-label="Company">${customer.fields['Company'] || '-'}</td>
            <td data-label="Region">
              <select 
                class="region-select" 
                data-user-email="${customer.fields['Email']}" 
                data-record-id="${customer.id}"
                data-original-value="${customer.fields['Region'] || ''}"
                onchange="updateUserRegion(this)"
              >
                <option value="">Select Region...</option>
                ${UK_REGIONS.map(region => `
                  <option value="${region}" ${customer.fields['Region'] === region ? 'selected' : ''}>
                    ${region}
                  </option>
                `).join('')}
              </select>
            </td>
            <td data-label="Status">
              <span class="status-badge status-${(customer.fields['Account Status'] || '').toLowerCase()}">
                ${customer.fields['Account Status'] || '-'}
              </span>
            </td>
            <td data-label="Email Alerts">
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  ${emailNotifications ? 'checked' : ''} 
                  onchange='toggleEmailNotifications("${customer.fields['Email']}", this.checked, "${customer.id}")'
                >
                <span class="toggle-slider"></span>
              </label>
            </td>
            <td data-label="Skip Payment">
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  ${allowReserve ? 'checked' : ''} 
                  onchange='toggleReservePrivilege("${customer.id}", "${customer.fields['Email']}", this.checked)'
                >
                <span class="toggle-slider"></span>
              </label>
            </td>
            <td data-label="Actions">
              <button class="btn btn-primary btn-small" onclick='viewCustomer(${JSON.stringify(customer).replace(/'/g, "&#39;")})'>
                View
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function viewCustomer(customer) {
      const modal = document.getElementById('customerModal');
      const title = document.getElementById('customerModalTitle');
      const body = document.getElementById('customerModalBody');

      title.textContent = customer.fields['Name'];

      const allowReserve = customer.fields['Allow Reserve Without Payment'] === true;
      const emailNotificationsEnabled = customer.fields['Email Notifications Enabled'] === true;
      const emailNotificationsStatus = emailNotificationsEnabled ? 'Enabled' : 'Disabled';
      const emailNotificationsColor = emailNotificationsEnabled ? '#10b981' : '#ef4444';

      body.innerHTML = `
        <div class="warning-box">
          ‚ö†Ô∏è <strong>Security Note:</strong> Passwords are hashed and cannot be viewed for security reasons.
        </div>

        <div class="detail-item">
          <span class="detail-label">üë§ Full Name</span>
          <span class="detail-value">${customer.fields['Name']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìß Email Address</span>
          <span class="detail-value">${customer.fields['Email']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üè¢ Company</span>
          <span class="detail-value">${customer.fields['Company'] || 'N/A'}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìç Region</span>
          <span class="detail-value">
            ${customer.fields['Region'] ? 
              `<span class="region-badge">${customer.fields['Region']}</span>` : 
              '<span class="region-badge empty">Not set</span>'
            }
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üìÖ Account Created</span>
          <span class="detail-value">${customer.fields['Created Date']}</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">‚úÖ Account Status</span>
          <span class="detail-value">
            <span class="status-badge status-${(customer.fields['Account Status'] || '').toLowerCase()}">
              ${customer.fields['Account Status'] || 'Unknown'}
            </span>
          </span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üì¨ Milestone Emails</span>
          <span class="detail-value">
            <span style="color: ${emailNotificationsColor}; font-weight: 600;">
              ${emailNotificationsStatus}
            </span>
          </span>
        </div>

       <div class="detail-item">
  <span class="detail-label">üö´ Skip Payment Requirement</span>
  <span class="detail-value">
    <label class="toggle-switch">
      <input 
        type="checkbox" 
        ${allowReserve ? 'checked' : ''} 
        onchange='toggleReservePrivilege("${customer.id}", "${customer.fields['Email']}", this.checked)'
      >
      <span class="toggle-slider"></span>
    </label>
    <br>
    <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
      ‚úÖ Enabled = Customer books without payment details (invoice later)<br>
      ‚ùå Disabled = Customer must pay or save card details
    </small>
  </span>
</div>

        <div class="detail-item">
          <span class="detail-label">üîê Password</span>
          <span class="detail-value" style="color: #64748b; font-style: italic;">Encrypted (not visible)</span>
        </div>

        <div class="detail-item">
          <span class="detail-label">üÜî Record ID</span>
          <span class="detail-value" style="font-family: monospace; font-size: 12px;">${customer.id}</span>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
          <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
            <button class="btn btn-danger" style="flex: 1;" onclick='redeemPoints("${customer.fields['Email']}", "${customer.fields['Name']}")'>
              ‚≠ê Redeem Points
            </button>
            <button class="btn btn-primary" style="flex: 1;" onclick='impersonateUser("${customer.fields['Email']}")'>
              üîë Login as ${customer.fields['Name']}
            </button>
            <button class="btn btn-secondary" style="flex: 1;" onclick='checkMilestone("${customer.fields['Email']}", "${customer.fields['Name']}")'>
              üìß Check Milestone
            </button>
          </div>
          
          <div style="padding: 16px; background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px;">
            <div style="font-weight: 600; color: #065f46; margin-bottom: 12px; font-size: 14px;">‚ûï Manually Add Points</div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input 
                type="number" 
                id="manualPoints-${customer.id}" 
                placeholder="Enter points amount" 
                min="1"
                style="flex: 1; padding: 10px 14px; border: 2px solid #10b981; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;"
              >
              <button class="btn btn-primary" style="white-space: nowrap;" onclick='addManualPoints("${customer.fields['Email']}", "${customer.fields['Name']}", "${customer.id}")'>
                ‚ûï Add Points
              </button>
            </div>
            <div style="font-size: 12px; color: #047857; margin-top: 8px;">Use this to add bonus/promotional points to the account</div>
          </div>
        </div>
      `;

      modal.classList.add('active');
    }

    async function toggleReservePrivilege(recordId, email, enabled) {
  try {
    const response = await fetch('/.netlify/functions/update-reserve-privilege', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recordId, email, enabled })
    });

    const data = await response.json();

    if (data.success) {
      console.log(`‚úì Reserve privilege ${enabled ? 'enabled' : 'disabled'} for ${email}`);
      const customer = allCustomers.find(c => c.id === recordId);
      if (customer) {
        customer.fields['Allow Reserve Without Payment'] = enabled;
      }
    } else {
      alert(`Error: ${data.message}`);
      event.target.checked = !enabled;
    }

  } catch (error) {
    console.error('Error toggling reserve privilege:', error);
    alert('Error updating privilege');
    event.target.checked = !enabled;
  }
}

    async function updateUserRegion(selectElement) {
      const email = selectElement.dataset.userEmail;
      const recordId = selectElement.dataset.recordId;
      const region = selectElement.value;
      
      const originalValue = selectElement.dataset.originalValue || '';
      selectElement.disabled = true;
      
      try {
        const response = await fetch('/.netlify/functions/update-user-region', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userEmail: email,
            recordId: recordId,
            region: region
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update region');
        }

        const result = await response.json();

        // Update the user in allCustomers array
        const userIndex = allCustomers.findIndex(u => u.fields['Email'] === email);
        if (userIndex !== -1) {
          allCustomers[userIndex].fields['Region'] = region;
        }

        // Store new value
        selectElement.dataset.originalValue = region;
        selectElement.disabled = false;
        
        console.log(`‚úÖ Region updated to "${region}" for ${email}`);

      } catch (error) {
        console.error('Error updating region:', error);
        alert(`‚ùå Failed to update region: ${error.message}`);
        
        // Revert selection
        selectElement.value = originalValue;
        selectElement.disabled = false;
      }
    }

    async function toggleEmailNotifications(email, enabled, recordId) {
      try {
        // Show loading state
        const toggleInput = event.target;
        toggleInput.disabled = true;

        const response = await fetch('/.netlify/functions/toggle-email-notifications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userEmail: email,
            enabled: enabled,
            recordId: recordId
          })
        });

        if (!response.ok) {
          throw new Error('Failed to update email notification settings');
        }

        const result = await response.json();
        
        // Update the user in allCustomers array
        const userIndex = allCustomers.findIndex(u => u.fields['Email'] === email);
        if (userIndex !== -1) {
          allCustomers[userIndex].fields['Email Notifications Enabled'] = enabled;
        }

        // Show success message briefly
        const statusText = enabled ? 'enabled' : 'disabled';
        console.log(`‚úÖ Email notifications ${statusText} for ${email}`);
        
        toggleInput.disabled = false;

      } catch (error) {
        console.error('Error toggling email notifications:', error);
        alert(`‚ùå Failed to update email notifications: ${error.message}`);
        
        // Revert the toggle
        event.target.checked = !enabled;
        event.target.disabled = false;
      }
    }

    function impersonateUser(email) {
      const user = allCustomers.find(c => c.fields['Email'] === email);
      if (!user) {
        alert('User data not found');
        return;
      }

      if (confirm(`Login as ${user.fields['Name']}?\n\nThis will open their dashboard in a new tab.`)) {
        const sessionData = {
          email: email,
          name: user.fields['Name'] || 'Client',
          company: user.fields['Company'] || '',
          timestamp: Date.now(),
          expires: Date.now() + (24 * 60 * 60 * 1000),
          adminImpersonation: true
        };

        const token = btoa(JSON.stringify(sessionData));
        
        const baseUrl = window.location.origin;
        const dashboardUrl = baseUrl + '/website/dashboard.html?admin_session=' + encodeURIComponent(token) + 
                            '&admin_email=' + encodeURIComponent(email) +
                            '&admin_name=' + encodeURIComponent(user.fields['Name'] || 'Client') +
                            '&admin_company=' + encodeURIComponent(user.fields['Company'] || '');
        
        window.open(dashboardUrl, '_blank');
        alert(`‚úì Logged in as ${user.fields['Name']}`);
      }
    }

    // Real-time search
    document.getElementById('bookingSearch')?.addEventListener('input', (e) => {
      renderBookingsTable(allBookings, e.target.value);
    });

    document.getElementById('customerSearch')?.addEventListener('input', (e) => {
      renderCustomersTable(allCustomers);
    });

    // Rewards and Points Management
   async function redeemPoints(email, name) {
  if (!email) {
    alert('Email address is required');
    return;
  }
  
  const user = allCustomers.find(u => u.fields['Email'] === email);
  if (!user) {
    alert('User data not found');
    return;
  }
  
  try {
    let airtableTotalInvestment = 0;
    const bookingsResponse = await fetch('/.netlify/functions/admin-bookings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ search: email })
    });
    
    if (bookingsResponse.ok) {
      const bookingsData = await bookingsResponse.json();
      
      if (bookingsData.success && bookingsData.bookings) {
        airtableTotalInvestment = bookingsData.bookings
          .filter(b => b.fields['Client Email']?.toLowerCase() === email.toLowerCase())
          .filter(b => b.fields['Payment Status'] === 'Paid' && b.fields['Booking Status'] !== 'Cancelled')
          .reduce((sum, booking) => sum + (booking.fields['Final Price'] || 0), 0);
      }
    }
    
    const bookingPoints = Math.floor(airtableTotalInvestment);
    
    const manualPointsResponse = await fetch('/.netlify/functions/get-manual-points', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userEmail: email })
    });
    
    const manualPointsData = await manualPointsResponse.json();
    const manualPoints = manualPointsData?.manualPoints || 0;
    const lastRedemptionBaseline = manualPointsData?.lastRedemptionBaseline || 0;
    
    const netBookingPoints = Math.max(0, bookingPoints - lastRedemptionBaseline);
    const currentPoints = netBookingPoints + manualPoints;
    const pointsValue = (currentPoints / 100).toFixed(2);

    if (currentPoints === 0) {
      alert(`${name} has no points to redeem.`);
      return;
    }

    const pointsToRedeem = prompt(`How many points would you like to redeem for ${name}?\n\nAvailable: ${currentPoints} pts (¬£${pointsValue})\n  ‚Ä¢ Airtable Bookings: ${netBookingPoints} pts\n  ‚Ä¢ Manual Points: ${manualPoints} pts\n\nEnter amount (or leave blank to redeem all):`);
    
    if (pointsToRedeem === null) {
      return;
    }

    let finalPointsToRedeem = currentPoints;
    
    if (pointsToRedeem.trim() !== '') {
      finalPointsToRedeem = parseInt(pointsToRedeem);
      
      if (isNaN(finalPointsToRedeem) || finalPointsToRedeem <= 0) {
        alert('Please enter a valid number greater than 0.');
        return;
      }
      
      if (finalPointsToRedeem > currentPoints) {
        alert(`Cannot redeem ${finalPointsToRedeem} points. Only ${currentPoints} points available.`);
        return;
      }
    }

    const finalValue = (finalPointsToRedeem / 100).toFixed(2);

    if (!confirm(`Confirm redemption for ${name}?\n\nRedeeming: ${finalPointsToRedeem} pts (¬£${finalValue})\nRemaining: ${currentPoints - finalPointsToRedeem} pts\n\nContinue?`)) {
      return;
    }

    const response = await fetch('/.netlify/functions/redeem-points', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        userEmail: email,
        redeemedPoints: finalPointsToRedeem,
        redeemedValue: finalValue,
        acuityTotalInvestment: airtableTotalInvestment,
        currentTotalPoints: currentPoints
      })
    });

    if (!response.ok) {
      throw new Error('Failed to redeem points');
    }

    const result = await response.json();
    
    alert(`‚úÖ Points redeemed successfully!\n\n${name} redeemed ${finalPointsToRedeem} points (¬£${finalValue})\n\nRemaining: ${currentPoints - finalPointsToRedeem} points`);
    
    loadCustomers();
    closeModal('customerModal');

  } catch (error) {
    console.error('Error redeeming points:', error);
    alert(`‚ùå Failed to redeem points: ${error.message}\n\nPlease try again.`);
  }
}

    async function addManualPoints(email, name, userId) {
      const input = document.getElementById(`manualPoints-${userId}`);
      const pointsToAdd = parseInt(input.value);
      
      if (!pointsToAdd || pointsToAdd <= 0) {
        alert('Please enter a valid points amount (greater than 0)');
        return;
      }
      
      if (!confirm(`Add ${pointsToAdd} bonus points to ${name}?\n\nThis will be recorded as a manual adjustment and will increase their total points balance.`)) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/add-manual-points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userEmail: email,
            pointsToAdd: pointsToAdd,
            addedBy: 'Admin',
            reason: 'Manual adjustment'
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to add points');
        }
        
        const result = await response.json();
        alert(`‚úÖ Successfully added ${pointsToAdd} points to ${name}!\n\nNew total: ${result.newTotal} points`);
        
        // Clear input and refresh
        input.value = '';
        loadCustomers();
        closeModal('customerModal');
        
      } catch (error) {
        console.error('Error adding points:', error);
        alert(`‚ùå Failed to add points: ${error.message}\n\nPlease try again.`);
      }
    }

    async function checkMilestone(email, name) {
      if (!email) {
        alert('Email address is required');
        return;
      }
      
      if (!confirm(`Check milestone for ${name}?\n\nThis will check if they've reached a new milestone and send an email if applicable.`)) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/check-milestone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userEmail: email })
        });
        
        if (!response.ok) {
          throw new Error('Failed to check milestone');
        }
        
        const result = await response.json();
        
        if (result.skipped) {
          alert(`‚ÑπÔ∏è Email notifications are disabled for ${name}`);
        } else if (result.emailSent) {
          alert(`‚úÖ Milestone email sent to ${name}!\n\nMilestone: ${result.milestone.tier} (${result.milestone.points} points)\nCurrent Balance: ${result.currentBalance} points`);
        } else {
          alert(`‚ÑπÔ∏è No new milestone reached for ${name}\n\nCurrent Balance: ${result.currentBalance} points\nLast Milestone: ${result.lastMilestoneReached} points`);
        }
        
        // Refresh user list
        loadCustomers();
        
      } catch (error) {
        console.error('Error checking milestone:', error);
        alert(`‚ùå Failed to check milestone: ${error.message}\n\nPlease try again.`);
      }
    }

    // Scroll input into view when keyboard appears on mobile/tablet
    if (window.innerWidth <= 1024) {
      document.addEventListener('focusin', function(e) {
        if (e.target.matches('input[type="number"]')) {
          setTimeout(() => {
            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      });
    }

    // ===== DISCOUNT CODES MANAGEMENT =====

let allDiscountCodes = [];
let currentDiscountCode = null;

// All available service IDs
const ALL_SERVICE_IDS = [
  'complete-branding',
  'branding-video',
  'branding-photo',
  'gold-package',
  'silver-package',
  'bronze-package',
  'all-in-one-drone',
  'property-video',
  'property-photo',
  'drone-video',
  'drone-photo',
  'property-speed-tours'
];

// Load Discount Codes
async function loadDiscountCodes() {
  const container = document.getElementById('discountCodesContainer');
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

  try {
    const statusFilter = document.getElementById('discountStatusFilter')?.value || '';
    
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        method: 'GET',
        table: 'Discount Codes',
        filterFormula: statusFilter ? `{Status} = "${statusFilter}"` : null
      })
    });

    const data = await response.json();

    if (data.records) {
      allDiscountCodes = data.records;
      renderDiscountCodesTable(allDiscountCodes);
    }

  } catch (error) {
    console.error('Error loading discount codes:', error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading discount codes</div>';
  }
}

// Render Discount Codes Table
function renderDiscountCodesTable(codes) {
  const container = document.getElementById('discountCodesContainer');
  
  if (codes.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üéÅ</div>
        <h3 style="color: #64748b; margin-bottom: 8px;">No Discount Codes Yet</h3>
        <p style="color: #94a3b8;">Create your first discount code to get started</p>
      </div>
    `;
    return;
  }

  let html = `
    <table class="data-table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Type</th>
          <th>Value</th>
          <th>Status</th>
          <th>Valid Period</th>
          <th>Usage</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  codes.forEach(code => {
    const fields = code.fields;
    const discountType = fields['Discount Type'];
    const discountValue = fields['Discount Value'];
    const status = fields['Status'];
    const maxUses = fields['Max Uses'] || '‚àû';
    const timesUsed = fields['Times Used'] || 0;
    
    const validFrom = fields['Valid From'] ? new Date(fields['Valid From']).toLocaleDateString('en-GB') : '-';
    const validUntil = fields['Valid Until'] ? new Date(fields['Valid Until']).toLocaleDateString('en-GB') : '-';
    
    const discountDisplay = discountType === 'Percentage' 
      ? `${discountValue}% off` 
      : `¬£${discountValue.toFixed(2)} off`;
    
    const usagePercent = maxUses !== '‚àû' ? Math.round((timesUsed / maxUses) * 100) : 0;
    
    html += `
      <tr>
        <td data-label="Code">
          <strong style="font-size: 16px; font-family: monospace;">${fields['Code']}</strong>
        </td>
        <td data-label="Type">
          <span class="status-badge" style="background: #dbeafe; color: #1e40af;">
            ${discountType}
          </span>
        </td>
        <td data-label="Value">
          <strong>${discountDisplay}</strong>
        </td>
        <td data-label="Status">
          <span class="status-badge status-${status.toLowerCase()}">
            ${status}
          </span>
        </td>
        <td data-label="Valid Period">
          ${validFrom}<br>to ${validUntil}
        </td>
        <td data-label="Usage">
          <div style="margin-bottom: 4px;">${timesUsed} / ${maxUses}</div>
          ${maxUses !== '‚àû' ? `
            <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="background: ${usagePercent >= 90 ? '#ef4444' : usagePercent >= 70 ? '#f59e0b' : '#10b981'}; height: 100%; width: ${usagePercent}%;"></div>
            </div>
          ` : ''}
        </td>
        <td data-label="Actions">
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-primary btn-small" onclick="editDiscountCode('${code.id}')">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn btn-danger btn-small" onclick="deleteDiscountCode('${code.id}', '${fields['Code']}')">
              üóëÔ∏è Delete
            </button>
          </div>
        </td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// Show Create Discount Modal
function showCreateDiscountModal() {
  currentDiscountCode = null;
  
  document.getElementById('discountModalTitle').textContent = 'Create Discount Code';
  document.getElementById('saveDiscountBtn').querySelector('span').textContent = 'Create Discount Code';
  
  // Reset form
  document.getElementById('discountForm').reset();
  
  // Populate service checkboxes
  populateServiceCheckboxes();
  
  // Show modal
  document.getElementById('discountModal').classList.add('active');
}

// Populate Service Checkboxes
function populateServiceCheckboxes() {
  const container = document.getElementById('serviceCheckboxes');
  
  const serviceNames = {
    'complete-branding': 'Complete Branding Package',
    'branding-video': 'Branding Video',
    'branding-photo': 'Branding Photo',
    'gold-package': 'Gold Package',
    'silver-package': 'Silver Package',
    'bronze-package': 'Bronze Package',
    'all-in-one-drone': 'All In One Drone',
    'property-video': 'Property Video',
    'property-photo': 'Property Photo',
    'drone-video': 'Drone Video',
    'drone-photo': 'Drone Photo',
    'property-speed-tours': 'Property Speed Tours'
  };
  
  container.innerHTML = ALL_SERVICE_IDS.map(serviceId => `
    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
      <input type="checkbox" value="${serviceId}" class="service-checkbox" style="width: 18px; height: 18px;">
      <span style="font-size: 13px;">${serviceNames[serviceId] || serviceId}</span>
    </label>
  `).join('');
}

// Update Discount Value Label
function updateDiscountValueLabel() {
  const type = document.getElementById('discountType').value;
  const label = document.getElementById('discountValueLabel');
  
  if (type === 'Percentage') {
    label.textContent = 'Percentage (%) *';
    document.getElementById('discountValue').placeholder = 'e.g. 25';
    document.getElementById('discountValue').max = '100';
  } else if (type === 'Fixed Amount') {
    label.textContent = 'Amount (¬£) *';
    document.getElementById('discountValue').placeholder = 'e.g. 50.00';
    document.getElementById('discountValue').removeAttribute('max');
  } else {
    label.textContent = 'Discount Value *';
  }
}

// Save Discount Code
async function saveDiscountCode(event) {
  event.preventDefault();
  
  const btn = document.getElementById('saveDiscountBtn');
  const originalText = btn.querySelector('span').textContent;
  btn.disabled = true;
  btn.classList.add('loading');
  
  try {
    const code = document.getElementById('discountCode').value.trim().toUpperCase();
    const type = document.getElementById('discountType').value;
    const value = parseFloat(document.getElementById('discountValue').value);
    const status = document.getElementById('discountStatus').value;
    const validFrom = document.getElementById('validFrom').value || null;
    const validUntil = document.getElementById('validUntil').value || null;
    const maxUses = document.getElementById('maxUses').value ? parseInt(document.getElementById('maxUses').value) : null;
    const minPurchase = document.getElementById('minPurchase').value ? parseFloat(document.getElementById('minPurchase').value) : null;
    const notes = document.getElementById('discountNotes').value.trim();
    
    const selectedRegions = Array.from(document.querySelectorAll('.region-checkbox:checked')).map(cb => cb.value);
    const selectedServices = Array.from(document.querySelectorAll('.service-checkbox:checked')).map(cb => cb.value);
    
    const fields = {
      'Code': code,
      'Discount Type': type,
      'Discount Value': value,
      'Status': status,
      'Times Used': currentDiscountCode ? undefined : 0
    };
    
    if (validFrom) fields['Valid From'] = validFrom;
    if (validUntil) fields['Valid Until'] = validUntil;
    if (maxUses) fields['Max Uses'] = maxUses;
    if (minPurchase) fields['Min Purchase'] = minPurchase;
    if (notes) fields['Notes'] = notes;
    if (selectedRegions.length > 0) fields['Applicable Regions'] = selectedRegions;
    if (selectedServices.length > 0) fields['Applicable Services'] = selectedServices;
    
    console.log('Sending to Airtable:', fields);
    
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: currentDiscountCode ? 'PATCH' : 'POST',
        table: 'Discount Codes',
        recordId: currentDiscountCode || undefined,
        body: { fields }
      })
    });

    const data = await response.json();
    console.log('Airtable response status:', response.status);
    console.log('Airtable response data:', data);
    
    if (!response.ok) {
      console.error('Airtable Error:', data);
      throw new Error(data.error?.message || 'Failed to save discount code');
    }
    
    alert(`‚úÖ Discount code "${code}" ${currentDiscountCode ? 'updated' : 'created'} successfully!`);
    closeModal('discountModal');
    loadDiscountCodes();
    
  } catch (error) {
    console.error('Error saving discount code:', error);
    alert('‚ùå Failed to save discount code: ' + error.message);
  }
  
  btn.disabled = false;
  btn.classList.remove('loading');
  btn.querySelector('span').textContent = originalText;
}

// Edit Discount Code
function editDiscountCode(codeId) {
  const code = allDiscountCodes.find(c => c.id === codeId);
  if (!code) return;
  
  currentDiscountCode = codeId;
  const fields = code.fields;
  
  document.getElementById('discountModalTitle').textContent = 'Edit Discount Code';
  document.getElementById('saveDiscountBtn').querySelector('span').textContent = 'Update Discount Code';
  
  // Populate form
  document.getElementById('discountCode').value = fields['Code'];
  document.getElementById('discountType').value = fields['Discount Type'];
  document.getElementById('discountValue').value = fields['Discount Value'];
  document.getElementById('discountStatus').value = fields['Status'];
  document.getElementById('validFrom').value = fields['Valid From'] || '';
  document.getElementById('validUntil').value = fields['Valid Until'] || '';
  document.getElementById('maxUses').value = fields['Max Uses'] || '';
  document.getElementById('minPurchase').value = fields['Min Purchase'] || '';
  document.getElementById('discountNotes').value = fields['Notes'] || '';
  
  updateDiscountValueLabel();
  
  // Populate service checkboxes
  populateServiceCheckboxes();
  
  // Check applicable regions
  const applicableRegions = fields['Applicable Regions'] || [];
  document.querySelectorAll('.region-checkbox').forEach(cb => {
    cb.checked = applicableRegions.includes(cb.value);
  });
  
  // Check applicable services
  const applicableServices = fields['Applicable Services'] || [];
  document.querySelectorAll('.service-checkbox').forEach(cb => {
    cb.checked = applicableServices.includes(cb.value);
  });
  
  document.getElementById('discountModal').classList.add('active');
}

// Delete Discount Code
async function deleteDiscountCode(codeId, codeName) {
  if (!confirm(`Delete discount code "${codeName}"?\n\nThis action cannot be undone.`)) {
    return;
  }
  
  try {
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: 'DELETE',
        table: 'Discount Codes',
        recordId: codeId
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error?.message || 'Failed to delete discount code');
    }
    
    alert(`‚úÖ Discount code "${codeName}" deleted successfully!`);
    loadDiscountCodes();
    
  } catch (error) {
    console.error('Error deleting discount code:', error);
    alert('‚ùå Failed to delete discount code: ' + error.message);
  }
}

// ===== BLOCKED TIMES MANAGEMENT =====

let allBlockedTimes = [];

// Load Blocked Times
async function loadBlockedTimes() {
  const container = document.getElementById('blockedTimesContainer');
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

  try {
    const regionFilter = document.getElementById('blockRegionFilter')?.value || '';
    
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: 'GET',
        table: 'Blocked Times',
        filterFormula: regionFilter ? `{Region} = "${regionFilter}"` : null,
        sort: [{ field: 'Date', direction: 'asc' }]
      })
    });

    const data = await response.json();

    if (data.records) {
      allBlockedTimes = data.records;
      renderBlockedTimesTable(allBlockedTimes);
    }

  } catch (error) {
    console.error('Error loading blocked times:', error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading blocked times</div>';
  }
}

// Render Blocked Times Table
function renderBlockedTimesTable(blocks) {
  const container = document.getElementById('blockedTimesContainer');
  
  if (blocks.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üö´</div>
        <h3 style="color: #64748b; margin-bottom: 8px;">No Blocked Times</h3>
        <p style="color: #94a3b8;">Click "Block Time" to prevent bookings for specific dates and times</p>
      </div>
    `;
    return;
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const upcomingBlocks = blocks.filter(b => new Date(b.fields['Date']) >= today);
  const pastBlocks = blocks.filter(b => new Date(b.fields['Date']) < today);

  let html = '';

  if (upcomingBlocks.length > 0) {
    html += `
      <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 16px;">
        üìÖ Upcoming Blocks (${upcomingBlocks.length})
      </h3>
      <table class="data-table" style="margin-bottom: 32px;">
        <thead>
          <tr>
            <th>Region</th>
            <th>Date</th>
            <th>Time Blocked</th>
            <th>Reason</th>
            <th>Created By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;

    upcomingBlocks.forEach(block => {
      const fields = block.fields;
      const date = new Date(fields['Date']);
      const formattedDate = date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
      
      html += `
        <tr>
          <td data-label="Region">
            <span class="region-badge ${fields['Region'].toLowerCase()}">${fields['Region']}</span>
          </td>
          <td data-label="Date">${formattedDate}</td>
          <td data-label="Time Blocked">
            <strong>${fields['Start Time']} - ${fields['End Time']}</strong>
          </td>
          <td data-label="Reason">${fields['Reason'] || '-'}</td>
          <td data-label="Created By">${fields['Created By'] || 'Admin'}</td>
          <td data-label="Actions">
            <button class="btn btn-danger btn-small" onclick="deleteBlockedTime('${block.id}', '${fields['Date']}')">
              üóëÔ∏è Remove
            </button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
  }

  if (pastBlocks.length > 0) {
    html += `
      <details style="margin-top: 24px;">
        <summary style="font-size: 16px; font-weight: 700; color: #64748b; cursor: pointer; padding: 12px; background: #f8fafc; border-radius: 8px;">
          üìú Past Blocks (${pastBlocks.length})
        </summary>
        <table class="data-table" style="margin-top: 16px;">
          <thead>
            <tr>
              <th>Region</th>
              <th>Date</th>
              <th>Time Blocked</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody>
    `;

    pastBlocks.forEach(block => {
      const fields = block.fields;
      const date = new Date(fields['Date']);
      const formattedDate = date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
      
      html += `
        <tr style="opacity: 0.6;">
          <td data-label="Region">
            <span class="region-badge ${fields['Region'].toLowerCase()}">${fields['Region']}</span>
          </td>
          <td data-label="Date">${formattedDate}</td>
          <td data-label="Time Blocked">${fields['Start Time']} - ${fields['End Time']}</td>
          <td data-label="Reason">${fields['Reason'] || '-'}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </details>
    `;
  }

  container.innerHTML = html;
}

// Show Create Block Modal
function showCreateBlockModal() {
  document.getElementById('blockTimeForm').reset();
  document.getElementById('blockDate').min = new Date().toISOString().split('T')[0];
  document.getElementById('blockTimeModal').classList.add('active');
}

// Save Blocked Time
async function saveBlockedTime(event) {
  event.preventDefault();
  
  const region = document.getElementById('blockRegion').value;
  const date = document.getElementById('blockDate').value;
  const startTime = document.getElementById('blockStartTime').value;
  const endTime = document.getElementById('blockEndTime').value;
  const reason = document.getElementById('blockReason').value.trim();
  
  if (startTime >= endTime) {
    alert('‚ùå End time must be after start time');
    return;
  }
  
  if (!confirm(`Block ${region} region on ${date} from ${startTime} to ${endTime}?`)) {
    return;
  }
  
  try {
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: 'POST',
        table: 'Blocked Times',
        body: {
          fields: {
            'Region': region,
            'Date': date,
            'Start Time': startTime,
            'End Time': endTime,
            'Reason': reason || '',
            'Created By': 'Admin'
          }
        }
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to create blocked time');
    }
    
    alert(`‚úÖ Time blocked successfully!\n\n${region} - ${date}\n${startTime} to ${endTime}`);
    closeModal('blockTimeModal');
    loadBlockedTimes();
    
  } catch (error) {
    console.error('Error creating blocked time:', error);
    alert('‚ùå Failed to block time');
  }
}

// Delete Blocked Time
async function deleteBlockedTime(recordId, date) {
  if (!confirm(`Remove this time block for ${date}?`)) {
    return;
  }
  
  try {
    const response = await fetch('/.netlify/functions/airtable-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method: 'DELETE',
        table: 'Blocked Times',
        recordId: recordId
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error?.message || 'Failed to delete blocked time');
    }
    
    alert('‚úÖ Time block removed successfully!');
    loadBlockedTimes();
    
  } catch (error) {
    console.error('Error deleting blocked time:', error);
    alert('‚ùå Failed to remove time block: ' + error.message);
  }
}

// Initialize all Lucide icons
document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();
});

// Re-initialize icons after dynamic content changes
function reinitializeLucideIcons() {
  lucide.createIcons();
}

// ===== MARKET UPDATES FUNCTIONS =====

async function loadMarketUpdateStats() {
  try {
    const response = await fetch('/.netlify/functions/admin-users');
    const data = await response.json();

    if (data.success) {
      const optedIn = data.users.filter(u => u.fields['Market Updates Opt In'] === true);
      
      // ‚úÖ NORTH = Everything above Birmingham
      const northRegions = [
        // Your Core Service Regions (North)
        'Cheshire East', 
        'Cheshire West and Chester',
        'Greater Manchester', 
        'West Midlands', 
        'Leicestershire',
        
        // North West England
        'Cumbria',
        'Lancashire',
        'Merseyside',
        'Blackburn with Darwen',
        'Blackpool',
        'Halton',
        'Warrington',
        
        // North East England
        'County Durham',
        'Northumberland',
        'Tyne and Wear',
        
        // Yorkshire & Humber
        'South Yorkshire', 
        'West Yorkshire', 
        'North Yorkshire', 
        'East Riding of Yorkshire',
        'York',
        
        // Midlands (above Birmingham line)
        'Derbyshire',
        'Derby',
        'Lincolnshire',
        'Nottinghamshire',
        'Nottingham',
        'Rutland',
        'Shropshire',
        'Telford and Wrekin',
        'Staffordshire',
        'Stoke-on-Trent',
        
        // Scotland (all of it)
        'Aberdeen City',
        'Aberdeenshire',
        'Angus',
        'Argyll and Bute',
        'City of Edinburgh',
        'Clackmannanshire',
        'Dumfries and Galloway',
        'Dundee City',
        'East Ayrshire',
        'East Dunbartonshire',
        'East Lothian',
        'East Renfrewshire',
        'Falkirk',
        'Fife',
        'Glasgow City',
        'Highland',
        'Inverclyde',
        'Midlothian',
        'Moray',
        'North Ayrshire',
        'North Lanarkshire',
        'Orkney Islands',
        'Perth and Kinross',
        'Renfrewshire',
        'Scottish Borders',
        'Shetland Islands',
        'South Ayrshire',
        'South Lanarkshire',
        'Stirling',
        'West Dunbartonshire',
        'West Lothian',
        'Na h-Eileanan Siar',
        
        // North Wales
        'Isle of Anglesey',
        'Conwy',
        'Denbighshire',
        'Flintshire',
        'Gwynedd',
        'Wrexham'
      ];
      
      // ‚úÖ SOUTH = Everything below Birmingham
      const southRegions = [
        // Your Core Service Regions (South)
        'Greater London',
        'Essex',
        
        // Midlands (below Birmingham line)
        'Herefordshire',
        'Warwickshire',
        'Worcestershire',
        'Northamptonshire',
        
        // East England
        'Bedford',
        'Central Bedfordshire',
        'Cambridgeshire',
        'Peterborough',
        'Hertfordshire',
        'Norfolk',
        'Suffolk',
        
        // South East England
        'Berkshire',
        'Buckinghamshire',
        'East Sussex',
        'Brighton and Hove',
        'Hampshire',
        'Portsmouth',
        'Southampton',
        'Isle of Wight',
        'Kent',
        'Medway',
        'Oxfordshire',
        'Surrey',
        'West Sussex',
        
        // South West England
        'Bristol',
        'Cornwall',
        'Devon',
        'Plymouth',
        'Torbay',
        'Dorset',
        'Bournemouth, Christchurch and Poole',
        'Gloucestershire',
        'Somerset',
        'Bath and North East Somerset',
        'North Somerset',
        'South Gloucestershire',
        'Wiltshire',
        'Swindon',
        
        // South Wales
        'Blaenau Gwent',
        'Bridgend',
        'Caerphilly',
        'Cardiff',
        'Carmarthenshire',
        'Ceredigion',
        'Merthyr Tydfil',
        'Monmouthshire',
        'Neath Port Talbot',
        'Newport',
        'Pembrokeshire',
        'Powys',
        'Rhondda Cynon Taf',
        'Swansea',
        'Torfaen',
        'Vale of Glamorgan',
        
        // Northern Ireland (geographically south of Scotland)
        'Antrim and Newtownabbey',
        'Ards and North Down',
        'Armagh City, Banbridge and Craigavon',
        'Belfast',
        'Causeway Coast and Glens',
        'Derry City and Strabane',
        'Fermanagh and Omagh',
        'Lisburn and Castlereagh',
        'Mid and East Antrim',
        'Mid Ulster',
        'Newry, Mourne and Down'
      ];
      
      const northCount = optedIn.filter(u => northRegions.includes(u.fields['Region'])).length;
      const southCount = optedIn.filter(u => southRegions.includes(u.fields['Region'])).length;

      document.getElementById('totalOptedIn').textContent = optedIn.length;
      document.getElementById('northOptedIn').textContent = northCount;
      document.getElementById('southOptedIn').textContent = southCount;
    }

    document.getElementById('lastSentDate').textContent = 'Never';

  } catch (error) {
    console.error('Error loading market update stats:', error);
  }
}

function updateMarketRecipientCount() {
  const regionSelect = document.getElementById('marketUpdateRegion');
  const selectedRegions = Array.from(regionSelect.selectedOptions).map(opt => opt.value);
  const recipientDiv = document.getElementById('recipientCount');
  
  if (selectedRegions.length === 0) {
    recipientDiv.innerHTML = 'Select region(s) to see recipient count';
    return;
  }

  const optedIn = allCustomers.filter(u => 
    u.fields['Market Updates Opt In'] === true && 
    selectedRegions.includes(u.fields['Region'])
  );

  recipientDiv.innerHTML = `
    <span style="color: #10b981; font-weight: 600;">
      ‚úÖ Will send to ${optedIn.length} customer${optedIn.length !== 1 ? 's' : ''} across ${selectedRegions.length} region${selectedRegions.length !== 1 ? 's' : ''}
    </span>
    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
      Selected: ${selectedRegions.join(', ')}
    </div>
  `;
}

function resetMarketUpdateForm() {
  document.getElementById('marketUpdateForm').reset();
  document.getElementById('recipientCount').innerHTML = 'Select a region to see recipient count';
  document.getElementById('dataPreview').innerHTML = '';  // ‚úÖ ADD THIS LINE
  currentMarketData = null;  // ‚úÖ ADD THIS LINE
}

// Find this section and UPDATE it:
document.getElementById('marketUpdateForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const regionSelect = document.getElementById('marketUpdateRegion');
  const selectedRegions = Array.from(regionSelect.selectedOptions).map(opt => opt.value);
  const subject = document.getElementById('marketUpdateSubject').value;
  const content = document.getElementById('marketUpdateContent').value;
  const sendPreview = document.getElementById('marketUpdatePreview').checked;

  if (selectedRegions.length === 0) {
    alert('‚ùå Please select at least one region');
    return;
  }

  const recipients = allCustomers.filter(u => 
    u.fields['Market Updates Opt In'] === true && 
    selectedRegions.includes(u.fields['Region'])
  );

  if (recipients.length === 0) {
    alert('‚ùå No opted-in customers found in selected region(s)');
    return;
  }

  const regionsList = selectedRegions.join(', ');
  const confirmMsg = sendPreview 
    ? `Send test email to yourself first?` 
    : `Send market update to ${recipients.length} customer${recipients.length !== 1 ? 's' : ''} across:\n${regionsList}?\n\nThis cannot be undone.`;

  if (!confirm(confirmMsg)) {
    return;
  }

  const btn = e.target.querySelector('button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.innerHTML = '‚è≥ Sending...';
  btn.disabled = true;

  try {
    const response = await fetch('/.netlify/functions/send-market-updates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        region: regionsList,
        subject,
        content,
        sendPreview,
        recipients: recipients.map(r => ({
          email: r.fields['Email'],
          name: r.fields['Name']
        })),
        marketData: currentMarketData
      })
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úÖ Market update sent!\n\nSent to: ${data.sentCount} recipient${data.sentCount !== 1 ? 's' : ''}\nRegions: ${regionsList}`);
      resetMarketUpdateForm();
      loadMarketUpdateStats();
      currentMarketData = null;
    } else {
      alert(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Error sending market update:', error);
    alert('‚ùå Failed to send market update: ' + error.message);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
});

// Load stats when section is shown
const originalShowSection = showSection;
showSection = function(sectionId) {
  originalShowSection(sectionId);
  
  if (sectionId === 'market-updates') {
    loadMarketUpdateStats();
  }
};

// ===== AUTO-FETCH MARKET DATA =====

async function autoFetchMarketData() {
  const regionSelect = document.getElementById('marketUpdateRegion');
  const selectedRegions = Array.from(regionSelect.selectedOptions).map(opt => opt.value);
  
  if (selectedRegions.length === 0) {
    alert('‚ö†Ô∏è Please select at least one region first');
    document.getElementById('marketUpdateRegion').focus();
    return;
  }
  
  // Use first selected region for data fetching
  const primaryRegion = selectedRegions[0];
  
  const btn = document.getElementById('fetchDataBtn');
  const preview = document.getElementById('dataPreview');
  
  btn.disabled = true;
  btn.innerHTML = '‚è≥ Fetching market data...';
  preview.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner" style="width: 40px; height: 40px;"></div></div>';
  
  try {
    // Fetch market data from API using primary region
    const response = await fetch('/.netlify/functions/fetch-market-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ region: primaryRegion })
    });
    
    const result = await response.json();
    
    if (result.success) {
      const data = result.data;
      currentMarketData = data;
      
      // Auto-fill subject - show all selected regions
      const month = new Date(data.currentMonth).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
      const regionText = selectedRegions.length === 1 
        ? selectedRegions[0] 
        : `${selectedRegions.length} Regions`;
      document.getElementById('marketUpdateSubject').value = `${regionText} Property Market Update - ${month}`;
      
      // Generate content with data
      const content = generateMarketUpdateContent(data, selectedRegions);
      document.getElementById('marketUpdateContent').value = content;
      
      // Show preview with charts
      preview.innerHTML = `
        <div class="success-box">
          <strong>‚úÖ Market data fetched for ${primaryRegion}!</strong>
          ${selectedRegions.length > 1 ? `<div style="font-size: 12px; margin-top: 4px;">Data will be sent to ${selectedRegions.length} regions: ${selectedRegions.join(', ')}</div>` : ''}
          
          <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">¬£${data.averagePrice.toLocaleString()}</div>
              <div style="font-size: 12px; color: #64748b;">Average Price</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: ${data.annualChange > 0 ? '#10b981' : '#ef4444'};">
                ${data.annualChange > 0 ? '+' : ''}${data.annualChange.toFixed(1)}%
              </div>
              <div style="font-size: 12px; color: #64748b;">Annual Change</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">${data.salesVolume.toLocaleString()}</div>
              <div style="font-size: 12px; color: #64748b;">Sales Volume</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">
                ${data.marketHealth.emoji} ${data.marketHealth.score}/100
              </div>
              <div style="font-size: 12px; color: #64748b;">Market Health</div>
            </div>
          </div>
          
          <div style="margin-top: 16px; padding: 12px; background: #eff6ff; border-radius: 8px; font-size: 13px;">
            <strong>Market Status:</strong> ${data.marketHealth.status}<br>
            <strong>Data Source:</strong> UK House Price Index (HM Land Registry)<br>
            <strong>Period:</strong> Last 12 months
          </div>
        </div>
      `;
      
    } else {
      throw new Error(result.error || 'Failed to fetch market data');
    }
    
  } catch (error) {
    console.error('Error fetching market data:', error);
    preview.innerHTML = `
      <div class="warning-box">
        ‚ùå <strong>Failed to fetch market data</strong><br>
        ${error.message}<br><br>
        You can still compose the email manually.
      </div>
    `;
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'üìä Auto-Fetch Market Data & Generate Content';
  }
}

function generateMarketUpdateContent(data, selectedRegions) {
  const month = new Date(data.currentMonth).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
  const priceChange = data.annualChange > 0 ? 'up' : 'down';
  const priceIcon = data.annualChange > 0 ? 'üìà' : 'üìâ';
  
  // Handle single vs multiple regions
  const regionText = selectedRegions.length === 1 
    ? selectedRegions[0] 
    : selectedRegions.join(' & ');
  const regionPossessive = selectedRegions.length === 1 ? `${selectedRegions[0]}'s` : 'these';
  
  return `Hey [Name],

Here's what's happening in the ${regionText} property market${selectedRegions.length > 1 ? 's' : ''} for ${month}:

üìä KEY STATS (${data.region})
- Average sale price: ¬£${data.averagePrice.toLocaleString()} (${priceIcon} ${Math.abs(data.annualChange).toFixed(1)}% vs last year)
- Transaction volume: ${data.salesVolume.toLocaleString()} properties
- Monthly change: ${data.monthlyChange > 0 ? '+' : ''}${data.monthlyChange.toFixed(1)}%
- Market health: ${data.marketHealth.status} (${data.marketHealth.score}/100)

üéØ WHAT THIS MEANS FOR YOU
${data.annualChange > 0 
  ? `With prices ${priceChange} ${Math.abs(data.annualChange).toFixed(1)}% year-on-year, this is a strong seller's market. Properties are moving quickly, and quality presentation is more important than ever.`
  : `The market is adjusting with a ${Math.abs(data.annualChange).toFixed(1)}% annual decrease. In this climate, exceptional photography and videography can be the difference between a quick sale and a listing that sits.`
}

üí° VALUATION INSIGHT
${data.salesVolume > 5000 
  ? 'High transaction volume indicates strong buyer activity. Properties with professional media are commanding premium prices.'
  : 'With fewer transactions, standing out is critical. Professional content can help your listings capture the limited buyer pool.'
}

üì∏ How Markeb Media Can Help
In ${data.marketHealth.status.toLowerCase()} markets like this, professional property content isn't optional‚Äîit's essential. Our team is ready to make your listings shine across ${regionPossessive} region${selectedRegions.length > 1 ? 's' : ''}.

Best regards,
Markeb Media Team`;
}

// ===== EMAIL BROADCAST FUNCTIONS =====

let allBroadcastUsers = [];
let selectedRecipients = [];
let broadcastHistory = [];

// Map UK regions to North/South for booking system
function mapRegionToBookingRegion(ukRegion) {
  if (!ukRegion) return null;
  
  // NORTH = Everything above Birmingham
  const northRegions = [
    // Your Core Service Regions (North)
    'Cheshire East', 
    'Cheshire West and Chester',
    'Greater Manchester', 
    'West Midlands', 
    'Leicestershire',
    
    // North West England
    'Cumbria',
    'Lancashire',
    'Merseyside',
    'Blackburn with Darwen',
    'Blackpool',
    'Halton',
    'Warrington',
    
    // North East England
    'County Durham',
    'Northumberland',
    'Tyne and Wear',
    
    // Yorkshire & Humber
    'South Yorkshire', 
    'West Yorkshire', 
    'North Yorkshire', 
    'East Riding of Yorkshire',
    'York',
    
    // Midlands (above Birmingham line)
    'Derbyshire',
    'Derby',
    'Lincolnshire',
    'Nottinghamshire',
    'Nottingham',
    'Rutland',
    'Shropshire',
    'Telford and Wrekin',
    'Staffordshire',
    'Stoke-on-Trent',
    
    // Scotland (all of it)
    'Aberdeen City',
    'Aberdeenshire',
    'Angus',
    'Argyll and Bute',
    'City of Edinburgh',
    'Clackmannanshire',
    'Dumfries and Galloway',
    'Dundee City',
    'East Ayrshire',
    'East Dunbartonshire',
    'East Lothian',
    'East Renfrewshire',
    'Falkirk',
    'Fife',
    'Glasgow City',
    'Highland',
    'Inverclyde',
    'Midlothian',
    'Moray',
    'North Ayrshire',
    'North Lanarkshire',
    'Orkney Islands',
    'Perth and Kinross',
    'Renfrewshire',
    'Scottish Borders',
    'Shetland Islands',
    'South Ayrshire',
    'South Lanarkshire',
    'Stirling',
    'West Dunbartonshire',
    'West Lothian',
    'Na h-Eileanan Siar',
    
    // North Wales
    'Isle of Anglesey',
    'Conwy',
    'Denbighshire',
    'Flintshire',
    'Gwynedd',
    'Wrexham'
  ];
  
  // SOUTH = Everything below Birmingham
  const southRegions = [
    // Your Core Service Regions (South)
    'Greater London',
    'Essex',
    
    // Midlands (below Birmingham line)
    'Herefordshire',
    'Warwickshire',
    'Worcestershire',
    'Northamptonshire',
    
    // East England
    'Bedford',
    'Central Bedfordshire',
    'Cambridgeshire',
    'Peterborough',
    'Hertfordshire',
    'Norfolk',
    'Suffolk',
    
    // South East England
    'Berkshire',
    'Buckinghamshire',
    'East Sussex',
    'Brighton and Hove',
    'Hampshire',
    'Portsmouth',
    'Southampton',
    'Isle of Wight',
    'Kent',
    'Medway',
    'Oxfordshire',
    'Surrey',
    'West Sussex',
    
    // South West England
    'Bristol',
    'Cornwall',
    'Devon',
    'Plymouth',
    'Torbay',
    'Dorset',
    'Bournemouth, Christchurch and Poole',
    'Gloucestershire',
    'Somerset',
    'Bath and North East Somerset',
    'North Somerset',
    'South Gloucestershire',
    'Wiltshire',
    'Swindon',
    
    // South Wales
    'Blaenau Gwent',
    'Bridgend',
    'Caerphilly',
    'Cardiff',
    'Carmarthenshire',
    'Ceredigion',
    'Merthyr Tydfil',
    'Monmouthshire',
    'Neath Port Talbot',
    'Newport',
    'Pembrokeshire',
    'Powys',
    'Rhondda Cynon Taf',
    'Swansea',
    'Torfaen',
    'Vale of Glamorgan',
    
    // Northern Ireland (geographically south of Scotland)
    'Antrim and Newtownabbey',
    'Ards and North Down',
    'Armagh City, Banbridge and Craigavon',
    'Belfast',
    'Causeway Coast and Glens',
    'Derry City and Strabane',
    'Fermanagh and Omagh',
    'Lisburn and Castlereagh',
    'Mid and East Antrim',
    'Mid Ulster',
    'Newry, Mourne and Down'
  ];
  
  // Check which region it belongs to
  if (northRegions.includes(ukRegion)) {
    return 'North';
  } else if (southRegions.includes(ukRegion)) {
    return 'South';
  }
  
  // If not found in either list, return null
  return null;
}

// Load broadcast data on section show
async function loadBroadcastData() {
  try {
    const response = await fetch('/.netlify/functions/admin-users');
    const data = await response.json();
    
    if (data.success) {
      allBroadcastUsers = data.users;
      
      // Update stats
      document.getElementById('broadcastTotalUsers').textContent = data.total;
      
      // Load history from localStorage
      broadcastHistory = JSON.parse(localStorage.getItem('broadcastHistory') || '[]');
      const totalSent = broadcastHistory.reduce((sum, h) => sum + h.recipientCount, 0);
      document.getElementById('broadcastTotalSent').textContent = totalSent;
      
      const lastSent = broadcastHistory.length > 0 
        ? new Date(broadcastHistory[0].timestamp).toLocaleDateString('en-GB')
        : 'Never';
      document.getElementById('broadcastLastSent').textContent = lastSent;
      
      // Render recipient list
      renderBroadcastRecipients();
      renderBroadcastHistory();
    }
  } catch (error) {
    console.error('Error loading broadcast data:', error);
  }
}

// Render recipient checkboxes
function renderBroadcastRecipients(filtered = null) {
  const container = document.getElementById('broadcastRecipientList');
  const users = filtered || allBroadcastUsers;
  
  if (users.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #94a3b8;">
        <p>No users found</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  users.forEach(user => {
    const fields = user.fields;
    const isActive = fields['Account Status'] === 'Active';
    const hasEmail = fields['Email Notifications Enabled'] === true;
    const isSelected = selectedRecipients.includes(fields['Email']);
    
    html += `
      <div class="recipient-checkbox-item">
        <input 
          type="checkbox" 
          value="${fields['Email']}"
          ${isSelected ? 'checked' : ''}
          onchange="toggleRecipient('${fields['Email']}')"
          id="recipient-${user.id}"
        >
        <label for="recipient-${user.id}" class="recipient-info">
          <div class="recipient-name">${fields['Name']}</div>
          <div class="recipient-details">
            ${fields['Company'] || 'No company'} ‚Ä¢ ${fields['Email']}
          </div>
        </label>
        <div>
          <span class="recipient-badge ${isActive ? 'badge-active' : 'badge-inactive'}">
            ${isActive ? 'Active' : 'Inactive'}
          </span>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  updateSelectedCount();
  
  // Re-initialize Lucide icons
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
}

// Toggle recipient selection
function toggleRecipient(email) {
  const index = selectedRecipients.indexOf(email);
  if (index > -1) {
    selectedRecipients.splice(index, 1);
  } else {
    selectedRecipients.push(email);
  }
  updateSelectedCount();
}

// Select all recipients
function selectAllBroadcastRecipients() {
  selectedRecipients = allBroadcastUsers.map(u => u.fields['Email']);
  renderBroadcastRecipients();
}

// Deselect all recipients
function deselectAllBroadcastRecipients() {
  selectedRecipients = [];
  renderBroadcastRecipients();
}

// Filter recipients
function filterBroadcastRecipients() {
  const search = document.getElementById('broadcastRecipientSearch').value.toLowerCase();
  const filter = document.getElementById('broadcastRecipientFilter').value;
  
  let filtered = allBroadcastUsers;
  
  // Apply status filter
  if (filter === 'active') {
    filtered = filtered.filter(u => u.fields['Account Status'] === 'Active');
  } else if (filter === 'email-enabled') {
    filtered = filtered.filter(u => u.fields['Email Notifications Enabled'] === true);
  }
  
  // Apply search filter
  if (search) {
    filtered = filtered.filter(u => {
      const name = (u.fields['Name'] || '').toLowerCase();
      const email = (u.fields['Email'] || '').toLowerCase();
      const company = (u.fields['Company'] || '').toLowerCase();
      return name.includes(search) || email.includes(search) || company.includes(search);
    });
  }
  
  renderBroadcastRecipients(filtered);
}

// Update selected count
function updateSelectedCount() {
  const count = selectedRecipients.length;
  document.getElementById('broadcastSelected').textContent = count;
  document.getElementById('sendBroadcastCount').textContent = count;
  
  // Enable/disable send button
  const sendBtn = document.getElementById('sendBroadcastBtn');
  if (sendBtn) {
    sendBtn.disabled = count === 0;
  }
}

// Load broadcast template
function loadBroadcastTemplate(templateId) {
  const subjectInput = document.getElementById('broadcastSubject');
  const contentInput = document.getElementById('broadcastContent');
  const composer = document.getElementById('broadcastComposer');
  
  let subject = '';
  let content = '';
  
  switch(templateId) {
   case 'availability':
  subject = 'Available Shoot Dates - Book Your Slot';
  
  composer.style.display = 'block';
  contentInput.value = 'Loading availability data...';
  
  if (selectedRecipients.length > 0) {
    const firstRecipient = allBroadcastUsers.find(u => u.fields['Email'] === selectedRecipients[0]);
    
    if (firstRecipient) {
      const userUKRegion = firstRecipient.fields['Region'];
      const userRegion = mapRegionToBookingRegion(userUKRegion);
      
      if (!userRegion) {
        content = `Hi [Name],

We'd love to show you our availability, but we need your region set up first.

Please update your profile with your region, then check back!

<strong><a href="https://markebmedia.com/website/dashboard.html">Update Your Profile</a></strong>

Best regards,
Markeb Media Team`;
        
        contentInput.value = content;
        updateBroadcastPreview();
        break;
      }
      
      const userPostcode = firstRecipient.fields['Postcode'] || 'M1 1AA';
      
      // ‚úÖ FIXED: Generate next 7 WEEKDAYS (skip weekends)
      const availabilityPromises = [];
      let daysChecked = 0;
      let dayOffset = 1;
      
      while (daysChecked < 7 && dayOffset <= 14) {  // Check up to 14 days to find 7 weekdays
        const checkDate = new Date();
        checkDate.setDate(checkDate.getDate() + dayOffset);
        
        // ‚úÖ Skip weekends (Sunday=0, Saturday=6)
        const dayOfWeek = checkDate.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
          const dateStr = checkDate.toISOString().split('T')[0];
          
          availabilityPromises.push(
            fetch('/.netlify/functions/check-availability', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                postcode: userPostcode,
                region: userRegion,
                selectedDate: dateStr,
                duration: 90
              })
            })
            .then(res => res.json())
            .then(data => ({
              date: dateStr,
              slots: data.availableSlots ? data.availableSlots.filter(s => s.available) : []
            }))
          );
          
          daysChecked++;
        }
        
        dayOffset++;
      }
      
      Promise.all(availabilityPromises).then(results => {
        const daysWithAvailability = results.filter(r => r.slots.length > 0);
        
        if (daysWithAvailability.length === 0) {
          content = `Hi [Name],

Unfortunately, we're fully booked in your region (${userUKRegion}) for the next week.

However, availability changes frequently as clients reschedule, so please check back or contact us directly:

<strong><a href="https://markebmedia.com/website/dashboard.html">Check Live Availability</a></strong>

Best regards,
Markeb Media Team`;
        } else {
          let availabilityHTML = '';
          daysWithAvailability.slice(0, 5).forEach(day => {
            const date = new Date(day.date);
            const dayName = date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short' });
            const times = day.slots.slice(0, 5).map(s => s.time).join(', ');
            
            availabilityHTML += `<strong>${dayName}:</strong> ${times}<br>\n`;
          });
          
          content = `Hi [Name],

Great news! We have availability in ${userUKRegion} this week:

‚úÖ <strong>AVAILABLE TIME SLOTS:</strong>

${availabilityHTML}
<strong>Why book now?</strong>
- Peak season approaching - slots filling fast
- Professional content = faster sales
- Premium presentation = premium prices

Ready to showcase your next property?

<strong><a href="https://markebmedia.com/website/dashboard.html">Book Your Shoot Now</a></strong>

Best regards,
Markeb Media Team`;
        }
        
        contentInput.value = content;
        updateBroadcastPreview();
      }).catch(error => {
        console.error('Error fetching availability:', error);
        content = fallbackAvailabilityContent;
        contentInput.value = content;
        updateBroadcastPreview();
      });
    }
  }
  break;
  }
  
  subjectInput.value = subject;
  contentInput.value = content;
  composer.style.display = 'block';
  
  updateBroadcastPreview();
  
  // Re-initialize Lucide icons
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
}

// Update preview with merge tags replaced
function updateBroadcastPreview() {
  const subject = document.getElementById('broadcastSubject').value;
  const content = document.getElementById('broadcastContent').value;
  const preview = document.getElementById('broadcastPreview');
  
  if (!subject && !content) {
    preview.innerHTML = '<div style="text-align: center; color: #94a3b8;">Select a template or enter content to preview</div>';
    return;
  }
  
  // Get first selected recipient for preview
  let previewData = {
    name: 'John Smith',
    company: 'Example Estate Agents',
    email: 'john@example.com'
  };
  
  if (selectedRecipients.length > 0) {
    const firstRecipient = allBroadcastUsers.find(u => u.fields['Email'] === selectedRecipients[0]);
    if (firstRecipient) {
      previewData = {
        name: firstRecipient.fields['Name'],
        company: firstRecipient.fields['Company'] || 'No company',
        email: firstRecipient.fields['Email']
      };
    }
  }
  
  // Replace merge tags
  let previewSubject = subject
    .replace(/\[Name\]/g, previewData.name)
    .replace(/\[Company\]/g, previewData.company)
    .replace(/\[Email\]/g, previewData.email);
    
  let previewContent = content
    .replace(/\[Name\]/g, previewData.name)
    .replace(/\[Company\]/g, previewData.company)
    .replace(/\[Email\]/g, previewData.email);
  
  preview.innerHTML = `
    <div style="border-bottom: 2px solid #e2e8f0; padding-bottom: 12px; margin-bottom: 16px;">
      <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">SUBJECT:</div>
      <div style="font-weight: 700; font-size: 16px;">${previewSubject}</div>
    </div>
    <div style="font-size: 14px; line-height: 1.6; white-space: pre-wrap;">${previewContent}</div>
    <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e2e8f0; font-size: 12px; color: #64748b;">
      Preview using: ${previewData.name} (${previewData.email})
    </div>
  `;
}

// Send test broadcast
async function sendTestBroadcast() {
  const subject = document.getElementById('broadcastSubject').value;
  const content = document.getElementById('broadcastContent').value;
  
  if (!subject || !content) {
    alert('‚ö†Ô∏è Please enter subject and content first');
    return;
  }
  
  if (!confirm('Send test email to commercial@markebmedia.com?')) {
    return;
  }
  
  try {
    const response = await fetch('/.netlify/functions/send-broadcast-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recipients: [{
          email: 'commercial@markebmedia.com',
          name: 'Test User',
          company: 'Test Company'
        }],
        subject: '[TEST] ' + subject,
        content: content,
        templateType: 'custom',
        testMode: true
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('‚úÖ Test email sent to commercial@markebmedia.com!');
    } else {
      alert('‚ùå Failed to send test: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error sending test:', error);
    alert('‚ùå Error sending test email');
  }
}

// Send broadcast email
async function sendBroadcastEmail() {
  const subject = document.getElementById('broadcastSubject').value;
  const content = document.getElementById('broadcastContent').value;
  
  if (!subject || !content) {
    alert('‚ö†Ô∏è Please enter subject and content');
    return;
  }
  
  if (selectedRecipients.length === 0) {
    alert('‚ö†Ô∏è Please select at least one recipient');
    return;
  }
  
  if (!confirm(`Send email to ${selectedRecipients.length} recipient${selectedRecipients.length !== 1 ? 's' : ''}?\n\nThis cannot be undone.`)) {
    return;
  }
  
  const btn = document.getElementById('sendBroadcastBtn');
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '‚è≥ Sending...';
  
  try {
    // Build recipients array with full data
    const recipients = selectedRecipients.map(email => {
      const user = allBroadcastUsers.find(u => u.fields['Email'] === email);
      return {
        email: email,
        name: user?.fields['Name'] || 'Client',
        company: user?.fields['Company'] || ''
      };
    });
    
    const response = await fetch('/.netlify/functions/send-broadcast-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recipients: recipients,
        subject: subject,
        content: content,
        templateType: 'custom',
        testMode: false
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert(`‚úÖ Broadcast sent successfully!\n\nSent: ${data.successCount}\nFailed: ${data.failureCount}`);
      
      // Save to history
      saveBroadcastHistory(subject, selectedRecipients.length);
      
      // Clear form
      clearBroadcastForm();
      loadBroadcastData();
    } else {
      alert('‚ùå Failed to send broadcast: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error sending broadcast:', error);
    alert('‚ùå Error sending broadcast');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}

// Save broadcast to history
function saveBroadcastHistory(subject, recipientCount) {
  const history = JSON.parse(localStorage.getItem('broadcastHistory') || '[]');
  
  history.unshift({
    subject: subject,
    recipientCount: recipientCount,
    timestamp: new Date().toISOString()
  });
  
  // Keep only last 20
  if (history.length > 20) {
    history.pop();
  }
  
  localStorage.setItem('broadcastHistory', JSON.stringify(history));
  broadcastHistory = history;
  
  renderBroadcastHistory();
}

// Render broadcast history
function renderBroadcastHistory() {
  const container = document.getElementById('broadcastHistoryContainer');
  const history = JSON.parse(localStorage.getItem('broadcastHistory') || '[]');
  
  if (history.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #94a3b8;">
        <i data-lucide="clock" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
        <p>No broadcasts sent yet</p>
      </div>
    `;
    
    // Re-initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    return;
  }
  
  let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
  
  history.forEach((item, index) => {
    const date = new Date(item.timestamp);
    const formattedDate = date.toLocaleDateString('en-GB', { 
      day: 'numeric', 
      month: 'short', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    html += `
      <div style="padding: 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
          <div style="font-weight: 600; color: #1e293b; flex: 1;">${item.subject}</div>
          <div style="font-size: 12px; color: #64748b; white-space: nowrap; margin-left: 12px;">${formattedDate}</div>
        </div>
        <div style="font-size: 13px; color: #64748b;">
          Sent to ${item.recipientCount} recipient${item.recipientCount !== 1 ? 's' : ''}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// Clear broadcast history
function clearBroadcastHistory() {
  if (!confirm('Clear all broadcast history?\n\nThis cannot be undone.')) {
    return;
  }
  
  localStorage.removeItem('broadcastHistory');
  broadcastHistory = [];
  document.getElementById('broadcastTotalSent').textContent = '0';
  document.getElementById('broadcastLastSent').textContent = 'Never';
  renderBroadcastHistory();
}

// Clear broadcast form
function clearBroadcastForm() {
  document.getElementById('broadcastSubject').value = '';
  document.getElementById('broadcastContent').value = '';
  document.getElementById('broadcastComposer').style.display = 'none';
  document.getElementById('broadcastPreview').innerHTML = '<div style="text-align: center; color: #94a3b8;">Select a template or enter content to preview</div>';
  selectedRecipients = [];
  renderBroadcastRecipients();
}

// Update showSection to load broadcast data
const originalShowSectionBroadcast = showSection;
showSection = function(sectionId) {
  originalShowSectionBroadcast(sectionId);
  
  if (sectionId === 'email-broadcast') {
    loadBroadcastData();
  }
  
  if (sectionId === 'market-updates') {
    loadMarketUpdateStats();
  }
};

  </script>
</body>
</html>