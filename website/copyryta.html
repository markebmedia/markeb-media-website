<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CopyRyta - AI Copywriting Assistant for Estate Agents</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            color: #1F2E3C;
            line-height: 1.6;
            padding-top: 100px;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 107, 0, 0.1);
            color: #FF6B00;
            border: 2px solid #FF6B00;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 10000;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .back-btn:hover { background: #FF6B00; color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 107, 0, 0.3); }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
            background: linear-gradient(135deg, #FF6B00 0%, #FF8533 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(255, 107, 0, 0.2);
        }
        .header h1 { font-size: 3em; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header p { font-size: 1.2em; opacity: 0.9; font-weight: 500; }

        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .input-section, .output-section { background: #f8f9fa; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; transition: all 0.3s ease; }
        .input-section:hover, .output-section:hover { border-color: #FF6B00; transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

        .section-title { font-size: 1.5em; margin-bottom: 20px; color: #1F2E3C; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; width: 4px; height: 25px; background: #FF6B00; border-radius: 2px; }

        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #1F2E3C; }
        .form-group select, .form-group textarea, .form-group input { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; font-family: inherit; color: #1F2E3C; }
        .form-group select:focus, .form-group textarea:focus, .form-group input:focus { outline: none; border-color: #FF6B00; box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1); }
        .form-group textarea { resize: vertical; min-height: 120px; }
        .form-group input[type="number"] { width: 48%; display: inline-block; margin-right: 4%; }
        .form-group input[type="number"]:last-child { margin-right: 0; }

        .property-status-group { background: white; padding: 20px; border-radius: 12px; border: 2px solid #e1e5e9; margin-bottom: 25px; transition: all 0.3s ease; }
        .property-status-group:hover { border-color: #FF6B00; }
        .status-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .status-option { display: flex; align-items: center; gap: 12px; padding: 15px 20px; background: #f8f9fa; border: 2px solid #e1e5e9; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .status-option:hover { border-color: #FF6B00; background: rgba(255, 107, 0, 0.05); }
        .status-option input[type="radio"] { width: 20px; height: 20px; accent-color: #FF6B00; margin: 0; }
        .status-option.selected { border-color: #FF6B00; background: rgba(255, 107, 0, 0.1); }
        .status-label { font-weight: 600; color: #1F2E3C; flex: 1; }
        .status-description { font-size: 14px; color: #666; margin-top: 5px; }

        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input[type="checkbox"] { width: auto; accent-color: #FF6B00; }

        .generate-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #FF6B00 0%, #FF8533 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 15px rgba(255, 107, 0, 0.3); }
        .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 0, 0.4); }
        .generate-btn:active { transform: translateY(0); }
        .generate-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        .output-area { background: white; border: 2px solid #e1e5e9; border-radius: 10px; padding: 20px; min-height: 300px; font-size: 16px; line-height: 1.7; transition: all 0.3s ease; color: #1F2E3C; }
        .output-area:focus { outline: none; border-color: #FF6B00; box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1); }

        .action-buttons { display: flex; gap: 15px; margin-top: 15px; }
        .copy-btn, .edit-btn { flex: 1; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; border: none; }
        .copy-btn { background: #1F2E3C; color: white; }
        .copy-btn:hover { background: #2a3d4f; transform: translateY(-1px); }
        .edit-btn { background: transparent; color: #FF6B00; border: 2px solid #FF6B00; }
        .edit-btn:hover { background: #FF6B00; color: white; }

        .loading { display: none; text-align: center; padding: 40px; color: #FF6B00; }
        .loading-text { font-size: 18px; margin-bottom: 10px; }
        .loading-subtext { font-size: 14px; color: #1F2E3C; opacity: 0.8; }
        .loading::after { content: ''; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #FF6B00; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; margin-top: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 40px; }
        .feature-card { background: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; transition: all 0.3s ease; }
        .feature-card:hover { border-color: #FF6B00; transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .feature-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #FF6B00 0%, #FF8533 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; color: white; }
        .feature-card h3 { color: #1F2E3C; margin-bottom: 10px; }
        .feature-card p { color: #1F2E3C; }

        /* Photo Upload Styles */
        .photo-section { margin-top: 30px; padding-top: 25px; border-top: 1px solid rgba(31,46,60,0.15); }
        .photo-title { font-size: 1.1em; font-weight: 600; color: #1F2E3C; margin-bottom: 10px; display: flex; align-items: center; }
        .photo-optional { color: #666; font-weight: 400; font-size: 0.9em; margin-left: 8px; }
        .photo-help { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
        .photo-upload-area { position: relative; margin-bottom: 20px; }
        .photo-input { position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none; }
        .photo-upload-btn { width: 100%; min-height: 120px; border: 2px dashed rgba(31,46,60,0.3); border-radius: 10px; background: #fff; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 20px; position: relative; overflow: hidden; }
        .photo-upload-btn:hover { border-color: #FF6B00; background: rgba(255,107,0,0.02); }
        .photo-upload-btn.drag-over { border-color: #FF6B00; background: rgba(255,107,0,0.1); transform: scale(1.02); }
        .photo-icon { font-size: 2.5em; color: #FF6B00; margin-bottom: 15px; }
        .photo-text { font-size: 16px; font-weight: 600; color: #1F2E3C; margin-bottom: 5px; }
        .photo-subtext { font-size: 14px; color: #666; }
        .photo-preview { margin-top: 20px; }
        .photo-preview-title { font-size: 16px; font-weight: 600; color: #1F2E3C; margin-bottom: 15px; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .photo-item { position: relative; background: #fff; border: 1px solid rgba(31,46,60,0.15); border-radius: 10px; overflow: hidden; transition: all 0.2s ease; }
        .photo-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .photo-img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .photo-info { padding: 12px; font-size: 12px; }
        .photo-name { font-weight: 500; color: #1F2E3C; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .photo-size { color: #666; }
        .photo-remove { position: absolute; top: 8px; right: 8px; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; opacity: 0.8; }
        .photo-remove:hover { opacity: 1; transform: scale(1.1); }
        .photo-limit-notice { background: rgba(255,107,0,0.1); border: 1px solid rgba(255,107,0,0.3); color: #d63384; padding: 12px; border-radius: 8px; font-size: 14px; margin-top: 15px; text-align: center; }
        .photo-enhancement-notice { background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3); color: #155724; padding: 12px; border-radius: 8px; font-size: 14px; margin-top: 15px; display: none; }

        /* Address Autocomplete Styles */
        .address-container { position: relative; }
        .address-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0; right: 0;
            background: #fff;
            border: 2px solid rgba(31,46,60,0.15);
            border-radius: 10px;
            max-height: 260px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }
        .address-option { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid rgba(31,46,60,0.06); font-size: 14px; }
        .address-option:last-child { border-bottom: none; }
        .address-option:hover { background: rgba(255,107,0,0.06); }
        .address-loading { padding: 14px; text-align: center; font-style: italic; color: #1F2E3C; opacity: 0.75; }

        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; gap: 20px; }
            .header { padding: 30px 20px; margin-bottom: 30px; }
            .header h1 { font-size: 2.2em; }
            .header p { font-size: 1.1em; line-height: 1.5; }
            .features { grid-template-columns: 1fr; }
            .back-btn { position: fixed; top: 10px; left: 10px; padding: 10px 15px; font-size: 14px; }
            .form-group input[type="number"] { width: 100%; margin-right: 0; margin-bottom: 10px; }
            .action-buttons { flex-direction: column; }
            .status-options { grid-template-columns: 1fr; }
            .input-section, .output-section { padding: 20px; }
            .checkbox-group { grid-template-columns: 1fr; }
            body { padding-top: 80px; padding-left: 10px; padding-right: 10px; }
            .container { padding: 10px; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 1.8em; }
            .header p { font-size: 1em; }
            .back-btn { font-size: 12px; padding: 8px 12px; }
            .generate-btn { font-size: 16px; padding: 16px; }
            .input-section, .output-section { padding: 15px; }
        }
    </style>
</head>
<body>
    <a href="dashboard.html" class="back-btn">← Back to Dashboard</a>

    <div class="container">
        <div class="header">
            <h1>CopyRyta</h1>
            <p>Your AI copywriting assistant for property descriptions and video scripts written in seconds.</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">Property Details</h2>

                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <select id="contentType">
                        <option value="property-description">Property Description</option>
                        <option value="video-script">Video Script</option>
                        <option value="social-media-post">Social Media Post</option>
                        <option value="email-marketing">Email Marketing</option>
                        <option value="brochure-copy">Brochure Copy</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Property Status</label>
                    <div class="property-status-group">
                        <div class="status-options">
                            <label class="status-option selected" for="sale">
                                <input type="radio" name="propertyStatus" id="sale" value="sale" checked />
                                <div>
                                    <div class="status-label">For Sale</div>
                                    <div class="status-description">Property available for purchase</div>
                                </div>
                            </label>
                            <label class="status-option" for="rental">
                                <input type="radio" name="propertyStatus" id="rental" value="rental" />
                                <div>
                                    <div class="status-label">To Let</div>
                                    <div class="status-description">Property available for rental</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="propertyType">Property Type</label>
                    <select id="propertyType">
                        <option value="house">House</option>
                        <option value="flat">Flat/Apartment</option>
                        <option value="bungalow">Bungalow</option>
                        <option value="cottage">Cottage</option>
                        <option value="townhouse">Townhouse</option>
                        <option value="detached">Detached House</option>
                        <option value="semi-detached">Semi-Detached House</option>
                        <option value="terraced">Terraced House</option>
                        <option value="commercial">Commercial Property</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bedrooms">Bedrooms</label>
                    <input type="number" id="bedrooms" min="0" max="20" placeholder="Number of bedrooms" />
                    <label for="bathrooms">Bathrooms</label>
                    <input type="number" id="bathrooms" min="0" max="10" placeholder="Number of bathrooms" />
                </div>

                <div class="form-group address-container">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="e.g. 10 Downing Street, SW1A or Manchester City Centre" autocomplete="off" />
                    <div id="addressDropdown" class="address-dropdown"></div>
                </div>

                <div class="form-group">
                    <label for="price">Price</label>
                    <input type="text" id="price" placeholder="e.g. £450,000 or £1,200 pcm" />
                </div>

                <div class="form-group">
                    <label for="tone">Writing Tone</label>
                    <select id="tone">
                        <option value="professional">Professional</option>
                        <option value="luxury">Luxury/Premium</option>
                        <option value="family-friendly">Family-Friendly</option>
                        <option value="modern">Modern & Contemporary</option>
                        <option value="cozy">Cozy & Welcoming</option>
                        <option value="investment">Investment Focused</option>
                        <option value="first-time-buyer">First-Time Buyer Friendly</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Key Features (Select all that apply)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" id="garden" value="garden" /><label for="garden">Garden</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="parking" value="parking" /><label for="parking">Parking</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="garage" value="garage" /><label for="garage">Garage</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="ensuite" value="ensuite" /><label for="ensuite">En-suite</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="balcony" value="balcony" /><label for="balcony">Balcony/Terrace</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="fireplace" value="fireplace" /><label for="fireplace">Fireplace</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="newbuild" value="newbuild" /><label for="newbuild">New Build</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="period" value="period" /><label for="period">Period Features</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="transport" value="transport" /><label for="transport">Good Transport Links</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="schools" value="schools" /><label for="schools">Near Good Schools</label></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="additionalInfo">Additional Details</label>
                    <textarea id="additionalInfo" placeholder="Any special features, recent renovations, local amenities, or unique selling points..."></textarea>
                </div>

                <!-- Photo Upload Section -->
                <div class="photo-section">
                    <h3 class="photo-title">Property Photos<span class="photo-optional">(Optional)</span></h3>
                    <p class="photo-help">
                        Upload photos of key property features to create more detailed and accurate descriptions.
                        Our AI will analyze images of rooms, kitchens, bathrooms, gardens, and special features to enhance your content.
                        <br /><strong>Accepted:</strong> JPEG, PNG, WebP • <strong>Max size:</strong> 50MB each • <strong>Up to 5 photos</strong>
                    </p>

                    <div class="photo-upload-area">
                        <input type="file" id="photoInput" class="photo-input" multiple accept="image/jpeg,image/jpg,image/png,image/webp" />
                        <label for="photoInput" class="photo-upload-btn" id="photoUploadBtn">
                            <div class="photo-icon">📷</div>
                            <div class="photo-text">Choose Photos</div>
                            <div class="photo-subtext">or drag and drop images here</div>
                        </label>
                    </div>

                    <div class="photo-preview" id="photoPreview" style="display: none;">
                        <div class="photo-preview-title" id="photoPreviewTitle">Selected Photos (0/5)</div>
                        <div class="photo-grid" id="photoGrid"></div>
                        <div class="photo-limit-notice" id="photoLimitNotice" style="display: none;">
                            Maximum of 5 photos reached. Remove a photo to add another.
                        </div>
                    </div>

                    <div class="photo-enhancement-notice" id="photoEnhancementNotice" style="display: none;">
                        Photos will be analyzed to identify key property features and enhance your description with specific visual details
                    </div>
                </div>

                <button class="generate-btn" onclick="generateContent()">Ryte for me!</button>
            </div>

            <div class="output-section">
                <h2 class="section-title">Generated Content</h2>
                <div class="loading" id="loading">
                    <div class="loading-text">Creating your perfect copy...</div>
                    <div class="loading-subtext">Our AI is analyzing your property details and crafting compelling content</div>
                </div>
                <textarea class="output-area" id="outputArea" placeholder="Your AI-generated property copy will appear here..."></textarea>
                <div class="action-buttons" id="actionButtons" style="display: none;">
                    <button class="edit-btn" onclick="editContent()">Edit</button>
                    <button class="copy-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
                </div>
            </div>
        </div>

        <div class="features">
            <div class="feature-card">
                <div class="feature-icon">🏠</div>
                <h3>Copywriting Assistant</h3>
                <p>AI-powered descriptions that highlight key features and attract potential buyers or tenants.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">🎬</div>
                <h3>Video Scripts</h3>
                <p>Engaging scripts for property videos that showcase homes in the most compelling way.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">📱</div>
                <h3>Social Media Ready</h3>
                <p>Perfect copy for Facebook, Instagram, and other platforms to maximize property exposure.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">⚡</div>
                <h3>Instant Results</h3>
                <p>Generate professional property copy in seconds, saving hours of writing time.</p>
            </div>
        </div>
    </div>

    <script>
        // ---- API ENDPOINTS ----
        const BASE_URL = 'https://ryta.onrender.com';
        const GENERATE_API = `${BASE_URL}/generate`;
        const ADDRESS_API = `${BASE_URL}/api/address-search`;

        // Handle property status selection
        document.querySelectorAll('input[name="propertyStatus"]').forEach(radio => {
            radio.addEventListener('change', function () {
                document.querySelectorAll('.status-option').forEach(option => option.classList.remove('selected'));
                this.closest('.status-option').classList.add('selected');
            });
        });

        // Photo upload functionality
        let selectedPhotos = [];

        function setupPhotoUpload() {
            const photoInput = document.getElementById('photoInput');
            const photoUploadBtn = document.getElementById('photoUploadBtn');

            photoInput.addEventListener('change', handlePhotoSelect);
            photoUploadBtn.addEventListener('dragover', handleDragOver);
            photoUploadBtn.addEventListener('dragleave', handleDragLeave);
            photoUploadBtn.addEventListener('drop', handleDrop);

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                photoUploadBtn.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
        }

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function handleDragOver() { document.getElementById('photoUploadBtn').classList.add('drag-over'); }
        function handleDragLeave() { document.getElementById('photoUploadBtn').classList.remove('drag-over'); }
        function handleDrop(e) { document.getElementById('photoUploadBtn').classList.remove('drag-over'); handleFiles(e.dataTransfer.files); }
        function handlePhotoSelect(e) { handleFiles(e.target.files); }

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                if (!['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) { 
                    alert(`${file.name} is not a valid image type. Please use JPEG, PNG, or WebP.`); 
                    return false; 
                }
                if (file.size > 50 * 1024 * 1024) { 
                    alert(`${file.name} is too large. Maximum size is 50MB.`); 
                    return false; 
                }
                return true;
            });

            const remainingSlots = 5 - selectedPhotos.length;
            const filesToAdd = validFiles.slice(0, remainingSlots);
            selectedPhotos = [...selectedPhotos, ...filesToAdd];
            updatePhotoPreview();
            document.getElementById('photoInput').value = '';
        }

        function updatePhotoPreview() {
            const photoPreview = document.getElementById('photoPreview');
            const photoPreviewTitle = document.getElementById('photoPreviewTitle');
            const photoGrid = document.getElementById('photoGrid');
            const photoLimitNotice = document.getElementById('photoLimitNotice');
            const photoEnhancementNotice = document.getElementById('photoEnhancementNotice');

            if (selectedPhotos.length === 0) { 
                photoPreview.style.display = 'none'; 
                photoEnhancementNotice.style.display = 'none'; 
                return; 
            }

            photoPreview.style.display = 'block';
            photoEnhancementNotice.style.display ='block';
            photoPreviewTitle.textContent = `Selected Photos (${selectedPhotos.length}/5)`;
            photoLimitNotice.style.display = selectedPhotos.length >= 5 ? 'block' : 'none';

            photoGrid.innerHTML = selectedPhotos.map((file, index) => {
                const url = URL.createObjectURL(file);
                const sizeInMB = (file.size / 1024 / 1024).toFixed(1);
                return `
                    <div class="photo-item">
                        <img src="${url}" alt="Preview ${index + 1}" class="photo-img" />
                        <div class="photo-info">
                            <div class="photo-name">${file.name}</div>
                            <div class="photo-size">${sizeInMB}MB</div>
                        </div>
                        <button type="button" class="photo-remove" onclick="removePhoto(${index})" title="Remove photo">✕</button>
                    </div>
                `;
            }).join('');
        }

        function removePhoto(index) {
            if (selectedPhotos[index]) {
                const url = URL.createObjectURL(selectedPhotos[index]);
                URL.revokeObjectURL(url);
            }
            selectedPhotos.splice(index, 1);
            updatePhotoPreview();
        }

        // Initialize photo upload on page load
        document.addEventListener('DOMContentLoaded', function () { 
            setupPhotoUpload(); 
            setupAddressAutocomplete(); 
        });

        // ---- Address Autocomplete ----
        let addressDebounceTimer = null;
        let lastAddressController = null;

        function setupAddressAutocomplete() {
            const input = document.getElementById('location');
            const dropdown = document.getElementById('addressDropdown');

            input.addEventListener('input', (e) => {
                const q = e.target.value.trim();
                clearTimeout(addressDebounceTimer);
                if (q.length < 3) { 
                    dropdown.style.display = 'none'; 
                    dropdown.innerHTML = ''; 
                    return; 
                }
                addressDebounceTimer = setTimeout(() => searchAddresses(q), 300);
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.address-container')) dropdown.style.display = 'none';
            });
        }

        async function searchAddresses(query) {
            const dropdown = document.getElementById('addressDropdown');
            if (lastAddressController) lastAddressController.abort();
            lastAddressController = new AbortController();

            dropdown.innerHTML = '<div class="address-loading">Searching addresses...</div>';
            dropdown.style.display = 'block';

            console.log('Searching for:', query); // DEBUG

            try {
                const res = await fetch(ADDRESS_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query }),
                    signal: lastAddressController.signal
                });

                console.log('Response status:', res.status); // DEBUG
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                console.log('Response data:', data); // DEBUG
                
                const addresses = Array.isArray(data.addresses) ? data.addresses : [];

                if (addresses.length === 0) {
                    dropdown.innerHTML = '<div class="address-loading">No matches found</div>';
                    return;
                }

                dropdown.innerHTML = addresses.map(addr => {
                    const safe = String(addr).replace(/'/g, "\\'").replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `<div class="address-option" onclick="selectAddress('${safe}')">${safe}</div>`;
                }).join('');
            } catch (err) {
                console.error('Address search error:', err); // DEBUG
                if (err.name === 'AbortError') return;
                dropdown.innerHTML = '<div class="address-loading">Error fetching addresses</div>';
            }
        }

        function selectAddress(address) {
            const input = document.getElementById('location');
            const dropdown = document.getElementById('addressDropdown');
            input.value = address;
            dropdown.style.display = 'none';
        }

        // ---- Generate Content ----
        async function generateContent() {
            const contentType = document.getElementById('contentType').value;
            const propertyType = document.getElementById('propertyType').value;
            const bedrooms = document.getElementById('bedrooms').value;
            const bathrooms = document.getElementById('bathrooms').value;
            const location = document.getElementById('location').value;
            const price = document.getElementById('price').value;
            const tone = document.getElementById('tone').value;
            const additionalInfo = document.getElementById('additionalInfo').value;

            // Get selected features
            const features = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => features.push(cb.value));

            const generateBtn = document.querySelector('.generate-btn');
            const loading = document.getElementById('loading');
            const outputArea = document.getElementById('outputArea');
            const actionButtons = document.getElementById('actionButtons');

            if (!location.trim()) { 
                alert('Please enter a location for your property.'); 
                return; 
            }

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            loading.style.display = 'block';
            outputArea.style.display = 'none';
            actionButtons.style.display = 'none';

            if (selectedPhotos.length > 0) {
                loading.querySelector('.loading-text').textContent = 'Analyzing photos and creating your copy...';
                loading.querySelector('.loading-subtext').textContent = `Processing ${selectedPhotos.length} photo${selectedPhotos.length > 1 ? 's' : ''} to enhance your content`;
            } else {
                loading.querySelector('.loading-text').textContent = 'Creating your perfect copy...';
                loading.querySelector('.loading-subtext').textContent = 'Our AI is analyzing your property details and crafting compelling content';
            }

            try {
                const propertyStatus = document.querySelector('input[name="propertyStatus"]:checked')?.value || 'sale';

                // Map content type to backend mode
                const contentModeMap = {
                    'property-description': 'description',
                    'video-script': 'script',
                    'social-media-post': 'social',
                    'email-marketing': 'description',
                    'brochure-copy': 'website'
                };
                const contentMode = contentModeMap[contentType] || 'description';

                const formData = new FormData();

                // Feature descriptions
                const featureDescriptions = {
                    garden: 'private garden',
                    parking: 'dedicated parking',
                    garage: 'garage',
                    ensuite: 'en-suite bathroom',
                    balcony: 'balcony with stunning views',
                    fireplace: 'charming fireplace',
                    newbuild: 'brand new construction',
                    period: 'beautiful period features',
                    transport: 'excellent transport connections',
                    schools: 'proximity to outstanding schools'
                };

                const selectedFeatures = features.map(f => featureDescriptions[f]).filter(Boolean);
                const featuresText = selectedFeatures.length > 0 ? selectedFeatures.join(', ') : '';

                // Build API data with tone and price as SEPARATE fields
                const apiData = {
                    address: location,
                    propertyType: propertyType,
                    bedrooms: bedrooms || '0',
                    bathrooms: bathrooms || '0',
                    features: featuresText,
                    description: additionalInfo,
                    propertyStatus: propertyStatus,
                    tone: tone,
                    price: price
                };

                formData.append('fields', JSON.stringify(apiData));
                formData.append('mode', contentMode);
                selectedPhotos.forEach(photo => formData.append('photos', photo));

                // Call the API
                const response = await fetch(GENERATE_API, {
                    method: 'POST',
                    headers: { 'X-Session-Id': crypto.randomUUID() },
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();

// Hide loading, show output area
loading.style.display = 'none';
outputArea.style.display = 'block';
outputArea.value = ''; // Clear first

// TYPING EFFECT - Type out the text character by character
await typeText(outputArea, result.text);

// Show action buttons after typing completes
actionButtons.style.display = 'flex';

                // Show photo enhancement notice if photos were processed
                if (result.photosAnalyzed > 0) {
                    const notice = document.createElement('div');
                    notice.style.cssText = 'background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3); color: #155724; padding: 12px; border-radius: 8px; font-size: 14px; margin-bottom: 15px; text-align: center;';
                    notice.textContent = `✨ Enhanced with analysis of ${result.photosAnalyzed} photo${result.photosAnalyzed > 1 ? 's' : ''}`;
                    outputArea.parentNode.insertBefore(notice, outputArea);
                    setTimeout(() => { 
                        if (notice.parentNode) notice.parentNode.removeChild(notice); 
                    }, 5000);
                }
            } catch (error) {
                console.error('Error generating content:', error);
                outputArea.value = 'Failed to generate content. Please check your internet connection and try again.';
                outputArea.style.display = 'block';
                actionButtons.style.display = 'flex';
            } finally {
                // Reset UI
                loading.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.textContent = 'Ryte for me!';
            }
        }

        // Typing animation function
async function typeText(element, text, speed = 15) {
    element.value = '';
    let index = 0;
    
    return new Promise((resolve) => {
        const interval = setInterval(() => {
            if (index < text.length) {
                element.value += text.charAt(index);
                index++;
                // Auto-scroll to bottom as text types
                element.scrollTop = element.scrollHeight;
            } else {
                clearInterval(interval);
                resolve();
            }
        }, speed);
    });
}

        function copyToClipboard() {
            const outputArea = document.getElementById('outputArea');
            const copyBtn = document.querySelector('.copy-btn');
            outputArea.select();
            document.execCommand('copy');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            copyBtn.style.background = '#28a745';
            setTimeout(() => { 
                copyBtn.textContent = originalText; 
                copyBtn.style.background = '#1F2E3C'; 
            }, 2000);
        }

        function editContent() {
            const outputArea = document.getElementById('outputArea');
            outputArea.focus();
            outputArea.readOnly = false;
        }

        // Auto-resize textarea
        document.getElementById('outputArea').addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.max(300, this.scrollHeight) + 'px';
        });

        // Expose globals used in inline handlers
        window.removePhoto = removePhoto;
        window.selectAddress = selectAddress;
    </script>
</body>
</html>