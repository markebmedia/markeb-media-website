<!-- /website/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal - Markeb Media</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
  /* Base */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.6; }

  /* Sidebar */
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 280px;
    height: 100vh;
    background: #fff;
    border-right: 1px solid #e2e8f0;
    padding: 32px 24px;
    z-index: 100;
    transform: translateX(0);
    transition: transform .3s ease;
    /* enable scrolling when content is taller than the viewport */
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .logo { margin-bottom: 48px; display: flex; align-items: center; }
  .logo img { height: 100px; width: auto; }

@media (max-width: 480px) {
  .logo img { height: 70px; }
}


  .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; color: #64748b; text-decoration: none; font-weight: 500; transition: all .2s ease; cursor: pointer; }
  .nav-item:hover, .nav-item.active { background: #f1f5f9; color: #0f172a; }
  .nav-item.active { background: #3b82f6; color: #fff; }
  .nav-icon { width: 20px; height: 20px; font-size: 16px; display: flex; align-items: center; justify-content: center; line-height: 1; }

  .mobile-toggle { display: none; position: fixed; top: 20px; left: 20px; z-index: 101; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
  .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 99; }

  .main-content { margin-left: 280px; min-height: 100vh; width: calc(100vw - 280px); box-sizing: border-box; }

  .header { background: #fff; border-bottom: 1px solid #e2e8f0; padding: 24px 32px; display: flex; justify-content: space-between; align-items: center; }
  .header-left { flex: 1; }

  /* Responsive headings */
  .page-title { font-size: clamp(20px, 3.5vw, 28px); font-weight: 600; color: #0f172a; margin-bottom: 4px; }
  .page-subtitle { color: #64748b; font-size: 16px; }

  .header-right { display: flex; align-items: center; gap: 16px; }
  .user-info { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: #f8fafc; border-radius: 8px; }
  .user-avatar { width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; }
  .user-details h4 { font-size: 14px; font-weight: 600; color: #0f172a; }
  .user-details p { font-size: 12px; color: #64748b; }

  .btn { padding: 12px 20px; border-radius: 8px; font-weight: 500; text-decoration: none; border: none; cursor: pointer; transition: all .2s ease; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
  .btn-primary { background: #3b82f6; color: #fff; }
  .btn-primary:hover { background: #2563eb; }

  /* Content area & sections */
  :root { --footer-h: 80px; }
  .content-area { padding: 32px; padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom, 0px)); }
  .section { display: none; }
  .section.active { display: block; }

  /* Metrics */
  .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px; }
  .metric-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; transition: all .2s ease; }
  .metric-card:hover { border-color: #cbd5e1; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.05); }
  .metric-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .metric-icon { width: 48px; height: 48px; background: #eff6ff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  .metric-value { font-size: 32px; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
  .metric-label { color: #64748b; font-size: 14px; font-weight: 500; }

  /* Cards & layout */
  .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 32px; }
  .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
  .card-header { padding: 24px 24px 0; border-bottom: 1px solid #f1f5f9; margin-bottom: 24px; }
  .card-title { font-size: clamp(16px, 2.6vw, 18px); font-weight: 600; color: #0f172a; margin-bottom: 8px; }
  .card-subtitle { color: #64748b; font-size: 14px; }
  .card-content { padding: 0 24px 24px; }

  .activity-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
  .activity-item:last-child { border-bottom: none; }
  .activity-icon { width: 40px; height: 40px; background: #f8fafc; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
  .activity-title { font-weight: 500; color: #0f172a; margin-bottom: 4px; }
  .activity-time { font-size: 13px; color: #64748b; }

  .action-grid { display: grid; gap: 12px; }
  .action-item { display: flex; align-items: center; gap: 12px; padding: 16px; background: #f8fafc; border-radius: 8px; text-decoration: none; color: #0f172a; transition: all .2s ease; cursor: pointer; }
  .action-item:hover { background: #f1f5f9; }
  .action-icon { width: 36px; height: 36px; background: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 16px; }

  /* Booking */
  .booking-container { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
  .booking-header { padding: 24px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
  .booking-title { font-size: 24px; font-weight: 700; color: #0f172a; margin-bottom: 8px; }
  .booking-description { color: #64748b; line-height: 1.6; }
  .booking-iframe-container { padding: 0; background: #fff; }
  .booking-iframe {
    width: 100%;
    height: min(80dvh, 800px); /* adaptive to mobile URL bar, keeps max */
    border: none;
    display: block;
  }

  /* Tracking widgets */
  .warning-message{background:linear-gradient(135deg,#FEF3C7 0%,#FCD34D 100%);border:2px solid #F59E0B;border-radius:16px;padding:20px;color:#92400E;font-weight:600;text-align:center}
  .error-message{background:linear-gradient(135deg,#FEE2E2 0%,#FECACA 100%);border:2px solid #EF4444;border-radius:16px;padding:20px;color:#991B1B;font-weight:600;text-align:center}
  .spinner{margin:30px auto;width:50px;height:50px;border:4px solid #E5E7EB;border-top:4px solid #3b82f6;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .progress-container{display:flex;align-items:center;justify-content:space-between;max-width:100%;padding:30px 10px;margin:30px auto;position:relative}
  .progress-container::before{content:'';position:absolute;top:50%;left:10%;right:10%;height:4px;background:#E5E7EB;z-index:0;border-radius:2px;transform:translateY(-50%)}
  .progress-step{z-index:1;flex:1;text-align:center;position:relative}
  .progress-step .icon{width:50px;height:50px;border-radius:50%;background:#E5E7EB;margin:0 auto;font-size:1.4em;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;position:relative;z-index:1;transition:all .3s ease;border:3px solid #FFFFFF;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
  .progress-step.active .icon{background:linear-gradient(135deg,#3b82f6,#60a5fa);transform:scale(1.1);box-shadow:0 6px 20px rgba(59,130,246,.35)}
  .progress-step .label{margin-top:12px;font-size:.9em;color:#6B7280;font-weight:500}
  .progress-step.active .label{color:#1F2E3C;font-weight:700}
  .progress-line{position:absolute;top:50%;left:10%;height:4px;background:linear-gradient(90deg,#3b82f6,#60a5fa);border-radius:2px;z-index:0;transition:width .8s ease-in-out;transform:translateY(-50%);box-shadow:0 2px 8px rgba(59,130,246,.25)}
  .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:25px 0}
  .info-item{background:linear-gradient(135deg,#F8FAFC 0%,#FFFFFF 100%);padding:20px;border-radius:12px;border:1px solid #E5E7EB;transition:all .3s ease}
  .info-item:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  .deadline-alert{background:linear-gradient(135deg,#E0E7FF 0%,#C7D2FE 100%);border:2px solid #6366F1;border-radius:16px;padding:20px;margin:20px 0;text-align:center;color:#3730A3;font-weight:600}
  .delivery-link{background:linear-gradient(135deg,#D1FAE5 0%,#A7F3D0 100%);border:2px solid #10B981;border-radius:16px;padding:20px;margin:20px 0;text-align:center}

  /* Amend file upload */
  .file-upload-area{border:2px dashed #E5E7EB;border-radius:12px;padding:20px;text-align:center;background:#FAFAFA;transition:all .3s ease;cursor:pointer}
  .file-upload-area:hover{border-color:#3b82f6;background:rgba(59,130,246,.03)}
  .file-upload-area.dragover{border-color:#3b82f6;background:rgba(59,130,246,.08)}
  .file-preview{margin-top:16px;display:none}
  .file-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border:2px solid #E5E7EB;border-radius:8px;margin-bottom:8px}
  .file-remove{background:#EF4444;color:#fff;border:none;border-radius:6px;padding:6px 10px;font-size:.8em;cursor:pointer}
  .upload-progress{display:none;margin-top:12px;padding:12px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;text-align:center}
  .progress-bar{width:100%;height:6px;background:#E5E7EB;border-radius:3px;margin:10px 0;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#3b82f6,#60a5fa);width:0%}

  /* Footer */
  .page-footer{position:fixed;bottom:0;left:280px;right:0;background:#fff;border-top:1px solid #e2e8f0;padding:16px 32px;z-index:50;display:flex;justify-content:space-between;align-items:center; padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));}
  .footer-buttons{display:flex;gap:12px;}
  .footer-btn{padding:10px 20px;border-radius:8px;font-weight:500;text-decoration:none;border:1px solid #e2e8f0;cursor:pointer;transition:all .2s ease;font-size:14px;background:#fff;color:#64748b;}
  .footer-btn:hover{background:#f8fafc;border-color:#cbd5e1;color:#0f172a;}
  .footer-copyright{font-size:12px;color:#64748b;}

  /* Touch-friendly tap targets */
  @media (pointer: coarse) {
    .nav-item, .action-item, .footer-btn, .btn { padding: 14px 20px; }
    .nav-item { gap: 14px; }
  }

  /* Tablet refinement */
  @media (max-width: 900px) {
    .content-grid { grid-template-columns: 1fr; }
  }

  /* Gallery protection on tiny screens */
  .gallery-image { aspect-ratio: 16 / 9; object-fit: cover; }

  /* Breakpoints */
  @media (max-width: 1024px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .mobile-toggle { display: block; }
  .mobile-overlay.active { display: block; }
  .main-content { margin-left: 0; width: 100%; }
  .content-grid { grid-template-columns: 1fr; }
  /* remove the extra left padding so header stays aligned */
  .header { padding: 24px 32px; }
  .booking-iframe { height: 600px; }
  .page-footer { left: 0; }
}


  @media (max-width: 768px) {
  .header {
    flex-direction: column;
    align-items: center;
    gap: 16px;
    text-align: center;
    padding: 16px 20px; /* removed padding-left: 80px */
  }

  .header-left  { order: 2; }
  .header-right { order: 1; }

  .header-left,
  .header-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  .page-title { font-size: clamp(20px, 5.5vw, 24px); }
  .content-area { padding: 20px; padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom, 0px)); }
  .metrics-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
  .metric-card { padding: 20px; }
  .metric-value { font-size: 28px; }
  .metric-label { font-size: 12px; }
  .card { margin-bottom: 20px; }
  .card-header { padding: 20px 20px 0; margin-bottom: 20px; }
  .card-content { padding: 0 20px 20px; }
  .action-item { padding: 12px; }
  .action-icon { width: 32px; height: 32px; font-size: 14px; }
  .booking-iframe { height: 500px; }
}


@media (max-width: 480px) {
  .metrics-grid { grid-template-columns: 1fr; }
  .metric-card { padding: 16px; text-align: center; }
  .content-area { 
    padding: 16px;
    padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom, 0px));
  }
  .card-header { padding: 16px 16px 0; margin-bottom: 16px; }
  .card-content { padding: 0 16px 16px; }
  .activity-item { padding: 12px 0; }
  .activity-icon { width: 36px; height: 36px; }
  .page-title { font-size: 20px; }
  .page-subtitle { font-size: 14px; }

  /* CHANGED: center header on phones (removed padding-left: 70px) */
  .header {
    flex-direction: column;
    align-items: center;
    gap: 12px;
    text-align: center;
    padding: 12px 16px;
  }

  /* NEW: keep avatar/name/email ABOVE welcome; center both blocks */
  .header-left  { order: 2; }
  .header-right { order: 1; }
  .header-left,
  .header-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  .booking-iframe { height: 400px; }

  /* smaller copyright */
  .footer-copyright { font-size: 12px; }

  /* footer stays fixed but taller */
  :root { --footer-h: 120px; }   /* increased reserved space */

  .page-footer {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    flex-direction: column;
    gap: 8px;
    text-align: center;
    padding: 12px 16px calc(12px + env(safe-area-inset-bottom, 0px));
  }

  .footer-buttons { justify-content: center; }
}



</style>

</head>
<body>
  <div class="mobile-toggle" onclick="toggleSidebar()">
    <div style="width: 20px; height: 20px; display: flex; flex-direction: column; justify-content: space-between;">
      <div style="width: 100%; height: 2px; background: #64748b;"></div>
      <div style="width: 100%; height: 2px; background: #64748b;"></div>
      <div style="width: 100%; height: 2px; background: #64748b;"></div>
    </div>
  </div>
  <div class="mobile-overlay" onclick="closeSidebar()"></div>

  <div class="sidebar">
    <div class="logo">
      <img src="../public/images/Markeb Media Logo (2).PNG" alt="Markeb Media" />
    </div>
    <nav>
      <div class="nav-item active" onclick="showSection('dashboard')"><div class="nav-icon">●</div>Dashboard</div>
      <div class="nav-item" onclick="showSection('booking')"><div class="nav-icon">+</div>Book Shoot</div>
      <div class="nav-item" onclick="showSection('gallery')"><div class="nav-icon">□</div>Gallery</div>
      <div class="nav-item" onclick="openCopyryta()"><div class="nav-icon">◇</div>CopyRyta AI</div>
      <div class="nav-item" onclick="showSection('tracking')"><div class="nav-icon">▲</div>Content Tracking</div>
      <div class="nav-item" onclick="showSection('amend')"><div class="nav-icon">△</div>Request Amendment</div>
      <div class="nav-item" onclick="showSection('settings')"><div class="nav-icon">○</div>Settings</div>
      <div class="nav-item" onclick="contactSupport()"><div class="nav-icon">@</div>Support</div>
      <div class="nav-item" onclick="logoutAll()" style="margin-top: 40px; color: #ef4444;"><div class="nav-icon">←</div>Logout</div>
    </nav>
  </div>

  <div class="main-content">
    <div class="header">
      <div class="header-left">
        <h1 class="page-title" id="pageTitle">Welcome back</h1>
        <p class="page-subtitle" id="pageSubtitle">Here's what's happening with your projects</p>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">M</div>
          <div class="user-details">
            <h4 id="userName">Loading...</h4>
            <p id="userEmail">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="content-area">
      <!-- DASHBOARD -->
      <div id="dashboard" class="section active">
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-header"><div class="metric-icon">■</div></div>
            <div class="metric-value" id="totalBookings">0</div>
            <div class="metric-label">Total Bookings</div>
          </div>
          <div class="metric-card">
            <div class="metric-header"><div class="metric-icon">£</div></div>
            <div class="metric-value" id="totalSpending">£0</div>
            <div class="metric-label">Total Investment</div>
          </div>
          <div class="metric-card">
            <div class="metric-header"><div class="metric-icon">✓</div></div>
            <div class="metric-value" id="completedProjects">0</div>
            <div class="metric-label">Completed Projects</div>
          </div>
          <div class="metric-card">
            <div class="metric-header"><div class="metric-icon">#</div></div>
            <div class="metric-value" id="memberSince">—</div>
            <div class="metric-label">Member Since</div>
          </div>
        </div>

        <div class="content-grid">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Recent Activity</h2>
              <p class="card-subtitle">Your latest interactions and updates</p>
            </div>
            <div class="card-content">
              <div id="activityList"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Quick Actions</h2>
              <p class="card-subtitle">Common tasks and shortcuts</p>
            </div>
            <div class="card-content">
              <div class="action-grid">
                <div class="action-item" onclick="showSection('booking')">
                  <div class="action-icon">+</div>
                  <div>
                    <div style="font-weight: 500;">Book New Shoot</div>
                    <div style="font-size: 12px; color: #64748b;">Schedule photos and videos</div>
                  </div>
                </div>
                <div class="action-item" onclick="showSection('tracking')">
                  <div class="action-icon">▲</div>
                  <div>
                    <div style="font-weight: 500;">Track Content</div>
                    <div style="font-size: 12px; color: #64748b;">Monitor content progress</div>
                  </div>
                </div>
                <div class="action-item" onclick="openCopyryta()">
                  <div class="action-icon">◇</div>
                  <div>
                    <div style="font-weight: 500;">CopyRyta AI</div>
                    <div style="font-size: 12px; color: #64748b;">AI copywriting tool</div>
                  </div>
                </div>
                <div class="action-item" onclick="showSection('amend')">
                  <div class="action-icon">△</div>
                  <div>
                    <div style="font-weight: 500;">Request Amendment</div>
                    <div style="font-size: 12px; color: #64748b;">Make adjustments to your content</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BOOKING -->
      <div id="booking" class="section">
        <div class="booking-container">
          <div class="booking-header">
            <h2 class="booking-title">Book Your Shoot</h2>
            <p class="booking-description">Schedule your professional shoots. Choose your preferred date and time, and we'll handle the rest.</p>
          </div>
          <div class="booking-iframe-container">
            <iframe 
              src="https://app.acuityscheduling.com/schedule.php?owner=32946394&ref=embedded_csp" 
              title="Schedule Appointment" 
              class="booking-iframe"
              frameBorder="0" 
              allow="payment">
            </iframe>
          </div>
        </div>
      </div>

      <!-- GALLERY -->
      <div id="gallery" class="section">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Your Photo Gallery</h2>
            <p class="card-subtitle">View and download your completed photography projects</p>
          </div>
          <div class="card-content">
            <div class="gallery-grid" id="galleryGrid">
              <div class="gallery-item" style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;">
                <div class="gallery-image" style="width:100%;height:200px;background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-size:48px;">IMG</div>
                <div class="gallery-info" style="padding:20px;">
                  <div class="gallery-title" style="font-weight:600;color:#0f172a;margin-bottom:8px;">Welcome to your gallery</div>
                  <div class="gallery-date" style="color:#64748b;font-size:14px;margin-bottom:12px;">Your completed projects will appear here</div>
                  <span class="gallery-status status-processing" style="display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500;background:#fef3c7;color:#d97706;">Coming Soon</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- COPYRYTA -->
      <div id="copyryta" class="section">
        <div class="card" style="padding:24px">
          <div class="card-header">
            <h2 class="card-title">CopyRyta AI</h2>
            <p class="card-subtitle">Open your AI copywriting workspace in a dedicated page.</p>
          </div>
          <div class="card-content">
            <button class="btn btn-primary" onclick="openCopyryta()">Open CopyRyta</button>
          </div>
        </div>
      </div>

      <!-- CONTENT TRACKING -->
      <div id="tracking" class="section">
        <div class="card" style="padding:24px">
          <div class="card-header">
            <h2 class="card-title">Track Your Content</h2>
            <p class="card-subtitle">Stay updated on your property marketing progress with real-time tracking</p>
          </div>
          <div class="card-content">
            <div style="max-width:520px">
              <input id="trackingInput" type="text" class="form-input" placeholder="Enter your tracking code" style="width:100%;padding:14px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">
            </div>
            <div style="margin-top:12px">
              <button class="btn btn-primary" onclick="trackBooking()">🔍 Track Progress</button>
            </div>
            <div class="result-container"><div id="result" style="margin-top:16px;"></div></div>
          </div>
        </div>
      </div>

      <!-- REQUEST AMENDMENT (with file upload and Render endpoints) -->
      <div id="amend" class="section">
        <div class="card" style="padding:24px">
          <div class="card-header">
            <h2 class="card-title">Request an Amendment</h2>
            <p class="card-subtitle">We're here to help get things just right for your property marketing</p>
          </div>
          <div class="card-content">
            <form id="amendForm">
              <div class="form-group" style="margin-bottom:16px">
                <label class="form-label" style="display:block;font-weight:600;margin-bottom:6px;">Your Name</label>
                <input type="text" name="clientName" required class="form-input" placeholder="Enter your full name" style="width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">
              </div>
              <div class="form-group" style="margin-bottom:16px">
                <label class="form-label" style="display:block;font-weight:600;margin-bottom:6px;">Your Email</label>
                <input type="email" name="email" required class="form-input" placeholder="your.email@example.com" style="width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">
              </div>
              <div class="form-group" style="margin-bottom:16px">
                <label class="form-label" style="display:block;font-weight:600;margin-bottom:6px;">Tracking Code</label>
                <input type="text" name="trackingCode" required pattern="MK.*" title="Tracking code must start with MK." class="form-input" placeholder="MK..." oninput="this.value=this.value.toUpperCase()" style="width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">
                <div id="trackingStatus" class="tracking-status" style="display:none;margin-top:8px;padding:10px;border-radius:8px;"></div>
              </div>
              <div class="form-group" style="margin-bottom:16px">
                <label class="form-label" style="display:block;font-weight:600;margin-bottom:6px;">What needs adjusting?</label>
                <div class="action-grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));">
                  <label class="action-item"><input type="checkbox" name="mediaType" value="Photos"> Photos</label>
                  <label class="action-item"><input type="checkbox" name="mediaType" value="Video"> Video</label>
                  <label class="action-item"><input type="checkbox" name="mediaType" value="Drone"> Drone</label>
                  <label class="action-item"><input type="checkbox" name="mediaType" value="Captions"> Captions</label>
                  <label class="action-item"><input type="checkbox" name="mediaType" value="Other"> Other</label>
                </div>
              </div>
              <div class="form-group" style="margin-bottom:16px">
                <label class="form-label" style="display:block;font-weight:600;margin-bottom:6px;">Details / Notes</label>
                <textarea name="amendDetails" required class="form-input" placeholder="Please describe the specific changes you'd like us to make..." style="width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;min-height:120px"></textarea>
              </div>

              <!-- File upload -->
              <div class="form-group" style="margin-bottom:16px">
                <label class="form-label" style="display:block;font-weight:600;margin-bottom:6px;">Reference Files (Optional)</label>
                <div class="file-upload-area" id="fileUploadArea">
                  <div style="font-size:1.1em;color:#6B7280;margin-bottom:8px;">Drag & drop files here, or click to browse</div>
                  <div style="font-size:.9em;color:#94a3b8;">Max 50MB each • Images, PDFs, Videos supported</div>
                  <button type="button" class="btn btn-primary" id="browseButton" style="margin-top:10px;">Choose Files</button>
                  <input type="file" id="fileInput" style="display:none" multiple accept="image/*,video/*,.pdf,.doc,.docx,.txt">
                </div>
                <div class="file-preview" id="filePreview"></div>
                <div class="upload-progress" id="uploadProgress">
                  <div>Uploading files...</div>
                  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                  <div id="progressText">0%</div>
                </div>
              </div>

              <button id="submitBtn" type="submit" class="btn btn-primary" style="width:100%">📤 Submit Amendment Request</button>
            </form>

            <div id="responseMessage" class="response-message" style="display:none;margin-top:12px;font-weight:600;text-align:center"></div>

            <div class="info-box" style="margin-top:20px;background:linear-gradient(135deg,#EBF4FF 0%, #DBEAFE 100%);border:2px solid #3B82F6;border-radius:16px;padding:20px;text-align:center;">
              <h3 style="color:#1E40AF;font-weight:700;margin-bottom:10px;font-size:1.1em;">Free Amendment Policy</h3>
              <p style="color:#1E3A8A;font-weight:500;margin-bottom:8px;">Each project comes with <span style="color:#3B82F6;font-weight:700;">up to two free amendment requests</span> within <span style="color:#3B82F6;font-weight:700;">7 days of delivery</span> using your tracking code.</p>
              <p style="color:#1E3A8A;font-weight:500;">Our team typically completes all amendments within <span style="color:#3B82F6;font-weight:700;">24 hours</span>.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS (profile only; integrations removed) -->
      <div id="settings" class="section">
        <div class="card" style="padding:24px">
          <div class="card-header">
            <h2 class="card-title">Profile</h2>
            <p class="card-subtitle">Update your display details (local to your device)</p>
          </div>
          <div class="card-content">
            <div class="form-group" style="margin-bottom:16px">
              <label class="form-label" style="display:block;font-weight:600;margin-bottom:6px;">Name</label>
              <input id="settingsName" class="form-input" placeholder="Your name" style="width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">
            </div>
            <div class="form-group" style="margin-bottom:16px">
              <label class="form-label" style="display:block;font-weight:600;margin-bottom:6px;">Email</label>
              <input id="settingsEmail" type="email" class="form-input" placeholder="you@example.com" style="width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">
            </div>
            <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
          </div>
        </div>
      </div>

      <!-- TERMS & CONDITIONS -->
      <div id="terms" class="section">
        <div class="card" style="padding:24px">
          <div class="card-header">
            <h2 class="card-title">Terms & Conditions</h2>
            <p class="card-subtitle">Our service terms and policies</p>
          </div>
          <div class="card-content">
            <ol style="padding-left:20px;line-height:1.8;">
              <li><strong>Services</strong><br>Markeb Media provides professional property marketing media services, including but not limited to: Photography, Videography, and Drone Footage. We reserve the right to modify, suspend, or discontinue any service at any time without prior notice.</li>
              <li><strong>Payment Terms</strong><br>Card details must be provided at booking. Full payment is charged automatically once editing begins. Clients may also choose to pay upfront. Payments are securely processed by Stripe. If payment fails, Markeb Media reserves the right to withhold delivery.</li>
              <li><strong>Cancellation and Refund Policy</strong><br>Clients may cancel with at least 24 hours' notice. Late cancellations may be charged in full. No refunds for completed work. Media produced prior to cancellation remains property of Markeb Media until full payment is received.</li>
              <li><strong>Delivery of Media</strong><br>Media is delivered digitally within 48 hours. Ownership transfers only upon full payment.</li>
              <li><strong>Usage Rights and Intellectual Property</strong><br>Markeb Media retains ownership until full payment. Upon payment, a non-exclusive, perpetual, non-transferable license is granted for property marketing. Reselling or redistribution without consent is prohibited.</li>
              <li><strong>Revisions and Amendment Requests</strong><br>Requests must be submitted within 7 days. Two free amendments per project are included. Further amendments may incur charges. Extensive changes or re-shoots may affect delivery timelines.</li>
              <li><strong>Limitation of Liability</strong><br>Markeb Media is not liable for technical issues, indirect damages, or delays beyond our control (e.g., weather, equipment failure, or regulatory changes).</li>
              <li><strong>Drone Operations</strong><br>All drone operations comply with UK CAA regulations and are subject to weather and legal restrictions.</li>
              <li><strong>Data Usage and Privacy</strong><br>Payments are processed securely by Stripe. Markeb Media does not store card details. Personal data is used only for service delivery and processed per UK data protection laws.</li>
              <li><strong>Amendments to Terms</strong><br>Markeb Media may update these Terms &amp; Conditions at any time. Continued use of services constitutes acceptance.</li>
              <li><strong>Governing Law</strong><br>These Terms &amp; Conditions are governed by the laws of England and Wales. Disputes are subject to the exclusive jurisdiction of the courts of England and Wales.</li>
            </ol>
          </div>
        </div>
      </div>

      <!-- PRIVACY POLICY -->
      <div id="privacy" class="section">
        <div class="card" style="padding:24px">
          <div class="card-header">
            <h2 class="card-title">Privacy Policy</h2>
            <p class="card-subtitle">How we handle your data</p>
          </div>
          <div class="card-content">
            <p style="margin-bottom:16px;"><em>Effective Date: 12/10/2024</em></p>
            <ol style="padding-left:20px;line-height:1.8;">
              <li><strong>Introduction</strong><br>We are committed to protecting your privacy and ensuring that your information is handled securely in compliance with GDPR.</li>
              <li><strong>Information We Collect</strong><br>Contact info (name, email, phone), property info, payment info (via Stripe), amendment requests, and other voluntary information.</li>
              <li><strong>How We Use Your Information</strong><br>To provide services, process payments, deliver media, communicate with clients, handle amendments, improve services, and ensure compliance.</li>
              <li><strong>Use of Media for Marketing</strong><br>Media may be used for promotional purposes (website, social media, marketing materials). Clients may opt out by emailing <a href="mailto:commercial@markebmedia.com">commercial@markebmedia.com</a>.</li>
              <li><strong>Data Sharing</strong><br>Shared only with service providers (Stripe, Dropbox/OneDrive, Airtable) or if legally required. Some providers may process data internationally with GDPR safeguards.</li>
              <li><strong>Data Security</strong><br>We implement technical and organizational measures to protect your data. Stripe securely processes all payment information.</li>
              <li><strong>Retention of Data</strong><br>Data is kept only as long as necessary for services, compliance, or dispute resolution, then securely deleted or anonymized.</li>
              <li><strong>Your Rights Under GDPR</strong><br>You have rights to access, correction, deletion, restriction, objection, and portability. Contact us to exercise these rights.</li>
              <li><strong>Cookies and Tracking</strong><br>We use cookies to improve user experience. By using our website, you consent to cookies. Manage cookies in your browser settings.</li>
              <li><strong>Updates</strong><br>We may update this Privacy Policy from time to time. Updates will be posted here with a revised effective date.</li>
              <li><strong>Contact Us</strong><br>Email: <a href="mailto:commercial@markebmedia.com">commercial@markebmedia.com</a></li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="page-footer">
    <div class="footer-buttons">
      <button class="footer-btn" onclick="showSection('terms')">Terms & Conditions</button>
      <button class="footer-btn" onclick="showSection('privacy')">Privacy Policy</button>
    </div>
    <div class="footer-copyright" id="footerCopyright">© 2025 Markeb Media. All rights reserved.</div>
  </div>

  <!-- Auth/session helper -->
  <script src="./assets/js/airtable.js"></script>
  <script>
    /* ====== endpoints ====== */
    const NETLIFY_ENDPOINTS = {
      acuity: '/.netlify/functions/acuity-data',
      projects: '/.netlify/functions/airtable-data',
      track: '/.netlify/functions/track-content',
    };

    const fmtGBP = (n) => (typeof n === 'number'
      ? n.toLocaleString('en-GB', { style: 'currency', currency: 'GBP' })
      : '£0');

    function toggleSidebar(){document.querySelector('.sidebar').classList.toggle('open');document.querySelector('.mobile-overlay').classList.toggle('active');}
    function closeSidebar(){document.querySelector('.sidebar').classList.remove('open');document.querySelector('.mobile-overlay').classList.remove('active');}
    function showSection(id){document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));[...document.querySelectorAll('.nav-item')].find(n=>n.textContent.trim().toLowerCase().includes(id))?.classList.add('active');window.scrollTo({top:0,behavior:'smooth'});}
    function openCopyryta(){window.location.href='./copyryta.html';}

    /* 📧 Support email function */
    function contactSupport(){
      window.location.href = "mailto:commercial@markebmedia.com?subject=Support%20Request&body=Hello%20Markeb%20Media%20Team,";
    }

    /* Greeting */
    function setDashboardGreeting(){
      const titleEl=document.getElementById('pageTitle');
      const user=window.AirtableAPI?.getCurrentUser?.()||null;
      const name=(user&&user.name)||localStorage.getItem('user_name')||'there';
      const action=localStorage.getItem('auth_action');
      titleEl.textContent=(action==='signup')?`Welcome, ${name}`:`Welcome back, ${name}`;
      localStorage.removeItem('auth_action');
    }

    /* Header user info */
    function populateHeaderUser(){
  const u = window.AirtableAPI?.getCurrentUser?.() || null;
  const name = (u && u.name) || localStorage.getItem('user_name') || 'Markeb Client';
  const email = (u && u.email) || localStorage.getItem('user_email') || 'client@markebmedia.com';

  document.getElementById('userName').textContent = name;
  document.getElementById('userEmail').textContent = email;
  document.getElementById('userAvatar').textContent = (name?.[0] || 'M').toUpperCase();
}


    function saveProfile(){
      const name=document.getElementById('settingsName').value.trim();
      const email=document.getElementById('settingsEmail').value.trim();
      if(!name||!email){alert('Please enter both name and email');return;}
      localStorage.setItem('user_name',name);
      localStorage.setItem('user_email',email);
      populateHeaderUser();
      alert('Profile saved');
    }

    /* simple POST helper */
    async function fetchJSON(url, bodyObj){
      const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(bodyObj||{})});
      const text=await res.text();
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}: ${text}`);
      try{return JSON.parse(text);}catch{return {};}
    }

    /* === Metrics === */
    async function loadAcuityMetrics(email){
      try{
        const data=await fetchJSON(NETLIFY_ENDPOINTS.acuity,{ userEmail: email });
        document.getElementById('totalBookings').textContent=data.totalBookings ?? 0;
        document.getElementById('totalSpending').textContent=fmtGBP(data.totalInvestment ?? 0);

        const list=document.getElementById('activityList');
        const appts=Array.isArray(data.appointments)?data.appointments.slice(0,5):[];
        appts.forEach(a=>{
          const when=a.datetime||a.time||a.date||'';
          const title=a.type||a.calendar||'Appointment';
          const row=document.createElement('div');
          row.className='activity-item';
          row.innerHTML=`<div class="activity-icon">■</div><div class="activity-content"><div class="activity-title">${title}</div><div class="activity-time">${when}</div></div>`;
          list.appendChild(row);
        });
      }catch(e){console.warn('Acuity metrics error:',e.message);}
    }

    async function loadAirtableProjectMetrics(email){
      try{
        const data=await fetchJSON(NETLIFY_ENDPOINTS.projects,{ userEmail: email });
        document.getElementById('completedProjects').textContent=data.completedProjects ?? 0;

        const list=document.getElementById('activityList');
        const projects=Array.isArray(data.projects)?data.projects.slice(0,5):[];
        projects.forEach(p=>{
          const f=p.fields||{};
          const title = f['A Project Address'] || f['Property'] || f['Title'] || 'Project';
          const status=f['Status']||'In progress';
          const row=document.createElement('div');
          row.className='activity-item';
          row.innerHTML=`<div class="activity-icon">✓</div><div class="activity-content"><div class="activity-title">${title}</div><div class="activity-time">Status: ${status}</div></div>`;
          list.appendChild(row);
        });
      }catch(e){console.warn('Airtable project metrics error:',e.message);}
    }

    async function loadMemberSince(email){
      try{
        const resp=await window.AirtableAPI.getUserData(email);
        if(resp?.success && resp.userData?.createdDate){
          const year=String(resp.userData.createdDate).slice(0,4);
          document.getElementById('memberSince').textContent=year; return;
        }
      }catch(e){console.warn('memberSince fetch err:',e.message);}
      document.getElementById('memberSince').textContent='2024';
    }

    async function loadDashboardData(){
      const user=window.AirtableAPI.getCurrentUser();
      if(!user?.email) return;

      const list=document.getElementById('activityList');
      list.innerHTML=`<div class="activity-item"><div class="activity-icon">+</div><div class="activity-content"><div class="activity-title">Signed in</div><div class="activity-time">${new Date().toLocaleString('en-GB')}</div></div></div>`;

      await Promise.all([
        loadAcuityMetrics(user.email),
        loadAirtableProjectMetrics(user.email),
        loadMemberSince(user.email),
      ]);
    }

    /* === Content Tracking (serverless) === */
    async function trackBooking() {
      const code = (document.getElementById('trackingInput').value || '').trim();
      const resultEl = document.getElementById('result');

      if (!code) {
        resultEl.innerHTML = '<div class="warning-message">⚠️ Please enter your tracking code to continue.</div>';
        return;
      }
      resultEl.innerHTML = '<div class="spinner"></div>';

      try {
        const res = await fetch(NETLIFY_ENDPOINTS.track, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trackingCode: code })
        });
        const data = await res.json();
        if (!res.ok || !data?.record) {
          resultEl.innerHTML = '<div class="error-message">❗ No booking found with that tracking code. Please check your code and try again.</div>';
          return;
        }

        const f = data.record;
        const stages = ['Booked','Editing','Quality Control','Ready for Delivery'];
        const icons  = ['📅','🎬','🔍','✅'];
        const idx = Math.max(0, stages.indexOf(f.status || ''));

        const progressPct = (idx / (stages.length - 1)) * 80 + 10;
        const shootDate = f.shootDate ? new Date(f.shootDate) : null;
        const fmtDate = (d)=> d ? `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}` : '-';

        let deadlineHTML = '';
        if (shootDate && (f.status === 'Editing' || f.status === 'Quality Control')) {
          const now = new Date();
          const start = new Date(shootDate); start.setDate(start.getDate()+1); start.setHours(0,0,0,0);
          const final = new Date(start.getTime() + (48*60*60*1000));
          const hrsLeft = Math.max(Math.floor((final - now)/(1000*60*60)), 0);
          const fmtFinal = `${String(final.getDate()).padStart(2,'0')}-${String(final.getMonth()+1).padStart(2,'0')}-${final.getFullYear()} ${String(final.getHours()).padStart(2,'0')}:00`;
          deadlineHTML = `
            <div class="deadline-alert">
              <div style="font-size:1.1em;margin-bottom:6px;">⏳ <strong>Delivery Timeline</strong></div>
              <div>Estimated completion: <strong>${hrsLeft} hours remaining</strong></div>
              <div>Expected delivery: <strong>${fmtFinal}</strong></div>
            </div>`;
        }

        const progressHTML = `
          <div class="progress-container">
            <div class="progress-line" style="width:${progressPct}%;"></div>
            ${stages.map((s,i)=>`
              <div class="progress-step ${i<=idx?'active':''}">
                <div class="icon">${icons[i]}</div>
                <div class="label">${s}</div>
              </div>`).join('')}
          </div>`;

        const deliveryHTML = (f.status === 'Ready for Delivery' && f.deliveryLink)
          ? `<div class="delivery-link">
               <div style="font-size:1.05em;margin-bottom:8px;">🎉 <strong>Your Content is Ready!</strong></div>
               <a href="${f.deliveryLink}" target="_blank" style="color:#065F46;text-decoration:none;font-weight:700;">📥 Download Your Files</a>
             </div>` : '';

        resultEl.innerHTML = `
          ${progressHTML}
          <div class="info-grid">
            <div class="info-item"><strong>🎯 Current Status:</strong><div style="margin-top:5px;color:#3B82F6;font-weight:700;">${f.status || '-'}</div></div>
            <div class="info-item"><strong>👤 Customer:</strong><div style="margin-top:5px;">${f.customerName || '-'}</div></div>
            <div class="info-item"><strong>🏷️ Service Type:</strong><div style="margin-top:5px;">${f.serviceType || '-'}</div></div>
            <div class="info-item"><strong>📅 Shoot Date:</strong><div style="margin-top:5px;">${fmtDate(shootDate)}</div></div>
            <div class="info-item"><strong>📍 Project Address:</strong><div style="margin-top:5px;">${f.projectAddress || '-'}</div></div>
          </div>
          ${deadlineHTML}
          ${deliveryHTML}
          <div style="text-align:center;margin-top:10px;"><a href="#" onclick="location.reload()" style="color:#334155;text-decoration:none;font-weight:600">🔁 Track another project</a></div>
        `;
      } catch (e) {
        console.error(e);
        resultEl.innerHTML = '<div class="error-message">❌ There was an error retrieving your tracking info. Please try again later.</div>';
      }
    }

    /* === Amend: Render endpoints + uploads === */
    let selectedFiles = [];
    const maxFileSize = 50 * 1024 * 1024;

    document.addEventListener('DOMContentLoaded', () => {
      const area = document.getElementById('fileUploadArea');
      const input = document.getElementById('fileInput');
      const browse = document.getElementById('browseButton');

      if (!area || !input || !browse) return;

      const stop = e => { e.preventDefault(); e.stopPropagation(); };

      ['dragenter','dragover','dragleave','drop'].forEach(evt => {
        area.addEventListener(evt, stop, false);
      });
      area.addEventListener('dragover', () => area.classList.add('dragover'));
      area.addEventListener('dragleave', () => area.classList.remove('dragover'));
      area.addEventListener('drop', e => { area.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });

      area.addEventListener('click', () => input.click());
      browse.addEventListener('click', e => { e.stopPropagation(); input.click(); });
      input.addEventListener('change', e => handleFiles(e.target.files));
    });

    function handleFiles(files){
      const list = Array.from(files);
      for (const f of list){
        if (f.size > maxFileSize){ alert(`File "${f.name}" is too large (max 50MB).`); continue; }
        if (selectedFiles.find(x => x.name===f.name && x.size===f.size)) { continue; }
        selectedFiles.push(f);
      }
      updateFilePreview();
    }

    function updateFilePreview(){
      const wrap = document.getElementById('filePreview');
      if (!wrap) return;
      if (selectedFiles.length === 0){ wrap.style.display='none'; wrap.innerHTML=''; return; }
      wrap.style.display='block';
      const icon = (t)=> t.startsWith('image/')?'🖼️':t.startsWith('video/')?'🎥':t.includes('pdf')?'📄':(t.includes('word')||t.includes('document'))?'📝':'📎';
      const size = (b)=>{ if(!b) return '0 B'; const k=1024, units=['B','KB','MB','GB']; const i=Math.floor(Math.log(b)/Math.log(k)); return (b/Math.pow(k,i)).toFixed(2)+' '+units[i]; };
      wrap.innerHTML = selectedFiles.map((f,i)=>`
        <div class="file-item">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:1.3em">${icon(f.type)}</div>
            <div>
              <div style="font-weight:600;color:#1F2E3C">${f.name}</div>
              <div style="font-size:.85em;color:#6B7280">${size(f.size)}</div>
            </div>
          </div>
          <button type="button" class="file-remove" onclick="removeFile(${i})">Remove</button>
        </div>
      `).join('');
    }

    function removeFile(i){
      selectedFiles.splice(i,1);
      updateFilePreview();
    }

    async function uploadFiles(){
      if (selectedFiles.length === 0) return [];
      const progress = document.getElementById('uploadProgress');
      const fill = document.getElementById('progressFill');
      const text = document.getElementById('progressText');
      progress.style.display='block';

      const out = [];
      for (let i=0;i<selectedFiles.length;i++){
        const fd = new FormData();
        fd.append('file', selectedFiles[i]);
        const r = await fetch('https://markeb-amend-api.onrender.com/api/upload',{ method:'POST', body: fd });
        if (!r.ok) throw new Error('Upload failed');
        const j = await r.json();
        out.push({ filename: selectedFiles[i].name, url: j.url, size: selectedFiles[i].size, type: selectedFiles[i].type });
        const pct = Math.round(((i+1)/selectedFiles.length)*100);
        fill.style.width=pct+'%'; text.textContent=pct+'%';
      }
      progress.style.display='none';
      return out;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const tc = document.querySelector('input[name="trackingCode"]');
      if (tc){
        tc.addEventListener('blur', ()=> checkTrackingCodeDeadline(tc.value.trim()));
      }
    });

    let isExpired=false;
    async function checkTrackingCodeDeadline(trackingCode){
      const statusDiv=document.getElementById('trackingStatus');
      const submitBtn=document.getElementById('submitBtn');
      if (!trackingCode) return;
      statusDiv.style.display='block';
      statusDiv.style.background='#eef2ff';
      statusDiv.style.border='1px solid #bfdbfe';
      statusDiv.style.color='#3730a3';
      statusDiv.textContent='🔍 Checking amendment eligibility...';

      try{
        const res=await fetch('https://markeb-amend-api.onrender.com/api/check-deadline',{
          method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({trackingCode})
        });
        const data=await res.json();
        if(!res.ok){
          statusDiv.style.background='#fee2e2'; statusDiv.style.border='1px solid #ef4444'; statusDiv.style.color='#991b1b';
          statusDiv.textContent='❌ '+(data.message||'Unable to verify tracking code');
          isExpired=true; submitBtn.disabled=true; submitBtn.textContent='⚠️ Not Eligible';
          return;
        }
        if(data.isExpired){
          statusDiv.style.display='none'; isExpired=true; submitBtn.disabled=true; submitBtn.textContent='⚠️ Amendment Window Expired';
        }else{
          statusDiv.style.display='none'; isExpired=false; submitBtn.disabled=false; submitBtn.textContent='📤 Submit Amendment Request';
        }
      }catch(err){
        statusDiv.style.background='#fee2e2'; statusDiv.style.border='1px solid #ef4444'; statusDiv.style.color='#991b1b';
        statusDiv.textContent='❌ Network error. Please try again.';
      }
    }

    document.getElementById('amendForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const form=e.target, btn=document.getElementById('submitBtn'), msg=document.getElementById('responseMessage');
      const trackingValue=form.trackingCode.value.trim();
      if(isExpired){ msg.style.display='block'; msg.className='response-message error'; msg.textContent='❌ The amendment window for this tracking code has expired.'; return; }
      if(!/^MK.*$/.test(trackingValue)){ alert('Tracking code must start with MK.'); form.trackingCode.focus(); return; }
      const mediaTypes=Array.from(form.querySelectorAll('input[name="mediaType"]:checked')).map(cb=>cb.value);
      if(mediaTypes.length===0){ alert('Please select at least one item that needs adjusting.'); return; }

      btn.disabled=true; btn.textContent='⏳ Submitting...'; msg.style.display='none';

      try{
        let uploaded = [];
        if (selectedFiles.length>0){
          btn.textContent='📤 Uploading files...';
          uploaded = await uploadFiles();
        }
        const payload={
          customerName:form.clientName.value.trim(),
          email:form.email.value.trim(),
          trackingCode:trackingValue,
          amendmentType:mediaTypes,
          amendmentDescription:form.amendDetails.value.trim(),
          attachments: uploaded
        };
        btn.textContent='⏳ Submitting request...';
        const r=await fetch('https://markeb-amend-api.onrender.com/api/amend',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j=await r.json();
        msg.style.display='block';
        if(r.ok){
          msg.className='response-message success';
          msg.textContent='✅ Thank you! Your amendment request has been submitted successfully.';
          form.reset(); selectedFiles=[]; updateFilePreview(); document.getElementById('trackingStatus').style.display='none';
        }else{
          msg.className='response-message error';
          msg.textContent='❌ '+(j.message||'Submission failed. Please try again.');
        }
      }catch(err){
        msg.style.display='block'; msg.className='response-message error'; msg.textContent='❌ Network error. Please check your connection and try again.';
      }
      btn.disabled=false; btn.textContent='📤 Submit Amendment Request'; msg.scrollIntoView({behavior:'smooth',block:'center'});
    });

    /* boot */
    document.addEventListener('DOMContentLoaded', async ()=>{
      const ok=await window.AirtableAPI.requireAuthentication();
      if(!ok) return;

      const u=window.AirtableAPI.getCurrentUser();
      if(u){ localStorage.setItem('user_email',u.email||''); if(u.name) localStorage.setItem('user_name',u.name); }

      populateHeaderUser();
      setDashboardGreeting();
      loadDashboardData();
    });

    function logoutAll(){
      if(window.AirtableAPI?.logoutUser){ AirtableAPI.logoutUser(); }
      else{ localStorage.clear(); window.location.href='../login.html'; }
    }

    /* Dynamic copyright year */
    (function(){
      const startYear = 2025;
      const currentYear = new Date().getFullYear();
      const yearText = (currentYear > startYear) ? `${startYear}–${currentYear}` : `${startYear}`;
      document.getElementById('footerCopyright').textContent = `© ${yearText} Markeb Media. All rights reserved.`;
    })();
  </script>

</body>
</html>