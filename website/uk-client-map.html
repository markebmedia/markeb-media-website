<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UK Client Map - Markeb Media</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      padding: 20px;
      color: #1e293b;
    }

    .map-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-content h1 {
      font-size: 32px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .header-subtitle {
      color: #64748b;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all .2s ease;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: #fff;
      color: #3b82f6;
      border: 2px solid #3b82f6;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 8px;
    }

    .stat-label {
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    .map-section {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .region-list {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      max-height: 600px;
      overflow-y: auto;
    }

    .region-list h3 {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .region-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      transition: background .2s ease;
    }

    .region-item:hover {
      background: #f8fafc;
    }

    .region-item:last-child {
      border-bottom: none;
    }

    .region-name {
      font-weight: 600;
      color: #0f172a;
      font-size: 14px;
    }

    .region-count {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    .region-item.active {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
    }

    .region-item.empty {
      opacity: 0.5;
    }

    .region-item.empty .region-count {
      background: #e2e8f0;
      color: #64748b;
    }

    #ukMap {
      width: 100%;
      height: 700px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .map-legend {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .map-legend h4 {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid #e2e8f0;
    }

    .loading-message {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .spinner {
      margin: 0 auto 20px;
      width: 50px;
      height: 50px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 20px;
      color: #991b1b;
      font-weight: 600;
      text-align: center;
      margin: 20px 0;
    }

    .filter-section {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .filter-section h4 {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 12px;
    }

    .filter-btn {
      width: 100%;
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      color: #0f172a;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
      margin-bottom: 8px;
    }

    .filter-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      border-color: #3b82f6;
    }

    @media (max-width: 1200px) {
      .content-grid {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: -1;
      }

      #ukMap {
        height: 500px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .header {
        padding: 20px;
      }

      .header-content h1 {
        font-size: 24px;
      }

      .stats-overview {
        grid-template-columns: 1fr;
      }

      .map-section {
        padding: 20px;
      }

      #ukMap {
        height: 400px;
      }

      .region-list {
        max-height: none;
      }
    }

    /* SVG Map Styles */
    .region-path {
      fill: #e2e8f0;
      stroke: #fff;
      stroke-width: 2;
      cursor: pointer;
      transition: all .2s ease;
    }

    .region-path:hover {
      fill: #cbd5e1;
    }

    .region-path.has-clients {
      fill: #93c5fd;
    }

    .region-path.has-clients:hover {
      fill: #60a5fa;
    }

    .region-path.active {
      fill: #3b82f6 !important;
      stroke: #1e40af;
      stroke-width: 3;
    }

    .region-label {
      font-size: 11px;
      font-weight: 600;
      fill: #475569;
      pointer-events: none;
      text-anchor: middle;
    }

    .client-marker {
      fill: #ef4444;
      stroke: #fff;
      stroke-width: 2;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
  </style>
</head>
<body>
  <div class="map-container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>üó∫Ô∏è UK Client Distribution Map</h1>
        <p class="header-subtitle">Visualise your client locations and identify growth opportunities</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='admin.html'">
          ‚¨ÖÔ∏è Back to Admin Panel
        </button>
        <button class="btn btn-primary" onclick="loadMapData()">
          üîÑ Refresh Data
        </button>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-value" id="totalClients">-</div>
        <div class="stat-label">Total Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="regionsWithClients">-</div>
        <div class="stat-label">Regions with Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="emptyRegions">-</div>
        <div class="stat-label">Opportunity Regions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="topRegion">-</div>
        <div class="stat-label">Top Region</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-grid">
      <!-- Map Section -->
      <div class="map-section">
        <div id="mapContainer">
          <div class="loading-message">
            <div class="spinner"></div>
            <p>Loading UK map data...</p>
          </div>
        </div>
        <svg id="ukMap" style="display: none;"></svg>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Filters -->
        <div class="filter-section">
          <h4>üîç Quick Filters</h4>
          <button class="filter-btn active" onclick="filterMap('all')">
            Show All Regions
          </button>
          <button class="filter-btn" onclick="filterMap('with-clients')">
            Regions with Clients
          </button>
          <button class="filter-btn" onclick="filterMap('opportunities')">
            Opportunity Regions
          </button>
        </div>

        <!-- Legend -->
        <div class="map-legend">
          <h4>üìä Map Legend</h4>
          <div class="legend-item">
            <div class="legend-color" style="background: #e2e8f0;"></div>
            <span>No clients</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #93c5fd;"></div>
            <span>Has clients</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #3b82f6;"></div>
            <span>Selected region</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ef4444; border-radius: 50%;"></div>
            <span>Client location</span>
          </div>
        </div>

        <!-- Region List -->
        <div class="region-list">
          <h3>
            Regions
            <span id="regionTotal" style="color: #64748b; font-size: 14px; font-weight: 500;">-</span>
          </h3>
          <div id="regionListContainer">
            <div class="loading-message">
              <p>Loading regions...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // UK Counties and Regions
    const UK_REGIONS = [
      // England - North West
      'Cheshire', 'Cumbria', 'Greater Manchester', 'Lancashire', 'Merseyside',
      // England - North East
      'County Durham', 'Northumberland', 'Tyne and Wear',
      // England - Yorkshire and the Humber
      'East Riding of Yorkshire', 'North Yorkshire', 'South Yorkshire', 'West Yorkshire',
      // England - East Midlands
      'Derbyshire', 'Leicestershire', 'Lincolnshire', 'Northamptonshire', 'Nottinghamshire', 'Rutland',
      // England - West Midlands
      'Herefordshire', 'Shropshire', 'Staffordshire', 'Warwickshire', 'West Midlands', 'Worcestershire',
      // England - East of England
      'Bedfordshire', 'Cambridgeshire', 'Essex', 'Hertfordshire', 'Norfolk', 'Suffolk',
      // England - South East
      'Berkshire', 'Buckinghamshire', 'East Sussex', 'Hampshire', 'Isle of Wight', 'Kent', 'Oxfordshire', 'Surrey', 'West Sussex',
      // England - South West
      'Bristol', 'Cornwall', 'Devon', 'Dorset', 'Gloucestershire', 'Somerset', 'Wiltshire',
      // England - London
      'Greater London',
      // Scotland
      'Aberdeenshire', 'Angus', 'Argyll and Bute', 'City of Edinburgh', 'Clackmannanshire', 
      'Dumfries and Galloway', 'Dundee City', 'East Ayrshire', 'East Dunbartonshire', 'East Lothian',
      'East Renfrewshire', 'Falkirk', 'Fife', 'Glasgow City', 'Highland', 'Inverclyde',
      'Midlothian', 'Moray', 'North Ayrshire', 'North Lanarkshire', 'Orkney Islands',
      'Perth and Kinross', 'Renfrewshire', 'Scottish Borders', 'Shetland Islands', 'South Ayrshire',
      'South Lanarkshire', 'Stirling', 'West Dunbartonshire', 'West Lothian', 'Western Isles',
      // Wales
      'Anglesey', 'Blaenau Gwent', 'Bridgend', 'Caerphilly', 'Cardiff', 'Carmarthenshire',
      'Ceredigion', 'Conwy', 'Denbighshire', 'Flintshire', 'Gwynedd', 'Merthyr Tydfil',
      'Monmouthshire', 'Neath Port Talbot', 'Newport', 'Pembrokeshire', 'Powys', 'Rhondda Cynon Taf',
      'Swansea', 'Torfaen', 'Vale of Glamorgan', 'Wrexham',
      // Northern Ireland
      'Antrim', 'Armagh', 'Down', 'Fermanagh', 'Londonderry', 'Tyrone'
    ].sort();

    let clientData = [];
    let regionCounts = {};
    let selectedRegion = null;
    let currentFilter = 'all';

    // Load map data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadMapData();
    });

    async function loadMapData() {
      const mapContainer = document.getElementById('mapContainer');
      const ukMap = document.getElementById('ukMap');
      
      mapContainer.style.display = 'block';
      ukMap.style.display = 'none';
      
      mapContainer.innerHTML = `
        <div class="loading-message">
          <div class="spinner"></div>
          <p>Loading UK map data...</p>
        </div>
      `;

      try {
        const response = await fetch('/.netlify/functions/admin-users', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Failed to load user data');
        }

        const data = await response.json();
        clientData = data.users || [];

        // Calculate region counts
        regionCounts = {};
        UK_REGIONS.forEach(region => {
          regionCounts[region] = 0;
        });

        clientData.forEach(user => {
          const region = user.fields['Region'];
          if (region && regionCounts.hasOwnProperty(region)) {
            regionCounts[region]++;
          }
        });

        // Update stats
        updateStats();

        // Render map and region list
        renderMap();
        renderRegionList();

      } catch (error) {
        console.error('Error loading map data:', error);
        mapContainer.innerHTML = `
          <div class="error-message">
            ‚ùå Failed to load map data: ${error.message}
            <br><br>
            <button class="btn btn-primary" onclick="loadMapData()">Try Again</button>
          </div>
        `;
      }
    }

    function updateStats() {
      const totalClients = clientData.filter(u => u.fields['Region']).length;
      const regionsWithClients = Object.values(regionCounts).filter(count => count > 0).length;
      const emptyRegions = UK_REGIONS.length - regionsWithClients;
      
      // Find top region
      let topRegion = '-';
      let maxCount = 0;
      for (const [region, count] of Object.entries(regionCounts)) {
        if (count > maxCount) {
          maxCount = count;
          topRegion = region;
        }
      }

      document.getElementById('totalClients').textContent = totalClients;
      document.getElementById('regionsWithClients').textContent = regionsWithClients;
      document.getElementById('emptyRegions').textContent = emptyRegions;
      document.getElementById('topRegion').textContent = maxCount > 0 ? topRegion : '-';
    }

    function renderMap() {
      const mapContainer = document.getElementById('mapContainer');
      const ukMap = document.getElementById('ukMap');
      
      mapContainer.style.display = 'none';
      ukMap.style.display = 'block';

      // Simplified UK map representation using regions
      const mapHTML = `
        <text x="50%" y="40" text-anchor="middle" class="region-label" style="font-size: 16px; font-weight: 700; fill: #0f172a;">
          United Kingdom Client Distribution
        </text>
        
        <!-- Simplified visual representation -->
        <g transform="translate(50, 80)">
          ${generateRegionBlocks()}
        </g>
      `;

      ukMap.innerHTML = mapHTML;
    }

    function generateRegionBlocks() {
      const blockWidth = 140;
      const blockHeight = 60;
      const gap = 10;
      const columns = 5;
      
      let blocks = '';
      UK_REGIONS.forEach((region, index) => {
        const col = index % columns;
        const row = Math.floor(index / columns);
        const x = col * (blockWidth + gap);
        const y = row * (blockHeight + gap);
        const count = regionCounts[region] || 0;
        
        const hasClients = count > 0;
        const fillColor = hasClients ? '#93c5fd' : '#e2e8f0';
        const textColor = hasClients ? '#1e40af' : '#64748b';

        blocks += `
          <g class="region-block" data-region="${region}" onclick="selectRegion('${region}')" style="cursor: pointer;">
            <rect 
              x="${x}" 
              y="${y}" 
              width="${blockWidth}" 
              height="${blockHeight}" 
              fill="${fillColor}" 
              stroke="#fff" 
              stroke-width="2" 
              rx="8"
              class="region-path ${hasClients ? 'has-clients' : ''}"
            />
            <text 
              x="${x + blockWidth/2}" 
              y="${y + blockHeight/2 - 8}" 
              text-anchor="middle" 
              class="region-label" 
              style="font-size: 10px; font-weight: 700; fill: ${textColor};"
            >
              ${region.length > 18 ? region.substring(0, 16) + '...' : region}
            </text>
            <text 
              x="${x + blockWidth/2}" 
              y="${y + blockHeight/2 + 10}" 
              text-anchor="middle" 
              style="font-size: 14px; font-weight: 700; fill: ${textColor};"
            >
              ${count} client${count !== 1 ? 's' : ''}
            </text>
          </g>
        `;
      });

      return blocks;
    }

    function renderRegionList() {
      const container = document.getElementById('regionListContainer');
      const regionTotal = document.getElementById('regionTotal');

      let visibleRegions = UK_REGIONS;
      
      if (currentFilter === 'with-clients') {
        visibleRegions = UK_REGIONS.filter(region => regionCounts[region] > 0);
      } else if (currentFilter === 'opportunities') {
        visibleRegions = UK_REGIONS.filter(region => regionCounts[region] === 0);
      }

      regionTotal.textContent = `${visibleRegions.length} of ${UK_REGIONS.length}`;

      const listHTML = visibleRegions.map(region => {
        const count = regionCounts[region] || 0;
        const isEmpty = count === 0;
        const isActive = selectedRegion === region;
        
        return `
          <div class="region-item ${isEmpty ? 'empty' : ''} ${isActive ? 'active' : ''}" onclick="selectRegion('${region}')">
            <span class="region-name">${region}</span>
            <span class="region-count">${count}</span>
          </div>
        `;
      }).join('');

      container.innerHTML = listHTML || '<p style="text-align: center; color: #64748b; padding: 20px;">No regions match this filter</p>';
    }

    function selectRegion(region) {
      selectedRegion = region;
      
      // Update visual highlighting
      document.querySelectorAll('.region-path').forEach(path => {
        path.classList.remove('active');
      });
      
      document.querySelectorAll(`[data-region="${region}"]`).forEach(el => {
        const rect = el.querySelector('.region-path');
        if (rect) rect.classList.add('active');
      });

      // Update region list highlighting
      document.querySelectorAll('.region-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const selectedItem = Array.from(document.querySelectorAll('.region-item')).find(
        item => item.textContent.includes(region)
      );
      if (selectedItem) {
        selectedItem.classList.add('active');
        selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // Show region details
      const count = regionCounts[region] || 0;
      const clients = clientData.filter(u => u.fields['Region'] === region);
      
      if (count > 0) {
        const clientNames = clients.map(c => c.fields['Name']).join(', ');
        console.log(`üìç ${region}: ${count} client${count !== 1 ? 's' : ''} - ${clientNames}`);
      } else {
        console.log(`üìç ${region}: Opportunity region - no clients yet`);
      }
    }

    function filterMap(filterType) {
      currentFilter = filterType;
      
      // Update button states
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Re-render region list with filter
      renderRegionList();
    }
  </script>
</body>
</html>