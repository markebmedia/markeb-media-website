<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UK Client Map - Markeb Media</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      padding: 20px;
      color: #0f172a;
    }

    .map-container { max-width: 1900px; margin: 0 auto; }

    .header {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-content h1 {
      font-size: 32px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-subtitle { color: #94a3b8; font-size: 14px; }
    .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all .2s ease;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border: 1px solid #60a5fa; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(59,130,246,0.5); }
    .btn-secondary { background: #1e293b; color: #60a5fa; border: 2px solid #334155; }
    .btn-secondary:hover { border-color: #60a5fa; background: #334155; }

    /* Data source toggle */
    .data-source-toggle {
      display: flex;
      gap: 0;
      background: #f1f5f9;
      border-radius: 12px;
      padding: 4px;
      border: 1px solid #e2e8f0;
      margin-bottom: 24px;
    }

    .ds-btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: #64748b;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all .2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
    }

    .ds-btn.active.clients { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
    .ds-btn.active.bookings { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: #fff; box-shadow: 0 2px 8px rgba(139,92,246,0.3); }

    /* Stats */
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
      text-align: center;
      transition: all .3s ease;
    }

    .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(59,130,246,0.15); border-color: #3b82f6; }
    .stat-card.booking-stat:hover { box-shadow: 0 8px 24px rgba(139,92,246,0.15); border-color: #8b5cf6; }

    .stat-value { font-size: 36px; font-weight: 700; color: #3b82f6; margin-bottom: 8px; }
    .stat-value.purple { color: #8b5cf6; }
    .stat-label { color: #94a3b8; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Layout */
    .content-grid {
      display: grid;
      grid-template-columns: 380px 1fr 340px;
      gap: 24px;
    }

    .map-section {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }

    #map {
      height: 720px;
      border-radius: 12px;
      border: 2px solid #334155;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }

    .sidebar { display: flex; flex-direction: column; gap: 20px; }

    .control-panel {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }

    .control-panel h3 { font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }

    .control-section { margin-bottom: 24px; }
    .control-section:last-child { margin-bottom: 0; }

    .control-label { font-size: 13px; font-weight: 600; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

    .view-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .view-btn {
      padding: 12px;
      border-radius: 8px;
      background: #f8fafc;
      color: #64748b;
      border: 2px solid #e2e8f0;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-family: 'Inter', sans-serif;
    }

    .view-btn:hover { border-color: #3b82f6; color: #3b82f6; }
    .view-btn.active { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border-color: #60a5fa; }

    .filter-btn {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #f8fafc;
      color: #64748b;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: 'Inter', sans-serif;
    }

    .filter-btn:hover { border-color: #3b82f6; color: #3b82f6; }
    .filter-btn.active { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; border-color: #60a5fa; }
    #bookingFilters .filter-btn.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-color: #a78bfa; }

    .filter-count { background: #e2e8f0; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; color: #64748b; }
    .filter-btn.active .filter-count { background: rgba(255,255,255,0.3); color: #fff; }

    .date-filter { display: flex; gap: 8px; margin-top: 8px; }

    .date-input {
      flex: 1;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      color: #0f172a;
      font-size: 12px;
      font-family: 'Inter', sans-serif;
    }

    .date-input:focus { outline: none; border-color: #3b82f6; }

    /* Region list */
    .region-list {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      border: 1px solid #334155;
      max-height: 580px;
      overflow-y: auto;
    }

    .region-list h3 { font-size: 16px; font-weight: 700; color: #e2e8f0; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }

    .region-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #1e293b;
      cursor: pointer;
      transition: all .2s ease;
      border-radius: 8px;
      margin-bottom: 2px;
    }

    .region-item:hover { background: #334155; }
    .region-name { font-weight: 600; color: #e2e8f0; font-size: 13px; }
    .region-sub { font-size: 11px; color: #10b981; margin-top: 2px; }

    .region-count { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; white-space: nowrap; }
    .region-count.booking { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .region-item.empty { opacity: 0.4; }
    .region-item.empty .region-count { background: #334155; color: #94a3b8; }
    .region-item.active { background: #1e293b; border-left: 3px solid #60a5fa; }

    /* Detail panel */
    .detail-panel {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      border: 1px solid #334155;
      max-height: 740px;
      overflow-y: auto;
    }

    .detail-panel h3 { font-size: 16px; font-weight: 700; color: #e2e8f0; margin-bottom: 16px; }

    .card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      transition: all .2s ease;
      cursor: pointer;
    }

    .card:hover { border-color: #60a5fa; transform: translateX(3px); }
    .card.booking:hover { border-color: #a78bfa; }

    .card-title { font-weight: 700; color: #e2e8f0; font-size: 14px; margin-bottom: 6px; }
    .card-info { font-size: 12px; color: #94a3b8; margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      margin-top: 6px;
      margin-right: 4px;
    }

    .badge-active { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid #10b981; }
    .badge-inactive { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid #ef4444; }
    .badge-confirmed { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid #10b981; }
    .badge-reserved { background: rgba(251,146,60,0.2); color: #fb923c; border: 1px solid #fb923c; }
    .badge-booked { background: rgba(59,130,246,0.2); color: #60a5fa; border: 1px solid #3b82f6; }
    .badge-completed { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid #10b981; }
    .badge-cancelled { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid #ef4444; }

    .revenue-total {
      background: rgba(16,185,129,0.1);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 8px;
      padding: 10px 14px;
      color: #10b981;
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .revenue-tag {
      display: inline-block;
      background: rgba(16,185,129,0.15);
      color: #10b981;
      border: 1px solid #10b981;
      padding: 2px 7px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      margin-top: 4px;
    }

    /* Legend */
    .map-legend {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #334155;
      margin-top: 16px;
    }

    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; color: #94a3b8; }
    .legend-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; border: 2px solid rgba(255,255,255,0.3); }

    /* Cluster */
    .marker-cluster-small { background: rgba(59,130,246,0.85); border: 3px solid #60a5fa; }
    .marker-cluster-medium { background: rgba(251,146,60,0.85); border: 3px solid #fb923c; }
    .marker-cluster-large { background: rgba(239,68,68,0.85); border: 3px solid #ef4444; }
    .marker-cluster-small.bk { background: rgba(139,92,246,0.85); border: 3px solid #a78bfa; }
    .marker-cluster-medium.bk { background: rgba(167,139,250,0.85); border: 3px solid #c4b5fd; }
    .marker-cluster-large.bk { background: rgba(196,181,253,0.85); border: 3px solid #ddd6fe; }
    .marker-cluster div { background: transparent; color: #fff; font-weight: 700; font-size: 13px; }

    /* Popups */
    .leaflet-popup-content-wrapper { background: #1e293b; color: #e2e8f0; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); border: 1px solid #334155; }
    .leaflet-popup-tip { background: #1e293b; }
    .leaflet-popup-content { margin: 14px; font-family: 'Inter', sans-serif; min-width: 220px; }
    .popup-title { font-size: 15px; font-weight: 700; color: #e2e8f0; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #334155; }
    .popup-row { font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
    .popup-footer { margin-top: 10px; padding-top: 10px; border-top: 1px solid #334155; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #60a5fa; }

    .spinner { margin: 40px auto 16px; width: 40px; height: 40px; border: 4px solid #334155; border-top-color: #60a5fa; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state { text-align: center; padding: 40px 20px; }
    .empty-state-text { font-size: 13px; color: #64748b; }

    @media (max-width: 1400px) {
      .content-grid { grid-template-columns: 1fr; }
      .sidebar { display: grid; grid-template-columns: 1fr 1fr; }
      #map { height: 600px; }
    }

    @media (max-width: 768px) {
      body { padding: 12px; }
      .stats-overview { grid-template-columns: 1fr 1fr; }
      .content-grid { grid-template-columns: 1fr; }
      .sidebar { grid-template-columns: 1fr; }
      #map { height: 400px; }
    }
  </style>
</head>
<body>
<div class="map-container">

  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1><i data-lucide="map" style="width:32px;height:32px;"></i> UK Distribution Map</h1>
      <p class="header-subtitle">Clients &amp; bookings geographic visualization</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="window.location.href='admin-panel.html'">
        <i data-lucide="arrow-left" style="width:16px;height:16px;"></i> Back to Admin
      </button>
      <button class="btn btn-primary" onclick="loadMapData()">
        <i data-lucide="refresh-cw" style="width:16px;height:16px;"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Data Source Toggle -->
  <div class="data-source-toggle">
    <button class="ds-btn active clients" id="dsClients" onclick="setDataSource('clients')">
      <i data-lucide="users" style="width:16px;height:16px;"></i> Clients
    </button>
    <button class="ds-btn" id="dsBookings" onclick="setDataSource('bookings')">
      <i data-lucide="calendar-check" style="width:16px;height:16px;"></i> Bookings
    </button>
  </div>

  <!-- Client Stats -->
  <div class="stats-overview" id="clientStats">
    <div class="stat-card">
      <div class="stat-value" id="totalClients">-</div>
      <div class="stat-label">Total Clients</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="regionsWithClients">-</div>
      <div class="stat-label">Regions Covered</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="emptyRegions">-</div>
      <div class="stat-label">Opportunities</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="topRegion">-</div>
      <div class="stat-label">Top Region</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="clientGrowth">-</div>
      <div class="stat-label">30-Day Growth</div>
    </div>
  </div>

  <!-- Booking Stats -->
  <div class="stats-overview" id="bookingStats" style="display:none;">
    <div class="stat-card booking-stat">
      <div class="stat-value purple" id="totalBookings">-</div>
      <div class="stat-label">Total Bookings</div>
    </div>
    <div class="stat-card booking-stat">
      <div class="stat-value purple" id="confirmedBookings">-</div>
      <div class="stat-label">Confirmed</div>
    </div>
    <div class="stat-card booking-stat">
      <div class="stat-value purple" id="reservedBookings">-</div>
      <div class="stat-label">Reserved</div>
    </div>
    <div class="stat-card booking-stat">
      <div class="stat-value purple" id="totalRevenue">-</div>
      <div class="stat-label">Total Revenue</div>
    </div>
    <div class="stat-card booking-stat">
      <div class="stat-value purple" id="bookingGrowth">-</div>
      <div class="stat-label">30-Day Bookings</div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="content-grid">

    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="control-panel">
        <h3><i data-lucide="settings" style="width:18px;height:18px;"></i> Map Controls</h3>

        <!-- View mode -->
        <div class="control-section">
          <div class="control-label">View Mode</div>
          <div class="view-toggle">
            <button class="view-btn active" id="viewMarkers" onclick="setViewMode('markers')">
              <i data-lucide="map-pin" style="width:15px;height:15px;"></i> Markers
            </button>
            <button class="view-btn" id="viewHeatmap" onclick="setViewMode('heatmap')">
              <i data-lucide="flame" style="width:15px;height:15px;"></i> Heat Map
            </button>
          </div>
        </div>

        <!-- Client filters -->
        <div class="control-section" id="clientFilters">
          <div class="control-label">Filter</div>
          <button class="filter-btn active" onclick="filterClients('all', event)">
            <span>All Clients</span><span class="filter-count" id="cAll">-</span>
          </button>
          <button class="filter-btn" onclick="filterClients('active', event)">
            <span>Active Only</span><span class="filter-count" id="cActive">-</span>
          </button>
          <button class="filter-btn" onclick="filterClients('with-clients', event)">
            <span>Regions With Clients</span><span class="filter-count" id="cWithClients">-</span>
          </button>
        </div>

        <!-- Booking filters -->
        <div class="control-section" id="bookingFilters" style="display:none;">
          <div class="control-label">Booking Status</div>
          <button class="filter-btn active" onclick="filterBookings('all', event)">
            <span>All Bookings</span><span class="filter-count" id="bAll">-</span>
          </button>
          <button class="filter-btn" onclick="filterBookings('Confirmed', event)">
            <span>Confirmed</span><span class="filter-count" id="bConfirmed">-</span>
          </button>
          <button class="filter-btn" onclick="filterBookings('Reserved', event)">
            <span>Reserved</span><span class="filter-count" id="bReserved">-</span>
          </button>
          <button class="filter-btn" onclick="filterBookings('Cancelled', event)">
            <span>Cancelled</span><span class="filter-count" id="bCancelled">-</span>
          </button>
        </div>

        <!-- Date range -->
        <div class="control-section">
          <div class="control-label">Date Range</div>
          <div class="date-filter">
            <input type="date" class="date-input" id="dateFrom" onchange="applyDateFilter()">
            <input type="date" class="date-input" id="dateTo" onchange="applyDateFilter()">
          </div>
        </div>

        <!-- Legend -->
        <div class="control-section">
          <div class="control-label">Legend</div>
          <div class="map-legend" id="clientLegend">
            <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> Client marker</div>
            <div class="legend-item"><div class="legend-dot" style="background:#3b82f6;border-radius:4px;"></div> Small cluster (2‚Äì10)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#fb923c;border-radius:4px;"></div> Medium (10‚Äì20)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ef4444;border-radius:4px;"></div> Large (20+)</div>
          </div>
          <div class="map-legend" id="bookingLegend" style="display:none;">
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> Booking (exact postcode)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#10b981;"></div> Confirmed</div>
            <div class="legend-item"><div class="legend-dot" style="background:#fb923c;"></div> Reserved</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> Cancelled</div>
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;border-radius:4px;"></div> Cluster</div>
          </div>
        </div>
      </div>

      <!-- Region list (clients mode) / Postcode summary (bookings mode) -->
      <div class="region-list" id="regionListPanel">
        <h3>
          <span id="regionListTitle">Regions</span>
          <span id="regionTotal" style="color:#94a3b8;font-size:13px;font-weight:500;">-</span>
        </h3>
        <div id="regionListContainer">
          <div style="text-align:center;padding:40px 20px;color:#94a3b8;">
            <div class="spinner"></div>
            <p>Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Map -->
    <div class="map-section">
      <div id="map"></div>
    </div>

    <!-- Detail Panel -->
    <div class="sidebar">
      <div class="detail-panel" id="detailPanel">
        <h3 id="detailTitle">All Clients</h3>
        <div id="detailContent">
          <div class="empty-state">
            <div class="spinner"></div>
            <p class="empty-state-text">Loading data...</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ‚îÄ‚îÄ Region coords (for client mode only) ‚îÄ‚îÄ
  const REGION_COORDS = {
    'Cheshire East': [53.1603, -2.2119], 'Cheshire West and Chester': [53.1905, -2.8909],
    'Greater London': [51.5074, -0.1278], 'Greater Manchester': [53.4808, -2.2426],
    'Essex': [51.7341, 0.4700], 'West Midlands': [52.4862, -1.8904],
    'Leicestershire': [52.6369, -1.1398], 'South Yorkshire': [53.5400, -1.3500],
    'West Yorkshire': [53.7900, -1.7500], 'North Yorkshire': [54.2766, -1.4090],
    'East Riding of Yorkshire': [53.8429, -0.4380], 'York': [53.9600, -1.0873],
    'Cumbria': [54.5772, -2.7974], 'Lancashire': [53.7632, -2.7044],
    'Merseyside': [53.4106, -2.9779], 'Blackburn with Darwen': [53.7480, -2.4820],
    'Blackpool': [53.8175, -3.0357], 'Halton': [53.3340, -2.7350],
    'Warrington': [53.3900, -2.5970], 'County Durham': [54.7753, -1.5849],
    'Northumberland': [55.2083, -2.0784], 'Tyne and Wear': [54.9783, -1.6178],
    'Derbyshire': [53.1235, -1.5650], 'Derby': [52.9219, -1.4746],
    'Herefordshire': [52.0564, -2.7160], 'Lincolnshire': [53.2307, -0.5406],
    'Northamptonshire': [52.2700, -0.8700], 'Nottinghamshire': [53.1000, -0.9900],
    'Nottingham': [52.9548, -1.1581], 'Rutland': [52.6558, -0.6389],
    'Shropshire': [52.7069, -2.7464], 'Telford and Wrekin': [52.6766, -2.4469],
    'Staffordshire': [52.8700, -2.0800], 'Stoke-on-Trent': [53.0027, -2.1794],
    'Warwickshire': [52.2819, -1.5849], 'Worcestershire': [52.2500, -2.2200],
    'Bedford': [52.1363, -0.4667], 'Central Bedfordshire': [52.0029, -0.2982],
    'Cambridgeshire': [52.2053, 0.1218], 'Peterborough': [52.5695, -0.2405],
    'Hertfordshire': [51.8090, -0.2376], 'Norfolk': [52.6295, 0.7100],
    'Suffolk': [52.1872, 0.9708], 'Berkshire': [51.4543, -1.0000],
    'Brighton and Hove': [50.8225, -0.1372], 'Buckinghamshire': [51.8133, -0.8084],
    'East Sussex': [50.9085, 0.2500], 'Hampshire': [51.0577, -1.3081],
    'Portsmouth': [50.8198, -1.0880], 'Southampton': [50.9097, -1.4044],
    'Isle of Wight': [50.6938, -1.3047], 'Kent': [51.2787, 0.5217],
    'Medway': [51.4021, 0.5501], 'Oxfordshire': [51.7612, -1.2500],
    'Surrey': [51.3148, -0.5600], 'West Sussex': [50.9200, -0.6000],
    'Bath and North East Somerset': [51.3811, -2.3590], 'Bournemouth, Christchurch and Poole': [50.7192, -1.8808],
    'Bristol': [51.4545, -2.5879], 'Cornwall': [50.2660, -5.0527],
    'Devon': [50.7184, -3.5339], 'Plymouth': [50.3755, -4.1427],
    'Torbay': [50.4619, -3.5253], 'Dorset': [50.7480, -2.3440],
    'Gloucestershire': [51.8642, -2.2381], 'North Somerset': [51.3877, -2.7780],
    'Somerset': [51.1054, -2.9260], 'South Gloucestershire': [51.5260, -2.4729],
    'Swindon': [51.5558, -1.7797], 'Wiltshire': [51.3493, -1.9927],
    'Aberdeen City': [57.1497, -2.0943], 'City of Edinburgh': [55.9533, -3.1883],
    'Glasgow City': [55.8642, -4.2518], 'Highland': [57.4778, -4.2247],
    'Cardiff': [51.4816, -3.1791], 'Swansea': [51.6214, -3.9436],
    'Belfast': [54.5973, -5.9301]
  };

  const UK_REGIONS = Object.keys(REGION_COORDS).sort();

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  let clientData = [];
  let filteredClientData = [];
  let bookingData = [];
  let filteredBookingData = [];
  let regionCounts = {};

  let map, markerCluster, heatLayer;
  let currentDataSource = 'clients';
  let currentViewMode = 'markers';

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', () => {
    initMap();
    initDateFilters();
    loadMapData();
    lucide.createIcons();
  });

  function initMap() {
    map = L.map('map').setView([54.0, -2.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors', maxZoom: 18, minZoom: 5
    }).addTo(map);
    resetCluster();
  }

  function resetCluster() {
    if (markerCluster) map.removeLayer(markerCluster);
    const isBookings = currentDataSource === 'bookings';
    markerCluster = L.markerClusterGroup({
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      spiderfyOnMaxZoom: true,
      iconCreateFunction: function(cluster) {
        const count = cluster.getChildCount();
        const size = count >= 20 ? 'large' : count >= 10 ? 'medium' : 'small';
        const extra = isBookings ? ' bk' : '';
        return L.divIcon({
          html: '<div><span>' + count + '</span></div>',
          className: 'marker-cluster marker-cluster-' + size + extra,
          iconSize: L.point(40, 40)
        });
      }
    });
  }

  function initDateFilters() {
    const today = new Date();
    const yearAgo = new Date();
    yearAgo.setFullYear(today.getFullYear() - 1);
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = yearAgo.toISOString().split('T')[0];
  }

  // ‚îÄ‚îÄ Load Data ‚îÄ‚îÄ
  async function loadMapData() {
    try {
      const [usersRes, bookingsRes] = await Promise.all([
        fetch('/.netlify/functions/admin-users'),
        fetch('/.netlify/functions/get-all-bookings')
      ]);

      if (!usersRes.ok) throw new Error('Failed to load user data');
      if (!bookingsRes.ok) throw new Error('Failed to load booking data');

      const userData = await usersRes.json();
      const bData = await bookingsRes.json();

      clientData = userData.users || [];
      filteredClientData = [...clientData];
      bookingData = bData.bookings || [];
      filteredBookingData = [...bookingData];

      buildRegionCounts();
      updateClientStats();
      updateBookingStats(bData.meta || {});
      updateClientFilterCounts();
      updateBookingFilterCounts();
      addMarkersToMap();
      renderRegionList();
      renderDetailPanel();

    } catch (err) {
      console.error('Error loading map data:', err);
      alert('Failed to load map data: ' + err.message);
    }
  }

  function buildRegionCounts() {
    regionCounts = {};
    UK_REGIONS.forEach(r => regionCounts[r] = 0);
    clientData.forEach(u => {
      const r = u.fields['Region'];
      if (r && regionCounts.hasOwnProperty(r)) regionCounts[r]++;
    });
  }

  // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
  function updateClientStats() {
    const total = clientData.filter(u => u.fields['Region']).length;
    const covered = Object.values(regionCounts).filter(c => c > 0).length;
    let top = '-', max = 0;
    for (const [r, c] of Object.entries(regionCounts)) { if (c > max) { max = c; top = r; } }
    const ago = new Date(); ago.setDate(ago.getDate() - 30);
    const recent = clientData.filter(u => new Date(u.fields['Created Date']) >= ago).length;

    document.getElementById('totalClients').textContent = total;
    document.getElementById('regionsWithClients').textContent = covered;
    document.getElementById('emptyRegions').textContent = UK_REGIONS.length - covered;
    document.getElementById('topRegion').textContent = max > 0 ? top : '-';
    document.getElementById('clientGrowth').textContent = `+${recent}`;
  }

  function updateBookingStats(meta) {
    document.getElementById('totalBookings').textContent = meta.total || 0;
    document.getElementById('confirmedBookings').textContent = meta.confirmed || 0;
    document.getElementById('reservedBookings').textContent = meta.reserved || 0;
    document.getElementById('totalRevenue').textContent = meta.totalRevenue ? `¬£${meta.totalRevenue.toLocaleString()}` : '¬£0';
    document.getElementById('bookingGrowth').textContent = `+${meta.recentBookings || 0}`;
  }

  function updateClientFilterCounts() {
    document.getElementById('cAll').textContent = clientData.length;
    document.getElementById('cActive').textContent = clientData.filter(u => u.fields['Account Status'] === 'Active').length;
    document.getElementById('cWithClients').textContent = Object.values(regionCounts).filter(c => c > 0).length;
  }

  function updateBookingFilterCounts() {
    document.getElementById('bAll').textContent = bookingData.length;
    document.getElementById('bConfirmed').textContent = bookingData.filter(b => b.bookingStatus === 'Confirmed').length;
    document.getElementById('bReserved').textContent = bookingData.filter(b => b.bookingStatus === 'Reserved').length;
    document.getElementById('bCancelled').textContent = bookingData.filter(b => b.bookingStatus === 'Cancelled').length;
  }

  // ‚îÄ‚îÄ Data Source Toggle ‚îÄ‚îÄ
  function setDataSource(source) {
    currentDataSource = source;
    const isBookings = source === 'bookings';

    document.getElementById('dsClients').className = `ds-btn${!isBookings ? ' active clients' : ''}`;
    document.getElementById('dsBookings').className = `ds-btn${isBookings ? ' active bookings' : ''}`;

    document.getElementById('clientStats').style.display = isBookings ? 'none' : 'grid';
    document.getElementById('bookingStats').style.display = isBookings ? 'grid' : 'none';
    document.getElementById('clientFilters').style.display = isBookings ? 'none' : 'block';
    document.getElementById('bookingFilters').style.display = isBookings ? 'block' : 'none';
    document.getElementById('clientLegend').style.display = isBookings ? 'none' : 'block';
    document.getElementById('bookingLegend').style.display = isBookings ? 'block' : 'none';
    document.getElementById('regionListTitle').textContent = isBookings ? 'Bookings by Area' : 'Regions';

    // Reset filters
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    const firstBtn = document.querySelector(`#${isBookings ? 'booking' : 'client'}Filters .filter-btn`);
    if (firstBtn) firstBtn.classList.add('active');

    if (isBookings) filteredBookingData = [...bookingData];
    else filteredClientData = [...clientData];

    resetCluster();
    addMarkersToMap();
    renderRegionList();
    renderDetailPanel();
    lucide.createIcons();
  }

  // ‚îÄ‚îÄ Map Rendering ‚îÄ‚îÄ
  function addMarkersToMap() {
    if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
    markerCluster.clearLayers();

    if (currentDataSource === 'clients') renderClientLayer();
    else renderBookingLayer();
  }

  function renderClientLayer() {
    if (currentViewMode === 'markers') {
      filteredClientData.forEach(user => {
        const region = user.fields['Region'];
        if (!region || !REGION_COORDS[region]) return;
        const [lat, lng] = REGION_COORDS[region];
        const jLat = lat + (Math.random() - 0.5) * 0.06;
        const jLng = lng + (Math.random() - 0.5) * 0.06;

        const icon = L.divIcon({
          className: '',
          html: `<div style="background:linear-gradient(135deg,#ef4444,#dc2626);border:3px solid #fff;border-radius:50%;width:22px;height:22px;box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>`,
          iconSize: [22, 22], iconAnchor: [11, 11]
        });

        const m = L.marker([jLat, jLng], { icon });
        m.bindPopup(`
          <div class="popup-title">${user.fields['Name'] || 'Client'}</div>
          <div class="popup-row">üè¢ ${user.fields['Company'] || 'N/A'}</div>
          <div class="popup-row">‚úâÔ∏è ${user.fields['Email'] || 'N/A'}</div>
          <div class="popup-row">üìç ${region}</div>
          <div class="popup-footer">
            <span class="badge badge-${(user.fields['Account Status'] || 'inactive').toLowerCase()}">${user.fields['Account Status'] || 'Unknown'}</span>
          </div>
        `);
        markerCluster.addLayer(m);
      });
      map.addLayer(markerCluster);

    } else {
      // Heatmap
      const heatData = UK_REGIONS
        .filter(r => regionCounts[r] > 0 && REGION_COORDS[r])
        .map(r => [...REGION_COORDS[r], regionCounts[r] / 10]);

      heatLayer = L.heatLayer(heatData, {
        radius: 40, blur: 50, maxZoom: 10,
        gradient: { 0.0: '#3b82f6', 0.5: '#fb923c', 1.0: '#ef4444' }
      }).addTo(map);
    }
  }

  function renderBookingLayer() {
    if (currentViewMode === 'markers') {
      let plotted = 0;
      filteredBookingData.forEach(booking => {
        // Only plot if we have exact coords from postcode geocoding
        if (!booking.lat || !booking.lng) return;
        plotted++;

        const statusColor = { 'Confirmed': '#10b981', 'Reserved': '#fb923c', 'Cancelled': '#ef4444' }[booking.bookingStatus] || '#8b5cf6';

        const icon = L.divIcon({
          className: '',
          html: `<div style="background:${statusColor};border:3px solid #fff;border-radius:50%;width:18px;height:18px;box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>`,
          iconSize: [18, 18], iconAnchor: [9, 9]
        });

        const isUpcoming = booking.date && new Date(booking.date) >= new Date();
        const m = L.marker([booking.lat, booking.lng], { icon });
        m.bindPopup(`
          <div class="popup-title">${booking.bookingRef || 'Booking'}</div>
          <div class="popup-row">üë§ ${booking.clientName || 'N/A'}</div>
          <div class="popup-row">üè† ${booking.propertyAddress || booking.postcode || 'N/A'}</div>
          <div class="popup-row">üé¨ ${booking.service || 'N/A'}</div>
          <div class="popup-row">üìÖ ${formatDate(booking.date)}${booking.time ? ' at ' + booking.time : ''}</div>
          ${booking.mediaSpecialist ? `<div class="popup-row">üì∏ ${booking.mediaSpecialist}</div>` : ''}
          <div class="popup-footer">
            <span class="badge badge-${(booking.bookingStatus || '').toLowerCase()}">${booking.bookingStatus || 'Unknown'}</span>
            ${isUpcoming ? '<span class="badge" style="background:rgba(59,130,246,0.2);color:#60a5fa;border:1px solid #3b82f6;">Upcoming</span>' : ''}
            ${booking.finalPrice ? `<span class="badge" style="background:rgba(16,185,129,0.15);color:#10b981;border:1px solid #10b981;">¬£${parseFloat(booking.finalPrice).toFixed(2)}</span>` : ''}
          </div>
        `);
        markerCluster.addLayer(m);
      });

      console.log(`Plotted ${plotted} of ${filteredBookingData.length} bookings`);
      map.addLayer(markerCluster);

    } else {
      // Heatmap using exact coords
      const heatData = filteredBookingData
        .filter(b => b.lat && b.lng)
        .map(b => [b.lat, b.lng, 0.5]);

      heatLayer = L.heatLayer(heatData, {
        radius: 35, blur: 45, maxZoom: 12,
        gradient: { 0.0: '#8b5cf6', 0.5: '#a78bfa', 1.0: '#c4b5fd' }
      }).addTo(map);
    }
  }

  // ‚îÄ‚îÄ Controls ‚îÄ‚îÄ
  function setViewMode(mode) {
    currentViewMode = mode;
    document.getElementById('viewMarkers').classList.toggle('active', mode === 'markers');
    document.getElementById('viewHeatmap').classList.toggle('active', mode === 'heatmap');
    addMarkersToMap();
  }

  function filterClients(type, e) {
    document.querySelectorAll('#clientFilters .filter-btn').forEach(b => b.classList.remove('active'));
    if (e) e.target.closest('.filter-btn').classList.add('active');

    if (type === 'active') filteredClientData = clientData.filter(u => u.fields['Account Status'] === 'Active');
    else filteredClientData = [...clientData];

    addMarkersToMap();
    renderRegionList();
    renderDetailPanel();
  }

  function filterBookings(status, e) {
    document.querySelectorAll('#bookingFilters .filter-btn').forEach(b => b.classList.remove('active'));
    if (e) e.target.closest('.filter-btn').classList.add('active');

    filteredBookingData = status === 'all' ? [...bookingData] : bookingData.filter(b => b.bookingStatus === status);
    addMarkersToMap();
    renderRegionList();
    renderDetailPanel();
  }

  function applyDateFilter() {
    const from = document.getElementById('dateFrom').value;
    const to = document.getElementById('dateTo').value;
    if (!from || !to) return;

    const dFrom = new Date(from);
    const dTo = new Date(to); dTo.setHours(23, 59, 59);

    if (currentDataSource === 'clients') {
      filteredClientData = clientData.filter(u => {
        const d = new Date(u.fields['Created Date']);
        return d >= dFrom && d <= dTo;
      });
    } else {
      filteredBookingData = bookingData.filter(b => {
        const d = new Date(b.date || b.createdTime);
        return d >= dFrom && d <= dTo;
      });
    }

    addMarkersToMap();
    renderRegionList();
    renderDetailPanel();
  }

  // ‚îÄ‚îÄ Region List ‚îÄ‚îÄ
  function renderRegionList() {
    const container = document.getElementById('regionListContainer');
    const regionTotal = document.getElementById('regionTotal');

    if (currentDataSource === 'clients') {
      const rows = UK_REGIONS.map(r => {
        const count = regionCounts[r] || 0;
        return `
          <div class="region-item ${count === 0 ? 'empty' : ''}" onclick="flyToRegion('${r}', event)">
            <div class="region-name">${r}</div>
            <span class="region-count">${count}</span>
          </div>`;
      }).join('');
      regionTotal.textContent = `${Object.values(regionCounts).filter(c => c > 0).length} active`;
      container.innerHTML = rows;

    } else {
      // For bookings: group by postcode area (first half of postcode)
      const areaCounts = {};
      const areaRevenue = {};
      filteredBookingData.forEach(b => {
        if (!b.postcode) return;
        const area = b.postcode.split(' ')[0].toUpperCase();
        areaCounts[area] = (areaCounts[area] || 0) + 1;
        areaRevenue[area] = (areaRevenue[area] || 0) + (parseFloat(b.finalPrice) || 0);
      });

      const sorted = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]);
      regionTotal.textContent = `${sorted.length} areas`;

      if (sorted.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-text">No bookings to display</div></div>`;
        return;
      }

      container.innerHTML = sorted.map(([area, count]) => `
        <div class="region-item" onclick="flyToPostcodeArea('${area}', event)">
          <div>
            <div class="region-name">${area}</div>
            ${areaRevenue[area] > 0 ? `<div class="region-sub">¬£${areaRevenue[area].toFixed(2)}</div>` : ''}
          </div>
          <span class="region-count booking">${count}</span>
        </div>
      `).join('');
    }
  }

  function flyToRegion(region, e) {
    if (REGION_COORDS[region]) {
      map.flyTo(REGION_COORDS[region], 10, { duration: 1.5 });
      showClientsInRegion(region);
    }
    document.querySelectorAll('.region-item').forEach(i => i.classList.remove('active'));
    if (e) e.target.closest('.region-item').classList.add('active');
  }

  function flyToPostcodeArea(area, e) {
    // Find first booking in this area with coords and fly there
    const booking = filteredBookingData.find(b => b.postcode && b.postcode.toUpperCase().startsWith(area) && b.lat);
    if (booking) {
      map.flyTo([booking.lat, booking.lng], 12, { duration: 1.5 });
    }
    showBookingsInArea(area);
    document.querySelectorAll('.region-item').forEach(i => i.classList.remove('active'));
    if (e) e.target.closest('.region-item').classList.add('active');
  }

  // ‚îÄ‚îÄ Detail Panel ‚îÄ‚îÄ
  function renderDetailPanel() {
    if (currentDataSource === 'clients') showAllClients();
    else showAllBookings();
  }

  function showAllClients() {
    document.getElementById('detailTitle').textContent = `All Clients (${filteredClientData.length})`;
    const items = filteredClientData.filter(u => u.fields['Region']).slice(0, 50);
    document.getElementById('detailContent').innerHTML = items.length === 0
      ? `<div class="empty-state"><div class="empty-state-text">No clients found</div></div>`
      : items.map(c => clientCard(c)).join('') + (filteredClientData.length > 50 ? `<div style="text-align:center;padding:16px;color:#64748b;font-size:12px;">Showing 50 of ${filteredClientData.length}</div>` : '');
  }

  function showAllBookings() {
    const geocoded = filteredBookingData.filter(b => b.lat).length;
    const total = filteredBookingData.length;
    const totalRevenue = filteredBookingData.reduce((s, b) => s + (parseFloat(b.finalPrice) || 0), 0);
    document.getElementById('detailTitle').textContent = `Bookings (${total})`;

    const revenueHtml = totalRevenue > 0
      ? `<div class="revenue-total">Total Revenue: ¬£${totalRevenue.toFixed(2)}</div>`
      : '';
    const geocodeNote = `<div style="font-size:11px;color:#64748b;margin-bottom:12px;">üìç ${geocoded} of ${total} plotted on map</div>`;

    const items = filteredBookingData.slice(0, 50);
    document.getElementById('detailContent').innerHTML = revenueHtml + geocodeNote
      + (items.length === 0
        ? `<div class="empty-state"><div class="empty-state-text">No bookings found</div></div>`
        : items.map(b => bookingCard(b)).join(''))
      + (filteredBookingData.length > 50 ? `<div style="text-align:center;padding:16px;color:#64748b;font-size:12px;">Showing 50 of ${filteredBookingData.length}</div>` : '');
  }

  function showClientsInRegion(region) {
    const clients = filteredClientData.filter(u => u.fields['Region'] === region);
    document.getElementById('detailTitle').textContent = `${region} (${clients.length})`;
    document.getElementById('detailContent').innerHTML = clients.length === 0
      ? `<div class="empty-state"><div class="empty-state-text">No clients in ${region}</div></div>`
      : clients.map(c => clientCard(c)).join('');
  }

  function showBookingsInArea(area) {
    const bookings = filteredBookingData.filter(b => b.postcode && b.postcode.toUpperCase().startsWith(area));
    const totalRevenue = bookings.reduce((s, b) => s + (parseFloat(b.finalPrice) || 0), 0);
    document.getElementById('detailTitle').textContent = `${area} ‚Äî ${bookings.length} bookings`;
    const revenueHtml = totalRevenue > 0 ? `<div class="revenue-total">Revenue: ¬£${totalRevenue.toFixed(2)}</div>` : '';
    document.getElementById('detailContent').innerHTML = revenueHtml
      + (bookings.length === 0
        ? `<div class="empty-state"><div class="empty-state-text">No bookings in ${area}</div></div>`
        : bookings.map(b => bookingCard(b)).join(''));
  }

  // ‚îÄ‚îÄ Card Templates ‚îÄ‚îÄ
  function clientCard(c) {
    const status = c.fields['Account Status'] || 'Unknown';
    return `
      <div class="card" onclick="flyToRegion('${c.fields['Region']}', event)">
        <div class="card-title">${c.fields['Name'] || 'Client'}</div>
        <div class="card-info">üè¢ ${c.fields['Company'] || 'N/A'}</div>
        <div class="card-info">üìç ${c.fields['Region'] || 'N/A'}</div>
        <div class="card-info">üìÖ ${formatDate(c.fields['Created Date'])}</div>
        <span class="badge badge-${status.toLowerCase()}">${status}</span>
      </div>`;
  }

  function bookingCard(b) {
    const status = b.bookingStatus || 'Unknown';
    const isUpcoming = b.date && new Date(b.date) >= new Date();
    return `
      <div class="card booking">
        <div class="card-title">${b.bookingRef || 'Booking'}</div>
        <div class="card-info">üë§ ${b.clientName || 'N/A'}</div>
        <div class="card-info">üè† ${b.propertyAddress || b.postcode || 'N/A'}</div>
        <div class="card-info">üé¨ ${b.service || 'N/A'}</div>
        <div class="card-info">üìÖ ${formatDate(b.date)}${b.time ? ' at ' + b.time : ''}</div>
        ${b.mediaSpecialist ? `<div class="card-info">üì∏ ${b.mediaSpecialist}</div>` : ''}
        <span class="badge badge-${status.toLowerCase()}">${status}</span>
        ${isUpcoming ? '<span class="badge" style="background:rgba(59,130,246,0.2);color:#60a5fa;border:1px solid #3b82f6;">Upcoming</span>' : ''}
        ${b.finalPrice ? `<span class="revenue-tag">¬£${parseFloat(b.finalPrice).toFixed(2)}</span>` : ''}
        ${!b.lat ? '<div style="font-size:10px;color:#64748b;margin-top:4px;">‚ö†Ô∏è Postcode not geocoded</div>' : ''}
      </div>`;
  }

  function formatDate(d) {
    if (!d) return 'N/A';
    return new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  }
</script>
</body>
</html>