<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UK Client Map - Markeb Media</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      padding: 20px;
      color: #1e293b;
    }

    .map-container {
      max-width: 1800px;
      margin: 0 auto;
    }

    .header {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-content h1 {
      font-size: 32px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .header-subtitle {
      color: #64748b;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all .2s ease;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: #fff;
      color: #3b82f6;
      border: 2px solid #3b82f6;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 8px;
    }

    .stat-label {
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    .map-section {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    #map {
      height: 700px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .region-list {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      max-height: 600px;
      overflow-y: auto;
    }

    .region-list h3 {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .region-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      transition: background .2s ease;
    }

    .region-item:hover {
      background: #f8fafc;
    }

    .region-item:last-child {
      border-bottom: none;
    }

    .region-name {
      font-weight: 600;
      color: #0f172a;
      font-size: 14px;
    }

    .region-count {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    .region-item.active {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
    }

    .region-item.empty {
      opacity: 0.5;
    }

    .region-item.empty .region-count {
      background: #e2e8f0;
      color: #64748b;
    }

    .map-legend {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .map-legend h4 {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid #e2e8f0;
    }

    .filter-section {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .filter-section h4 {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 12px;
    }

    .filter-btn {
      width: 100%;
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      color: #0f172a;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
      margin-bottom: 8px;
    }

    .filter-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      border-color: #3b82f6;
    }

    .loading-message {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .spinner {
      margin: 0 auto 20px;
      width: 50px;
      height: 50px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Custom Leaflet Popup */
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .leaflet-popup-content {
      margin: 16px;
      font-family: 'Inter', sans-serif;
    }

    .popup-title {
      font-size: 16px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .popup-info {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .popup-clients {
      font-size: 14px;
      font-weight: 600;
      color: #3b82f6;
      margin-top: 8px;
    }

    @media (max-width: 1200px) {
      .content-grid {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: -1;
      }

      #map {
        height: 500px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .header {
        padding: 20px;
      }

      .header-content h1 {
        font-size: 24px;
      }

      .stats-overview {
        grid-template-columns: 1fr;
      }

      .map-section {
        padding: 20px;
      }

      #map {
        height: 400px;
      }

      .region-list {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <div class="map-container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>üó∫Ô∏è UK Client Distribution Map</h1>
        <p class="header-subtitle">Interactive map showing your client locations across the UK</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='admin-panel.html'">
          ‚¨ÖÔ∏è Back to Admin Panel
        </button>
        <button class="btn btn-primary" onclick="loadMapData()">
          üîÑ Refresh Data
        </button>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-value" id="totalClients">-</div>
        <div class="stat-label">Total Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="regionsWithClients">-</div>
        <div class="stat-label">Regions with Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="emptyRegions">-</div>
        <div class="stat-label">Opportunity Regions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="topRegion">-</div>
        <div class="stat-label">Top Region</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-grid">
      <!-- Map Section -->
      <div class="map-section">
        <div id="map">
          <div class="loading-message">
            <div class="spinner"></div>
            <p>Loading interactive UK map...</p>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Filters -->
        <div class="filter-section">
          <h4>üîç Quick Filters</h4>
          <button class="filter-btn active" onclick="filterMap('all')">
            Show All Regions
          </button>
          <button class="filter-btn" onclick="filterMap('with-clients')">
            Regions with Clients
          </button>
          <button class="filter-btn" onclick="filterMap('opportunities')">
            Opportunity Regions
          </button>
        </div>

        <!-- Legend -->
        <div class="map-legend">
          <h4>üìä Map Legend</h4>
          <div class="legend-item">
            <div class="legend-color" style="background: #ef4444; border-radius: 50%;"></div>
            <span>Client location marker</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #3b82f6; opacity: 0.3;"></div>
            <span>Region with clients</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #e2e8f0;"></div>
            <span>No clients yet</span>
          </div>
        </div>

        <!-- Region List -->
        <div class="region-list">
          <h3>
            Regions
            <span id="regionTotal" style="color: #64748b; font-size: 14px; font-weight: 500;">-</span>
          </h3>
          <div id="regionListContainer">
            <div class="loading-message">
              <p>Loading regions...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // UK Region coordinates (approximate centers)
    const REGION_COORDS = {
      'Leicestershire': [52.6369, -1.1398],
      'Derbyshire': [53.1235, -1.5650],
      'Nottinghamshire': [53.1000, -0.9900],
      'Greater London': [51.5074, -0.1278],
      'Greater Manchester': [53.4808, -2.2426],
      'West Midlands': [52.4862, -1.8904],
      'Hampshire': [51.0577, -1.3081],
      'Kent': [51.2787, 0.5217],
      'Essex': [51.7341, 0.4700],
      'Surrey': [51.3148, -0.5600],
      'Lancashire': [53.7632, -2.7044],
      'Hertfordshire': [51.8090, -0.2376],
      'Berkshire': [51.4543, -1.0000],
      'Staffordshire': [52.8700, -2.0800],
      'Cheshire': [53.2000, -2.5300],
      'West Yorkshire': [53.7900, -1.7500],
      'South Yorkshire': [53.5400, -1.3500],
      'Norfolk': [52.6295, 0.7100],
      'Oxfordshire': [51.7612, -1.2500],
      'Lincolnshire': [53.2307, -0.5406],
      'Suffolk': [52.1872, 0.9708],
      'Cambridgeshire': [52.2053, 0.1218],
      'Worcestershire': [52.2500, -2.2200],
      'Devon': [50.7184, -3.5339],
      'Gloucestershire': [51.8642, -2.2381],
      'Somerset': [51.1054, -2.9260],
      'Dorset': [50.7480, -2.3440],
      'Wiltshire': [51.3493, -1.9927],
      'Cornwall': [50.2660, -5.0527],
      'East Sussex': [50.9085, 0.2500],
      'West Sussex': [50.9200, -0.6000],
      'Bedfordshire': [52.0406, -0.4547],
      'Northamptonshire': [52.2700, -0.8700],
      'Warwickshire': [52.2819, -1.5849],
      'Shropshire': [52.7069, -2.7464],
      'Herefordshire': [52.0564, -2.7160],
      'Buckinghamshire': [51.8133, -0.8084],
      'City of Edinburgh': [55.9533, -3.1883],
      'Glasgow City': [55.8642, -4.2518],
      'Fife': [56.2079, -3.1498],
      'Highland': [57.4778, -4.2247],
      'Aberdeenshire': [57.1497, -2.5943],
      'Perth and Kinross': [56.3950, -3.4373],
      'Dumfries and Galloway': [55.0700, -3.6053],
      'Scottish Borders': [55.5446, -2.7820],
      'South Lanarkshire': [55.6743, -3.7819],
      'North Lanarkshire': [55.8667, -3.9667],
      'Angus': [56.6500, -2.8667],
      'Stirling': [56.1165, -3.9369],
      'Cardiff': [51.4816, -3.1791],
      'Swansea': [51.6214, -3.9436],
      'Newport': [51.5842, -2.9977],
      'Gwynedd': [52.9167, -4.1333],
      'Powys': [52.3333, -3.3333],
      'Carmarthenshire': [51.8567, -4.3123],
      'Pembrokeshire': [51.6730, -4.9094],
      'Ceredigion': [52.4167, -3.9667],
      'Antrim': [54.7167, -6.2167],
      'Down': [54.3167, -5.7167],
      'Armagh': [54.3500, -6.6500],
      'Londonderry': [54.9958, -7.3086],
      'Tyrone': [54.6000, -7.3000],
      'Fermanagh': [54.3500, -7.6333],
      'Bristol': [51.4545, -2.5879],
      'Cumbria': [54.5772, -2.7974],
      'Northumberland': [55.2083, -2.0784],
      'County Durham': [54.7753, -1.5849],
      'Tyne and Wear': [54.9783, -1.6178],
      'North Yorkshire': [54.2766, -1.4090],
      'East Riding of Yorkshire': [53.8429, -0.4380],
      'Rutland': [52.6558, -0.6389],
      'Isle of Wight': [50.6938, -1.3047],
      'Merseyside': [53.4106, -2.9779]
    };

    const UK_REGIONS = Object.keys(REGION_COORDS).sort();
    
    let clientData = [];
    let regionCounts = {};
    let map;
    let markers = [];
    let currentFilter = 'all';

    // Initialize map
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      loadMapData();
    });

    function initMap() {
      // Create map centered on UK
      map = L.map('map').setView([54.5, -3], 6);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 10,
        minZoom: 5
      }).addTo(map);
    }

    async function loadMapData() {
      try {
        const response = await fetch('/.netlify/functions/admin-users', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Failed to load user data');
        }

        const data = await response.json();
        clientData = data.users || [];

        // Calculate region counts
        regionCounts = {};
        UK_REGIONS.forEach(region => {
          regionCounts[region] = 0;
        });

        clientData.forEach(user => {
          const region = user.fields['Region'];
          if (region && regionCounts.hasOwnProperty(region)) {
            regionCounts[region]++;
          }
        });

        // Update stats
        updateStats();

        // Add markers to map
        addMarkersToMap();

        // Render region list
        renderRegionList();

      } catch (error) {
        console.error('Error loading map data:', error);
        alert('Failed to load map data: ' + error.message);
      }
    }

    function updateStats() {
      const totalClients = clientData.filter(u => u.fields['Region']).length;
      const regionsWithClients = Object.values(regionCounts).filter(count => count > 0).length;
      const emptyRegions = UK_REGIONS.length - regionsWithClients;
      
      let topRegion = '-';
      let maxCount = 0;
      for (const [region, count] of Object.entries(regionCounts)) {
        if (count > maxCount) {
          maxCount = count;
          topRegion = region;
        }
      }

      document.getElementById('totalClients').textContent = totalClients;
      document.getElementById('regionsWithClients').textContent = regionsWithClients;
      document.getElementById('emptyRegions').textContent = emptyRegions;
      document.getElementById('topRegion').textContent = maxCount > 0 ? topRegion : '-';
    }

    function addMarkersToMap() {
      // Clear existing markers
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      // Add markers for each region with clients
      Object.entries(regionCounts).forEach(([region, count]) => {
        if (count > 0 && REGION_COORDS[region]) {
          const coords = REGION_COORDS[region];
          
          // Create custom icon based on client count
          const iconSize = Math.min(20 + (count * 3), 40);
          const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
              background: #ef4444;
              border: 3px solid #fff;
              border-radius: 50%;
              width: ${iconSize}px;
              height: ${iconSize}px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #fff;
              font-weight: 700;
              font-size: 12px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            ">${count}</div>`,
            iconSize: [iconSize, iconSize]
          });

          // Get client names for this region
          const clients = clientData.filter(u => u.fields['Region'] === region);
          const clientNames = clients.map(c => c.fields['Name']).join('<br>');

          const marker = L.marker(coords, { icon: icon }).addTo(map);
          
          marker.bindPopup(`
            <div class="popup-title">${region}</div>
            <div class="popup-clients">${count} client${count !== 1 ? 's' : ''}</div>
            <div class="popup-info" style="margin-top: 8px; max-height: 150px; overflow-y: auto;">
              ${clientNames}
            </div>
          `);

          markers.push(marker);
        }
      });
    }

    function renderRegionList() {
      const container = document.getElementById('regionListContainer');
      const regionTotal = document.getElementById('regionTotal');

      let visibleRegions = UK_REGIONS;
      
      if (currentFilter === 'with-clients') {
        visibleRegions = UK_REGIONS.filter(region => regionCounts[region] > 0);
      } else if (currentFilter === 'opportunities') {
        visibleRegions = UK_REGIONS.filter(region => regionCounts[region] === 0);
      }

      regionTotal.textContent = `${visibleRegions.length} of ${UK_REGIONS.length}`;

      const listHTML = visibleRegions.map(region => {
        const count = regionCounts[region] || 0;
        const isEmpty = count === 0;
        
        return `
          <div class="region-item ${isEmpty ? 'empty' : ''}" onclick="flyToRegion('${region}')">
            <span class="region-name">${region}</span>
            <span class="region-count">${count}</span>
          </div>
        `;
      }).join('');

      container.innerHTML = listHTML || '<p style="text-align: center; color: #64748b; padding: 20px;">No regions match this filter</p>';
    }

    function flyToRegion(region) {
      if (REGION_COORDS[region]) {
        const coords = REGION_COORDS[region];
        map.flyTo(coords, 9, {
          duration: 1.5
        });

        // Find and open the marker popup
        markers.forEach(marker => {
          if (marker.getLatLng().lat === coords[0] && marker.getLatLng().lng === coords[1]) {
            setTimeout(() => marker.openPopup(), 1600);
          }
        });
      }

      // Highlight in sidebar
      document.querySelectorAll('.region-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const selectedItem = Array.from(document.querySelectorAll('.region-item')).find(
        item => item.textContent.includes(region)
      );
      if (selectedItem) {
        selectedItem.classList.add('active');
        selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    function filterMap(filterType) {
      currentFilter = filterType;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      renderRegionList();
    }
  </script>
</body>
</html>