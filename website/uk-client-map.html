<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UK Client Map - Markeb Media</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      padding: 20px;
      color: #1e293b;
    }

    .map-container {
      max-width: 1800px;
      margin: 0 auto;
    }

    .header {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-content h1 {
      font-size: 32px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .header-subtitle {
      color: #64748b;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all .2s ease;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: #fff;
      color: #3b82f6;
      border: 2px solid #3b82f6;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 8px;
    }

    .stat-label {
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    .map-section {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      min-height: 800px;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .region-list {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      max-height: 600px;
      overflow-y: auto;
    }

    .region-list h3 {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .region-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      transition: background .2s ease;
    }

    .region-item:hover {
      background: #f8fafc;
    }

    .region-item:last-child {
      border-bottom: none;
    }

    .region-name {
      font-weight: 600;
      color: #0f172a;
      font-size: 14px;
    }

    .region-count {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    .region-item.active {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
    }

    .region-item.empty {
      opacity: 0.5;
    }

    .region-item.empty .region-count {
      background: #e2e8f0;
      color: #64748b;
    }

    #ukMapSvg {
      width: 100%;
      height: 700px;
    }

    .map-legend {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .map-legend h4 {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid #e2e8f0;
    }

    .loading-message {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .spinner {
      margin: 0 auto 20px;
      width: 50px;
      height: 50px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 20px;
      color: #991b1b;
      font-weight: 600;
      text-align: center;
      margin: 20px 0;
    }

    .filter-section {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .filter-section h4 {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 12px;
    }

    .filter-btn {
      width: 100%;
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      color: #0f172a;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
      margin-bottom: 8px;
    }

    .filter-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      border-color: #3b82f6;
    }

    /* SVG Map Styles */
    .uk-region {
      fill: #e2e8f0;
      stroke: #fff;
      stroke-width: 1.5;
      cursor: pointer;
      transition: all .3s ease;
    }

    .uk-region:hover {
      fill: #cbd5e1;
      stroke-width: 2;
    }

    .uk-region.has-clients {
      fill: #93c5fd;
    }

    .uk-region.has-clients:hover {
      fill: #60a5fa;
    }

    .uk-region.active {
      fill: #3b82f6 !important;
      stroke: #1e40af;
      stroke-width: 3;
    }

    .region-label {
      font-size: 9px;
      font-weight: 600;
      fill: #475569;
      pointer-events: none;
      text-anchor: middle;
      user-select: none;
    }

    .client-marker {
      fill: #ef4444;
      stroke: #fff;
      stroke-width: 2;
      pointer-events: none;
    }

    .region-tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      pointer-events: none;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 1200px) {
      .content-grid {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: -1;
      }

      #ukMapSvg {
        height: 500px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .header {
        padding: 20px;
      }

      .header-content h1 {
        font-size: 24px;
      }

      .stats-overview {
        grid-template-columns: 1fr;
      }

      .map-section {
        padding: 20px;
      }

      #ukMapSvg {
        height: 400px;
      }

      .region-list {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <div class="region-tooltip" id="tooltip"></div>

  <div class="map-container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>üó∫Ô∏è UK Client Distribution Map</h1>
        <p class="header-subtitle">Interactive map showing your client locations across the UK</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='admin-panel.html'">
          ‚¨ÖÔ∏è Back to Admin Panel
        </button>
        <button class="btn btn-primary" onclick="loadMapData()">
          üîÑ Refresh Data
        </button>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-value" id="totalClients">-</div>
        <div class="stat-label">Total Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="regionsWithClients">-</div>
        <div class="stat-label">Regions with Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="emptyRegions">-</div>
        <div class="stat-label">Opportunity Regions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="topRegion">-</div>
        <div class="stat-label">Top Region</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-grid">
      <!-- Map Section -->
      <div class="map-section">
        <div id="mapContainer">
          <div class="loading-message">
            <div class="spinner"></div>
            <p>Loading UK map data...</p>
          </div>
        </div>
        <svg id="ukMapSvg" style="display: none;" viewBox="0 0 600 800"></svg>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Filters -->
        <div class="filter-section">
          <h4>üîç Quick Filters</h4>
          <button class="filter-btn active" onclick="filterMap('all')">
            Show All Regions
          </button>
          <button class="filter-btn" onclick="filterMap('with-clients')">
            Regions with Clients
          </button>
          <button class="filter-btn" onclick="filterMap('opportunities')">
            Opportunity Regions
          </button>
        </div>

        <!-- Legend -->
        <div class="map-legend">
          <h4>üìä Map Legend</h4>
          <div class="legend-item">
            <div class="legend-color" style="background: #e2e8f0;"></div>
            <span>No clients</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #93c5fd;"></div>
            <span>Has clients</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #3b82f6;"></div>
            <span>Selected region</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ef4444; border-radius: 50%;"></div>
            <span>Client location marker</span>
          </div>
        </div>

        <!-- Region List -->
        <div class="region-list">
          <h3>
            Regions
            <span id="regionTotal" style="color: #64748b; font-size: 14px; font-weight: 500;">-</span>
          </h3>
          <div id="regionListContainer">
            <div class="loading-message">
              <p>Loading regions...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // UK Regions - Grouped by country/area for map visualization
    const UK_REGIONS_DATA = {
      'Scotland': {
        regions: ['Aberdeenshire', 'Angus', 'Argyll and Bute', 'City of Edinburgh', 'Clackmannanshire', 
          'Dumfries and Galloway', 'Dundee City', 'East Ayrshire', 'East Dunbartonshire', 'East Lothian',
          'East Renfrewshire', 'Falkirk', 'Fife', 'Glasgow City', 'Highland', 'Inverclyde',
          'Midlothian', 'Moray', 'North Ayrshire', 'North Lanarkshire', 'Orkney Islands',
          'Perth and Kinross', 'Renfrewshire', 'Scottish Borders', 'Shetland Islands', 'South Ayrshire',
          'South Lanarkshire', 'Stirling', 'West Dunbartonshire', 'West Lothian', 'Western Isles'],
        color: '#93c5fd',
        position: { x: 250, y: 50 }
      },
      'Northern England': {
        regions: ['County Durham', 'Northumberland', 'Tyne and Wear', 'Cumbria', 'Lancashire', 
          'Greater Manchester', 'Merseyside', 'Cheshire', 'East Riding of Yorkshire', 'North Yorkshire', 
          'South Yorkshire', 'West Yorkshire'],
        color: '#7dd3fc',
        position: { x: 300, y: 250 }
      },
      'Midlands': {
        regions: ['Derbyshire', 'Leicestershire', 'Lincolnshire', 'Northamptonshire', 'Nottinghamshire', 
          'Rutland', 'Herefordshire', 'Shropshire', 'Staffordshire', 'Warwickshire', 'West Midlands', 'Worcestershire'],
        color: '#67e8f9',
        position: { x: 300, y: 350 }
      },
      'East of England': {
        regions: ['Bedfordshire', 'Cambridgeshire', 'Essex', 'Hertfordshire', 'Norfolk', 'Suffolk'],
        color: '#5eead4',
        position: { x: 380, y: 380 }
      },
      'Greater London': {
        regions: ['Greater London'],
        color: '#6ee7b7',
        position: { x: 370, y: 450 }
      },
      'South East': {
        regions: ['Berkshire', 'Buckinghamshire', 'East Sussex', 'Hampshire', 'Isle of Wight', 
          'Kent', 'Oxfordshire', 'Surrey', 'West Sussex'],
        color: '#86efac',
        position: { x: 350, y: 500 }
      },
      'South West': {
        regions: ['Bristol', 'Cornwall', 'Devon', 'Dorset', 'Gloucestershire', 'Somerset', 'Wiltshire'],
        color: '#a7f3d0',
        position: { x: 250, y: 520 }
      },
      'Wales': {
        regions: ['Anglesey', 'Blaenau Gwent', 'Bridgend', 'Caerphilly', 'Cardiff', 'Carmarthenshire',
          'Ceredigion', 'Conwy', 'Denbighshire', 'Flintshire', 'Gwynedd', 'Merthyr Tydfil',
          'Monmouthshire', 'Neath Port Talbot', 'Newport', 'Pembrokeshire', 'Powys', 'Rhondda Cynon Taf',
          'Swansea', 'Torfaen', 'Vale of Glamorgan', 'Wrexham'],
        color: '#bef264',
        position: { x: 180, y: 380 }
      },
      'Northern Ireland': {
        regions: ['Antrim', 'Armagh', 'Down', 'Fermanagh', 'Londonderry', 'Tyrone'],
        color: '#fde047',
        position: { x: 100, y: 250 }
      }
    };

    // Flatten regions for easy lookup
    const UK_REGIONS = [];
    Object.values(UK_REGIONS_DATA).forEach(area => {
      UK_REGIONS.push(...area.regions);
    });
    UK_REGIONS.sort();

    let clientData = [];
    let regionCounts = {};
    let selectedRegion = null;
    let currentFilter = 'all';

    // Load map data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadMapData();
    });

    async function loadMapData() {
      const mapContainer = document.getElementById('mapContainer');
      const ukMap = document.getElementById('ukMapSvg');
      
      mapContainer.style.display = 'block';
      ukMap.style.display = 'none';
      
      mapContainer.innerHTML = `
        <div class="loading-message">
          <div class="spinner"></div>
          <p>Loading UK map data...</p>
        </div>
      `;

      try {
        const response = await fetch('/.netlify/functions/admin-users', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Failed to load user data');
        }

        const data = await response.json();
        clientData = data.users || [];

        // Calculate region counts
        regionCounts = {};
        UK_REGIONS.forEach(region => {
          regionCounts[region] = 0;
        });

        clientData.forEach(user => {
          const region = user.fields['Region'];
          if (region && regionCounts.hasOwnProperty(region)) {
            regionCounts[region]++;
          }
        });

        // Update stats
        updateStats();

        // Render map and region list
        renderMap();
        renderRegionList();

      } catch (error) {
        console.error('Error loading map data:', error);
        mapContainer.innerHTML = `
          <div class="error-message">
            ‚ùå Failed to load map data: ${error.message}
            <br><br>
            <button class="btn btn-primary" onclick="loadMapData()">Try Again</button>
          </div>
        `;
      }
    }

    function updateStats() {
      const totalClients = clientData.filter(u => u.fields['Region']).length;
      const regionsWithClients = Object.values(regionCounts).filter(count => count > 0).length;
      const emptyRegions = UK_REGIONS.length - regionsWithClients;
      
      // Find top region
      let topRegion = '-';
      let maxCount = 0;
      for (const [region, count] of Object.entries(regionCounts)) {
        if (count > maxCount) {
          maxCount = count;
          topRegion = region;
        }
      }

      document.getElementById('totalClients').textContent = totalClients;
      document.getElementById('regionsWithClients').textContent = regionsWithClients;
      document.getElementById('emptyRegions').textContent = emptyRegions;
      document.getElementById('topRegion').textContent = maxCount > 0 ? topRegion : '-';
    }

    function renderMap() {
      const mapContainer = document.getElementById('mapContainer');
      const ukMap = document.getElementById('ukMapSvg');
      
      mapContainer.style.display = 'none';
      ukMap.style.display = 'block';

      let svgContent = '';
      let yOffset = 0;

      // Draw each area of the UK
      Object.entries(UK_REGIONS_DATA).forEach(([areaName, areaData], areaIndex) => {
        const x = areaData.position.x;
        const y = areaData.position.y;
        
        // Calculate total clients in this area
        let areaClients = 0;
        areaData.regions.forEach(region => {
          areaClients += regionCounts[region] || 0;
        });

        const hasClients = areaClients > 0;
        const fillColor = hasClients ? '#93c5fd' : '#e2e8f0';

        // Draw area as a rounded rectangle
        const width = 120;
        const height = 80;
        
        svgContent += `
          <g class="area-group" data-area="${areaName}">
            <rect 
              x="${x}" 
              y="${y}" 
              width="${width}" 
              height="${height}" 
              rx="12"
              class="uk-region ${hasClients ? 'has-clients' : ''}" 
              data-area="${areaName}"
              data-clients="${areaClients}"
              onclick="selectArea('${areaName}')"
              onmouseover="showTooltip(event, '${areaName}', ${areaClients})"
              onmouseout="hideTooltip()"
            />
            <text 
              x="${x + width/2}" 
              y="${y + height/2 - 10}" 
              class="region-label" 
              style="font-size: 11px; font-weight: 700;"
            >
              ${areaName}
            </text>
            <text 
              x="${x + width/2}" 
              y="${y + height/2 + 8}" 
              class="region-label" 
              style="font-size: 14px; fill: ${hasClients ? '#1e40af' : '#64748b'};"
            >
              ${areaClients} client${areaClients !== 1 ? 's' : ''}
            </text>
            <text 
              x="${x + width/2}" 
              y="${y + height/2 + 22}" 
              class="region-label" 
              style="font-size: 9px; fill: #94a3b8;"
            >
              ${areaData.regions.length} region${areaData.regions.length !== 1 ? 's' : ''}
            </text>
          </g>
        `;
      });

      ukMap.innerHTML = svgContent;
    }

    function showTooltip(event, areaName, clientCount) {
      const tooltip = document.getElementById('tooltip');
      const area = UK_REGIONS_DATA[areaName];
      
      tooltip.innerHTML = `
        <strong>${areaName}</strong><br>
        ${clientCount} client${clientCount !== 1 ? 's' : ''} ‚Ä¢ ${area.regions.length} regions
      `;
      tooltip.style.display = 'block';
      tooltip.style.left = (event.pageX + 10) + 'px';
      tooltip.style.top = (event.pageY - 30) + 'px';
    }

    function hideTooltip() {
      document.getElementById('tooltip').style.display = 'none';
    }

    function selectArea(areaName) {
      // Highlight area on map
      document.querySelectorAll('.uk-region').forEach(rect => {
        rect.classList.remove('active');
      });
      
      document.querySelectorAll(`[data-area="${areaName}"]`).forEach(el => {
        if (el.classList.contains('uk-region')) {
          el.classList.add('active');
        }
      });

      // Show regions in sidebar
      console.log(`Selected: ${areaName}`);
      const area = UK_REGIONS_DATA[areaName];
      console.log('Regions:', area.regions);
    }

    function renderRegionList() {
      const container = document.getElementById('regionListContainer');
      const regionTotal = document.getElementById('regionTotal');

      let visibleRegions = UK_REGIONS;
      
      if (currentFilter === 'with-clients') {
        visibleRegions = UK_REGIONS.filter(region => regionCounts[region] > 0);
      } else if (currentFilter === 'opportunities') {
        visibleRegions = UK_REGIONS.filter(region => regionCounts[region] === 0);
      }

      regionTotal.textContent = `${visibleRegions.length} of ${UK_REGIONS.length}`;

      const listHTML = visibleRegions.map(region => {
        const count = regionCounts[region] || 0;
        const isEmpty = count === 0;
        
        return `
          <div class="region-item ${isEmpty ? 'empty' : ''}" onclick="selectRegion('${region}')">
            <span class="region-name">${region}</span>
            <span class="region-count">${count}</span>
          </div>
        `;
      }).join('');

      container.innerHTML = listHTML || '<p style="text-align: center; color: #64748b; padding: 20px;">No regions match this filter</p>';
    }

    function selectRegion(region) {
      selectedRegion = region;
      
      // Update region list highlighting
      document.querySelectorAll('.region-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const selectedItem = Array.from(document.querySelectorAll('.region-item')).find(
        item => item.textContent.includes(region)
      );
      if (selectedItem) {
        selectedItem.classList.add('active');
        selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      const count = regionCounts[region] || 0;
      const clients = clientData.filter(u => u.fields['Region'] === region);
      
      if (count > 0) {
        const clientNames = clients.map(c => c.fields['Name']).join(', ');
        console.log(`üìç ${region}: ${count} client${count !== 1 ? 's' : ''} - ${clientNames}`);
      } else {
        console.log(`üìç ${region}: Opportunity region - no clients yet`);
      }
    }

    function filterMap(filterType) {
      currentFilter = filterType;
      
      // Update button states
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Re-render region list with filter
      renderRegionList();
    }
  </script>
</body>
</html>