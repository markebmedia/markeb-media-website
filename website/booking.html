<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Your Shoot - Markeb Media</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #1e293b;
    }

    .booking-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .booking-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .booking-header h1 {
      font-size: 42px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 12px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .booking-header p {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.9);
    }

    .booking-card {
      background: #fff;
      border-radius: 20px;
      padding: 48px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 48px;
      position: relative;
    }

    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e2e8f0;
      z-index: 0;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      z-index: 1;
      background: #fff;
      padding: 0 10px;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #94a3b8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .step.active .step-number {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .step.completed .step-number {
      background: #10b981;
      color: #fff;
    }

    .step-label {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
    }

    .step.active .step-label {
      color: #3b82f6;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 28px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-input.error {
      border-color: #ef4444;
    }

    .error-message {
      color: #ef4444;
      font-size: 13px;
      margin-top: 6px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .info-box {
      background: #eff6ff;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 28px;
      display: none;
    }

    .info-box.show {
      display: block;
    }

    .info-box.success {
      background: #f0fdf4;
      border-color: #10b981;
    }

    .info-box.warning {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    .info-box-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 8px;
      color: #1e293b;
    }

    .info-box-text {
      font-size: 14px;
      color: #64748b;
      line-height: 1.6;
    }

    .region-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .region-badge.north {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
    }

    .region-badge.south {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #fff;
    }

    .btn {
      padding: 14px 32px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #64748b;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn-primary.loading .loading-spinner {
      display: block;
    }

    .btn-primary.loading span {
      display: none;
    }

    .service-card {
      background: #fff;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    .service-card:hover {
      border-color: #3b82f6;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .service-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .service-card.popular {
      border-color: #10b981;
    }

    .popular-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .service-radio {
      width: 24px;
      height: 24px;
      border: 3px solid #e2e8f0;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .service-card:hover .service-radio {
      border-color: #3b82f6;
    }

    .service-card.selected .service-radio {
      border-color: #3b82f6;
      background: #3b82f6;
      position: relative;
    }

    .service-card.selected .service-radio::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
    }

    .bedroom-btn {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
      background: #fff;
      font-size: 24px;
      font-weight: 700;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }

    .bedroom-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
      transform: scale(1.05);
    }

    .bedroom-btn:active {
      transform: scale(0.95);
    }

    .calendar-day {
      aspect-ratio: 1;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fff;
      color: #1e293b;
    }

    .calendar-day.day-label {
      background: transparent;
      border: none;
      font-size: 12px;
      font-weight: 700;
      color: #94a3b8;
      cursor: default;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .calendar-day.disabled {
      background: #f8fafc;
      color: #cbd5e1;
      cursor: not-allowed;
    }

    .calendar-day.other-month {
      color: #cbd5e1;
    }

    .calendar-day:not(.disabled):not(.day-label):not(.other-month):hover {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: scale(1.05);
    }

    .calendar-day.selected {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
      color: #fff;
    }

    .calendar-day.today {
      border-color: #10b981;
      font-weight: 700;
    }

    .time-slot {
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fff;
      color: #1e293b;
    }

    .time-slot:hover {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: translateY(-2px);
    }

    .time-slot.selected {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
      color: #fff;
    }

    .time-slot.disabled {
      background: #f8fafc;
      color: #cbd5e1;
      cursor: not-allowed;
      border-color: #f1f5f9;
    }

    .time-slot.disabled:hover {
      transform: none;
      border-color: #f1f5f9;
      background: #f8fafc;
    }

    .payment-option {
      background: #fff;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    .payment-option:hover {
      border-color: #3b82f6;
      transform: translateX(4px);
    }

    .payment-option.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .payment-radio {
      width: 24px;
      height: 24px;
      border: 3px solid #e2e8f0;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .payment-option:hover .payment-radio {
      border-color: #3b82f6;
    }

    .payment-option.selected .payment-radio {
      border-color: #3b82f6;
      background: #3b82f6;
      position: relative;
    }

    .payment-option.selected .payment-radio::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
    }

    @media (max-width: 768px) {
      body {
        padding: 20px 12px;
      }

      .booking-header h1 {
        font-size: 32px;
      }

      .booking-card {
        padding: 32px 24px;
      }

      .step-indicator {
        flex-wrap: wrap;
      }

      .step {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="booking-container">
    <!-- Header -->
    <div class="booking-header">
      <div style="margin-bottom: 20px;">
       <img src="/public/images/Markeb Media Logo (2).png" alt="Markeb Media" style="height: 60px;">
      </div>
      <h1>Book Your Shoot</h1>
      <p>Professional property marketing & media partner in the UK</p>
    </div>

    <!-- Booking Card -->
    <div class="booking-card">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1Indicator">
          <div class="step-number">1</div>
          <div class="step-label">Location</div>
        </div>
        <div class="step" id="step2Indicator">
          <div class="step-number">2</div>
          <div class="step-label">Service</div>
        </div>
        <div class="step" id="step3Indicator">
          <div class="step-number">3</div>
          <div class="step-label">Date & Time</div>
        </div>
        <div class="step" id="step4Indicator">
          <div class="step-number">4</div>
          <div class="step-label">Details</div>
        </div>
        <div class="step" id="step5Indicator">
          <div class="step-number">5</div>
          <div class="step-label">Payment</div>
        </div>
      </div>

      <!-- Step 1: Postcode Check -->
      <div class="form-section active" id="step1">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: #1e293b;">
          Where is your property?
        </h2>
        <p style="font-size: 14px; color: #64748b; margin-bottom: 28px;">
          Enter your postcode so we can check availability in your area
        </p>

        <div class="form-group">
          <label class="form-label" for="postcode">Property Postcode *</label>
          <input 
            type="text" 
            id="postcode" 
            class="form-input" 
            placeholder="e.g. LE2 7LH"
            style="text-transform: uppercase;"
            maxlength="8"
          />
          <div class="error-message" id="postcodeError">Please enter a valid UK postcode</div>
        </div>

        <!-- Region Info Box (hidden initially) -->
        <div class="info-box" id="regionInfo">
          <div class="info-box-title">
            Great news! We cover your area
          </div>
          <div class="info-box-text">
            Your property is in our <span id="regionBadge"></span> region.
            <br><br>
            <strong>Your media specialist:</strong> <span id="mediaSpecialistName"></span>
          </div>
        </div>

        <div class="info-box warning" id="unavailableInfo">
          <div class="info-box-title">
            Sorry, we don't cover this area yet
          </div>
          <div class="info-box-text">
            We're currently available in the Midlands & North (Jodie) and London & South (Maeve). Please contact us if you'd like to discuss options.
          </div>
        </div>

        <!-- Address Form (shown after postcode validation) -->
        <div id="addressSection" style="display: none;">
          <div class="form-group">
            <label class="form-label" for="propertyAddress">Full Property Address *</label>
            <input 
              type="text" 
              id="propertyAddress" 
              class="form-input" 
              placeholder="e.g. 123 High Street, Leicester"
            />
            <div style="font-size: 12px; color: #64748b; margin-top: 6px;">
              This helps us plan the best route and ensure accurate timing
            </div>
            <div class="error-message" id="addressError">Please enter the property address</div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" id="checkPostcodeBtn" onclick="checkPostcode()">
            <div class="loading-spinner"></div>
            <span>Check Availability</span>
          </button>
          <button class="btn btn-primary" id="continueWithAddressBtn" onclick="proceedToServiceSelection()" style="display: none;">
            <span>Continue to Service Selection</span>
          </button>
        </div>
      </div>
      <!-- Step 2: Service Selection -->
      <div class="form-section" id="step2">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: #1e293b;">
          Choose Your Service
        </h2>
        <p style="font-size: 14px; color: #64748b; margin-bottom: 28px;">
          Select the photography service that best suits your property
        </p>

        <!-- Service Cards -->
        <div id="serviceCards" style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 28px;">
          <!-- Services will be dynamically inserted here -->
        </div>

        <!-- Bedroom Counter (only shown for property services) -->
        <div id="bedroomSection" style="display: none;">
          <div class="form-group">
            <label class="form-label">Number of Bedrooms</label>
            <div style="display: flex; align-items: center; gap: 16px;">
              <button type="button" class="bedroom-btn" onclick="adjustBedrooms(-1)">-</button>
              <div style="flex: 1; text-align: center;">
                <div id="bedroomCount" style="font-size: 48px; font-weight: 700; color: #3b82f6;">4</div>
                <div style="font-size: 13px; color: #64748b; margin-top: 4px;">bedrooms</div>
              </div>
              <button type="button" class="bedroom-btn" onclick="adjustBedrooms(1)">+</button>
            </div>
            <div id="bedroomFeeNotice" style="display: none; margin-top: 12px; padding: 12px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; font-size: 13px; color: #92400e;">
              <strong>¬£30 per additional bedroom</strong> after the first 4 bedrooms
            </div>
          </div>
        </div>

        <!-- Add-Ons Section -->
        <div id="addonsSection" style="display: none; margin-top: 32px;">
          <div style="border-top: 2px solid #e2e8f0; padding-top: 32px;">
            <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">
              üì¶ Enhance Your Service
            </h3>
            <p style="font-size: 14px; color: #64748b; margin-bottom: 24px;">
              Select optional add-ons to enhance your booking
            </p>
            <div id="addonsGrid" style="display: flex; flex-direction: column; gap: 12px;">
              <!-- Add-ons will be inserted here dynamically -->
            </div>
          </div>
        </div>

        <!-- Price Breakdown -->
        <div id="priceBreakdown" style="background: #f8fafc; border-radius: 12px; padding: 24px; margin-bottom: 28px; display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-size: 14px; color: #64748b;">Service</span>
            <span style="font-size: 14px; font-weight: 600; color: #1e293b;" id="servicePrice">¬£0.00</span>
          </div>
          <div id="bedroomFeeRow" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-size: 14px; color: #64748b;">Extra bedrooms</span>
            <span style="font-size: 14px; font-weight: 600; color: #1e293b;" class="detail-value">¬£0.00</span>
          </div>
          <div style="border-top: 2px solid #e2e8f0; margin: 16px 0;"></div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 18px; font-weight: 700; color: #1e293b;">Total</span>
            <span style="font-size: 24px; font-weight: 700; color: #3b82f6;" id="totalPrice">¬£0.00</span>
          </div>
          <div style="font-size: 12px; color: #94a3b8; text-align: right; margin-top: 4px;">Inc. VAT</div>
        </div>

        <!-- Discount Code Section -->
<div id="discountSection" style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 28px; display: none;">
  <h3 style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">
    üéÅ Have a Discount Code?
  </h3>
  
  <div style="display: flex; gap: 12px; align-items: start;">
    <div style="flex: 1;">
      <input 
        type="text" 
        id="discountCodeInput" 
        class="form-input" 
        placeholder="Enter code"
        style="text-transform: uppercase; margin-bottom: 0;"
      />
      <div class="error-message" id="discountCodeError"></div>
      <div id="discountSuccess" style="display: none; margin-top: 8px; color: #065f46; font-size: 13px; font-weight: 600;">
        ‚úì <span id="discountSuccessText"></span>
      </div>
    </div>
    <button 
      type="button" 
      class="btn btn-primary" 
      id="applyDiscountBtn"
      onclick="applyDiscountCode()"
      style="width: auto; padding: 14px 24px;"
    >
      Apply
    </button>
    <button 
      type="button" 
      class="btn btn-secondary" 
      id="removeDiscountBtn"
      onclick="removeDiscountCode()"
      style="width: auto; padding: 14px 24px; display: none;"
    >
      Remove
    </button>
  </div>
</div>

        <div class="button-group">
          <button type="button" class="btn btn-secondary" onclick="goToStep(1)" style="flex: 1;">
            Back
          </button>
          <button type="button" class="btn btn-primary" id="continueToCalendarBtn" onclick="goToStep(3)" style="flex: 2;" disabled>
            <span>Continue to Date Selection</span>
          </button>
        </div>
      </div>
      <!-- Step 3: Date & Time Selection -->
      <div class="form-section" id="step3">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: #1e293b;">
          Choose Date & Time
        </h2>
        <p style="font-size: 14px; color: #64748b; margin-bottom: 28px;">
          Select your preferred date and time for the shoot
        </p>

        <!-- Calendar -->
        <div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
          <!-- Calendar Header -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <button type="button" onclick="changeMonth(-1)" style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid #e2e8f0; background: #fff; cursor: pointer; font-size: 18px; font-weight: 700; color: #64748b;">‚Äπ</button>
            <h3 id="calendarMonth" style="font-size: 18px; font-weight: 700; color: #1e293b;">Loading...</h3>
            <button type="button" onclick="changeMonth(1)" style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid #e2e8f0; background: #fff; cursor: pointer; font-size: 18px; font-weight: 700; color: #64748b;">‚Ä∫</button>
          </div>

          <!-- Calendar Grid -->
          <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
            <!-- Days will be inserted here -->
          </div>
        </div>

        <!-- Time Slots -->
        <div id="timeSlotSection" style="display: none; margin-bottom: 24px;">
          <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 16px;">
            Available Times for <span id="selectedDateDisplay"></span>
          </h3>
          <div id="timeSlotGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
            <!-- Time slots will be inserted here -->
          </div>
          <div id="loadingTimeSlots" style="text-align: center; padding: 40px; color: #64748b;">
            <div class="spinner" style="margin: 0 auto 20px;"></div>
            <p>Checking availability...</p>
          </div>
        </div>

        <div class="button-group">
          <button type="button" class="btn btn-secondary" onclick="goToStep(2)" style="flex: 1;">
            Back
          </button>
          <button type="button" class="btn btn-primary" id="continueToDetailsBtn" onclick="goToStep(4)" style="flex: 2;" disabled>
            <span>Continue to Details</span>
          </button>
        </div>
      </div>
      <!-- Step 4: Client Details & Payment -->
      <div class="form-section" id="step4">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: #1e293b;">
          Your Details
        </h2>
        <p style="font-size: 14px; color: #64748b; margin-bottom: 28px;">
          Please provide your contact information
        </p>

        <!-- Client Details Form -->
        <div class="form-group">
          <label class="form-label" for="clientName">Full Name *</label>
          <input 
            type="text" 
            id="clientName" 
            class="form-input" 
            placeholder="e.g. John Smith"
          />
          <div class="error-message" id="nameError">Please enter your full name</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="clientEmail">Email Address *</label>
          <input 
            type="email" 
            id="clientEmail" 
            class="form-input" 
            placeholder="e.g. john@example.com"
          />
          <div class="error-message" id="emailError">Please enter a valid email address</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="clientPhone">Phone Number *</label>
          <input 
            type="tel" 
            id="clientPhone" 
            class="form-input" 
            placeholder="e.g. 07700 900123"
          />
          <div class="error-message" id="phoneError">Please enter a valid UK phone number</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="clientNotes">Special Requirements (Optional)</label>
          <textarea 
            id="clientNotes" 
            class="form-input" 
            placeholder="Any special requirements or notes for the Media Specialist..."
            rows="4"
            style="resize: vertical; min-height: 100px;"
          ></textarea>
        </div>

        <!-- Terms & Conditions -->
        <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 28px;">
          <h3 style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 16px;">
            Important Information
          </h3>

          <!-- Revisions -->
          <div style="margin-bottom: 16px;">
            <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
              <input type="checkbox" id="termsRevisions" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;" required>
              <span style="font-size: 14px; color: #64748b; line-height: 1.6;">
                I understand that I am entitled to <strong>two free revisions</strong> and additional revisions may be charged.
              </span>
            </label>
          </div>

          <!-- Item Removal -->
          <div id="termsItemRemoval" style="margin-bottom: 16px; display: none;">
            <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
              <input type="checkbox" id="termsItemRemovalConfirm" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 14px; color: #64748b; line-height: 1.6;">
                I understand that <strong>item removal from photos</strong> may incur extra charges.
              </span>
            </label>
          </div>

          <!-- Property Access (Property services only) -->
          <div id="termsPropertyAccess" style="margin-bottom: 16px; display: none;">
            <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
              <input type="checkbox" id="termsAccess" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 14px; color: #64748b; line-height: 1.6;">
                I have arranged <strong>access to the property</strong> and informed the owner/occupants (if applicable).
              </span>
            </label>
          </div>

          <!-- Hygiene Notice (Property services only - not drone) -->
          <div id="termsHygiene" style="margin-bottom: 16px; display: none;">
            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
              <p style="font-size: 13px; color: #92400e; line-height: 1.6; margin: 0;">
                <strong>Please note:</strong> For hygiene reasons, Markeb Media will not handle or move items such as towels, toiletries or other personal items. Please advise the owner of the property to do so before arrival.
              </p>
            </div>
            <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
              <input type="checkbox" id="termsHygieneConfirm" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 14px; color: #64748b; line-height: 1.6;">
                I acknowledge the hygiene policy and will ensure the property is prepared accordingly.
              </span>
            </label>
          </div>

          <!-- Privacy & Payment Policy -->
          <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h4 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 8px;">
              Privacy & Payment
            </h4>
            <p style="font-size: 13px; color: #64748b; line-height: 1.6; margin-bottom: 8px;">
              Markeb Media respects your privacy. We do not sell, rent, or share your personal data with third parties for marketing purposes. Your information is used solely to manage bookings, deliver services, and process payments.
            </p>
            <p style="font-size: 13px; color: #64748b; line-height: 1.6; margin-bottom: 8px;">
              All card payments are securely processed by <strong>Stripe</strong>. Markeb Media does not store or have access to your full card details.
            </p>
            <p style="font-size: 13px; color: #64748b; line-height: 1.6; margin: 0;">
              Your card will be charged automatically once your content enters the editing stage, and you will receive a confirmation notification at that time.
            </p>
          </div>

          <!-- Cancellation Policy -->
          <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <h4 style="font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 8px;">
              Cancellation Policy
            </h4>
            <p style="font-size: 13px; color: #64748b; line-height: 1.6; margin: 0;">
              You may cancel or reschedule your booking up to <strong>24 hours before</strong> the scheduled shoot time at no charge. Cancellations made within 24 hours incur a <strong>50% charge</strong>. Same-day cancellations or no-shows are charged in full (<strong>100%</strong>).
            </p>
          </div>

          <!-- Final Agreement Checkbox -->
          <div style="margin-bottom: 0;">
            <label style="display: flex; align-items: start; gap: 12px; cursor: pointer;">
              <input type="checkbox" id="termsAgree" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;" required>
              <span style="font-size: 14px; color: #1e293b; font-weight: 600; line-height: 1.6;">
                I have read, understood, and agree to the Terms & Conditions, Privacy Policy, and Cancellation Policy.
              </span>
            </label>
          </div>
        </div>
        <!-- Booking Summary -->
        <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 24px; margin-bottom: 28px;">
          <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 16px;">
            Booking Summary
          </h3>
          <div style="display: grid; gap: 12px; font-size: 14px;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #64748b;">Property:</span>
              <span style="font-weight: 600; color: #1e293b; text-align: right;" id="summaryAddress">-</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #64748b;">Date & Time:</span>
              <span style="font-weight: 600; color: #1e293b;" id="summaryDateTime">-</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #64748b;">Service:</span>
              <span style="font-weight: 600; color: #1e293b; text-align: right;" id="summaryService">-</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #64748b;">Media Specialist:</span>
              <span style="font-weight: 600; color: #1e293b;" id="summaryMediaSpecialist">-</span>
            </div>
            <div style="border-top: 2px solid #3b82f6; margin: 8px 0;"></div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 16px; font-weight: 700; color: #1e293b;">Total Amount:</span>
              <span style="font-size: 24px; font-weight: 700; color: #3b82f6;" id="summaryTotal">¬£0.00</span>
            </div>
          </div>
        </div>

       <!-- Payment Options -->
<div style="margin-bottom: 28px;" id="paymentOptionsSection">
  <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 16px;">
    Payment Options
  </h3>
  
  <div class="payment-option" onclick="selectPaymentOption('pay-now')">
    <div style="flex: 1;">
      <div style="font-weight: 700; font-size: 16px; color: #1e293b; margin-bottom: 4px;">
        Pay Now
      </div>
      <div style="font-size: 13px; color: #64748b;">
        Secure payment via Stripe. Your booking is confirmed immediately.
      </div>
    </div>
    <div class="payment-radio"></div>
  </div>

  <div class="payment-option" onclick="selectPaymentOption('reserve')" style="display: none;">
    <div style="flex: 1;">
      <div style="font-weight: 700; font-size: 16px; color: #1e293b; margin-bottom: 4px;">
        Reserve Without Payment
      </div>
      <div style="font-size: 13px; color: #64748b;">
        Save your card details. We'll charge after completing your shoot.
      </div>
    </div>
    <div class="payment-radio"></div>
  </div>
</div>

<!-- Skip Payment Message (shown when toggle is ON) -->
<div id="skipPaymentMessage" style="display: none; margin-bottom: 28px;">
  <div class="info-box success">
    <div class="info-box-title">‚úÖ Trusted Customer</div>
    <div class="info-box-text">
      No payment required now. We'll invoice you after completing your shoot.
    </div>
  </div>
</div>

        <!-- Stripe Card Elements Section (only shown for Reserve Without Payment) -->
        <div id="stripeCardSection" style="display: none; margin-bottom: 28px;">
          <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 24px;">
            <h3 style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">
              üí≥ Card Details for Payment After Shoot
            </h3>
            <p style="font-size: 14px; color: #64748b; margin-bottom: 20px;">
              Your booking is reserved. We'll charge your card after completing your shoot.
            </p>

            <div class="form-group" style="margin-bottom: 16px;">
              <label class="form-label" for="cardholderName">Cardholder Name *</label>
              <input 
                type="text" 
                id="cardholderName" 
                class="form-input" 
                placeholder="Name on card"
              />
              <div class="error-message" id="cardholderNameError">Please enter the cardholder name</div>
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
              <label class="form-label">Card Details *</label>
              <div id="stripe-card-element" style="
                padding: 12px;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                background: white;
                min-height: 40px;
              "></div>
              <div class="error-message" id="stripeCardError"></div>
            </div>

            <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; font-size: 13px; color: #1e40ab;">
              <strong>üîí Stripe Secure:</strong> Your card is securely stored by Stripe and will only be charged after we complete your shoot.
            </div>
          </div>
        </div>

        <div class="button-group">
          <button type="button" class="btn btn-secondary" onclick="goToStep(3)" style="flex: 1;">
            Back
          </button>
          <button type="button" class="btn btn-primary" id="completeBookingBtn" onclick="completeBooking()" style="flex: 2;" disabled>
            <div class="loading-spinner"></div>
            <span id="completeBookingText">Complete Booking</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ===== STRIPE INITIALIZATION =====
    const stripePublicKey = 'pk_live_51QycLvQAVOs8qTDFVfXTNzuuhBnPjgZQSS3AH30NGMuSf3SxAWF9pLzYwL0ulj1wMMCC2jnhDyeqeop7BkWDfeZ400wT3Ko8aK';
    const stripe = Stripe(stripePublicKey);
    const elements = stripe.elements();
    let cardElement = null;

    function initializeStripeCard() {
      if (cardElement) return; // Already initialized
      
      cardElement = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#1e293b',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
            '::placeholder': {
              color: '#94a3b8'
            }
          },
          invalid: {
            color: '#ef4444',
            iconColor: '#ef4444'
          }
        },
        hidePostalCode: true
      });

      cardElement.mount('#stripe-card-element');

      cardElement.on('change', function(event) {
        const displayError = document.getElementById('stripeCardError');
        if (event.error) {
          displayError.textContent = event.error.message;
          displayError.classList.add('show');
        } else {
          displayError.textContent = '';
          displayError.classList.remove('show');
        }
      });
    }

    // ===== REGION CONFIGURATION =====
    const NORTH_POSTCODES = [
      'B', 'CV', 'LE', 'DE', 'NG', 'S', 'DN', 'HU', 'YO', 'LS', 'BD', 'HX', 
      'WF', 'HD', 'M', 'OL', 'BL', 'WN', 'SK', 'L', 'WA', 'CH', 'CW', 'ST', 
      'TF', 'SY', 'WV', 'WS', 'DY', 'CF', 'SA', 'NP', 'LL', 'LD'
    ];

    const SOUTH_POSTCODES = [
      // Greater London
      'E', 'EC', 'N', 'NW', 'SE', 'SW', 'W', 'WC',
      // Surrounding areas
      'AL', 'BR', 'CM', 'CR', 'DA', 'EN', 'HA', 'IG', 'KT', 'RM', 'SL', 'SM', 
      'TW', 'UB', 'WD',
      // Home Counties
      'GU', 'HP', 'LU', 'MK', 'OX', 'RG', 'SG', 'SS', 'TN'
    ];

    const MEDIA_SPECIALISTS = {
      north: {
        name: 'Jodie',
        region: 'North'
      },
      south: {
        name: 'Maeve',
        region: 'South'
      }
    };

    let currentStep = 1;
    let bookingData = {
      postcode: '',
      propertyAddress: '',
      region: '', // ‚úÖ FIXED: lowercase for consistency
      mediaSpecialist: '',
      selectedDate: null,
      selectedTime: null,
      service: null,
      bedrooms: 4,
      basePrice: 0,
      extraBedroomFee: 0,
      totalPrice: 0,
      clientName: '',
      clientEmail: '',
      clientPhone: '',
      clientNotes: '',
      paymentOption: null,
      selectedAddons: []
    };

    let currentCalendarDate = new Date();

    // Add-Ons Catalog
    const ADDONS = {
  'standard-floor-plan': {
    id: 'standard-floor-plan',
    name: 'Standard Floor Plan',
    price: 24.00,
    duration: 0,
    description: '2D floor plan to help buyers visualize the property layout',
    appliesToVideo: false
  },
  'plus-floor-plan': {
    id: 'plus-floor-plan',
    name: 'Plus Floor Plan',
    price: 36.00,
    duration: 0,
    description: 'Enhanced 2D floor plan with measurements and room labels',
    appliesToVideo: false
  },
  'elevate-edit': {  // ‚úÖ CHANGED from 'cinematic-edit'
    id: 'elevate-edit',
    name: 'Elevate Your Edit',  // ‚úÖ NEW NAME
    price: 75.00,  // ‚úÖ CHANGED from 50.00
    duration: 0,
    description: 'Transform your video with premium editing including dynamic transitions, bold captions, spotlight features on key property details, advanced color grading, and creative effects that make your listing unforgettable',  // ‚úÖ NEW DESCRIPTION
    appliesToVideo: true
  },
  'property-drone-photo': {
    id: 'property-drone-photo',
    name: 'Property Drone Photography',
    price: 130.80,
    duration: 15,
    description: 'Up to 10 stunning aerial photographs',
    appliesToVideo: false
  },
  'property-drone-video': {
    id: 'property-drone-video',
    name: 'Property Drone Videography',
    price: 130.80,
    duration: 15,
    description: 'Up to 30-second cinematic aerial showcase',
    appliesToVideo: true
  },
  'property-video': {
    id: 'property-video',
    name: 'Property Videography',
    price: 154.80,
    duration: 60,
    description: 'Shot in 4K to captivate viewers and drive enquiries',
    appliesToVideo: true
  },
  'property-speed-tours': {
    id: 'property-speed-tours',
    name: 'Property Speed Tours',
    price: 60.00,
    duration: 0,
    description: 'Quick walkthrough video tour of the property',
    appliesToVideo: true
  },
  'add-branded-outro': {
    id: 'add-branded-outro',
    name: 'Add Branded Outro To Video',
    price: 0.00,
    duration: 0,
    description: 'Add your branded outro to any video content',
    appliesToVideo: true
  }
};
    // Service Catalog with Add-Ons
   const SERVICES = {
  north: [
    {
      id: 'complete-branding',
      name: 'Complete Branding Package - Photo & Video',
      price: 894.00,
      duration: 300,
      description: 'Full personal branding suite for estate agents. Photography and video content with classic editing included.',
      isPropertyService: false,
      availableAddons: ['elevate-edit', 'add-branded-outro']
    },
    {
      id: 'branding-video',
      name: 'Branding Videography Session',
      price: 534.00,
      duration: 180,
      description: 'Personal branding video for estate agents. Multiple sequences for social content with classic editing included.',
      isPropertyService: false,
      availableAddons: ['elevate-edit', 'add-branded-outro']
    },
    {
      id: 'branding-photo',
      name: 'Branding Photography Session - 10 Signature Shots',
      price: 414.00,
      duration: 120,
      description: 'Personal branding for estate agents. You\'re in every shot.',
      isPropertyService: false,
      availableAddons: []
    },
    {
      id: 'gold-package',
      name: 'Gold Package',
      price: 600.00,
      duration: 150,
      description: 'Everything in our Silver Package, plus enhanced lifestyle content with classic editing included.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'silver-package',
      name: 'Silver Package',
      price: 262.80,
      duration: 90,
      description: 'Everything in our Bronze Package, plus full videography and drone shots with classic editing included for complete property marketing.',
      popular: true,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'bronze-package',
      name: 'Bronze Package',
      price: 202.80,
      duration: 90,
      description: 'Up to 30 interior and exterior photos, plus drone shots included. Professional photography.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-speed-tours']
    },
    {
      id: 'all-in-one-drone',
      name: 'All In One Drone',
      price: 214.80,
      duration: 45,
      description: '10 aerial photos and a 30-second drone video with classic editing included for your property marketing.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'property-video',
      name: 'Property Videography',
      price: 154.80,
      duration: 60,
      description: 'Shot in 4K with classic editing included (color grading & smooth transitions) to captivate viewers and drive enquiries.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-drone-photo', 'property-drone-video', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'property-photo',
      name: 'Property Photography',
      price: 118.80,
      duration: 45,
      description: 'Up to 30 magazine-quality images that make your property irresistible to potential buyers.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-photo', 'property-drone-video', 'property-speed-tours']
    },
    {
      id: 'drone-video',
      name: 'Property Drone Videography',
      price: 130.80,
      duration: 20,
      description: 'Up to 30-second cinematic aerial showcase with classic editing included.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-drone-photo', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'drone-photo',
      name: 'Property Drone Photography',
      price: 130.80,
      duration: 20,
      description: 'Up to 10 stunning aerial photographs.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-video', 'property-speed-tours']
    }
  ],
  south: [
    {
      id: 'gold-package',
      name: 'Gold Package',
      price: 600.00,
      duration: 150,
      description: 'Everything in our Silver Package, plus enhanced lifestyle content with classic editing included.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'silver-package',
      name: 'Silver Package',
      price: 262.80,
      duration: 90,
      description: 'Everything in our Bronze Package, plus full videography and drone shots with classic editing included for complete property marketing.',
      popular: true,
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'bronze-package',
      name: 'Bronze Package',
      price: 202.80,
      duration: 90,
      description: 'Up to 30 interior and exterior photos, plus drone shots included. Professional photography.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-speed-tours']
    },
    {
      id: 'all-in-one-drone',
      name: 'All In One Drone',
      price: 214.80,
      duration: 45,
      description: '10 aerial photos and a 30-second drone video with classic editing included for your property marketing.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'property-video',
      name: 'Property Videography',
      price: 154.80,
      duration: 60,
      description: 'Shot in 4K with classic editing included (color grading & smooth transitions) to captivate viewers and drive enquiries.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-drone-photo', 'property-drone-video', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'property-photo',
      name: 'Property Photography',
      price: 118.80,
      duration: 45,
      description: 'Up to 30 magazine-quality images that make your property irresistible to potential buyers.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-photo', 'property-drone-video', 'property-speed-tours']
    },
    {
      id: 'drone-video',
      name: 'Property Drone Videography',
      price: 130.80,
      duration: 20,
      description: 'Up to 30-second cinematic aerial showcase with classic editing included.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-drone-photo', 'property-speed-tours', 'add-branded-outro']
    },
    {
      id: 'drone-photo',
      name: 'Property Drone Photography',
      price: 130.80,
      duration: 20,
      description: 'Up to 10 stunning aerial photographs.',
      isPropertyService: true,
      availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-video', 'property-speed-tours']
    }
  ]
};

    // Validate UK Postcode Format
    function validatePostcode(postcode) {
      const postcodeRegex = /^[A-Z]{1,2}[0-9]{1,2}[A-Z]?\s?[0-9][A-Z]{2}$/i;
      return postcodeRegex.test(postcode.trim());
    }

    // Determine Region from Postcode
    function determineRegion(postcode) {
      const cleanPostcode = postcode.trim().toUpperCase().replace(/\s/g, '');
      const outcodeArea = cleanPostcode.match(/^[A-Z]+/)[0];
      
      const isNorth = NORTH_POSTCODES.includes(outcodeArea);
      const isSouth = SOUTH_POSTCODES.includes(outcodeArea);
      
      return {
        region: isNorth ? 'north' : (isSouth ? 'south' : 'unknown'),
        mediaSpecialist: isNorth ? MEDIA_SPECIALISTS.north : (isSouth ? MEDIA_SPECIALISTS.south : null),
        isServiceable: isNorth || isSouth
      };
    }
    // New function to fetch addresses from GetAddress.io
    async function fetchAddressesFromPostcode(postcode) {
      const cleanPostcode = postcode.replace(/\s/g, '');
      
      const response = await fetch('/.netlify/functions/get-address', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ postcode: cleanPostcode })
      });
      
      if (!response.ok) {
        throw new Error('Failed to fetch addresses');
      }
      
      const data = await response.json();
      return data.addresses || [];
    }

    // New function to format address from GetAddress.io response
    function formatAddress(address) {
      const parts = [
        address.line_1,
        address.line_2,
        address.line_3,
        address.line_4,
        address.locality,
        address.town_or_city,
        address.county
      ].filter(part => part && part.trim() !== '');
      
      return parts.join(', ');
    }

    // New function to show address section with dropdown or manual entry
    function showAddressSection(addresses) {
      const addressSection = document.getElementById('addressSection');
      
      if (addresses && addresses.length > 0) {
        addressSection.innerHTML = `
          <div class="form-group">
            <label class="form-label" for="addressSelect">Select Your Property Address *</label>
            <select 
              id="addressSelect" 
              class="form-input" 
              style="cursor: pointer;"
              onchange="handleAddressSelection()"
            >
              <option value="">-- Select an address --</option>
              ${addresses.map((addr, index) => `
                <option value="${index}">
                  ${formatAddress(addr)}
                </option>
              `).join('')}
              <option value="manual">Enter address manually</option>
            </select>
            <div class="error-message" id="addressSelectError">Please select an address</div>
          </div>
          
          <div id="manualAddressEntry" style="display: none;">
            <div class="form-group">
              <label class="form-label" for="propertyAddress">Full Property Address *</label>
              <input 
                type="text" 
                id="propertyAddress" 
                class="form-input" 
                placeholder="e.g. 123 High Street, Leicester"
              />
              <div style="font-size: 12px; color: #64748b; margin-top: 6px;">
                This helps us plan the best route and ensure accurate timing
              </div>
              <div class="error-message" id="addressError">Please enter the property address</div>
            </div>
          </div>
        `;
        
        bookingData.availableAddresses = addresses;
      } else {
        addressSection.innerHTML = `
          <div class="form-group">
            <label class="form-label" for="propertyAddress">Full Property Address *</label>
            <input 
              type="text" 
              id="propertyAddress" 
              class="form-input" 
              placeholder="e.g. 123 High Street, Leicester"
            />
            <div style="font-size: 12px; color: #64748b; margin-top: 6px;">
              This helps us plan the best route and ensure accurate timing
            </div>
            <div class="error-message" id="addressError">Please enter the property address</div>
          </div>
        `;
      }
      
      addressSection.style.display = 'block';
    }

    // New function to handle address selection
    function handleAddressSelection() {
      const select = document.getElementById('addressSelect');
      const selectedValue = select.value;
      const manualEntry = document.getElementById('manualAddressEntry');
      const errorMsg = document.getElementById('addressSelectError');
      
      errorMsg.classList.remove('show');
      select.classList.remove('error');
      
      if (selectedValue === 'manual') {
        manualEntry.style.display = 'block';
        bookingData.propertyAddress = '';
        
        setTimeout(() => {
          document.getElementById('propertyAddress').focus();
        }, 100);
      } else if (selectedValue !== '') {
        manualEntry.style.display = 'none';
        const address = bookingData.availableAddresses[parseInt(selectedValue)];
        bookingData.propertyAddress = formatAddress(address);
      } else {
        manualEntry.style.display = 'none';
        bookingData.propertyAddress = '';
      }
    }

    async function checkPostcode() {
      const postcodeInput = document.getElementById('postcode');
      const postcode = postcodeInput.value;
      const errorMsg = document.getElementById('postcodeError');
      const checkBtn = document.getElementById('checkPostcodeBtn');
      const regionInfo = document.getElementById('regionInfo');
      const unavailableInfo = document.getElementById('unavailableInfo');

      postcodeInput.classList.remove('error');
      errorMsg.classList.remove('show');
      regionInfo.classList.remove('show');
      unavailableInfo.classList.remove('show');

      if (!validatePostcode(postcode)) {
        postcodeInput.classList.add('error');
        errorMsg.classList.add('show');
        return;
      }

      checkBtn.classList.add('loading');
      checkBtn.disabled = true;

      try {
        // Fetch addresses from GetAddress.io
        const addresses = await fetchAddressesFromPostcode(postcode);
        
        const result = determineRegion(postcode);

        // ‚úÖ FIXED: Store ALL region data in bookingData (lowercase)
        bookingData.postcode = postcode.toUpperCase();
        bookingData.region = result.region; // 'north' or 'south' (lowercase)
        bookingData.mediaSpecialist = result.mediaSpecialist.name; // 'Jodie' or 'Maeve'

        console.log('Region determined:', {
          postcode: bookingData.postcode,
          region: bookingData.region,
          mediaSpecialist: bookingData.mediaSpecialist,
          isServiceable: result.isServiceable
        });

        if (result.isServiceable) {
          const regionBadge = document.getElementById('regionBadge');
          regionBadge.className = `region-badge ${result.region}`;
          regionBadge.textContent = result.region.toUpperCase();
          
          document.getElementById('mediaSpecialistName').textContent = result.mediaSpecialist.name;
          regionInfo.classList.add('show');

          // Show address section with dropdown if addresses found
          showAddressSection(addresses);
          
          document.getElementById('checkPostcodeBtn').style.display = 'none';
          document.getElementById('continueWithAddressBtn').style.display = 'block';

          setTimeout(() => {
            const addressSelect = document.getElementById('addressSelect');
            if (addressSelect) {
              addressSelect.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              addressSelect.focus();
            } else {
              document.getElementById('propertyAddress').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              document.getElementById('propertyAddress').focus();
            }
          }, 500);
        } else {
          unavailableInfo.classList.add('show');
        }
      } catch (error) {
        console.error('Error fetching addresses:', error);
        // Fallback to manual entry if API fails
        const result = determineRegion(postcode);
        bookingData.postcode = postcode.toUpperCase();
        bookingData.region = result.region;
        bookingData.mediaSpecialist = result.mediaSpecialist?.name || '';

        if (result.isServiceable) {
          const regionBadge = document.getElementById('regionBadge');
          regionBadge.className = `region-badge ${result.region}`;
          regionBadge.textContent = result.region.toUpperCase();
          
          document.getElementById('mediaSpecialistName').textContent = result.mediaSpecialist.name;
          regionInfo.classList.add('show');

          // Show manual address entry
          showAddressSection([]);
          
          document.getElementById('checkPostcodeBtn').style.display = 'none';
          document.getElementById('continueWithAddressBtn').style.display = 'block';
        }
      }

      checkBtn.classList.remove('loading');
      checkBtn.disabled = false;
    }

    // ‚úÖ FIXED: Proper address validation
    function proceedToServiceSelection() {
      const addressSelect = document.getElementById('addressSelect');
      const manualAddressInput = document.getElementById('propertyAddress');
      
      // Clear previous errors
      const addressSelectError = document.getElementById('addressSelectError');
      const addressError = document.getElementById('addressError');
      
      if (addressSelectError) addressSelectError.classList.remove('show');
      if (addressError) addressError.classList.remove('show');
      if (addressSelect) addressSelect.classList.remove('error');
      if (manualAddressInput) manualAddressInput.classList.remove('error');
      
      // Check if using dropdown or manual entry
      if (addressSelect) {
        const selectedValue = addressSelect.value;
        
        if (selectedValue === 'manual') {
          // Validate manual entry
          const address = manualAddressInput.value.trim();
          
          if (!address || address.length < 10) {
            manualAddressInput.classList.add('error');
            addressError.classList.add('show');
            manualAddressInput.focus();
            return;
          }
          
          bookingData.propertyAddress = address;
        } else if (selectedValue === '') {
          // No address selected
          addressSelect.classList.add('error');
          addressSelectError.classList.add('show');
          addressSelect.focus();
          return;
        }
        // If valid selection, propertyAddress is already set in handleAddressSelection
      } else {
        // Fallback to manual entry only (if dropdown doesn't exist)
        const address = manualAddressInput.value.trim();
        
        if (!address || address.length < 10) {
          manualAddressInput.classList.add('error');
          addressError.classList.add('show');
          manualAddressInput.focus();
          return;
        }
        
        bookingData.propertyAddress = address;
      }

      goToStep(2);
    }
    // Navigate to Step
    function goToStep(stepNumber) {
      currentStep = stepNumber;

      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });

      document.getElementById(`step${stepNumber}`).classList.add('active');

      document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNum < stepNumber) {
          step.classList.add('completed');
        } else if (stepNum === stepNumber) {
          step.classList.add('active');
        }
      });

      if (stepNumber === 2) {
        renderServices();
      }

      if (stepNumber === 3) {
        renderCalendar();
      }

      if (stepNumber === 4) {
        populateBookingSummary();
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Populate Booking Summary
    function populateBookingSummary() {
      document.getElementById('summaryService').textContent = bookingData.service ? bookingData.service.name : '-';
      
      if (bookingData.selectedDate && bookingData.selectedTime) {
        const date = new Date(bookingData.selectedDate + 'T12:00:00');
        const options = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
        const formattedDate = date.toLocaleDateString('en-GB', options);
        document.getElementById('summaryDateTime').textContent = `${formattedDate} at ${bookingData.selectedTime}`;
      } else {
        document.getElementById('summaryDateTime').textContent = '-';
      }
      
      document.getElementById('summaryAddress').textContent = bookingData.propertyAddress || bookingData.postcode || '-';
      document.getElementById('summaryMediaSpecialist').textContent = bookingData.mediaSpecialist || '-';
      document.getElementById('summaryTotal').textContent = `¬£${bookingData.totalPrice.toFixed(2)}`;

      updateTermsVisibility();
    }

    // Update Terms Visibility
    function updateTermsVisibility() {
      const service = bookingData.service;
      if (!service) return;

      const termsItemRemoval = document.getElementById('termsItemRemoval');
      const termsItemRemovalConfirm = document.getElementById('termsItemRemovalConfirm');
      const termsPropertyAccess = document.getElementById('termsPropertyAccess');
      const termsHygiene = document.getElementById('termsHygiene');
      const termsAccess = document.getElementById('termsAccess');
      const termsHygieneConfirm = document.getElementById('termsHygieneConfirm');

      const isPropertyService = service.isPropertyService;
      const isDroneOnly = service.id === 'all-in-one-drone' || service.id === 'drone-video' || service.id === 'drone-photo';

      if (isPropertyService) {
        termsItemRemoval.style.display = 'block';
        termsItemRemovalConfirm.required = true;
      } else {
        termsItemRemoval.style.display = 'none';
        termsItemRemovalConfirm.required = false;
      }

      if (isPropertyService) {
        termsPropertyAccess.style.display = 'block';
        termsAccess.required = true;

        if (!isDroneOnly) {
          termsHygiene.style.display = 'block';
          termsHygieneConfirm.required = true;
        } else {
          termsHygiene.style.display = 'none';
          termsHygieneConfirm.required = false;
        }
      } else {
        termsPropertyAccess.style.display = 'none';
        termsHygiene.style.display = 'none';
        termsAccess.required = false;
        termsHygieneConfirm.required = false;
      }
    }

    // Select Payment Option
    function selectPaymentOption(option) {
      bookingData.paymentOption = option;
      
      document.querySelectorAll('.payment-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      event.target.closest('.payment-option').classList.add('selected');
      
      // Show/hide Stripe card section
      const stripeCardSection = document.getElementById('stripeCardSection');
      if (option === 'reserve') {
        stripeCardSection.style.display = 'block';
        
        // Initialize Stripe card element if not already initialized
        setTimeout(() => {
          initializeStripeCard();
        }, 100);
        
        // Make cardholder name required
        document.getElementById('cardholderName').required = true;
      } else {
        stripeCardSection.style.display = 'none';
        document.getElementById('cardholderName').required = false;
      }
      
      const submitBtnText = document.getElementById('completeBookingText');
      if (option === 'pay-now') {
        submitBtnText.textContent = 'Proceed to Payment';
      } else {
        submitBtnText.textContent = 'Reserve Booking';
      }
      
      validateStep4Form();
    }

    // Validate Step 4 Form
    function validateStep4Form() {
      const name = document.getElementById('clientName').value.trim();
      const email = document.getElementById('clientEmail').value.trim();
      const phone = document.getElementById('clientPhone').value.trim();
      const paymentOption = bookingData.paymentOption;
      
      const termsRevisions = document.getElementById('termsRevisions').checked;
      const termsAgree = document.getElementById('termsAgree').checked;
      
      const termsItemRemovalConfirm = document.getElementById('termsItemRemovalConfirm');
      const termsAccess = document.getElementById('termsAccess');
      const termsHygieneConfirm = document.getElementById('termsHygieneConfirm');
      
      const itemRemovalChecked = termsItemRemovalConfirm.required ? termsItemRemovalConfirm.checked : true;
      const accessChecked = termsAccess.required ? termsAccess.checked : true;
      const hygieneChecked = termsHygieneConfirm.required ? termsHygieneConfirm.checked : true;
      
      const submitBtn = document.getElementById('completeBookingBtn');
      
      if (name && email && phone && paymentOption && termsRevisions && termsAgree && itemRemovalChecked && accessChecked && hygieneChecked) {
        submitBtn.disabled = false;
      } else {
        submitBtn.disabled = true;
      }
    }

    // Render Services
    function renderServices() {
      const region = bookingData.region; // ‚úÖ FIXED: lowercase
      const services = SERVICES[region] || SERVICES.south;
      const container = document.getElementById('serviceCards');

      console.log('Rendering services for region:', region);

      const servicesHTML = services.map(service => `
        <div class="service-card ${service.popular ? 'popular' : ''}" data-service-id="${service.id}" onclick="selectService('${service.id}')">
          ${service.popular ? '<div class="popular-badge">Most Popular</div>' : ''}
          <div style="flex: 1;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 6px;">
              ${service.name}
            </h3>
            <p style="font-size: 14px; color: #64748b; line-height: 1.5; margin-bottom: 12px;">
              ${service.description}
            </p>
            <div style="display: flex; align-items: center; gap: 16px;">
              <span style="font-size: 13px; color: #94a3b8;">
                ${Math.floor(service.duration / 60)}h ${service.duration % 60}m
              </span>
              <span style="font-size: 20px; font-weight: 700; color: #3b82f6;">
                ¬£${service.price.toFixed(2)}
              </span>
            </div>
          </div>
          <div class="service-radio"></div>
        </div>
      `).join('');

      container.innerHTML = servicesHTML;
    }

    // Select Service
    function selectService(serviceId) {
      const region = bookingData.region; // ‚úÖ FIXED: lowercase
      const services = SERVICES[region] || SERVICES.south;
      const service = services.find(s => s.id === serviceId);

      if (!service) return;

      bookingData.service = service;
      bookingData.basePrice = service.price;
      bookingData.selectedAddons = [];

      document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-service-id="${serviceId}"]`).classList.add('selected');

      const bedroomSection = document.getElementById('bedroomSection');
      if (service.isPropertyService) {
        bedroomSection.style.display = 'block';
        bookingData.bedrooms = 4;
        document.getElementById('bedroomCount').textContent = 4;
      } else {
        bedroomSection.style.display = 'none';
        bookingData.bedrooms = 0;
      }

      renderAddons();
      calculatePrice();
      showDiscountSection();

      document.getElementById('continueToCalendarBtn').disabled = false;
    }

    // Render Add-Ons
    function renderAddons() {
      const service = bookingData.service;
      if (!service || !service.availableAddons || service.availableAddons.length === 0) {
        document.getElementById('addonsSection').style.display = 'none';
        return;
      }

      const container = document.getElementById('addonsGrid');
      const addonsHTML = service.availableAddons.map(addonId => {
        const addon = ADDONS[addonId];
        if (!addon) return '';

        const isSelected = bookingData.selectedAddons.includes(addonId);

        return `
          <div class="service-card ${isSelected ? 'selected' : ''}" 
               data-addon-id="${addon.id}" 
               onclick="toggleAddon('${addon.id}')"
               style="padding: 16px;">
            <div style="flex: 1;">
              <h4 style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
                ${addon.name}
              </h4>
              <p style="font-size: 13px; color: #64748b; line-height: 1.5; margin-bottom: 8px;">
                ${addon.description}
              </p>
              <div style="display: flex; align-items: center; gap: 12px;">
                ${addon.duration > 0 ? `
                  <span style="font-size: 12px; color: #94a3b8;">
                    +${addon.duration} min
                  </span>
                ` : ''}
                <span style="font-size: 18px; font-weight: 700; color: #3b82f6;">
                  ${addon.price === 0 ? 'FREE' : `+¬£${addon.price.toFixed(2)}`}
                </span>
              </div>
            </div>
            <div class="service-radio"></div>
          </div>
        `;
      }).join('');

      container.innerHTML = addonsHTML;
      document.getElementById('addonsSection').style.display = 'block';
    }

    // Toggle Add-On
    function toggleAddon(addonId) {
      const index = bookingData.selectedAddons.indexOf(addonId);
      
      if (index > -1) {
        bookingData.selectedAddons.splice(index, 1);
      } else {
        bookingData.selectedAddons.push(addonId);
      }

      renderAddons();
      calculatePrice();
    }

    // Adjust Bedrooms
    function adjustBedrooms(change) {
      const currentBedrooms = bookingData.bedrooms;
      const newBedrooms = Math.max(1, Math.min(15, currentBedrooms + change));
      
      bookingData.bedrooms = newBedrooms;
      document.getElementById('bedroomCount').textContent = newBedrooms;

      const feeNotice = document.getElementById('bedroomFeeNotice');
      if (newBedrooms > 4) {
        feeNotice.style.display = 'block';
      } else {
        feeNotice.style.display = 'none';
      }

      calculatePrice();
    }

    // Calculate Total Price
    function calculatePrice() {
      if (!bookingData.service) return;

      const basePrice = bookingData.basePrice;
      const extraRooms = bookingData.bedrooms > 4 ? bookingData.bedrooms - 4 : 0;
      const extraBedroomFee = extraRooms * 30;
      
      let addonsPrice = 0;
      let addonsDuration = 0;
      bookingData.selectedAddons.forEach(addonId => {
        const addon = ADDONS[addonId];
        if (addon) {
          addonsPrice += addon.price;
          addonsDuration += addon.duration;
        }
      });

      const totalPrice = basePrice + extraBedroomFee + addonsPrice;

      bookingData.extraBedroomFee = extraBedroomFee;
      bookingData.addonsPrice = addonsPrice;
      bookingData.addonsDuration = addonsDuration;
      bookingData.totalPrice = totalPrice;

      document.getElementById('servicePrice').textContent = `¬£${basePrice.toFixed(2)}`;
      document.getElementById('totalPrice').textContent = `¬£${totalPrice.toFixed(2)}`;

      const bedroomFeeRow = document.getElementById('bedroomFeeRow');
      if (extraBedroomFee > 0) {
        bedroomFeeRow.style.display = 'flex';
        bedroomFeeRow.querySelector('.detail-value').textContent = `¬£${extraBedroomFee.toFixed(2)}`;
      } else {
        bedroomFeeRow.style.display = 'none';
      }

      let addonsRow = document.getElementById('addonsRow');
      if (!addonsRow && addonsPrice > 0) {
        const bedroomRow = document.getElementById('bedroomFeeRow');
        addonsRow = document.createElement('div');
        addonsRow.id = 'addonsRow';
        addonsRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        addonsRow.innerHTML = `
          <span style="font-size: 14px; color: #64748b;">Add-ons</span>
          <span style="font-size: 14px; font-weight: 600; color: #1e293b;" class="addons-value">¬£0.00</span>
        `;
        bedroomRow.parentNode.insertBefore(addonsRow, bedroomRow.nextSibling);
      }

      if (addonsRow) {
        if (addonsPrice > 0) {
          addonsRow.style.display = 'flex';
          addonsRow.querySelector('.addons-value').textContent = `¬£${addonsPrice.toFixed(2)}`;
        } else {
          addonsRow.style.display = 'none';
        }
      }

      document.getElementById('priceBreakdown').style.display = 'block';
    }
    // Change Month
    function changeMonth(direction) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
      renderCalendar();
    }

    // Render Calendar
    function renderCalendar() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDay = firstDay.getDay();

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const maxDate = new Date();
      maxDate.setDate(maxDate.getDate() + 60);
      maxDate.setHours(23, 59, 59, 999);

      const grid = document.getElementById('calendarGrid');
      let html = '';

      const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayLabels.forEach(label => {
        html += `<div class="calendar-day day-label">${label}</div>`;
      });

      for (let i = 0; i < startDay; i++) {
        html += `<div class="calendar-day disabled other-month"></div>`;
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0);
        
        const isPast = date < today;
        const isTooFarAhead = date > maxDate;
        const isSunday = date.getDay() === 0;
        const isSaturday = date.getDay() === 6;
        const isDisabled = isPast || isTooFarAhead || isSunday || isSaturday;
        const isToday = date.getTime() === today.getTime();
        const isSelected = bookingData.selectedDate && date.getTime() === new Date(bookingData.selectedDate).getTime();

        let classes = 'calendar-day';
        if (isDisabled) classes += ' disabled';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';

        const dateString = date.toISOString().split('T')[0];
        html += `<div class="${classes}" onclick="${isDisabled ? '' : `selectDate('${dateString}')`}">${day}</div>`;
      }

      grid.innerHTML = html;
    }

    // Select Date
    async function selectDate(dateString) {
      bookingData.selectedDate = dateString;
      bookingData.selectedTime = null;

      renderCalendar();

      document.getElementById('timeSlotSection').style.display = 'block';
      document.getElementById('loadingTimeSlots').style.display = 'block';
      document.getElementById('timeSlotGrid').style.display = 'none';

      const date = new Date(dateString + 'T12:00:00');
      const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
      document.getElementById('selectedDateDisplay').textContent = date.toLocaleDateString('en-GB', options);

      await loadAvailableTimeSlots(dateString);

      document.getElementById('timeSlotSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Load Available Time Slots
async function loadAvailableTimeSlots(dateString) {
  try {
    // ‚úÖ Calculate total duration (service + addons)
    const serviceDuration = bookingData.service ? bookingData.service.duration : 90;
    const addonsDuration = bookingData.addonsDuration || 0;
    const totalDuration = serviceDuration + addonsDuration;

    console.log('Loading time slots with data:', {
      postcode: bookingData.postcode,
      region: bookingData.region,
      selectedDate: dateString,
      duration: totalDuration // ‚úÖ ADD THIS
    });

    const response = await fetch('/.netlify/functions/check-availability', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        postcode: bookingData.postcode,
        region: bookingData.region,
        selectedDate: dateString,
        duration: totalDuration // ‚úÖ ADD THIS LINE
      })
    });

    if (!response.ok) {
      throw new Error('Failed to check availability');
    }

    const data = await response.json();
    console.log('Availability check response:', data);

    renderTimeSlots(data.availableSlots);
  } catch (error) {
    console.error('Error loading time slots:', error);
    
    const fallbackSlots = [];
    for (let hour = 9; hour <= 15; hour++) {
      for (let minute of [0, 30]) {
        if (hour === 15 && minute === 30) break;
        
        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        fallbackSlots.push({
          time: timeString,
          available: true
        });
      }
    }
    
    renderTimeSlots(fallbackSlots);
    
    document.getElementById('loadingTimeSlots').innerHTML = 
      '<p style="color: #f59e0b;">Could not verify availability. Showing all time slots.</p>';
    
    setTimeout(() => {
      document.getElementById('loadingTimeSlots').style.display = 'none';
      document.getElementById('timeSlotGrid').style.display = 'grid';
    }, 1000);
  }
}

    // Render Time Slots
    function renderTimeSlots(slots) {
      const grid = document.getElementById('timeSlotGrid');
      
      const html = slots.map(slot => {
        const classes = slot.available ? 'time-slot' : 'time-slot disabled';
        const onclick = slot.available ? `selectTimeSlot('${slot.time}')` : '';
        
        return `<div class="${classes}" onclick="${onclick}">${slot.time}</div>`;
      }).join('');

      grid.innerHTML = html;
      
      document.getElementById('loadingTimeSlots').style.display = 'none';
      document.getElementById('timeSlotGrid').style.display = 'grid';
    }

    // Select Time Slot
    function selectTimeSlot(time) {
      bookingData.selectedTime = time;

      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
      });
      event.target.classList.add('selected');

      document.getElementById('continueToDetailsBtn').disabled = false;
    }
    // Event listeners for form validation
document.addEventListener('DOMContentLoaded', function() {
  const nameField = document.getElementById('clientName');
  const emailField = document.getElementById('clientEmail');
  const phoneField = document.getElementById('clientPhone');
  
  if (nameField) nameField.addEventListener('input', validateStep4Form);
  if (emailField) emailField.addEventListener('input', validateStep4Form);
  if (phoneField) phoneField.addEventListener('input', validateStep4Form);

  const checkboxes = ['termsRevisions', 'termsItemRemovalConfirm', 'termsAccess', 'termsHygieneConfirm', 'termsAgree'];
  checkboxes.forEach(id => {
    const checkbox = document.getElementById(id);
    if (checkbox) checkbox.addEventListener('change', validateStep4Form);
  });

 // ‚úÖ Check privilege when email is entered
  if (emailField) {
    emailField.addEventListener('blur', async function() {
      const email = this.value.trim();
      
      if (!email || !email.includes('@')) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/check-reserve-privilege', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        });
        
        const data = await response.json();
        
        if (data.success) {
          const paymentSection = document.getElementById('paymentOptionsSection');
          const skipMessage = document.getElementById('skipPaymentMessage');
          const reserveOption = document.querySelector('.payment-option[onclick*="reserve"]');
          
          if (data.skipPayment) {
            // ‚úÖ TRUSTED CUSTOMER: Hide all payment options, show trusted message
            paymentSection.style.display = 'none';
            skipMessage.style.display = 'block';
            bookingData.paymentOption = 'book-without-payment';
            
          } else if (data.isNewCustomer) {
            // ‚ùå NEW CUSTOMER: Show Pay Now ONLY (hide Reserve)
            paymentSection.style.display = 'block';
            skipMessage.style.display = 'none';
            if (reserveOption) reserveOption.style.display = 'none';
            bookingData.paymentOption = null;
            
          } else {
            // ‚úÖ EXISTING CUSTOMER: Show BOTH Pay Now and Reserve
            paymentSection.style.display = 'block';
            skipMessage.style.display = 'none';
            if (reserveOption) reserveOption.style.display = 'flex';
            bookingData.paymentOption = null;
          }
          
          // Reset selections
          document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          
          validateStep4Form();
        }
      } catch (error) {
        console.error('Error checking reserve privilege:', error);
        // On error, show normal payment options (Pay Now only for safety)
        document.getElementById('paymentOptionsSection').style.display = 'block';
        document.getElementById('skipPaymentMessage').style.display = 'none';
        const reserveOption = document.querySelector('.payment-option[onclick*="reserve"]');
        if (reserveOption) reserveOption.style.display = 'none';
      }
    });
  }
});

 // Complete Booking
async function completeBooking() {
  const name = document.getElementById('clientName').value.trim();
  const email = document.getElementById('clientEmail').value.trim();
  const phone = document.getElementById('clientPhone').value.trim();
  const notes = document.getElementById('clientNotes').value.trim();

  // Clear previous errors
  document.querySelectorAll('.form-input').forEach(input => input.classList.remove('error'));
  document.querySelectorAll('.error-message').forEach(msg => msg.classList.remove('show'));

  let hasError = false;

  // Validate name
  if (!name || name.length < 2) {
    document.getElementById('clientName').classList.add('error');
    document.getElementById('nameError').classList.add('show');
    hasError = true;
  }

  // Validate email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!email || !emailRegex.test(email)) {
    document.getElementById('clientEmail').classList.add('error');
    document.getElementById('emailError').classList.add('show');
    hasError = true;
  }

  // Validate phone
  const phoneRegex = /^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{3}\s?\d{3}$/;
  if (!phone || !phoneRegex.test(phone.replace(/\s/g, ''))) {
    document.getElementById('clientPhone').classList.add('error');
    document.getElementById('phoneError').classList.add('show');
    hasError = true;
  }

  if (hasError) {
    const firstError = document.querySelector('.form-input.error');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    return;
  }

  // ‚úÖ NEW: Check if they can skip payment entirely (trusted customer)
  if (bookingData.paymentOption === 'book-without-payment') {
    console.log('Trusted customer - booking without payment');
    
    bookingData.clientName = name;
    bookingData.clientEmail = email;
    bookingData.clientPhone = phone;
    bookingData.clientNotes = notes;
    
    const submitBtn = document.getElementById('completeBookingBtn');
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    try {
      await createBooking(); // Create booking with Payment Status = "Pending"
    } catch (error) {
      console.error('Booking error:', error);
      alert('Failed to create booking. Please try again.');
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
    }
    return; // ‚úÖ Exit early - skip all payment/Stripe logic below
  }

  // ‚úÖ EXISTING: Check if booking is free (¬£0 total) - SKIP ALL PAYMENT LOGIC
  if (bookingData.totalPrice === 0) {
    console.log('Total is ¬£0 - creating free booking');
    
    bookingData.clientName = name;
    bookingData.clientEmail = email;
    bookingData.clientPhone = phone;
    bookingData.clientNotes = notes;
    bookingData.paymentOption = 'free';
    
    const submitBtn = document.getElementById('completeBookingBtn');
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    try {
      await createBooking();
    } catch (error) {
      console.error('Booking error:', error);
      alert('Failed to create booking. Please try again.');
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
    }
    return; // Exit early - skip all card/payment logic below
  }

  // Create Stripe Payment Method if Reserve Without Payment
  let paymentMethodId = null;
  if (bookingData.paymentOption === 'reserve') {
    const cardholderName = document.getElementById('cardholderName').value.trim();
    
    if (!cardholderName || cardholderName.length < 2) {
      document.getElementById('cardholderName').classList.add('error');
      document.getElementById('cardholderNameError').classList.add('show');
      hasError = true;
    }
    
    if (hasError) {
      const firstError = document.querySelector('.form-input.error');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('completeBookingBtn');
    submitBtn.disabled = true;
    submitBtn.classList.add('loading');
    
    try {
      // Create payment method with Stripe
      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: 'card',
        card: cardElement,
        billing_details: {
          name: cardholderName,
          email: email
        }
      });
      
      if (error) {
        throw new Error(error.message);
      }
      
      paymentMethodId = paymentMethod.id;
      
      // Get card details for display
      bookingData.cardholderName = cardholderName;
      bookingData.cardLast4 = paymentMethod.card.last4;
      bookingData.cardBrand = paymentMethod.card.brand;
      bookingData.cardExpiry = `${paymentMethod.card.exp_month.toString().padStart(2, '0')}/${paymentMethod.card.exp_year.toString().slice(-2)}`;
      bookingData.stripePaymentMethodId = paymentMethodId;
      
    } catch (error) {
      console.error('Stripe error:', error);
      document.getElementById('stripeCardError').textContent = error.message || 'Failed to save card details. Please try again.';
      document.getElementById('stripeCardError').classList.add('show');
      
      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
      return;
    }
  }
  
  if (hasError) {
    const firstError = document.querySelector('.form-input.error');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    return;
  }
  
  bookingData.clientName = name;
  bookingData.clientEmail = email;
  bookingData.clientPhone = phone;
  bookingData.clientNotes = notes;
  
  const submitBtn = document.getElementById('completeBookingBtn');
  submitBtn.classList.add('loading');
  submitBtn.disabled = true;
  
  try {
    if (bookingData.paymentOption === 'pay-now') {
      await processStripePayment();
    } else {
      await createBooking();
    }
  } catch (error) {
    console.error('Booking error:', error);
    alert('Failed to create booking. Please try again.');
    submitBtn.classList.remove('loading');
    submitBtn.disabled = false;
  }
}

    // Create Booking
async function createBooking() {
  const bookingPayload = {
    postcode: bookingData.postcode,
    propertyAddress: bookingData.propertyAddress,
    region: bookingData.region,
    mediaSpecialist: bookingData.mediaSpecialist,
    date: bookingData.selectedDate,
    time: bookingData.selectedTime,
    service: bookingData.service.name,
    serviceId: bookingData.service.id,
    duration: bookingData.service.duration + (bookingData.addonsDuration || 0),
    bedrooms: bookingData.bedrooms,
    basePrice: bookingData.basePrice,
    extraBedroomFee: bookingData.extraBedroomFee,
    addons: bookingData.selectedAddons.map(id => ({
      id: id,
      name: ADDONS[id].name,
      price: ADDONS[id].price
    })),
    addonsPrice: bookingData.addonsPrice || 0,
    
    // ‚úÖ ADD THESE DISCOUNT FIELDS
    discountCode: bookingData.discountCode || '',
    discountAmount: bookingData.discountAmount || 0,
    priceBeforeDiscount: bookingData.priceBeforeDiscount || 0,
    totalPrice: bookingData.totalPrice, // This should be the discounted price
    
    clientName: bookingData.clientName,
    clientEmail: bookingData.clientEmail,
    clientPhone: bookingData.clientPhone,
    clientNotes: bookingData.clientNotes,
    paymentOption: bookingData.paymentOption,
    
    // Stripe Payment Method (card on file)
    stripePaymentMethodId: bookingData.stripePaymentMethodId || '',
    cardholderName: bookingData.cardholderName || '',
    cardLast4: bookingData.cardLast4 || '',
    cardBrand: bookingData.cardBrand || '',
    cardExpiry: bookingData.cardExpiry || '',
    
    status: 'Booked'
  };
  
  console.log('Creating booking with payload:', bookingPayload);
      
      const response = await fetch('/.netlify/functions/create-booking', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(bookingPayload)
      });

      if (!response.ok) {
        throw new Error('Failed to create booking');
      }

      const result = await response.json();
      console.log('Booking created:', result);
      
      window.location.href = `/booking-success?ref=${result.bookingRef}&email=${encodeURIComponent(bookingData.clientEmail)}`;
    }

    async function processStripePayment() {
  try {
    // ‚úÖ NEW: If total is ¬£0, skip Stripe and create booking directly
    if (bookingData.totalPrice === 0) {
      console.log('Total is ¬£0 - creating booking without payment');
      bookingData.paymentOption = 'free';
      await createBooking();
      return;
    }

    const response = await fetch('/.netlify/functions/create-stripe-checkout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        postcode: bookingData.postcode,
        propertyAddress: bookingData.propertyAddress,
        region: bookingData.region,
        mediaSpecialist: bookingData.mediaSpecialist,
        date: bookingData.selectedDate,
        time: bookingData.selectedTime,
        service: bookingData.service.name,
        serviceId: bookingData.service.id,
        duration: bookingData.service.duration + (bookingData.addonsDuration || 0),
        bedrooms: bookingData.bedrooms,
        basePrice: bookingData.basePrice,
        extraBedroomFee: bookingData.extraBedroomFee,
        addons: bookingData.selectedAddons.map(id => ({
          id: id,
          name: ADDONS[id].name,
          price: ADDONS[id].price
        })),
        addonsPrice: bookingData.addonsPrice || 0,
        totalPrice: bookingData.totalPrice,
        
        // ‚úÖ ADD THESE 3 LINES:
        discountCode: bookingData.discountCode || '',
        discountAmount: bookingData.discountAmount || 0,
        priceBeforeDiscount: bookingData.priceBeforeDiscount || 0,
        
        clientName: bookingData.clientName,
        clientEmail: bookingData.clientEmail,
        clientPhone: bookingData.clientPhone,
        clientNotes: bookingData.clientNotes
      })
    });

        if (!response.ok) {
          throw new Error('Failed to create checkout session');
        }

        const { url } = await response.json();
        
        // Redirect to Stripe Checkout
        window.location.href = url;

      } catch (error) {
        console.error('Stripe error:', error);
        throw error;
      }
    }

    // Auto-format postcode
    document.getElementById('postcode').addEventListener('input', function(e) {
      let value = e.target.value.toUpperCase().replace(/\s/g, '');
      
      if (value.length > 3) {
        value = value.slice(0, -3) + ' ' + value.slice(-3);
      }
      
      e.target.value = value;
    });

    // Allow Enter key
    document.getElementById('postcode').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkPostcode();
      }
    });

    // Allow Enter key on address field
    document.addEventListener('DOMContentLoaded', function() {
      const addressField = document.getElementById('propertyAddress');
      if (addressField) {
        addressField.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            proceedToServiceSelection();
          }
        });
      }
    });

    console.log('Booking Platform with Add-Ons Initialized');

    // Discount code state
let appliedDiscount = null;

// Show discount section when service is selected
function showDiscountSection() {
  if (bookingData.service) {
    document.getElementById('discountSection').style.display = 'block';
  }
}

// Apply Discount Code
async function applyDiscountCode() {
  const input = document.getElementById('discountCodeInput');
  const code = input.value.trim().toUpperCase();
  const errorMsg = document.getElementById('discountCodeError');
  const successMsg = document.getElementById('discountSuccess');
  const applyBtn = document.getElementById('applyDiscountBtn');
  const removeBtn = document.getElementById('removeDiscountBtn');
  
  // Clear previous messages
  errorMsg.classList.remove('show');
  successMsg.style.display = 'none';
  input.classList.remove('error');
  
  if (!code) {
    input.classList.add('error');
    errorMsg.textContent = 'Please enter a discount code';
    errorMsg.classList.add('show');
    return;
  }
  
  if (!bookingData.service) {
    input.classList.add('error');
    errorMsg.textContent = 'Please select a service first';
    errorMsg.classList.add('show');
    return;
  }
  
  // Show loading
  applyBtn.disabled = true;
  applyBtn.innerHTML = '<div class="loading-spinner"></div>';
  
  try {
    // ‚úÖ FIXED: Capitalize region for Airtable lookup
    const regionCapitalized = bookingData.region.charAt(0).toUpperCase() + bookingData.region.slice(1);
    
    console.log('Validating discount code:', {
      code,
      region: regionCapitalized,
      serviceId: bookingData.service.id,
      totalPrice: bookingData.totalPrice
    });
    
    const response = await fetch('/.netlify/functions/validate-discount-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: code,
        totalPrice: bookingData.totalPrice,
        region: regionCapitalized, // ‚úÖ 'North' or 'South'
        serviceId: bookingData.service.id
      })
    });
    
    const data = await response.json();
    console.log('Discount validation response:', data);
    
    if (data.success) {
      // Store discount data
      appliedDiscount = {
        code: data.code,
        discountType: data.discountType,
        discountValue: data.discountValue,
        discountAmount: data.discountAmount,
        originalPrice: data.originalPrice,
        finalPrice: data.finalPrice,
        recordId: data.recordId
      };
      
      // Update booking data
      bookingData.discountCode = data.code;
      bookingData.discountAmount = data.discountAmount;
      bookingData.priceBeforeDiscount = data.originalPrice;
      bookingData.totalPrice = data.finalPrice;
      
      // Show success message
      const discountText = data.discountType === 'Percentage' 
        ? `${data.discountValue}% off (-¬£${data.discountAmount.toFixed(2)})`
        : `¬£${data.discountAmount.toFixed(2)} off`;
      
      document.getElementById('discountSuccessText').textContent = discountText;
      successMsg.style.display = 'block';
      input.disabled = true;
      applyBtn.style.display = 'none';
      removeBtn.style.display = 'block';
      
      // Update price display
      updatePriceWithDiscount();
      
    } else {
      input.classList.add('error');
      errorMsg.textContent = data.error || 'Invalid discount code';
      errorMsg.classList.add('show');
    }
    
  } catch (error) {
    console.error('Error applying discount:', error);
    input.classList.add('error');
    errorMsg.textContent = 'Failed to apply discount code. Please try again.';
    errorMsg.classList.add('show');
  }
  
  // Reset button
  applyBtn.disabled = false;
  applyBtn.innerHTML = 'Apply';
}

// Remove Discount Code
function removeDiscountCode() {
  appliedDiscount = null;
  bookingData.discountCode = null;
  bookingData.discountAmount = 0;
  bookingData.priceBeforeDiscount = 0;
  
  // Recalculate original price
  calculatePrice();
  
  // Reset UI
  document.getElementById('discountCodeInput').value = '';
  document.getElementById('discountCodeInput').disabled = false;
  document.getElementById('discountSuccess').style.display = 'none';
  document.getElementById('applyDiscountBtn').style.display = 'block';
  document.getElementById('removeDiscountBtn').style.display = 'none';
  
  // Remove discount row
  const discountRow = document.getElementById('discountRow');
  if (discountRow) discountRow.remove();
}

// Update Price Display with Discount
function updatePriceWithDiscount() {
  if (!appliedDiscount) return;
  
  // Add discount row to price breakdown
  let discountRow = document.getElementById('discountRow');
  if (!discountRow) {
    const priceBreakdown = document.getElementById('priceBreakdown');
    const divider = priceBreakdown.querySelector('[style*="border-top"]');
    
    discountRow = document.createElement('div');
    discountRow.id = 'discountRow';
    discountRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
    discountRow.innerHTML = `
      <span style="font-size: 14px; color: #10b981; font-weight: 600;">
        Discount (${appliedDiscount.code})
      </span>
      <span style="font-size: 14px; font-weight: 600; color: #10b981;">
        -¬£${appliedDiscount.discountAmount.toFixed(2)}
      </span>
    `;
    
    priceBreakdown.insertBefore(discountRow, divider);
  }
  
  // Update total price
  document.getElementById('totalPrice').textContent = `¬£${appliedDiscount.finalPrice.toFixed(2)}`;
  document.getElementById('summaryTotal').textContent = `¬£${appliedDiscount.finalPrice.toFixed(2)}`;
}
  </script>
</body>
</html>