<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Your Booking - Markeb Media</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Stripe.js for cancellation payments -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  padding: 40px 20px;
  color: #1e293b;
  position: relative;
  overflow-x: hidden;
}

/* Video Background */
.video-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}

.video-background video {
  position: absolute;
  top: 50%;
  left: 50%;
  min-width: 100%;
  min-height: 100%;
  width: auto;
  height: auto;
  transform: translate(-50%, -50%);
  object-fit: cover;
}

.video-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.85) 0%, rgba(37, 99, 235, 0.85) 100%);
}

.container {
  max-width: 800px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

    .header {
  text-align: center;
  margin-bottom: 40px;
  margin-top: 112px; /* ‚úÖ ADD THIS LINE */
}

    .header h1 {
      font-size: 42px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 12px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .header p {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.9);
    }

    .card {
      background: #fff;
      border-radius: 20px;
      padding: 48px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin-bottom: 24px;
    }

    .booking-detail {
      display: flex;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .booking-detail:last-child {
      border-bottom: none;
    }

    .booking-detail-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
    }

    .booking-detail-value {
      font-size: 14px;
      color: #1e293b;
      font-weight: 600;
      text-align: right;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.paid {
      background: #10b981;
      color: #fff;
    }

    .status-badge.reserved {
      background: #f59e0b;
      color: #fff;
    }

    .status-badge.cancelled {
      background: #ef4444;
      color: #fff;
    }

    .btn {
      padding: 14px 32px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      justify-content: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #64748b;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-danger {
      background: #ef4444;
      color: #fff;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 24px;
    }

    .alert {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      line-height: 1.6;
    }

    .alert-info {
      background: #eff6ff;
      border: 2px solid #3b82f6;
      color: #1e40af;
    }

    .alert-warning {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      color: #92400e;
    }

    .alert-error {
      background: #fef2f2;
      border: 2px solid #ef4444;
      color: #991b1b;
    }

    .alert-success {
      background: #f0fdf4;
      border: 2px solid #10b981;
      color: #065f46;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      margin-bottom: 16px;
    }

    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
    }

    .hidden {
      display: none !important;
    }

    .payment-breakdown {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .payment-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
    }

    .payment-row.total {
      border-top: 2px solid #e2e8f0;
      margin-top: 12px;
      padding-top: 12px;
      font-size: 18px;
      font-weight: 700;
    }

   /* Calendar Styles */
.calendar-container {
  background: #fff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 24px;
  max-width: 100%;
  overflow: hidden;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.calendar-nav-btn {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  border: 2px solid #e2e8f0;
  background: #fff;
  cursor: pointer;
  font-size: 16px;
  font-weight: 700;
  color: #64748b;
  transition: all 0.2s ease;
}

.calendar-nav-btn:hover {
  border-color: #3b82f6;
  color: #3b82f6;
}

.calendar-month-title {
  font-size: 16px;
  font-weight: 700;
  color: #1e293b;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}

.calendar-day {
  aspect-ratio: 1;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  background: #fff;
  color: #1e293b;
  min-width: 0;
}

    .calendar-day.day-label {
      background: transparent;
      border: none;
      font-size: 12px;
      font-weight: 700;
      color: #94a3b8;
      cursor: default;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .calendar-day.disabled {
      background: #f8fafc;
      color: #cbd5e1;
      cursor: not-allowed;
    }

    .calendar-day.other-month {
      color: #cbd5e1;
    }

    .calendar-day:not(.disabled):not(.day-label):not(.other-month):hover {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: scale(1.05);
    }

    .calendar-day.selected {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
      color: #fff;
    }

    .calendar-day.today {
      border-color: #10b981;
      font-weight: 700;
    }

    /* Time Slot Styles */
    .time-slot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .time-slot {
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fff;
      color: #1e293b;
    }

    .time-slot:hover {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: translateY(-2px);
    }

    .time-slot.selected {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
      color: #fff;
    }

    .time-slot.disabled {
      background: #f8fafc;
      color: #cbd5e1;
      cursor: not-allowed;
      border-color: #f1f5f9;
    }

    .time-slot.disabled:hover {
      transform: none;
      border-color: #f1f5f9;
      background: #f8fafc;
    }

    /* Service Card Styles */
    .service-card {
      background: #fff;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
      margin-bottom: 12px;
    }

    .service-card:hover {
      border-color: #3b82f6;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .service-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .service-radio {
      width: 24px;
      height: 24px;
      border: 3px solid #e2e8f0;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .service-card:hover .service-radio {
      border-color: #3b82f6;
    }

    .service-card.selected .service-radio {
      border-color: #3b82f6;
      background: #3b82f6;
      position: relative;
    }

    .service-card.selected .service-radio::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
    }

    /* Bedroom Counter */
    .bedroom-btn {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
      background: #fff;
      font-size: 24px;
      font-weight: 700;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }

    .bedroom-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
      transform: scale(1.05);
    }

    .bedroom-btn:active {
      transform: scale(0.95);
    }

   /* Mobile Responsive */
@media (max-width: 768px) {
  .card {
    padding: 24px;
  }

  .button-group {
    grid-template-columns: 1fr;
  }

  .calendar-container {
    padding: 12px;
  }

  .calendar-grid {
    gap: 4px;
  }

  .calendar-day {
    font-size: 12px;
    border-width: 1px;
  }

  .time-slot-grid {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  }
}

  </style>
</head>
<body>

<!-- Video Background -->
  <div class="video-background">
    <video autoplay muted loop playsinline id="bgVideo">
      <source src="/public/videos/property-showcase.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>
  </div>

  <div class="container">
    <div class="header">
      <h1>Manage Your Booking</h1>
      <p>Reschedule or cancel your shoot</p>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="card">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Loading your booking...</p>
      </div>
    </div>

    <!-- Booking Not Found -->
<div id="notFoundState" class="card hidden">
  <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 16px; color: #1e293b;">
    Booking Not Found
  </h2>
  <p style="color: #64748b; margin-bottom: 24px;">
    We couldn't find a booking with the provided details. Please check your booking reference and email address.
  </p>
  <a href="/website/booking.html" class="btn btn-primary">Make a New Booking</a>
</div>

    <!-- Booking Details -->
    <div id="bookingDetails" class="hidden">
      <!-- Booking Info Card -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
          <div>
            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #1e293b;">
              Your Booking
            </h2>
            <p style="color: #64748b;">
              Ref: <strong id="bookingRef">-</strong>
            </p>
          </div>
          <div id="bookingStatus" class="status-badge paid">Confirmed</div>
        </div>

        <div id="cancellationWarning" class="alert alert-warning hidden">
          <strong>‚è∞ Cancellation Policy:</strong> You have <strong id="hoursRemaining">-</strong> hours until your booking. Free cancellation is available until 24 hours before your shoot time.
        </div>

        <div style="margin-bottom: 24px;">
          <div class="booking-detail">
            <span class="booking-detail-label">Service</span>
            <span class="booking-detail-value" id="detailService">-</span>
          </div>
          <div class="booking-detail">
            <span class="booking-detail-label">Date & Time</span>
            <span class="booking-detail-value" id="detailDateTime">-</span>
          </div>
          <div class="booking-detail">
            <span class="booking-detail-label">Property Address</span>
            <span class="booking-detail-value" id="detailAddress" style="max-width: 400px;">-</span>
          </div>
          <div class="booking-detail">
            <span class="booking-detail-label">Media Specialist</span>
            <span class="booking-detail-value" id="detailMediaSpecialist">-</span>
          </div>
          <div class="booking-detail">
            <span class="booking-detail-label">Total Amount</span>
            <span class="booking-detail-value" id="detailTotal">-</span>
          </div>
        </div>

        <div class="button-group">
  <button id="modifyServiceBtn" class="btn btn-secondary" onclick="showModifyServiceForm()">
    üõ†Ô∏è Modify Service
  </button>
  <button id="rescheduleBtn" class="btn btn-secondary" onclick="showRescheduleForm()">
    üìÖ Reschedule
  </button>
  <button id="cancelBtn" class="btn btn-danger" onclick="showCancelForm()">
    ‚úñÔ∏è Cancel Booking
  </button>
</div>

      <!-- Reschedule Form with Calendar (hidden by default) -->
      <div id="rescheduleForm" class="card hidden">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 16px; color: #1e293b;">
          Reschedule Your Booking
        </h2>
        <p style="color: #64748b; margin-bottom: 24px;">
          Select a new date and time for your shoot. Free rescheduling available if more than 24 hours before your booking.
        </p>

        <div id="reschedule24HourWarning" class="alert alert-warning hidden">
          <strong>‚è∞ Cannot Reschedule:</strong> Rescheduling requires 24 hours notice. Your booking is too close to reschedule.
        </div>

        <!-- Calendar -->
        <div class="calendar-container">
          <div class="calendar-header">
            <button type="button" class="calendar-nav-btn" onclick="changeRescheduleMonth(-1)">‚Äπ</button>
            <h3 id="rescheduleCalendarMonth" class="calendar-month-title">Loading...</h3>
            <button type="button" class="calendar-nav-btn" onclick="changeRescheduleMonth(1)">‚Ä∫</button>
          </div>

          <div id="rescheduleCalendarGrid" class="calendar-grid">
            <!-- Calendar days will be inserted here -->
          </div>
        </div>

        <!-- Time Slots -->
        <div id="rescheduleTimeSlotSection" class="hidden">
          <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 16px;">
            Available Times for <span id="rescheduleSelectedDateDisplay"></span>
          </h3>

          <div id="rescheduleLoadingTimeSlots" class="loading hidden">
            <div class="loading-spinner" style="width: 32px; height: 32px;"></div>
            <p>Checking availability...</p>
          </div>

          <div id="rescheduleNoSlotsAvailable" class="alert alert-warning hidden">
  <strong>üìÖ Fully Booked:</strong> <span id="rescheduleNoSlotsReason">All time slots are taken for this date. Please select a different date.</span>
</div>

          <div id="rescheduleTimeSlotGrid" class="time-slot-grid hidden">
            <!-- Time slots will be inserted here -->
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="hideRescheduleForm()">Cancel</button>
          <button class="btn btn-primary" id="confirmRescheduleBtn" onclick="submitReschedule()" disabled>
            Confirm Reschedule
          </button>
        </div>
      </div>

     <!-- Modify Service Form -->
      <div id="modifyServiceForm" class="card hidden">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 16px; color: #1e293b;">
          Modify Your Service
        </h2>
        <p style="color: #64748b; margin-bottom: 24px;">
          Change your service, add extras, or adjust bedrooms. Price differences will be charged or refunded automatically.
        </p>

        <div class="alert alert-info">
          <strong>üí° Note:</strong> Discounts will be preserved and recalculated based on your new service price.
        </div>

        <!-- Service Selection -->
        <div id="modifyServiceCards" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 28px;">
          <!-- Services will be dynamically inserted here -->
        </div>

        <!-- Bedroom Counter -->
        <div id="modifyBedroomSection" style="display: none; margin-bottom: 28px;">
          <label class="form-label">Number of Bedrooms</label>
          <div style="display: flex; align-items: center; gap: 16px;">
            <button type="button" class="bedroom-btn" onclick="adjustModifyBedrooms(-1)">-</button>
            <div style="flex: 1; text-align: center;">
              <div id="modifyBedroomCount" style="font-size: 48px; font-weight: 700; color: #3b82f6;">4</div>
              <div style="font-size: 13px; color: #64748b; margin-top: 4px;">bedrooms</div>
            </div>
            <button type="button" class="bedroom-btn" onclick="adjustModifyBedrooms(1)">+</button>
          </div>
          <div id="modifyBedroomFeeNotice" style="display: none; margin-top: 12px; padding: 12px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; font-size: 13px; color: #92400e;">
            <strong>¬£30 per additional bedroom</strong> after the first 4 bedrooms
          </div>
        </div>

        <!-- Add-Ons Section -->
        <div id="modifyAddonsSection" style="display: none; margin-bottom: 28px;">
          <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">
            üì¶ Add-Ons
          </h3>
          <p style="font-size: 14px; color: #64748b; margin-bottom: 16px;">
            Select optional add-ons to enhance your booking
          </p>
          <div id="modifyAddonsGrid" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Add-ons will be inserted here -->
          </div>
        </div>

        <!-- Price Comparison -->
        <div id="modifyPriceComparison" style="background: #f8fafc; border-radius: 12px; padding: 24px; margin-bottom: 28px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <span style="font-size: 14px; color: #64748b;">Current Price</span>
            <span style="font-size: 14px; font-weight: 600; color: #64748b; text-decoration: line-through;" id="modifyCurrentPrice">¬£0.00</span>
          </div>
          <div id="modifyDiscountRow" style="display: none; justify-content: space-between; margin-bottom: 12px;">
            <span style="font-size: 14px; color: #10b981;">Discount Applied</span>
            <span style="font-size: 14px; font-weight: 600; color: #10b981;" id="modifyDiscountAmount">-¬£0.00</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
            <span style="font-size: 14px; color: #64748b;">New Price</span>
            <span style="font-size: 14px; font-weight: 600; color: #1e293b;" id="modifyNewPrice">¬£0.00</span>
          </div>
          <div style="border-top: 2px solid #e2e8f0; padding-top: 16px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 18px; font-weight: 700; color: #1e293b;">Price Difference</span>
            <span style="font-size: 24px; font-weight: 700;" id="modifyPriceDifference">¬£0.00</span>
          </div>
          <div id="modifyPriceNote" style="font-size: 12px; color: #64748b; text-align: right; margin-top: 8px;"></div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="hideModifyServiceForm()">Cancel</button>
          <button class="btn btn-primary" id="confirmModifyBtn" onclick="submitModifyService()" disabled>
            Confirm Changes
          </button>
        </div>
      </div>


      <!-- Cancel Form (hidden by default) -->
      <div id="cancelForm" class="card hidden">
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 16px; color: #1e293b;">
          Cancel Your Booking
        </h2>
        
        <div id="cancellationFeeWarning" class="alert alert-error hidden">
          <strong>‚ö†Ô∏è Cancellation Fee Applies:</strong>
          <p style="margin-top: 8px;" id="cancellationFeeText"></p>
        </div>

        <div id="freeCancellation" class="alert alert-success hidden">
          <strong>‚úÖ Free Cancellation Available</strong>
          <p style="margin-top: 8px;">You're cancelling more than 24 hours before your shoot, so no fees apply.</p>
        </div>

        <!-- Payment Breakdown (for paid cancellations) -->
        <div id="cancellationPaymentBreakdown" class="payment-breakdown hidden">
          <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px;">Cancellation Charges</h3>
          <div class="payment-row">
            <span>Original Booking Amount:</span>
            <span id="cancelOriginalAmount">¬£0.00</span>
          </div>
          <div class="payment-row">
            <span id="cancelFeeLabel">Cancellation Fee (50%):</span>
            <span id="cancelFeeAmount">¬£0.00</span>
          </div>
          <div class="payment-row total">
            <span>Amount to Charge:</span>
            <span id="cancelTotalCharge">¬£0.00</span>
          </div>
        </div>

        <label class="form-label">Reason for Cancellation (Optional)</label>
        <textarea id="cancelReason" class="form-input" rows="4" placeholder="Let us know why you're cancelling..."></textarea>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="hideCancelForm()">Go Back</button>
          <button class="btn btn-danger" id="confirmCancelBtn" onclick="submitCancellation()">
            <span id="cancelButtonText">Confirm Cancellation</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const stripe = Stripe('pk_live_51QycLvQAVOs8qTDFVfXTNzuuhBnPjgZQSS3AH30NGMuSf3SxAWF9pLzYwL0ulj1wMMCC2jnhDyeqeop7BkWDfeZ400wT3Ko8aK');
    let bookingData = null;
    let modifyData = {
      bedrooms: 4,
      selectedAddons: [],
      selectedService: null
    };
    let rescheduleCalendarDate = new Date();
    let rescheduleSelectedDate = null;
    let rescheduleSelectedTime = null;

    // ===== SERVICE & ADDON CATALOGS =====
    const SERVICES = {
      north: [
        {
          id: 'complete-branding',
          name: 'Complete Branding Package - Photo & Video',
          price: 894.00,
          duration: 300,
          isPropertyService: false,
          availableAddons: ['elevate-edit', 'add-branded-outro']
        },
        {
          id: 'branding-video',
          name: 'Branding Videography Session',
          price: 534.00,
          duration: 180,
          isPropertyService: false,
          availableAddons: ['elevate-edit', 'add-branded-outro']
        },
        {
          id: 'branding-photo',
          name: 'Branding Photography Session - 10 Signature Shots',
          price: 414.00,
          duration: 120,
          isPropertyService: false,
          availableAddons: []
        },
        {
          id: 'gold-package',
          name: 'Gold Package',
          price: 600.00,
          duration: 150,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'silver-package',
          name: 'Silver Package',
          price: 262.80,
          duration: 90,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'bronze-package',
          name: 'Bronze Package',
          price: 202.80,
          duration: 90,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-speed-tours']
        },
        {
          id: 'all-in-one-drone',
          name: 'All In One Drone',
          price: 214.80,
          duration: 45,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'property-video',
          name: 'Property Videography',
          price: 154.80,
          duration: 60,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-drone-photo', 'property-drone-video', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'property-photo',
          name: 'Property Photography',
          price: 118.80,
          duration: 45,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-photo', 'property-drone-video', 'property-speed-tours']
        },
        {
          id: 'drone-video',
          name: 'Property Drone Videography',
          price: 130.80,
          duration: 20,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-drone-photo', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'drone-photo',
          name: 'Property Drone Photography',
          price: 130.80,
          duration: 20,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-video', 'property-speed-tours']
        }
      ],
      south: [
        {
          id: 'gold-package',
          name: 'Gold Package',
          price: 600.00,
          duration: 150,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'silver-package',
          name: 'Silver Package',
          price: 262.80,
          duration: 90,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'bronze-package',
          name: 'Bronze Package',
          price: 202.80,
          duration: 90,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-speed-tours']
        },
        {
          id: 'all-in-one-drone',
          name: 'All In One Drone',
          price: 214.80,
          duration: 45,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'property-video',
          name: 'Property Videography',
          price: 154.80,
          duration: 60,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-drone-photo', 'property-drone-video', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'property-photo',
          name: 'Property Photography',
          price: 118.80,
          duration: 45,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-photo', 'property-drone-video', 'property-speed-tours']
        },
        {
          id: 'drone-video',
          name: 'Property Drone Videography',
          price: 130.80,
          duration: 20,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'elevate-edit', 'property-video', 'property-drone-photo', 'property-speed-tours', 'add-branded-outro']
        },
        {
          id: 'drone-photo',
          name: 'Property Drone Photography',
          price: 130.80,
          duration: 20,
          isPropertyService: true,
          availableAddons: ['standard-floor-plan', 'plus-floor-plan', 'property-video', 'property-drone-video', 'property-speed-tours']
        }
      ]
    };

    const ADDONS = {
      'standard-floor-plan': {
        id: 'standard-floor-plan',
        name: 'Standard Floor Plan',
        price: 24.00,
        description: '2D floor plan to help buyers visualize the property layout'
      },
      'plus-floor-plan': {
        id: 'plus-floor-plan',
        name: 'Plus Floor Plan',
        price: 36.00,
        description: 'Enhanced 2D floor plan with measurements and room labels'
      },
      'elevate-edit': {
        id: 'elevate-edit',
        name: 'Elevate Your Edit',
        price: 75.00,
        description: 'Transform your video with premium editing including dynamic transitions, bold captions, spotlight features'
      },
      'property-drone-photo': {
        id: 'property-drone-photo',
        name: 'Property Drone Photography',
        price: 130.80,
        description: 'Up to 10 stunning aerial photographs'
      },
      'property-drone-video': {
        id: 'property-drone-video',
        name: 'Property Drone Videography',
        price: 130.80,
        description: 'Up to 30-second cinematic aerial showcase'
      },
      'property-video': {
        id: 'property-video',
        name: 'Property Videography',
        price: 154.80,
        description: 'Shot in 4K to captivate viewers and drive enquiries'
      },
      'property-speed-tours': {
        id: 'property-speed-tours',
        name: 'Property Speed Tours',
        price: 60.00,
        description: 'Quick walkthrough video tour of the property'
      },
      'add-branded-outro': {
        id: 'add-branded-outro',
        name: 'Add Branded Outro To Video',
        price: 0.00,
        description: 'Add your branded outro to any video content'
      }
    };

    // Get booking reference and email from URL
    const urlParams = new URLSearchParams(window.location.search);
    const bookingRef = urlParams.get('ref');
    const clientEmail = urlParams.get('email');

    // Load booking on page load
    if (bookingRef && clientEmail) {
      loadBooking(bookingRef, clientEmail);
    } else {
      showNotFound();
    }

    async function loadBooking(ref, email) {
      try {
        const response = await fetch(`/.netlify/functions/get-booking?ref=${encodeURIComponent(ref)}&email=${encodeURIComponent(email)}`);
        
        if (!response.ok) {
          throw new Error('Booking not found');
        }

        bookingData = await response.json();
        displayBooking(bookingData);

      } catch (error) {
        console.error('Error loading booking:', error);
        showNotFound();
      }
    }

    function displayBooking(booking) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('bookingDetails').classList.remove('hidden');

      // Populate booking details
      document.getElementById('bookingRef').textContent = booking.bookingRef;
      document.getElementById('detailService').textContent = booking.service;
      
      const date = new Date(booking.date + 'T' + booking.time);
      const dateStr = date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
      document.getElementById('detailDateTime').textContent = `${dateStr} at ${booking.time}`;
      
      document.getElementById('detailAddress').textContent = booking.propertyAddress;
      document.getElementById('detailMediaSpecialist').textContent = booking.mediaSpecialist;
      document.getElementById('detailTotal').textContent = `¬£${booking.finalPrice.toFixed(2)}`;

      // Set status badge
      const statusBadge = document.getElementById('bookingStatus');
      if (booking.bookingStatus === 'Cancelled') {
        statusBadge.textContent = 'Cancelled';
        statusBadge.className = 'status-badge cancelled';
      } else if (booking.paymentStatus === 'Paid') {
        statusBadge.textContent = 'Confirmed';
        statusBadge.className = 'status-badge paid';
      } else {
        statusBadge.textContent = 'Reserved';
        statusBadge.className = 'status-badge reserved';
      }

      // Calculate hours until booking
      const bookingDateTime = new Date(booking.date + 'T' + booking.time);
      const now = new Date();
      const hoursUntil = Math.floor((bookingDateTime - now) / (1000 * 60 * 60));
      
      booking.hoursUntilBooking = hoursUntil;

      // Show cancellation warning
      if (hoursUntil > 0 && hoursUntil <= 48) {
        document.getElementById('hoursRemaining').textContent = hoursUntil;
        document.getElementById('cancellationWarning').classList.remove('hidden');
      }

      // Disable buttons if booking is in the past or already cancelled
      if (booking.bookingStatus === 'Cancelled') {
        document.getElementById('modifyServiceBtn').style.display = 'none';
        document.getElementById('rescheduleBtn').style.display = 'none';
        document.getElementById('cancelBtn').style.display = 'none';
      } else if (hoursUntil < 0) {
        document.getElementById('modifyServiceBtn').disabled = true;
        document.getElementById('rescheduleBtn').disabled = true;
        document.getElementById('rescheduleBtn').textContent = 'üìÖ Shoot Completed';
        document.getElementById('cancelBtn').disabled = true;
        document.getElementById('cancelBtn').textContent = '‚úñÔ∏è Cannot Cancel';
      } else if (hoursUntil < 24) {
        // Disable reschedule within 24 hours
        document.getElementById('rescheduleBtn').disabled = true;
        document.getElementById('rescheduleBtn').textContent = 'üìÖ Too Late to Reschedule';
      }
    }

    function showNotFound() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('notFoundState').classList.remove('hidden');
    }

    // ===== RESCHEDULE WITH CALENDAR =====
    
    function showRescheduleForm() {
      // Check if within 24 hours
      if (bookingData.hoursUntilBooking < 24) {
        document.getElementById('reschedule24HourWarning').classList.remove('hidden');
        document.getElementById('confirmRescheduleBtn').disabled = true;
      } else {
        document.getElementById('reschedule24HourWarning').classList.add('hidden');
      }
      
      document.getElementById('rescheduleForm').classList.remove('hidden');
      document.getElementById('rescheduleForm').scrollIntoView({ behavior: 'smooth' });
      
      // Initialize calendar
      rescheduleCalendarDate = new Date();
      rescheduleSelectedDate = null;
      rescheduleSelectedTime = null;
      renderRescheduleCalendar();
    }

    function hideRescheduleForm() {
      document.getElementById('rescheduleForm').classList.add('hidden');
      document.getElementById('rescheduleTimeSlotSection').classList.add('hidden');
      document.getElementById('confirmRescheduleBtn').disabled = true;
      rescheduleSelectedDate = null;
      rescheduleSelectedTime = null;
    }

    function changeRescheduleMonth(direction) {
      rescheduleCalendarDate.setMonth(rescheduleCalendarDate.getMonth() + direction);
      renderRescheduleCalendar();
    }

    function renderRescheduleCalendar() {
      const year = rescheduleCalendarDate.getFullYear();
      const month = rescheduleCalendarDate.getMonth();
      
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('rescheduleCalendarMonth').textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDay = firstDay.getDay();

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const maxDate = new Date();
      maxDate.setDate(maxDate.getDate() + 60);
      maxDate.setHours(23, 59, 59, 999);

      const grid = document.getElementById('rescheduleCalendarGrid');
      let html = '';

      const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayLabels.forEach(label => {
        html += `<div class="calendar-day day-label">${label}</div>`;
      });

      for (let i = 0; i < startDay; i++) {
        html += `<div class="calendar-day disabled other-month"></div>`;
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0);
        
        const isPast = date < today;
        const isTooFarAhead = date > maxDate;
        const isSunday = date.getDay() === 0;
        const isSaturday = date.getDay() === 6;
        const isDisabled = isPast || isTooFarAhead || isSunday || isSaturday;
        const isToday = date.getTime() === today.getTime();
        const isSelected = rescheduleSelectedDate && date.toISOString().split('T')[0] === rescheduleSelectedDate;

        let classes = 'calendar-day';
        if (isDisabled) classes += ' disabled';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';

        const dateString = date.toISOString().split('T')[0];
        html += `<div class="${classes}" onclick="${isDisabled ? '' : `selectRescheduleDate('${dateString}')`}">${day}</div>`;
      }

      grid.innerHTML = html;
    }

    async function selectRescheduleDate(dateString) {
      rescheduleSelectedDate = dateString;
      rescheduleSelectedTime = null;

      renderRescheduleCalendar();

      document.getElementById('rescheduleTimeSlotSection').classList.remove('hidden');
      document.getElementById('rescheduleLoadingTimeSlots').classList.remove('hidden');
      document.getElementById('rescheduleTimeSlotGrid').classList.add('hidden');
      document.getElementById('rescheduleNoSlotsAvailable').classList.add('hidden');
      document.getElementById('confirmRescheduleBtn').disabled = true;

      const date = new Date(dateString + 'T12:00:00');
      const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
      document.getElementById('rescheduleSelectedDateDisplay').textContent = date.toLocaleDateString('en-GB', options);

      await loadRescheduleTimeSlots(dateString);

      document.getElementById('rescheduleTimeSlotSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    async function loadRescheduleTimeSlots(dateString) {
      try {
        // ‚úÖ Calculate service duration from catalog
        const serviceName = bookingData.service;
        const region = bookingData.region.toLowerCase();
        
        let serviceDuration = 90; // default
        if (SERVICES[region]) {
          const service = SERVICES[region].find(s => s.name === serviceName);
          if (service) {
            serviceDuration = service.duration;
          }
        }
        
        console.log('Loading reschedule time slots:', {
          postcode: bookingData.postcode,
          region: bookingData.region,
          selectedDate: dateString,
          duration: serviceDuration
        });

        const response = await fetch('/.netlify/functions/check-availability', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            postcode: bookingData.postcode,
            region: bookingData.region,
            selectedDate: dateString,
            duration: serviceDuration, // ‚úÖ ADD THIS
            isAdmin: false
          })
        });

        if (!response.ok) {
          throw new Error('Failed to check availability');
        }

        const data = await response.json();
        console.log('Availability response:', data);

        renderRescheduleTimeSlots(data.availableSlots);

      } catch (error) {
        console.error('Error loading time slots:', error);
        
        // Fallback to all slots
        const fallbackSlots = [];
        for (let hour = 9; hour <= 15; hour++) {
          for (let minute of [0, 30]) {
            if (hour === 15 && minute === 30) break;
            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            fallbackSlots.push({ time: timeString, available: true });
          }
        }
        
        renderRescheduleTimeSlots(fallbackSlots);
      }
    }

    function renderRescheduleTimeSlots(slots) {
  const grid = document.getElementById('rescheduleTimeSlotGrid');
  const loadingEl = document.getElementById('rescheduleLoadingTimeSlots');
  const noSlotsEl = document.getElementById('rescheduleNoSlotsAvailable');
  
  loadingEl.classList.add('hidden');
  
  const availableSlots = slots.filter(slot => slot.available);
  
  if (availableSlots.length === 0) {
    // ‚úÖ Show "Fully Booked" message WITHOUT the conflict details
    noSlotsEl.classList.remove('hidden');
    grid.classList.add('hidden');
    
    // ‚úÖ Generic message only
    document.getElementById('rescheduleNoSlotsReason').textContent = 'All time slots are taken for this date. Please select a different date.';
    return;
  }
  
  // ‚úÖ Hide warning when slots ARE available
  noSlotsEl.classList.add('hidden');
  
  const html = availableSlots.map(slot => {
    const isSelected = rescheduleSelectedTime === slot.time;
    return `<div class="time-slot ${isSelected ? 'selected' : ''}" onclick="selectRescheduleTime('${slot.time}')">${slot.time}</div>`;
  }).join('');
  
  grid.innerHTML = html;
  grid.classList.remove('hidden');
}

    function selectRescheduleTime(time) {
      rescheduleSelectedTime = time;
      renderRescheduleTimeSlots(
        Array.from(document.querySelectorAll('#rescheduleTimeSlotGrid .time-slot')).map(el => ({
          time: el.textContent.trim(),
          available: true
        }))
      );
      document.getElementById('confirmRescheduleBtn').disabled = false;
    }

    async function submitReschedule() {
      if (!rescheduleSelectedDate || !rescheduleSelectedTime) {
        alert('Please select both a date and time');
        return;
      }

      if (!confirm(`Reschedule to ${rescheduleSelectedDate} at ${rescheduleSelectedTime}?`)) {
        return;
      }

      const confirmBtn = document.getElementById('confirmRescheduleBtn');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Rescheduling...';

      try {
        const response = await fetch('/.netlify/functions/reschedule-booking', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookingRef: bookingData.bookingRef,
            newDate: rescheduleSelectedDate,
            newTime: rescheduleSelectedTime,
            clientEmail: bookingData.clientEmail
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to reschedule');
        }

        window.location.href = `/reschedule-success.html?ref=${bookingData.bookingRef}&date=${rescheduleSelectedDate}&time=${rescheduleSelectedTime}&email=${encodeURIComponent(bookingData.clientEmail)}`;

      } catch (error) {
        console.error('Reschedule error:', error);
        alert(`Failed to reschedule: ${error.message}`);
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirm Reschedule';
      }
    }

    // ===== MODIFY SERVICE =====
    
    function showModifyServiceForm() {
      document.getElementById('modifyServiceForm').classList.remove('hidden');
      document.getElementById('modifyServiceForm').scrollIntoView({ behavior: 'smooth' });
      
      // Reset modify data
      modifyData = {
        bedrooms: bookingData.bedrooms || 4,
        selectedAddons: [],
        selectedService: null
      };
      
      document.getElementById('modifyBedroomCount').textContent = modifyData.bedrooms;
      document.getElementById('modifyCurrentPrice').textContent = `¬£${bookingData.finalPrice.toFixed(2)}`;
      
      renderModifyServices();
    }

    function hideModifyServiceForm() {
      document.getElementById('modifyServiceForm').classList.add('hidden');
      modifyData = { bedrooms: 4, selectedAddons: [], selectedService: null };
      document.getElementById('confirmModifyBtn').disabled = true;
    }

    function renderModifyServices() {
      const region = bookingData.region.toLowerCase();
      const services = SERVICES[region] || SERVICES.south;
      const container = document.getElementById('modifyServiceCards');

      const servicesHTML = services.map(service => `
        <div class="service-card" data-service-id="${service.id}" onclick="selectModifyService('${service.id}')">
          <div style="flex: 1;">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 6px;">
              ${service.name}
            </h3>
            <p style="font-size: 14px; color: #64748b; line-height: 1.5; margin-bottom: 12px;">
              ${service.isPropertyService ? 'Property service' : 'Personal branding'}
            </p>
            <div style="display: flex; align-items: center; gap: 16px;">
              <span style="font-size: 13px; color: #94a3b8;">
                ${Math.floor(service.duration / 60)}h ${service.duration % 60}m
              </span>
              <span style="font-size: 20px; font-weight: 700; color: #3b82f6;">
                ¬£${service.price.toFixed(2)}
              </span>
            </div>
          </div>
          <div class="service-radio"></div>
        </div>
      `).join('');

      container.innerHTML = servicesHTML;
    }

    function selectModifyService(serviceId) {
      const region = bookingData.region.toLowerCase();
      const services = SERVICES[region] || SERVICES.south;
      const service = services.find(s => s.id === serviceId);

      if (!service) return;

      modifyData.selectedService = service;
      modifyData.selectedAddons = [];

      document.querySelectorAll('#modifyServiceCards .service-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`#modifyServiceCards [data-service-id="${serviceId}"]`).classList.add('selected');

      const bedroomSection = document.getElementById('modifyBedroomSection');
      if (service.isPropertyService) {
        bedroomSection.style.display = 'block';
        modifyData.bedrooms = bookingData.bedrooms || 4;
        document.getElementById('modifyBedroomCount').textContent = modifyData.bedrooms;
      } else {
        bedroomSection.style.display = 'none';
        modifyData.bedrooms = 0;
      }

      renderModifyAddons();
      calculateModifyPrice();
    }

    function renderModifyAddons() {
      const service = modifyData.selectedService;
      if (!service || !service.availableAddons || service.availableAddons.length === 0) {
        document.getElementById('modifyAddonsSection').style.display = 'none';
        return;
      }

      const container = document.getElementById('modifyAddonsGrid');
      const addonsHTML = service.availableAddons.map(addonId => {
        const addon = ADDONS[addonId];
        if (!addon) return '';

        const isSelected = modifyData.selectedAddons.includes(addonId);

        return `
          <div class="service-card ${isSelected ? 'selected' : ''}" 
               data-addon-id="${addon.id}" 
               onclick="toggleModifyAddon('${addon.id}')"
               style="padding: 16px;">
            <div style="flex: 1;">
              <h4 style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
                ${addon.name}
              </h4>
              <p style="font-size: 13px; color: #64748b; line-height: 1.5; margin-bottom: 8px;">
                ${addon.description}
              </p>
              <span style="font-size: 18px; font-weight: 700; color: #3b82f6;">
                ${addon.price === 0 ? 'FREE' : `+¬£${addon.price.toFixed(2)}`}
              </span>
            </div>
            <div class="service-radio"></div>
          </div>
        `;
      }).join('');

      container.innerHTML = addonsHTML;
      document.getElementById('modifyAddonsSection').style.display = 'block';
    }

    function toggleModifyAddon(addonId) {
      const index = modifyData.selectedAddons.indexOf(addonId);
      
      if (index > -1) {
        modifyData.selectedAddons.splice(index, 1);
      } else {
        modifyData.selectedAddons.push(addonId);
      }

      renderModifyAddons();
      calculateModifyPrice();
    }

    function adjustModifyBedrooms(change) {
      const currentBedrooms = modifyData.bedrooms;
      const newBedrooms = Math.max(1, Math.min(15, currentBedrooms + change));
      
      modifyData.bedrooms = newBedrooms;
      document.getElementById('modifyBedroomCount').textContent = newBedrooms;

      const feeNotice = document.getElementById('modifyBedroomFeeNotice');
      if (newBedrooms > 4) {
        feeNotice.style.display = 'block';
      } else {
        feeNotice.style.display = 'none';
      }

      calculateModifyPrice();
    }

    function calculateModifyPrice() {
      if (!modifyData.selectedService) {
        document.getElementById('confirmModifyBtn').disabled = true;
        return;
      }

      const basePrice = modifyData.selectedService.price;
      const extraRooms = modifyData.bedrooms > 4 ? modifyData.bedrooms - 4 : 0;
      const extraBedroomFee = extraRooms * 30;
      
      let addonsPrice = 0;
      modifyData.selectedAddons.forEach(addonId => {
        const addon = ADDONS[addonId];
        if (addon) addonsPrice += addon.price;
      });

      const newTotalPrice = basePrice + extraBedroomFee + addonsPrice;
      const currentPrice = bookingData.finalPrice;
      const priceDifference = newTotalPrice - currentPrice;

      // Update UI
      document.getElementById('modifyNewPrice').textContent = `¬£${newTotalPrice.toFixed(2)}`;
      
      const diffEl = document.getElementById('modifyPriceDifference');
      diffEl.textContent = `${priceDifference >= 0 ? '+' : ''}¬£${priceDifference.toFixed(2)}`;
      diffEl.style.color = priceDifference >= 0 ? '#ef4444' : '#10b981';

      const noteEl = document.getElementById('modifyPriceNote');
      if (priceDifference > 0) {
        noteEl.textContent = 'Additional charge will be applied';
        noteEl.style.color = '#ef4444';
      } else if (priceDifference < 0) {
        noteEl.textContent = 'Refund will be processed';
        noteEl.style.color = '#10b981';
      } else {
        noteEl.textContent = 'No price change';
        noteEl.style.color = '#64748b';
      }

      // Show discount if exists
      if (bookingData.discountCode) {
        document.getElementById('modifyDiscountRow').style.display = 'flex';
        document.getElementById('modifyDiscountAmount').textContent = `-¬£${bookingData.discountAmount.toFixed(2)}`;
      }

      document.getElementById('confirmModifyBtn').disabled = false;
    }

    async function submitModifyService() {
      if (!modifyData.selectedService) {
        alert('Please select a service');
        return;
      }

      const service = modifyData.selectedService;
      const extraRooms = modifyData.bedrooms > 4 ? modifyData.bedrooms - 4 : 0;
      const extraBedroomFee = extraRooms * 30;
      
      let addonsPrice = 0;
      const addonsArray = modifyData.selectedAddons.map(addonId => {
        const addon = ADDONS[addonId];
        if (addon) addonsPrice += addon.price;
        return {
          id: addonId,
          name: addon?.name || '',
          price: addon?.price || 0
        };
      });

      const newTotalPrice = service.price + extraBedroomFee + addonsPrice;
      const priceDifference = newTotalPrice - bookingData.totalPrice;

      if (!confirm(`Modify service to ${service.name}?\n\nPrice difference: ${priceDifference >= 0 ? '+' : ''}¬£${priceDifference.toFixed(2)}`)) {
        return;
      }

      const confirmBtn = document.getElementById('confirmModifyBtn');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      try {
        const response = await fetch('/.netlify/functions/modify-booking-service', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookingId: bookingData.id,
            bookingRef: bookingData.bookingRef,
            clientEmail: bookingData.clientEmail,
            newServiceId: service.id,
            newServiceName: service.name,
            newServicePrice: service.price,
            newServiceDuration: service.duration,
            bedrooms: modifyData.bedrooms,
            extraBedroomFee: extraBedroomFee,
            addons: addonsArray,
            addonsPrice: addonsPrice,
            totalPrice: newTotalPrice
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to modify service');
        }

        const result = await response.json();
        alert(`‚úÖ Service updated successfully!\n\nNew service: ${service.name}\nTotal: ¬£${newTotalPrice.toFixed(2)}`);
        window.location.reload();

      } catch (error) {
        console.error('Modify service error:', error);
        alert(`Failed to modify service: ${error.message}`);
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirm Changes';
      }
    }

    // ===== CANCELLATION =====
    
    function showCancelForm() {
  const hoursUntil = bookingData.hoursUntilBooking;
  const totalPrice = bookingData.finalPrice;
  
  console.log('Cancel form opened:', {
    hoursUntil: hoursUntil,
    totalPrice: totalPrice,
    bookingDate: bookingData.date,
    bookingTime: bookingData.time
  });
  
  let cancellationFee = 0;
  let feePercentage = 0;
  let feeText = '';
  
  // Determine fee based on hours until booking
  if (hoursUntil < 0) {
    // Past booking time - 100% fee
    feePercentage = 100;
    cancellationFee = totalPrice;
    feeText = `This booking has passed. Cancelling after the shoot time incurs the <strong>full charge (¬£${cancellationFee.toFixed(2)})</strong>.`;
  } else if (hoursUntil < 24) {
    // Within 24 hours - 50% fee
    feePercentage = 50;
    cancellationFee = totalPrice * 0.5;
    feeText = `You have <strong>${hoursUntil} hours</strong> until your shoot. Cancelling within 24 hours incurs a <strong>50% fee (¬£${cancellationFee.toFixed(2)})</strong>.`;
  }
  
  console.log('Cancellation calculation:', {
    fee: cancellationFee,
    percentage: feePercentage,
    requiresPayment: cancellationFee > 0
  });
  
  // Show appropriate UI based on fee
  if (cancellationFee > 0) {
    // PAID CANCELLATION
    document.getElementById('cancellationFeeWarning').classList.remove('hidden');
    document.getElementById('cancellationFeeText').innerHTML = feeText;
    document.getElementById('freeCancellation').classList.add('hidden');
    
    // Show payment breakdown
    document.getElementById('cancellationPaymentBreakdown').classList.remove('hidden');
    document.getElementById('cancelOriginalAmount').textContent = `¬£${totalPrice.toFixed(2)}`;
    document.getElementById('cancelFeeLabel').textContent = `Cancellation Fee (${feePercentage}%):`;
    document.getElementById('cancelFeeAmount').textContent = `¬£${cancellationFee.toFixed(2)}`;
    document.getElementById('cancelTotalCharge').textContent = `¬£${cancellationFee.toFixed(2)}`;
    
    document.getElementById('cancelButtonText').textContent = `Pay ¬£${cancellationFee.toFixed(2)} & Cancel`;
  } else {
    // FREE CANCELLATION
    document.getElementById('cancellationFeeWarning').classList.add('hidden');
    document.getElementById('freeCancellation').classList.remove('hidden');
    document.getElementById('cancellationPaymentBreakdown').classList.add('hidden');
    document.getElementById('cancelButtonText').textContent = 'Confirm Free Cancellation';
  }
  
  document.getElementById('cancelForm').classList.remove('hidden');
  document.getElementById('cancelForm').scrollIntoView({ behavior: 'smooth' });
}

    function hideCancelForm() {
      document.getElementById('cancelForm').classList.add('hidden');
    }

    async function submitCancellation() {
      const reason = document.getElementById('cancelReason').value;
      const hoursUntil = bookingData.hoursUntilBooking;
      const totalPrice = bookingData.finalPrice;
      
      let cancellationFee = 0;
      if (hoursUntil < 24 && hoursUntil >= 0) {
        cancellationFee = totalPrice * 0.5;
      } else if (hoursUntil < 0) {
        cancellationFee = totalPrice;
      }
      
      const requiresPayment = cancellationFee > 0;
      
      if (requiresPayment) {
        if (!confirm(`This cancellation requires a fee of ¬£${cancellationFee.toFixed(2)}. Continue?`)) {
          return;
        }
        await processCancellationWithPayment(cancellationFee, reason);
      } else {
        if (!confirm('Are you sure you want to cancel this booking?')) {
          return;
        }
        await processFreeCancellation(reason);
      }
    }

    async function processCancellationWithPayment(cancellationFee, reason) {
      try {
        const response = await fetch('/.netlify/functions/cancel-booking-with-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookingRef: bookingData.bookingRef,
            clientEmail: bookingData.clientEmail,
            cancellationFee: cancellationFee,
            reason: reason
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to process cancellation');
        }

        const result = await response.json();
        window.location.href = result.checkoutUrl;

      } catch (error) {
        console.error('Cancellation payment error:', error);
        alert(`Failed to process cancellation: ${error.message}`);
      }
    }

    async function processFreeCancellation(reason) {
      try {
        const response = await fetch('/.netlify/functions/cancel-booking', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookingId: bookingData.id,
            clientEmail: bookingData.clientEmail,
            reason: reason
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to cancel');
        }

        const result = await response.json();
        alert(`‚úÖ Booking cancelled successfully. ${result.refundNote || ''}`);
        window.location.reload();

      } catch (error) {
        console.error('Cancellation error:', error);
        alert(`Failed to cancel: ${error.message}`);
      }
    }
  </script>
</body>
</html>